# QooERP 客户关系管理模块 - 技术设计文档

> 模块名称: qooerp-crm
> 模块版本: v1.0
> 创建日期: 2026-02-17
> 作者: Auto
> **数据库**: PostgreSQL 15+

---

## 一、技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Spring Boot | 3.2.x | 核心框架 |
| MyBatis-Plus | 3.5.x | ORM框架 |
| PostgreSQL | 15+ | 数据库 |
| Redis | 7.x | 缓存 |
| Nacos | 2.x | 配置中心 |

---

## 二、核心功能实现

### 2.1 商机转化分析

```java
@Service
public class OpportunityAnalysisService {
    
    public ConversionRateDTO calculateConversionRate(Long customerId) {
        // 计算商机转化率
        long totalOpportunities = opportunityMapper.countByCustomerId(customerId);
        long convertedOpportunities = opportunityMapper.countConvertedByCustomerId(customerId);
        
        BigDecimal conversionRate = BigDecimal.ZERO;
        if (totalOpportunities > 0) {
            conversionRate = new BigDecimal(convertedOpportunities)
                .divide(new BigDecimal(totalOpportunities), 4, RoundingMode.HALF_UP)
                .multiply(new BigDecimal("100"));
        }
        
        return ConversionRateDTO.builder()
            .totalOpportunities(totalOpportunities)
            .convertedOpportunities(convertedOpportunities)
            .conversionRate(conversionRate)
            .build();
    }
}
```

### 2.2 客户分级算法

```java
@Service
public class CustomerGradingService {
    
    public void calculateCustomerGrade(Long customerId) {
        CrmCustomer customer = customerMapper.selectById(customerId);
        
        // 计算客户分数
        BigDecimal totalAmount = contractMapper.sumAmountByCustomerId(customerId);
        int contractCount = contractMapper.countByCustomerId(customerId);
        int serviceCount = serviceMapper.countByCustomerId(customerId);
        
        BigDecimal score = BigDecimal.ZERO;
        score = score.add(totalAmount.divide(new BigDecimal("10000"), 2, RoundingMode.HALF_UP));
        score = score.add(new BigDecimal(contractCount * 10));
        score = score.add(new BigDecimal(serviceCount * 5));
        
        // 根据分数确定等级
        if (score.compareTo(new BigDecimal("100")) >= 0) {
            customer.setLevel(CustomerLevel.A);
        } else if (score.compareTo(new BigDecimal("50")) >= 0) {
            customer.setLevel(CustomerLevel.B);
        } else {
            customer.setLevel(CustomerLevel.C);
        }
        
        customerMapper.updateById(customer);
    }
}
```

---

## 三、部署配置

```yaml
server:
  port: 8094

spring:
  application:
    name: qooerp-crm
  datasource:
    url: jdbc:postgresql://localhost:5432/qooerp_crm
```

---

**文档版本**: v1.0  
**最后更新**: 2026-02-17
