# qooerp-user 用户管理 - 功能重复分析报告

> 分析日期：20xx-xx-xx
> 分析人员：QooERP团队
> 分析范围：QooERP各微服务模块

---

## 一、分析概述

### 1.1 分析目的

本次分析旨在识别`qooerp-user`用户管理模块与其他微服务模块之间的功能重复情况，明确各模块的职责边界，避免功能冗余，确保系统架构的清晰性和可维护性。

### 1.2 分析方法

1. 对比分析：对比各微服务的业务设计文档
2. 职责划分：基于DDD领域驱动设计原则，明确各限界上下文的职责
3. 依赖关系：分析模块之间的依赖关系和数据流
4. 功能去重：识别重复功能并提出优化建议

### 1.3 分析范围

| 模块名称 | 模块说明 | 是否分析 |
|---------|---------|---------|
| qooerp-user | 用户管理 | ✅ 主模块 |
| qooerp-auth | 认证服务 | ✅ 分析 |
| qooerp-hr | 人力资源管理 | ✅ 分析 |
| qooerp-organization | 组织管理 | ✅ 分析 |
| qooerp-permission | 权限服务 | ✅ 分析 |
| qooerp-system | 系统管理 | ✅ 分析 |
| qooerp-notify | 通知服务 | ✅ 分析 |
| qooerp-message | 消息服务 | ✅ 分析 |

---

## 二、功能重复分析

### 2.1 用户管理 vs 认证服务（qooerp-auth）

#### 2.1.1 功能对比

| 功能点 | qooerp-user | qooerp-auth | 是否重复 | 结论 |
|--------|-------------|-------------|---------|------|
| 用户基本信息管理 | ✅ | ❌ | 否 | ✓ user职责 |
| 用户档案管理 | ✅ | ❌ | 否 | ✓ user职责 |
| 用户账户管理 | ✅ | ❌ | 否 | ✓ user职责 |
| **密码管理** | ✅ 密码修改、重置 | ✅ 密码验证 | ⚠️ 部分重叠 | 需明确职责 |
| **MFA管理** | ✅ MFA启用、禁用、验证 | ❌ | 否 | ✓ user职责 |
| **登录功能** | ❌ | ✅ 登录、登出、令牌管理 | 否 | ✓ auth职责 |
| **登录安全** | ⚠️ 登录失败计数、锁定 | ✅ 登录失败限制 | ⚠️ 部分重叠 | 需协调 |
| **第三方登录** | ⚠️ 社交账号存储 | ✅ 第三方登录集成 | ⚠️ 部分重叠 | 需协调 |

#### 2.1.2 职责划分建议

**qooerp-user（用户上下文）职责：**
- ✅ 用户身份信息管理（用户名、手机、邮箱）
- ✅ 用户档案信息管理（基本信息、教育、工作经历）
- ✅ 用户账户信息管理（密码存储、MFA配置）
- ✅ 用户状态管理（启用、停用、锁定）
- ✅ 登录失败计数和账户锁定状态
- ✅ 社交账号绑定信息存储

**qooerp-auth（认证上下文）职责：**
- ✅ 登录流程编排（用户名密码、手机验证码、邮箱验证码）
- ✅ 令牌管理（JWT生成、验证、刷新、吊销）
- ✅ 登录安全策略（登录失败限制、IP封禁、设备管理）
- ✅ 第三方登录集成（OAuth2.0、OIDC、微信、钉钉等）
- ✅ MFA验证逻辑（调用user服务的MFA配置进行验证）
- ✅ 单点登录（SSO）

**协作关系：**
```
qooerp-auth（认证上下文）
    ↓ 查询用户信息
qooerp-user（用户上下文）
    ↓ 返回用户信息（包含密码、MFA配置等）
qooerp-auth（认证上下文）
    ↓ 验证密码和MFA
qooerp-auth（认证上下文）
    ↓ 生成令牌
客户端
```

#### 2.1.3 重复功能处理建议

| 重复功能 | 处理建议 | 说明 |
|---------|---------|------|
| 密码验证 | **auth服务** | auth服务验证密码，user服务存储密码 |
| 登录失败计数 | **双方协作** | auth记录登录失败，user更新账户状态 |
| 账户锁定 | **user服务** | user服务管理账户锁定状态 |
| 第三方登录 | **双方协作** | auth处理OAuth流程，user存储绑定信息 |

---

### 2.2 用户管理 vs 人力资源管理（qooerp-hr）

#### 2.2.1 功能对比

| 功能点 | qooerp-user | qooerp-hr | 是否重复 | 结论 |
|--------|-------------|------------|---------|------|
| **员工基本信息** | ✅ 用户档案（姓名、性别、生日） | ✅ 员工档案 | ⚠️ 严重重叠 | 需明确职责 |
| **员工编号** | ✅ employee_no | ✅ 员工编号 | ⚠️ 重复 | 需统一管理 |
| **入职日期** | ✅ hire_date | ✅ 入职管理 | ⚠️ 重复 | 需统一管理 |
| **组织关系** | ✅ user_organization_relation | ✅ 员工组织信息 | ⚠️ 重复 | 需协调 |
| **岗位关系** | ✅ user_position_relation | ✅ 员工岗位信息 | ⚠️ 重复 | 需协调 |
| **教育背景** | ✅ user_education | ✅ 教育经历 | ⚠️ 重复 | 需协调 |
| **工作经历** | ✅ user_work_experience | ✅ 工作经历 | ⚠️ 重复 | 需协调 |
| **技能信息** | ✅ user_skill | ✅ 证书资质 | ⚠️ 重复 | 需协调 |
| **证件信息** | ✅ user_document | ❌ | 否 | ✓ user职责 |
| **家庭成员** | ❌ | ✅ 家庭成员 | 否 | ✓ hr职责 |
| **考勤管理** | ❌ | ✅ 考勤管理 | 否 | ✓ hr职责 |
| **薪资管理** | ❌ | ✅ 薪资管理 | 否 | ✓ hr职责 |
| **绩效管理** | ❌ | ✅ 绩效管理 | 否 | ✓ hr职责 |
| **入职离职流程** | ❌ | ✅ 入职离职流程 | 否 | ✓ hr职责 |

#### 2.2.2 职责划分建议

**核心问题：**
`qooerp-user`和`qooerp-hr`在员工基本信息管理上存在**严重重叠**，这是DDD限界上下文划分不清晰的表现。

**分析：**
- 用户（User）：系统用户，包括员工、客户、供应商、系统用户等
- 员工（Employee）：企业内部员工，是User的一个子集

**推荐方案：采用"用户-员工分离"模式**

**qooerp-user（用户上下文）职责：**
- ✅ 通用用户身份管理（适用于所有类型用户）
  - 用户名、密码、MFA
  - 通用联系方式（手机、邮箱）
  - 用户偏好（语言、时区、主题）
- ✅ 基本用户档案（最小化）
  - 真实姓名（必填）
  - 昵称（选填）
  - 头像
  - 性别、生日
- ✅ 用户账户和安全
  - 密码管理
  - MFA配置
  - 登录安全
- ✅ 用户类型区分
  - INTERNAL（内部用户/员工）
  - EXTERNAL（外部用户/客户、供应商）
  - SYSTEM（系统用户）

**qooerp-hr（人力资源上下文）职责：**
- ✅ 员工全生命周期管理（仅针对内部用户）
  - 员工档案（扩展user的基本信息）
  - 员工编号（HR专用编号）
  - 入职管理（入职申请、审批、激活）
  - 离职管理（离职申请、审批、停用）
  - 转岗管理
  - 调薪管理
- ✅ 员工HR专业信息
  - 教育背景（HR视角，更详细）
  - 工作经历（HR视角，更详细）
  - 技能证书（HR视角）
  - 家庭成员（HR专用）
  - 合同信息（HR专用）
- ✅ 考勤管理
  - 打卡记录
  - 请假管理
  - 加班管理
  - 出差管理
- ✅ 薪资管理
- ✅ 绩效管理

**协作关系：**
```
创建员工流程：
qooerp-hr（发起入职申请）
    ↓ 创建用户（基本信息）
qooerp-user（创建user，userType=INTERNAL）
    ↓ 返回userId
qooerp-hr（创建employee，关联userId）
    ↓ 发布员工创建事件
其他上下文（处理事件）
```

#### 2.2.3 数据模型调整建议

**方案A：完全分离（推荐）**

```sql
-- qooerp-user 表（通用用户）
user_aggregate              -- 用户聚合（所有用户）
user_profile                 -- 用户基本信息（最小化）
user_account                 -- 用户账户
user_preference              -- 用户偏好
user_notification            -- 用户通知
user_message                 -- 用户消息

-- qooerp-hr 表（员工信息，仅针对userType=INTERNAL的用户）
hr_employee                  -- 员工信息（关联user_id）
hr_education                -- 员工教育背景（HR视角）
hr_work_experience           -- 员工工作经历（HR视角）
hr_skill_certificate         -- 员工技能证书
hr_family_member            -- 员工家庭成员
hr_contract                 -- 员工合同
hr_attendance              -- 考勤记录
hr_salary                  -- 薪资信息
hr_performance             -- 绩效信息
```

**方案B：部分共享（备选）**

```sql
-- qooerp-user 表（通用用户）
user_aggregate              -- 用户聚合
user_profile               -- 用户基本信息（HR可扩展）
user_account              -- 用户账户
user_education           -- 教育背景（通用）
user_work_experience     -- 工作经历（通用）
user_skill               -- 技能（通用）
user_document            -- 证件（通用）

-- qooerp-hr 表（员工HR专用）
hr_employee              -- 员工HR信息（关联user_id）
hr_family_member        -- 家庭成员
hr_contract             -- 合同
hr_attendance           -- 考勤
hr_salary               -- 薪资
hr_performance          -- 绩效
```

**推荐方案A的原因：**
1. **职责清晰**：User负责通用用户，HR负责员工HR信息
2. **易于扩展**：外部用户（客户、供应商）不需要HR字段
3. **性能优化**：HR查询时只查询必要字段
4. **符合DDD**：清晰的限界上下文划分

#### 2.2.4 重复功能处理建议

| 重复功能 | 处理建议 | 说明 |
|---------|---------|------|
| 员工基本信息 | **user服务存储基本信息，hr服务扩展** | user存储最小化信息，hr扩展HR专用字段 |
| 员工编号 | **hr服务管理** | 员工编号是HR概念，user不需要 |
| 入职日期 | **hr服务管理** | 入职日期是HR概念，user不需要 |
| 教育背景 | **hr服务管理** | HR视角的教育背景更详细 |
| 工作经历 | **hr服务管理** | HR视角的工作经历更详细 |
| 技能信息 | **hr服务管理** | HR视角的技能与认证相关 |
| 组织关系 | **双方协作** | user存储通用组织关系，hr存储HR组织信息 |
| 岗位关系 | **双方协作** | user存储通用岗位关系，hr存储HR岗位信息 |

---

### 2.3 用户管理 vs 组织管理（qooerp-organization）

#### 2.3.1 功能对比

| 功能点 | qooerp-user | qooerp-organization | 是否重复 | 结论 |
|--------|-------------|-------------------|---------|------|
| 用户组织关联 | ✅ user_organization_relation | ❌ | 否 | ✓ user职责 |
| 部门管理 | ❌ | ✅ 部门CRUD、树形结构 | 否 | ✓ org职责 |
| 岗位管理 | ❌ | ✅ 岗位CRUD | 否 | ✓ org职责 |
| 组织架构 | ❌ | ✅ 组织树、层级管理 | 否 | ✓ org职责 |

#### 2.3.2 职责划分建议

**qooerp-user（用户上下文）职责：**
- ✅ 用户与组织的关联关系（user_organization_relation）
- ✅ 用户与岗位的关联关系（user_position_relation）
- ✅ 用户主组织、主岗位

**qooerp-organization（组织管理上下文）职责：**
- ✅ 组织管理（部门、事业部、子公司）
- ✅ 岗位管理（岗位信息、岗位层级）
- ✅ 组织架构树（树形结构、层级管理）
- ✅ 组织权限边界

**协作关系：**
```
创建用户时关联组织：
qooerp-user
    ↓ 查询组织信息
qooerp-organization
    ↓ 返回组织信息
qooerp-user
    ↓ 保存user_organization_relation
数据库
```

#### 2.3.3 重复功能处理建议

| 重复功能 | 处理建议 | 说明 |
|---------|---------|------|
| 组织信息查询 | **org服务** | org服务管理组织信息，user只存储关联关系 |
| 岗位信息查询 | **org服务** | org服务管理岗位信息，user只存储关联关系 |

**结论：无重复，职责清晰** ✓

---

### 2.4 用户管理 vs 权限服务（qooerp-permission）

#### 2.4.1 功能对比

| 功能点 | qooerp-user | qooerp-permission | 是否重复 | 结论 |
|--------|-------------|------------------|---------|------|
| 用户角色关联 | ✅ user_role_relation | ✅ 用户角色分配 | ⚠️ 重复 | 需协调 |
| 角色管理 | ❌ | ✅ 角色CRUD | 否 | ✓ perm职责 |
| 权限管理 | ❌ | ✅ 菜单权限、按钮权限、数据权限 | 否 | ✓ perm职责 |
| 权限验证 | ❌ | ✅ 权限验证、缓存 | 否 | ✓ perm职责 |

#### 2.4.2 职责划分建议

**qooerp-user（用户上下文）职责：**
- ✅ 用户与角色的关联关系（user_role_relation）
- ✅ 用户主角色

**qooerp-permission（权限管理上下文）职责：**
- ✅ 角色管理（CRUD）
- ✅ 权限管理（菜单、按钮、数据权限）
- ✅ 用户角色分配（管理user_role_relation）
- ✅ 权限验证和缓存
- ✅ 数据权限控制

**协作关系：**
```
分配角色：
qooerp-permission
    ↓ 验证用户和角色
qooerp-user / qooerp-permission
    ↓ 保存user_role_relation
数据库
```

#### 2.4.3 重复功能处理建议

| 重复功能 | 处理建议 | 说明 |
|---------|---------|------|
| 用户角色关联 | **permission服务管理** | permission服务管理角色分配，user只提供数据存储 |

**推荐方案：**
- user_role_relation表在user服务中
- permission服务通过Feign调用user服务管理关联关系
- 或采用事件驱动：permission发布角色分配事件，user订阅并保存

**结论：职责需要明确，建议permission服务统一管理用户角色关联** ✓

---

### 2.5 用户管理 vs 系统管理（qooerp-system）

#### 2.5.1 功能对比

| 功能点 | qooerp-user | qooerp-system | 是否重复 | 结论 |
|--------|-------------|---------------|---------|------|
| **操作日志** | ✅ user_operation_log | ✅ 操作日志记录 | ⚠️ 重复 | 需统一管理 |
| **登录日志** | ✅ user_activity_log（登录） | ❌ | 否 | ✓ user职责 |
| **在线用户** | ❌ | ✅ 在线用户管理 | 否 | ✓ sys职责 |
| **会话管理** | ❌ | ✅ 会话管理、强制下线 | 否 | ✓ sys职责 |
| **审计日志** | ✅ user_activity_log（安全） | ✅ 审计日志 | ⚠️ 部分重叠 | 需协调 |

#### 2.5.2 职责划分建议

**qooerp-user（用户上下文）职责：**
- ✅ 用户活动日志（user_activity_log）
  - 登录、登出
  - 密码修改
  - MFA启用/禁用
- ❌ 不负责操作日志（由system服务统一管理）

**qooerp-system（系统管理上下文）职责：**
- ✅ 操作日志（operation_log）
  - 统一记录所有模块的操作日志
  - 通过AOP切面自动记录
- ✅ 在线用户管理
- ✅ 会话管理
- ✅ 审计日志

**协作关系：**
```
用户登录：
qooerp-auth
    ↓ 登录成功
qooerp-user
    ↓ 记录用户活动日志
数据库
    ↓ 记录操作日志
qooerp-system（AOP切面）
数据库
```

#### 2.5.3 重复功能处理建议

| 重复功能 | 处理建议 | 说明 |
|---------|---------|------|
| 操作日志 | **system服务统一管理** | system服务通过AOP切面统一记录，user服务移除user_operation_log表 |
| 审计日志 | **system服务统一管理** | 审计日志由system服务统一记录 |

**推荐调整：**
- 删除user服务中的user_operation_log表
- 删除user服务中的审计日志相关功能
- 保留user_activity_log（用户活动日志，登录等）

**结论：操作日志应由system服务统一管理，避免重复** ✓

---

### 2.6 用户管理 vs 通知服务（qooerp-notify）

#### 2.6.1 功能对比

| 功能点 | qooerp-user | qooerp-notify | 是否重复 | 结论 |
|--------|-------------|--------------|---------|------|
| **用户通知** | ✅ user_notification | ✅ 通知管理 | ⚠️ 重复 | 需协调 |
| **系统公告** | ❌ | ✅ 系统公告 | 否 | ✓ notify职责 |
| **通知设置** | ✅ user_preference.notification_settings | ❌ | 否 | ✓ user职责 |

#### 2.6.2 职责划分建议

**qooerp-user（用户上下文）职责：**
- ✅ 用户通知偏好设置（user_preference.notification_settings）
  - 接收方式（系统内、邮件、短信、微信等）
  - 通知类型偏好

**qooerp-notify（通知上下文）职责：**
- ✅ 通知管理
  - 通知创建、发送
  - 通知查询
  - 通知状态（已读/未读）
- ✅ 系统公告管理
  - 公告发布、撤回
  - 公告阅读状态
- ✅ 通知渠道
  - 邮件、短信、微信、钉钉等

**协作关系：**
```
发送通知：
qooerp-xxx（业务模块）
    ↓ 发送通知
qooerp-notify
    ↓ 查询用户通知偏好
qooerp-user
    ↓ 返回通知偏好
qooerp-notify
    ↓ 根据偏好选择渠道发送
用户
```

#### 2.6.3 重复功能处理建议

| 重复功能 | 处理建议 | 说明 |
|---------|---------|------|
| 用户通知 | **notify服务统一管理** | notify服务管理通知，user只提供偏好设置 |

**推荐调整：**
- 删除user服务中的user_notification表
- 通知管理由notify服务统一负责
- user服务只保留通知偏好设置

**结论：通知管理应由notify服务统一管理** ✓

---

### 2.7 用户管理 vs 消息服务（qooerp-message）

#### 2.7.1 功能对比

| 功能点 | qooerp-user | qooerp-message | 是否重复 | 结论 |
|--------|-------------|----------------|---------|------|
| **用户消息** | ✅ user_message | ✅ 消息管理 | ⚠️ 重复 | 需协调 |

#### 2.7.2 职责划分建议

**qooerp-user（用户上下文）职责：**
- ❌ 不负责消息管理

**qooerp-message（消息上下文）职责：**
- ✅ 消息管理
  - 消息发送、接收
  - 消息查询
  - 消息状态（已读/未读）

**推荐调整：**
- 删除user服务中的user_message表
- 消息管理由message服务统一负责

**结论：消息管理应由message服务统一管理** ✓

---

## 三、功能重复总结

### 3.1 重复功能清单

| 序号 | 重复功能 | 涉及模块 | 重复程度 | 处理建议 |
|------|---------|---------|---------|---------|
| 1 | 员工基本信息 | user, hr | 严重 | 方案A：完全分离（推荐） |
| 2 | 用户角色关联 | user, permission | 中 | permission服务统一管理 |
| 3 | 操作日志 | user, system | 中 | system服务统一管理 |
| 4 | 审计日志 | user, system | 中 | system服务统一管理 |
| 5 | 用户通知 | user, notify | 中 | notify服务统一管理 |
| 6 | 用户消息 | user, message | 中 | message服务统一管理 |
| 7 | 密码管理 | user, auth | 轻 | 明确职责：user存储，auth验证 |
| 8 | 登录安全 | user, auth | 轻 | 双方协作 |
| 9 | 第三方登录 | user, auth | 轻 | 双方协作 |

### 3.2 职责划分矩阵

| 功能模块 | user | auth | hr | org | permission | system | notify | message |
|---------|------|------|----|-----|------------|--------|--------|---------|
| 用户基本信息 | ✅ | | ⚠️ | | | | | |
| 用户档案 | ✅ | | ⚠️ | | | | | |
| 用户账户 | ✅ | | | | | | | |
| 用户偏好 | ✅ | | | | | | | |
| 用户状态 | ✅ | | | | | | | |
| 密码管理 | ✅ | ⚠️ | | | | | | |
| MFA管理 | ✅ | ⚠️ | | | | | | |
| 登录功能 | | ✅ | | | | | | |
| 令牌管理 | | ✅ | | | | | | |
| 第三方登录 | ⚠️ | ✅ | | | | | | |
| 登录安全 | ⚠️ | ⚠️ | | | | | | |
| 员工档案 | ⚠️ | | ✅ | | | | | |
| 员工生命周期 | | | ✅ | | | | | |
| 考勤管理 | | | ✅ | | | | | |
| 薪资管理 | | | ✅ | | | | | |
| 绩效管理 | | | ✅ | | | | | |
| 组织管理 | | | | ✅ | | | | |
| 岗位管理 | | | | ✅ | | | | |
| 用户组织关联 | ✅ | | | | | | | |
| 用户岗位关联 | ✅ | | | | | | | |
| 角色管理 | | | | | ✅ | | | |
| 权限管理 | | | | | ✅ | | | |
| 用户角色分配 | ⚠️ | | | | ✅ | | | |
| 权限验证 | | | | | ✅ | | | |
| 操作日志 | ⚠️ | | | | | ✅ | | |
| 在线用户 | | | | | | ✅ | | |
| 会话管理 | | | | | | ✅ | | |
| 审计日志 | ⚠️ | | | | | ✅ | | |
| 系统公告 | | | | | | | ✅ | |
| 用户通知 | ⚠️ | | | | | | ✅ | |
| 用户消息 | ⚠️ | | | | | | | ✅ |

**图例：**
- ✅：主负责
- ⚠️：参与/有重叠
- 空白：不负责

---

## 四、优化建议

### 4.1 数据模型优化

#### 4.1.1 建议删除的表

| 表名 | 原因 | 替代方案 |
|------|------|---------|
| user_operation_log | 操作日志应由system服务统一管理 | system.operation_log |
| user_notification | 通知应由notify服务统一管理 | notify.notification |
| user_message | 消息应由message服务统一管理 | message.message |
| user_education | 教育背景应由hr服务管理 | hr.employee_education |
| user_work_experience | 工作经历应由hr服务管理 | hr.employee_work_experience |
| user_skill | 技能信息应由hr服务管理 | hr.employee_skill |

#### 4.1.2 建议保留的表

| 表名 | 保留原因 |
|------|---------|
| user_aggregate | 用户聚合根（核心） |
| user_profile | 用户基本信息（最小化） |
| user_account | 用户账户（密码、MFA） |
| user_preference | 用户偏好（语言、时区、主题） |
| user_organization_relation | 用户组织关联 |
| user_role_relation | 用户角色关联 |
| user_document | 证件信息（通用） |
| user_activity_log | 用户活动日志（登录等） |
| user_login_method | 用户登录方式 |
| user_password_question | 用户安全问题 |
| user_security_log | 用户安全日志 |

### 4.2 功能优化

#### 4.2.1 user模块功能调整

| 删除功能 | 原因 |
|---------|------|
| 教育背景管理 | 移至hr模块 |
| 工作经历管理 | 移至hr模块 |
| 技能管理 | 移至hr模块 |
| 操作日志记录 | 移至system模块 |
| 通知管理 | 移至notify模块 |
| 消息管理 | 移至message模块 |

| 新增功能 | 说明 |
|---------|------|
| 用户类型管理 | INTERNAL/EXTERNAL/SYSTEM |
| 多租户支持 | tenant_id字段 |
| 扩展属性 | extended_attributes（JSON） |

#### 4.2.2 与其他模块的协作接口

**user模块提供的接口：**
```java
// 用户查询接口
public interface UserQueryService {
    UserDTO getUserById(Long userId);
    UserDTO getUserByUsername(String username);
    UserDTO getUserByPhone(String phone);
    List<UserDTO> getUsersByIds(List<Long> userIds);
}

// 用户通知偏好接口
public interface UserPreferenceService {
    NotificationPreferenceDTO getNotificationPreference(Long userId);
}
```

**user模块订阅的事件：**
```java
// 订阅员工创建事件，自动创建用户账号
@EventListener
public void onEmployeeCreated(EmployeeCreatedEvent event) {
    // 自动创建用户账号
}

// 订阅员工离职事件，自动停用用户账号
@EventListener
public void onEmployeeTerminated(EmployeeTerminatedEvent event) {
    // 自动停用用户账号
}
```

### 4.3 架构优化

#### 4.3.1 限界上下文划分

```
┌─────────────────────────────────────────────────────────────┐
│                    系统上下文地图                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────┐  ┌──────────────────┐              │
│  │  用户上下文      │  │  认证上下文      │              │
│  │  (User Context)  │  │  (Auth Context)  │              │
│  │                  │  │                  │              │
│  │  - 用户身份      │  │  - 登录流程      │              │
│  │  - 用户档案      │  │  - 令牌管理      │              │
│  │  - 用户账户      │  │  - 第三方登录    │              │
│  │  - 用户偏好      │  │  - MFA验证       │              │
│  └──────────────────┘  └──────────────────┘              │
│           │                      │                         │
│           │                      │                         │
│  ┌──────────────────┐  ┌──────────────────┐              │
│  │  HR上下文       │  │  权限上下文      │              │
│  │  (HR Context)   │  │(Perm Context)    │              │
│  │                  │  │                  │              │
│  │  - 员工档案      │  │  - 角色管理      │              │
│  │  - 考勤管理      │  │  - 权限管理      │              │
│  │  - 薪资管理      │  │  - 角色分配      │              │
│  │  - 绩效管理      │  │  - 权限验证      │              │
│  └──────────────────┘  └──────────────────┘              │
│           │                      │                         │
│           │                      │                         │
│  ┌──────────────────┐  ┌──────────────────┐              │
│  │ 组织上下文       │  │  系统上下文      │              │
│  │(Org Context)    │  │(System Context)  │              │
│  │                  │  │                  │              │
│  │  - 组织管理      │  │  - 字典管理      │              │
│  │  - 岗位管理      │  │  - 参数配置      │              │
│  │  - 组织架构      │  │  - 操作日志      │              │
│  │                  │  │  - 在线用户      │              │
│  └──────────────────┘  └──────────────────┘              │
│                                   │                         │
│                                   │                         │
│                          ┌──────────────────┐              │
│                          │  通知上下文      │              │
│                          │(Notify Context)  │              │
│                          │                  │              │
│                          │  - 通知管理      │              │
│                          │  - 系统公告      │              │
│                          │  - 通知渠道      │              │
│                          └──────────────────┘              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.3.2 领域事件流

```
用户创建流程：
qooerp-hr（创建员工）
    ↓ 发布员工创建事件
事件总线
    ↓ 订阅
qooerp-user（创建用户账号）
    ↓ 发布用户创建事件
事件总线
    ↓ 订阅
qooerp-auth（配置登录）
qooerp-permission（分配默认角色）
qooerp-notify（发送欢迎通知）
```

---

## 五、实施建议

### 5.1 优先级划分

| 优先级 | 优化项 | 工作量 | 预期收益 |
|--------|--------|--------|---------|
| P0 | 删除user_operation_log表 | 小 | 避免重复，职责清晰 |
| P0 | 删除user_notification表 | 小 | 避免重复，职责清晰 |
| P0 | 删除user_message表 | 小 | 避免重复，职责清晰 |
| P0 | 明确user与hr的职责边界 | 大 | 解决严重重叠 |
| P0 | 明确user与auth的协作关系 | 中 | 明确职责划分 |
| P1 | 删除user_education等hr相关表 | 中 | 避免重复 |
| P1 | 调整user_role_relation的管理方式 | 中 | 统一管理 |
| P2 | 优化通知偏好查询接口 | 小 | 性能优化 |

### 5.2 实施步骤

#### 第一步：数据迁移（1-2周）

1. 备份现有数据
2. 迁移操作日志到system模块
3. 迁移通知到notify模块
4. 迁移消息到message模块
5. 迁移HR相关数据到hr模块

#### 第二步：代码调整（2-3周）

1. 删除user模块中的重复功能代码
2. 调整user模块与hr、auth、permission、system、notify、message的协作关系
3. 实现领域事件机制
4. 更新API接口

#### 第三步：测试验证（1-2周）

1. 单元测试
2. 集成测试
3. 性能测试
4. 回归测试

#### 第四步：上线部署（1周）

1. 灰度发布
2. 监控告警
3. 问题修复
4. 全量发布

### 5.3 风险控制

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 数据丢失 | 高 | 完整备份，分步迁移，可回滚 |
| 功能缺失 | 高 | 充分测试，灰度发布 |
| 性能下降 | 中 | 性能测试，优化查询 |
| 依赖问题 | 中 | 提前验证，制定降级方案 |

---

## 六、总结

### 6.1 主要发现

1. **严重重复**：qooerp-user与qooerp-hr在员工基本信息管理上存在严重重叠
2. **中度重复**：操作日志、审计日志、通知、消息等功能存在重复
3. **轻度重复**：密码管理、登录安全、第三方登录等功能存在轻度重复
4. **职责不清晰**：部分功能的职责划分不够明确，需要调整

### 6.2 核心建议

1. **明确职责边界**：基于DDD限界上下文，明确各模块的职责
2. **删除重复功能**：删除user模块中的重复功能，统一由专业模块管理
3. **优化协作关系**：通过领域事件和API调用优化模块间的协作
4. **数据模型调整**：删除冗余表，保留核心表

### 6.3 预期收益

1. **降低复杂度**：职责清晰，代码更易维护
2. **避免重复**：消除功能重复，减少冗余代码
3. **提升性能**：优化数据模型，减少不必要的数据同步
4. **易于扩展**：清晰的限界上下文，便于功能扩展

---

**文档版本历史**

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 20xx-xx-xx | 初始版本 | QooERP团队 |
