# QooERP System 模块 - 应用设计文档

## 1. 应用概述

### 1.1 应用定位
QooERP System 模块是系统管理核心模块，提供字典管理、配置管理、日志管理、公告管理等系统级基础功能，为整个ERP系统提供配置和基础设施支持。

### 1.2 应用目标
- 提供系统字典数据管理，统一系统枚举值
- 提供系统参数配置管理，支持动态配置
- 提供系统日志管理，包括操作日志、登录日志、审计日志
- 提供系统公告管理，支持公告发布和阅读跟踪
- 提供在线用户管理，支持会话管理和强制下线
- 提供数据导入导出功能，支持Excel格式

## 2. 应用架构

### 2.1 分层架构

```
qooerp-system/
├── qooerp-system-api/              # API接口定义
│   ├── dto/                        # 数据传输对象
│   │   ├── SystemDictDTO.java
│   │   ├── SystemConfigDTO.java
│   │   ├── SystemLogDTO.java
│   │   ├── SystemAnnouncementDTO.java
│   │   └── SystemOnlineUserDTO.java
│   ├── vo/                         # 视图对象
│   │   ├── SystemDictVO.java
│   │   ├── SystemConfigVO.java
│   │   ├── SystemLogVO.java
│   │   └── SystemAnnouncementVO.java
│   └── query/                      # 查询对象
│       ├── SystemDictQuery.java
│       └── SystemLogQuery.java
├── qooerp-system-service/          # 服务实现
│   ├── controller/                 # 控制器层
│   │   ├── SystemDictController.java
│   │   ├── SystemConfigController.java
│   │   ├── SystemLogController.java
│   │   ├── SystemAnnouncementController.java
│   │   ├── SystemOnlineUserController.java
│   │   └── SystemImportExportController.java
│   ├── service/                    # 服务层
│   │   ├── SystemDictService.java
│   │   ├── SystemConfigService.java
│   │   ├── SystemLogService.java
│   │   ├── SystemAnnouncementService.java
│   │   ├── SystemOnlineUserService.java
│   │   └── SystemImportExportService.java
│   ├── mapper/                     # 数据访问层
│   │   ├── SystemDictMapper.java
│   │   ├── SystemDictItemMapper.java
│   │   ├── SystemConfigMapper.java
│   │   ├── SystemLogMapper.java
│   │   ├── SystemAnnouncementMapper.java
│   │   └── SystemOnlineUserMapper.java
│   └── entity/                    # 实体类
│       ├── SystemDict.java
│       ├── SystemDictItem.java
│       ├── SystemConfig.java
│       ├── SystemLog.java
│       ├── SystemAnnouncement.java
│       ├── SystemAnnouncementRead.java
│       ├── SystemOnlineUser.java
│       ├── SystemExportTask.java
│       ├── SystemImportTask.java
│       └── SystemImportError.java
└── qooerp-system-domain/           # 领域服务
    ├── cache/                      # 缓存服务
    │   ├── SystemDictCacheService.java
    │   └── SystemParamCacheService.java
    └── queue/                      # 队列服务
        └── SystemLogQueue.java
```

### 2.2 模块依赖

```
qooerp-system
    └── qooerp-common (公共组件)
```

> 注意：qooerp-system与其他模块（qooerp-auth、qooerp-permission等）是并列的微服务，需要其他服务功能时通过网关或Feign客户端调用，避免直接依赖。

## 3. 核心功能设计

### 3.1 字典管理

#### 功能概述
提供系统字典类型和字典项的增删改查功能，支持多语言字典、分组管理、排序等功能。

#### 字典类型管理

**SystemDict实体**
```java
@Data
@TableName("system_dict")
public class SystemDict extends BaseEntity {
    private Long id;                    // 字典ID
    private String dictCode;            // 字典编码
    private String dictName;            // 字典名称
    private String dictType;            // 字典类型
    private String description;        // 描述
    private Integer sort;               // 排序
    private Boolean isSystem;           // 是否系统字典
}
```

**字典项管理**

**SystemDictItem实体**
```java
@Data
@TableName("system_dict_item")
public class SystemDictItem extends BaseEntity {
    private Long id;                    // 字典项ID
    private Long dictId;                // 所属字典ID
    private String itemValue;           // 字典值
    private String itemLabel;           // 字典标签
    private String itemColor;           // 标签颜色
    private Integer sort;               // 排序
    private Boolean isDefault;          // 是否默认
}
```

#### 字典缓存策略

```java
@Service
public class SystemDictCacheService {
    
    private static final String DICT_CACHE_KEY = "system:dict:";
    private static final String DICT_ITEM_CACHE_KEY = "system:dict:item:";
    
    /**
     * 获取字典类型缓存
     */
    @Cacheable(value = "systemDict", key = "#dictCode")
    public SystemDictVO getDictByCode(String dictCode) {
        return systemDictMapper.selectByCode(dictCode);
    }
    
    /**
     * 获取字典项列表缓存
     */
    @Cacheable(value = "systemDictItems", key = "#dictCode")
    public List<SystemDictItemVO> getDictItemsByCode(String dictCode) {
        return systemDictItemMapper.selectByDictCode(dictCode);
    }
    
    /**
     * 清除字典缓存
     */
    @CacheEvict(value = {"systemDict", "systemDictItems"}, key = "#dictCode")
    public void clearDictCache(String dictCode) {
    }
}
```

### 3.2 参数配置管理

#### 功能概述
提供系统参数的配置管理，支持参数分组、参数类型验证、参数加密等功能。

#### SystemConfig实体

```java
@Data
@TableName("system_config")
public class SystemConfig extends BaseEntity {
    private Long id;                    // 参数ID
    private String configKey;            // 参数键
    private String configValue;         // 参数值
    private String configType;          // 参数类型
    private String configGroup;         // 参数分组
    private String description;        // 描述
    private Boolean isSystem;           // 是否系统参数
    private Boolean isEncrypted;        // 是否加密
}
```

#### 参数类型枚举

```java
public enum ConfigType {
    STRING("string", "字符串"),
    NUMBER("number", "数字"),
    BOOLEAN("boolean", "布尔值"),
    JSON("json", "JSON对象"),
    ARRAY("array", "数组");
    
    private String code;
    private String description;
}
```

#### 参数配置服务

```java
@Service
public class SystemConfigServiceImpl implements SystemConfigService {
    
    @Override
    @Cacheable(value = "systemConfig", key = "#configKey")
    public String getConfigValue(String configKey) {
        SystemConfig config = systemConfigMapper.selectByKey(configKey);
        if (config == null) {
            return null;
        }
        
        // 解密处理
        if (Boolean.TRUE.equals(config.getIsEncrypted())) {
            return CryptoUtils.aesDecrypt(config.getConfigValue(), getEncryptKey());
        }
        
        return config.getConfigValue();
    }
    
    @Override
    @CacheEvict(value = "systemConfig", key = "#configDTO.configKey")
    public void updateConfig(SystemConfigDTO configDTO) {
        SystemConfig config = BeanUtil.copyProperties(configDTO, SystemConfig.class);
        
        // 加密处理
        if (Boolean.TRUE.equals(configDTO.getIsEncrypted())) {
            config.setConfigValue(CryptoUtils.aesEncrypt(configDTO.getConfigValue(), getEncryptKey()));
        }
        
        systemConfigMapper.updateById(config);
    }
}
```

### 3.3 日志管理

#### 功能概述
提供操作日志、登录日志、审计日志的记录、查询、分析功能。

#### SystemLog实体

```java
@Data
@TableName("system_log")
public class SystemLog extends BaseEntity {
    private Long id;                    // 日志ID
    private String logType;             // 日志类型: operation/login/audit
    private String module;              // 模块名
    private String operation;           // 操作名称
    private String description;        // 描述
    private Long userId;                // 用户ID
    private String username;            // 用户名
    private String ip;                  // IP地址
    private String location;            // 地理位置
    private String userAgent;           // 用户代理
    private String requestMethod;       // 请求方法
    private String requestUrl;          // 请求URL
    private String requestParams;       // 请求参数
    private Long costTime;              // 耗时(毫秒)
    private Integer status;             // 状态: 1-成功 0-失败
    private String errorMessage;        // 错误信息
}
```

#### 日志服务

```java
@Service
public class SystemLogServiceImpl implements SystemLogService {
    
    @Override
    public void saveLog(SystemLogDTO logDTO) {
        SystemLog log = BeanUtil.copyProperties(logDTO, SystemLog.class);
        log.setUserId(SecurityUtils.getUserId());
        log.setUsername(SecurityUtils.getUsername());
        
        // 获取IP地址
        HttpServletRequest request = ServletUtils.getRequest();
        log.setIp(IpUtils.getIpAddr(request));
        log.setLocation(IpUtils.getLocation(log.getIp()));
        log.setUserAgent(request.getHeader("User-Agent"));
        
        systemLogMapper.insert(log);
    }
    
    @Override
    @Async
    public void saveLogAsync(SystemLogDTO logDTO) {
        saveLog(logDTO);
    }
}
```

### 3.4 系统公告管理

#### 功能概述
提供系统公告的发布、撤回、阅读状态跟踪等功能。

#### SystemAnnouncement实体

```java
@Data
@TableName("system_announcement")
public class SystemAnnouncement extends BaseEntity {
    private Long id;                    // 公告ID
    private String title;               // 公告标题
    private String content;             // 公告内容
    private Integer type;               // 类型: 1-紧急 2-重要 3-普通
    private Integer status;             // 状态: 0-草稿 1-已发布 2-已撤回
    private String targetScope;         // 目标范围: all/department/role
    private String targetIds;           // 目标IDs(JSON数组)
    private Date publishTime;           // 发布时间
    private String publisher;           // 发布人
}
```

#### SystemAnnouncementRead实体

```java
@Data
@TableName("system_announcement_read")
public class SystemAnnouncementRead extends BaseEntity {
    private Long id;                    // ID
    private Long announcementId;        // 公告ID
    private Long userId;                // 用户ID
    private String username;            // 用户名
    private Date readTime;              // 阅读时间
}
```

#### 公告服务

```java
@Service
public class SystemAnnouncementServiceImpl implements SystemAnnouncementService {
    
    @Autowired
    private SystemAnnouncementMapper announcementMapper;
    
    @Autowired
    private SystemAnnouncementReadMapper announcementReadMapper;
    
    /**
     * 发布公告
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void publishAnnouncement(Long announcementId) {
        SystemAnnouncement announcement = announcementMapper.selectById(announcementId);
        
        if (announcement == null) {
            throw new BusinessException("公告不存在");
        }
        
        if (announcement.getStatus() == 1) {
            throw new BusinessException("公告已发布");
        }
        
        announcement.setStatus(1);
        announcement.setPublishTime(new Date());
        announcement.setPublisher(SecurityUtils.getUsername());
        announcementMapper.updateById(announcement);
        
        // 发送通知
        sendAnnouncementNotification(announcement);
    }
    
    /**
     * 标记公告已读
     */
    @Override
    public void markAsRead(Long announcementId) {
        Long userId = SecurityUtils.getUserId();
        
        SystemAnnouncementRead readRecord = new SystemAnnouncementRead();
        readRecord.setAnnouncementId(announcementId);
        readRecord.setUserId(userId);
        readRecord.setUsername(SecurityUtils.getUsername());
        readRecord.setReadTime(new Date());
        
        announcementReadMapper.insert(readRecord);
    }
    
    /**
     * 查询公告阅读状态
     */
    @Override
    public List<Long> getReadAnnouncementIds(Long userId) {
        return announcementReadMapper.selectList(
            new LambdaQueryWrapper<SystemAnnouncementRead>()
                .eq(SystemAnnouncementRead::getUserId, userId)
        ).stream()
         .map(SystemAnnouncementRead::getAnnouncementId)
         .collect(Collectors.toList());
    }
}
```

### 3.5 在线用户管理

#### 功能概述
提供在线用户会话管理，支持查询在线用户、强制下线等功能。

#### SystemOnlineUser实体

```java
@Data
@TableName("system_online_user")
public class SystemOnlineUser extends BaseEntity {
    private Long id;                    // ID
    private Long userId;                // 用户ID
    private String username;            // 用户名
    private String sessionId;           // 会话ID
    private String ip;                  // IP地址
    private String location;            // 地理位置
    private String userAgent;           // 用户代理
    private Date loginTime;             // 登录时间
    private Date lastAccessTime;        // 最后访问时间
}
```

#### 在线用户服务

```java
@Service
public class SystemOnlineUserServiceImpl implements SystemOnlineUserService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String ONLINE_USER_KEY = "system:online:user:";
    private static final long SESSION_TIMEOUT = 1800; // 30分钟
    
    /**
     * 记录用户会话
     */
    @Override
    public void recordSession(Long userId, String username, String sessionId, 
                             String ip, String location) {
        String key = ONLINE_USER_KEY + userId;
        
        SystemOnlineUser onlineUser = new SystemOnlineUser();
        onlineUser.setUserId(userId);
        onlineUser.setUsername(username);
        onlineUser.setSessionId(sessionId);
        onlineUser.setIp(ip);
        onlineUser.setLocation(location);
        onlineUser.setLoginTime(new Date());
        onlineUser.setLastAccessTime(new Date());
        
        redisTemplate.opsForValue().set(key, onlineUser, SESSION_TIMEOUT, TimeUnit.SECONDS);
    }
    
    /**
     * 强制下线
     */
    @Override
    public void forceLogout(Long userId) {
        String key = ONLINE_USER_KEY + userId;
        redisTemplate.delete(key);
        
        // 通知认证模块销毁会话
        authApi.invalidateSession(userId);
    }
    
    /**
     * 查询在线用户列表
     */
    @Override
    public List<SystemOnlineUser> listOnlineUsers() {
        Set<String> keys = redisTemplate.keys(ONLINE_USER_KEY + "*");
        if (keys == null || keys.isEmpty()) {
            return new ArrayList<>();
        }
        
        return keys.stream()
            .map(key -> (SystemOnlineUser) redisTemplate.opsForValue().get(key))
            .filter(Objects::nonNull)
            .collect(Collectors.toList());
    }
}
```

### 3.6 数据导入导出

#### 功能概述
提供数据导入导出功能，支持Excel格式，支持模板管理和错误记录。

#### SystemExportTask实体

```java
@Data
@TableName("system_export_task")
public class SystemExportTask extends BaseEntity {
    private Long id;                    // 任务ID
    private String taskName;            // 任务名称
    private String module;              // 模块名
    private String queryCondition;      // 查询条件(JSON)
    private Integer status;             // 状态: 0-进行中 1-完成 2-失败
    private Long totalCount;            // 总记录数
    private Long exportedCount;         // 已导出数
    private String fileId;              // 文件ID
    private String errorMessage;        // 错误信息
    private Long userId;                // 用户ID
}
```

#### SystemImportTask实体

```java
@Data
@TableName("system_import_task")
public class SystemImportTask extends BaseEntity {
    private Long id;                    // 任务ID
    private String taskName;            // 任务名称
    private String module;              // 模块名
    private Long templateId;            // 模板ID
    private String fileId;              // 文件ID
    private Integer status;             // 状态: 0-待验证 1-验证中 2-验证失败 3-待导入 4-导入中 5-导入完成 6-导入失败
    private Long totalCount;            // 总记录数
    private Long successCount;          // 成功数
    private Long failCount;              // 失败数
    private String errorMessage;        // 错误信息
    private Long userId;                // 用户ID
}
```

#### 导入导出服务

```java
@Service
public class SystemImportExportServiceImpl implements SystemImportExportService {
    
    @Autowired
    private FileService fileService;
    
    /**
     * 执行数据导入
     */
    @Override
    public ImportResultDTO importData(ImportTaskDTO importTask) {
        // 1. 下载导入文件
        InputStream inputStream = fileService.downloadFile(importTask.getFileId());
        
        // 2. 解析Excel
        List<Map<Integer, String>> dataList = EasyExcel.read(inputStream)
            .sheet()
            .doReadSync();
        
        // 3. 数据验证
        ValidationResult validationResult = validateData(importTask.getTemplateId(), dataList);
        if (!validationResult.isValid()) {
            return ImportResultDTO.failure(validationResult.getErrors());
        }
        
        // 4. 执行导入
        ImportResultDTO result = executeImport(importTask, validationResult.getValidData());
        
        // 5. 记录导入日志
        saveImportLog(importTask, result);
        
        return result;
    }
    
    /**
     * 执行数据导出
     */
    @Override
    public ExportResultDTO exportData(ExportTaskDTO exportTask) {
        // 1. 查询数据
        List<?> dataList = queryData(exportTask);
        
        // 2. 创建临时文件
        String tempFileName = UUID.randomUUID() + ".xlsx";
        File tempFile = new File(System.getProperty("java.io.tmpdir"), tempFileName);
        
        // 3. 写入Excel
        try (ExcelWriter excelWriter = EasyExcel.write(tempFile).build()) {
            WriteSheet writeSheet = EasyExcel.writerSheet("Sheet1")
                .head(exportTask.getTemplateId())
                .build();
            
            excelWriter.write(dataList, writeSheet);
        }
        
        // 4. 上传文件到文件服务
        FileUploadDTO uploadDTO = new FileUploadDTO();
        uploadDTO.setFile(new FileInputStream(tempFile));
        uploadDTO.setFileName(exportTask.getFileName());
        uploadDTO.setModule("export");
        
        String fileId = fileService.uploadFile(uploadDTO);
        
        // 5. 记录导出任务
        saveExportTask(exportTask, fileId, dataList.size());
        
        // 6. 删除临时文件
        tempFile.delete();
        
        return ExportResultDTO.success(fileId);
    }
}
```

## 4. 接口设计

### 4.1 字典管理接口

```
POST   /api/system/dict                    # 创建字典类型
GET    /api/system/dict/{id}               # 获取字典类型
PUT    /api/system/dict/{id}               # 更新字典类型
DELETE /api/system/dict/{id}               # 删除字典类型
GET    /api/system/dict/list               # 分页查询字典类型
GET    /api/system/dict/code/{code}        # 根据编码获取字典类型

POST   /api/system/dict-item               # 创建字典项
GET    /api/system/dict-item/{id}          # 获取字典项
PUT    /api/system/dict-item/{id}          # 更新字典项
DELETE /api/system/dict-item/{id}          # 删除字典项
GET    /api/system/dict-item/list          # 分页查询字典项
GET    /api/system/dict-item/dict/{dictId} # 根据字典ID获取字典项
```

### 4.2 参数配置接口

```
POST   /api/system/config                  # 创建参数
GET    /api/system/config/{id}             # 获取参数
PUT    /api/system/config/{id}             # 更新参数
DELETE /api/system/config/{id}             # 删除参数
GET    /api/system/config/list             # 分页查询参数
GET    /api/system/config/key/{key}        # 根据键获取参数值
POST   /api/system/config/batch            # 批量更新参数
POST   /api/system/config/refresh          # 刷新参数缓存
```

### 4.3 日志管理接口

```
GET    /api/system/log/{id}                # 获取日志
GET    /api/system/log/list                # 分页查询日志
GET    /api/system/log/statistics          # 日志统计
DELETE /api/system/log/{id}                # 删除日志
DELETE /api/system/log/batch               # 批量删除日志
POST   /api/system/log/export              # 导出日志
```

### 4.4 系统公告接口

```
POST   /api/system/announcement            # 创建公告
GET    /api/system/announcement/{id}       # 获取公告
PUT    /api/system/announcement/{id}       # 更新公告
DELETE /api/system/announcement/{id}       # 删除公告
GET    /api/system/announcement/list       # 分页查询公告
POST   /api/system/announcement/{id}/publish   # 发布公告
POST   /api/system/announcement/{id}/revoke    # 撤回公告
POST   /api/system/announcement/{id}/read       # 标记已读
GET    /api/system/announcement/read-ids       # 获取已读公告ID列表
```

### 4.5 在线用户接口

```
GET    /api/system/online-user/list        # 查询在线用户列表
GET    /api/system/online-user/{id}         # 获取在线用户详情
POST   /api/system/online-user/{id}/force-logout  # 强制下线
POST   /api/system/online-user/batch-force-logout # 批量强制下线
GET    /api/system/online-user/statistics  # 在线用户统计
```

### 4.6 数据导入导出接口

```
# 导出相关
POST   /api/system/export/task             # 创建导出任务
GET    /api/system/export/task/{id}       # 获取导出任务
GET    /api/system/export/task/list       # 查询导出任务列表
GET    /api/system/export/task/{id}/download  # 下载导出文件
GET    /api/system/export/template/list   # 查询导出模板列表

# 导入相关
POST   /api/system/import/task             # 创建导入任务
GET    /api/system/import/task/{id}       # 获取导入任务
GET    /api/system/import/task/list       # 查询导入任务列表
POST   /api/system/import/task/{id}/validate    # 验证导入数据
POST   /api/system/import/task/{id}/execute     # 执行导入
GET    /api/system/import/task/{id}/errors      # 获取导入错误记录
GET    /api/system/import/template/download     # 下载导入模板
```

## 5. 部署说明

### 5.1 配置文件

```yaml
server:
  port: 8084

spring:
  application:
    name: qooerp-system
  
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 50MB

logging:
  file:
    name: /data/qooerp/logs/system.log
```

### 5.2 目录结构

```
/data/qooerp/
└── logs/              # 日志目录
    ├── system.log     # 系统日志
    └── backup/        # 备份目录
```

## 6. 版本历史

|| 版本 | 日期 | 变更内容 | 作者 ||
||------|------|----------|------||
|| 1.0.0 | 2025-01-17 | 初始版本 | Auto ||
|| 1.1.0 | 2026-02-18 | 移除文件管理和定时任务功能，新增系统公告、在线用户、导入导出功能 | Auto ||
|| 1.2.0 | 2026-02-18 | 更新模块依赖关系，明确与其他模块为并列微服务，通过微服务调用方式交互 | Auto ||
