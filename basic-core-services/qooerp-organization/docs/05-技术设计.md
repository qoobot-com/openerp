# QooERP Organization 模块 - 技术设计文档

> **数据库**: PostgreSQL 15+

## 1. 技术选型

### 1.1 核心技术栈

| 技术组件 | 版本 | 用途 |
|---------|------|------|
| Spring Boot | 3.x | 应用框架 |
| MyBatis-Plus | 3.5.x | ORM框架 |
| PostgreSQL | 15+ | 关系型数据库 |
| Redis | 7.x | 缓存数据库 |
| Nacos | 2.x | 配置中心和服务发现 |

### 1.2 依赖模块

```xml
<dependencies>
    <!-- 公共模块 -->
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-common-api</artifactId>
    </dependency>
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-common-core</artifactId>
    </dependency>
    
    <!-- 认证模块 -->
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-auth-api</artifactId>
    </dependency>
    
    <!-- 权限模块 -->
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-permission-api</artifactId>
    </dependency>
    
    <!-- 数据库 -->
    <dependency>
        <groupId>org.postgresql</groupId>
        <artifactId>postgresql</artifactId>
    </dependency>
    
    <!-- 缓存 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    
    <!-- 注册中心和配置中心 -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    </dependency>
</dependencies>
```

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                   客户端层 (Web/Mobile)                   │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│                    API Gateway                            │
│              (路由、认证、限流)                            │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│             Organization Service                        │
│  ┌────────────────────────────────────────────────────┐  │
│  │              Controller 层                         │  │
│  │  - OrganizationCompanyController                    │  │
│  │  - OrganizationDepartmentController                 │  │
│  │  - OrganizationPositionController                  │  │
│  └──────────────────────┬─────────────────────────────┘  │
│  ┌──────────────────────▼─────────────────────────────┐  │
│  │              Service 层                             │  │
│  │  - OrganizationCompanyService                      │  │
│  │  - OrganizationDepartmentService                   │  │
│  │  - OrganizationPositionService                     │  │
│  │  - OrganizationTreeService                          │  │
│  └──────────────────────┬─────────────────────────────┘  │
│  ┌──────────────────────▼─────────────────────────────┐  │
│  │              Mapper 层                              │  │
│  │  - OrganizationCompanyMapper                       │  │
│  │  - OrganizationDepartmentMapper                    │  │
│  │  - OrganizationPositionMapper                      │  │
│  └──────────────────────┬─────────────────────────────┘  │
│  ┌──────────────────────▼─────────────────────────────┐  │
│  │              数据访问层                             │  │
│  │  - MyBatis-Plus                                     │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
┌───────▼──────┐ ┌────▼─────┐ ┌────▼─────┐
│  PostgreSQL  │ │  Redis   │ │  Nacos   │
│   (持久化)   │ │  (缓存)  │ │(配置中心) │
└──────────────┘ └──────────┘ └──────────┘
```

## 3. 核心功能实现

### 3.1 树形结构构建

#### 递归构建树

```java
@Service
public class OrganizationTreeService {
    
    /**
     * 递归构建树形结构
     */
    public <T extends OrganizationTreeBase> List<T> buildTree(List<T> nodes, Long parentId) {
        return nodes.stream()
            .filter(node -> {
                if (parentId == null) {
                    return node.getParentId() == null | node.getParentId() == 0;
                }
                return parentId.equals(node.getParentId());
            })
            .map(node -> {
                List<T> children = buildTree(nodes, node.getId());
                node.setChildren(children);
                node.setHasChildren(!children.isEmpty());
                return node;
            })
            .sorted(Comparator.comparing(OrganizationTreeBase::getSort))
            .collect(Collectors.toList());
    }
}
```

### 3.2 组织层级管理

#### 层级自动计算

```java
@Component
public class OrganizationLevelCalculator {
    
    /**
     * 计算公司级别
     */
    public Integer calculateCompanyLevel(Long companyId, Long parentId) {
        if (parentId == null | parentId == 0) {
            return 1;
        }
        
        OrganizationCompany parent = companyMapper.selectById(parentId);
        if (parent == null) {
            throw new BusinessException("父公司不存在");
        }
        
        if (parent.getCompanyLevel() >= 10) {
            throw new BusinessException("公司层级不能超过10级");
        }
        
        return parent.getCompanyLevel() + 1;
    }
    
    /**
     * 计算部门级别
     */
    public Integer calculateDeptLevel(Long deptId, Long parentId) {
        if (parentId == null | parentId == 0) {
            return 1;
        }
        
        OrganizationDepartment parent = departmentMapper.selectById(parentId);
        if (parent == null) {
            throw new BusinessException("父部门不存在");
        }
        
        if (parent.getDeptLevel() >= 20) {
            throw new BusinessException("部门层级不能超过20级");
        }
        
        return parent.getDeptLevel() + 1;
    }
}
```

### 3.3 部门移动功能

#### 移动部门实现

```java
@Service
public class OrganizationDepartmentServiceImpl implements OrganizationDepartmentService {
    
    @Autowired
    private OrganizationLevelCalculator levelCalculator;
    
    /**
     * 移动部门
     */
    @Override
    @Transactional
    public void moveDepartment(Long deptId, Long newParentId) {
        // 获取当前部门
        OrganizationDepartment department = departmentMapper.selectById(deptId);
        if (department == null) {
            throw new DataNotFoundException("部门不存在");
        }
        
        // 获取原父部门ID
        Long oldParentId = department.getParentId();
        
        // 检查是否移动到自己的子部门下
        if (newParentId != null && newParentId > 0) {
            List<Long> childIds = getAllChildDepartmentIds(deptId);
            if (childIds.contains(newParentId)) {
                throw new BusinessException("不能将部门移动到其子部门下");
            }
        }
        
        // 更新父部门
        department.setParentId(newParentId);
        department.setDeptLevel(levelCalculator.calculateDeptLevel(deptId, newParentId));
        departmentMapper.updateById(department);
        
        // 更新子部门级别
        updateChildrenDeptLevel(deptId, department.getDeptLevel());
        
        // 更新父部门员工数
        if (oldParentId != null && oldParentId > 0) {
            updateDepartmentEmployeeCount(oldParentId, -department.getEmployeeCount());
        }
        
        if (newParentId != null && newParentId > 0) {
            updateDepartmentEmployeeCount(newParentId, department.getEmployeeCount());
        }
    }
    
    /**
     * 递归更新子部门级别
     */
    private void updateChildrenDeptLevel(Long parentId, Integer parentLevel) {
        List<OrganizationDepartment> children = departmentMapper.selectList(
            new LambdaQueryWrapper<OrganizationDepartment>()
                .eq(OrganizationDepartment::getParentId, parentId)
        );
        
        for (OrganizationDepartment child : children) {
            Integer newLevel = parentLevel + 1;
            child.setDeptLevel(newLevel);
            departmentMapper.updateById(child);
            
            // 递归更新子部门
            updateChildrenDeptLevel(child.getId(), newLevel);
        }
    }
}
```

### 3.4 员工数量统计

#### 实时统计员工数量

```java
@Service
public class EmployeeCountService {
    
    /**
     * 更新部门员工数量
     */
    @Async
    public void updateDepartmentEmployeeCount(Long deptId, Integer delta) {
        if (deptId == null | deptId == 0) {
            return;
        }
        
        OrganizationDepartment dept = departmentMapper.selectById(deptId);
        if (dept != null) {
            Integer newCount = dept.getEmployeeCount() + delta;
            dept.setEmployeeCount(Math.max(0, newCount));
            departmentMapper.updateById(dept);
            
            // 递归更新父部门
            updateDepartmentEmployeeCount(dept.getParentId(), delta);
        }
    }
    
    /**
     * 重新计算部门员工数量
     */
    @Transactional
    public void recalculateDepartmentEmployeeCount(Long deptId) {
        OrganizationDepartment dept = departmentMapper.selectById(deptId);
        if (dept == null) {
            return;
        }
        
        // 统计直接归属的员工数量
        Integer directCount = userMapper.selectCount(
            new LambdaQueryWrapper<User>()
                .eq(User::getDeptId, deptId)
        );
        
        // 统计子部门的员工数量
        List<Long> childDeptIds = getAllChildDepartmentIds(deptId);
        Integer childrenCount = userMapper.selectCount(
            new LambdaQueryWrapper<User>()
                .in(User::getDeptId, childDeptIds)
        );
        
        // 更新总数量
        dept.setEmployeeCount(directCount + childrenCount);
        departmentMapper.updateById(dept);
    }
}
```

## 4. 缓存设计

### 4.1 缓存策略

| 数据类型 | 缓存Key | 过期时间 | 更新策略 |
|---------|---------|----------|----------|
| 公司信息 | organization:company:{id} | 30分钟 | 公司变更时清除 |
| 部门信息 | organization:dept:{id} | 30分钟 | 部门变更时清除 |
| 职位信息 | organization:position:{id} | 30分钟 | 职位变更时清除 |
| 部门树 | organization:dept:tree:{companyId} | 1小时 | 部门结构变更时清除 |
| 组织树 | organization:tree:{companyId} | 1小时 | 组织结构变更时清除 |

### 4.2 缓存实现

```java
@Service
public class OrganizationCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String COMPANY_CACHE_KEY = "organization:company:";
    private static final String DEPT_CACHE_KEY = "organization:dept:";
    private static final String DEPT_TREE_CACHE_KEY = "organization:dept:tree:";
    
    /**
     * 获取公司缓存
     */
    @Cacheable(value = "organizationCompany", key = "#companyId")
    public OrganizationCompanyVO getCompany(Long companyId) {
        return companyMapper.selectById(companyId);
    }
    
    /**
     * 清除公司缓存
     */
    @CacheEvict(value = "organizationCompany", key = "#companyId")
    public void clearCompanyCache(Long companyId) {
    }
    
    /**
     * 获取部门缓存
     */
    @Cacheable(value = "organizationDept", key = "#deptId")
    public OrganizationDepartmentVO getDepartment(Long deptId) {
        return departmentMapper.selectById(deptId);
    }
    
    /**
     * 清除部门缓存
     */
    @CacheEvict(value = "organizationDept", key = "#deptId")
    public void clearDeptCache(Long deptId) {
        // 清除部门树缓存
        OrganizationDepartment dept = departmentMapper.selectById(deptId);
        if (dept != null) {
            redisTemplate.delete(DEPT_TREE_CACHE_KEY + dept.getCompanyId());
        }
    }
    
    /**
     * 获取部门树缓存
     */
    @Cacheable(value = "organizationDeptTree", key = "#companyId")
    public List<OrganizationTreeVO> getDeptTree(Long companyId) {
        List<OrganizationDepartment> allDepts = departmentMapper.selectList(
            new LambdaQueryWrapper<OrganizationDepartment>()
                .eq(OrganizationDepartment::getCompanyId, companyId)
        );
        return buildTree(allDepts, null);
    }
}
```

## 5. 性能优化

### 5.1 数据库优化

#### 索引设计

```sql
-- organization_company表索引
CREATE INDEX idx_company_code ON organization_company(company_code);
CREATE INDEX idx_company_parent_id ON organization_company(parent_id);

-- organization_department表索引
CREATE INDEX idx_dept_company_id ON organization_department(company_id);
CREATE INDEX idx_dept_code ON organization_department(dept_code);
CREATE INDEX idx_dept_parent_id ON organization_department(parent_id);
CREATE INDEX idx_dept_leader_id ON organization_department(leader_id);

-- organization_position表索引
CREATE INDEX idx_position_company_id ON organization_position(company_id);
CREATE INDEX idx_position_dept_id ON organization_position(dept_id);
CREATE INDEX idx_position_code ON organization_position(position_code);
```

#### 部门树查询优化

```xml
<!-- 使用递归CTE查询部门树 -->
<select id="selectDepartmentTree" resultType="OrganizationDepartment">
    WITH RECURSIVE dept_tree AS (
        -- 查询根部门
        SELECT * FROM organization_department
        WHERE company_id = #{companyId}
          AND (parent_id IS NULL OR parent_id = 0)
        
        UNION ALL
        
        -- 递归查询子部门
        SELECT d.* FROM organization_department d
        INNER JOIN dept_tree dt ON d.parent_id = dt.id
        WHERE d.company_id = #{companyId}
    )
    SELECT * FROM dept_tree
    ORDER BY sort
</select>
```

### 5.2 树形结构优化

#### 使用闭包表优化树查询

```sql
-- 创建部门闭包表
CREATE TABLE organization_department_closure (
    ancestor BIGINT NOT NULL,      -- 祖先部门ID
    descendant BIGINT NOT NULL,    -- 后代部门ID
    depth INTEGER NOT NULL,        -- 深度
    PRIMARY KEY (ancestor, descendant)
);

-- 创建索引
CREATE INDEX idx_closure_ancestor ON organization_department_closure(ancestor);
CREATE INDEX idx_closure_descendant ON organization_department_closure(descendant);
```

## 6. 安全设计

### 6.1 数据权限

#### 部门数据权限

```java
@Aspect
@Component
public class DeptDataScopeAspect {
    
    @Autowired
    private OrganizationService organizationService;
    
    @Around("@annotation(dataScope)")
    public Object around(ProceedingJoinPoint point, DataScope dataScope) throws Throwable {
        // 获取当前用户
        User currentUser = SecurityUtils.getCurrentUser();
        if (currentUser == null) {
            return point.proceed();
        }
        
        // 获取用户数据权限范围
        DataScopeInfo dataScopeInfo = getUserDataScope(currentUser.getId());
        
        if (dataScopeInfo != null) {
            // 注入数据权限条件
            Object parameter = point.getArgs()[0];
            if (parameter instanceof Map) {
                Map<?, ?> map = (Map<?, ?>) parameter;
                map.put("dataScope", dataScopeInfo);
            }
        }
        
        return point.proceed();
    }
    
    /**
     * 获取用户数据权限
     */
    private DataScopeInfo getUserDataScope(Long userId) {
        // 查询用户所属部门
        User user = userMapper.selectById(userId);
        if (user == null | user.getDeptId() == null) {
            return null;
        }
        
        // 查询用户数据权限类型
        String dataScopeType = getDataScopeType(userId);
        
        DataScopeInfo info = new DataScopeInfo();
        info.setUserId(userId);
        info.setDeptId(user.getDeptId());
        info.setDataScopeType(dataScopeType);
        
        switch (dataScopeType) {
            case "all":
                info.setSqlCondition("1=1");
                break;
            case "custom":
                List<Long> deptIds = getCustomDeptIds(userId);
                info.setDeptIds(deptIds);
                info.setSqlCondition("dept_id IN (" + String.join(",", deptIds.stream()
                    .map(String::valueOf).collect(Collectors.toList())) + ")");
                break;
            case "dept":
                info.setSqlCondition("dept_id = " + user.getDeptId());
                break;
            case "dept_and_child":
                List<Long> allChildIds = organizationService.getAllChildDepartmentIds(user.getDeptId());
                allChildIds.add(user.getDeptId());
                info.setDeptIds(allChildIds);
                info.setSqlCondition("dept_id IN (" + String.join(",", allChildIds.stream()
                    .map(String::valueOf).collect(Collectors.toList())) + ")");
                break;
            case "self":
                info.setSqlCondition("id = " + userId);
                break;
            default:
                info.setSqlCondition("1=0");
        }
        
        return info;
    }
}
```

### 6.2 并发控制

#### 部门移动并发控制

```java
@Service
public class OrganizationDepartmentServiceImpl implements OrganizationDepartmentService {
    
    /**
     * 移动部门（带并发控制）
     */
    @Override
    @Transactional
    public void moveDepartmentWithLock(Long deptId, Long newParentId) {
        // 使用分布式锁
        String lockKey = "organization:dept:move:" + deptId;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // 尝试获取锁，最多等待5秒，锁超时30秒
            boolean locked = lock.tryLock(5, 30, TimeUnit.SECONDS);
            if (!locked) {
                throw new BusinessException("系统繁忙，请稍后重试");
            }
            
            try {
                // 执行移动逻辑
                moveDepartment(deptId, newParentId);
            } finally {
                lock.unlock();
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new BusinessException("操作被中断");
        }
    }
}
```

## 7. 部署配置

### 7.1 application.yml

```yaml
server:
  port: 8085

spring:
  application:
    name: qooerp-organization
  
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/qooerp
    username: postgres
    password: postgres
  
  redis:
    host: localhost
    port: 6379
    database: 4
    password:
  
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: qooerp
      config:
        server-addr: localhost:8848
        namespace: qooerp
        file-extension: yml

mybatis-plus:
  mapper-locations: classpath*:mapper/**/*.xml
  type-aliases-package: com.qoobot.qooerp.organization.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl

# 组织架构配置
organization:
  max-company-level: 10      # 最大公司层级
  max-dept-level: 20         # 最大部门层级
  enable-dept-cache: true    # 启用部门缓存

logging:
  level:
    com.qoobot.qooerp.organization: debug
```

### 7.2 环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| SERVER_PORT | 服务端口 | 8085 |
| DB_URL | 数据库URL | - |
| DB_USERNAME | 数据库用户名 | - |
| DB_PASSWORD | 数据库密码 | - |
| REDIS_HOST | Redis主机 | localhost |
| REDIS_PORT | Redis端口 | 6379 |
| NACOS_ADDR | Nacos地址 | localhost:8848 |

## 8. 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2025-01-17 | 初始版本 | Auto |
