# QooERP Common 模块 - 应用设计文档

## 1. 应用概述

### 1.1 应用定位
QooERP Common 模块是整个系统的公共基础模块，提供所有微服务共用的基础设施、工具类、公共组件和通用功能。作为系统的底层支撑模块，为上层业务模块提供统一的技术能力。

### 1.2 应用目标
- 提供统一的响应体结构和异常处理机制
- 封装通用的工具类和辅助方法
- 提供全局配置和常量定义
- 实现跨模块的公共组件和功能
- 统一系统的编码规范和开发模式
- 提供OpenFeign微服务调用能力，支持服务间通信

## 2. 应用架构

### 2.1 分层架构
```
qooerp-common/
├── qooerp-common-api/              # 公共API接口定义
│   ├── dto/                        # 数据传输对象
│   ├── vo/                         # 视图对象
│   ├── enums/                      # 枚举定义
│   ├── constants/                  # 常量定义
│   └── exception/                  # 异常定义
├── qooerp-common-core/             # 核心工具类
│   ├── util/                       # 工具类
│   ├── helper/                     # 辅助类
│   ├── converter/                  # 转换器
│   └── validator/                  # 验证器
├── qooerp-common-security/         # 安全组件
│   ├── annotation/                 # 安全注解
│   ├── handler/                    # 安全处理器
│   └── filter/                     # 安全过滤器
├── qooerp-common-web/              # Web组件
│   ├── interceptor/                # 拦截器
│   ├── aspect/                     # 切面
│   └── resolver/                   # 参数解析器
└── qooerp-common-database/         # 数据库组件
    ├── interceptor/                # MyBatis拦截器
    ├── handler/                    # 数据库处理器
    └── converter/                  # 类型转换器
```

### 2.2 模块依赖关系
```
业务模块 (auth, permission, system等)
    ↓
qooerp-common-web (Web组件)
    ↓
qooerp-common-security (安全组件)
    ↓
qooerp-common-database (数据库组件)
    ↓
qooerp-common-core (核心工具)
    ↓
qooerp-common-api (公共接口)
```

## 3. 核心组件设计

### 3.1 统一响应体
提供统一的API响应格式，确保所有接口返回结构一致。

**Response<T>**
```java
public class Response<T> {
    private Integer code;        // 响应码
    private String message;      // 响应消息
    private T data;             // 响应数据
    private Long timestamp;     // 时间戳
    
    // 成功响应
    public static <T> Response<T> success(T data);
    public static <T> Response<T> success(String message, T data);
    
    // 失败响应
    public static <T> Response<T> error(String message);
    public static <T> Response<T> error(Integer code, String message);
    
    // 分页响应
    public static <T> PageResponse<T> page(Page<T> page);
}
```

**分页响应体**
```java
public class PageResponse<T> {
    private Integer code;
    private String message;
    private List<T> records;      // 数据列表
    private Long total;           // 总记录数
    private Long current;         // 当前页
    private Long size;           // 每页大小
    private Long pages;          // 总页数
}
```

### 3.2 全局异常处理
统一处理应用中的各类异常，提供友好的错误信息。

**异常层级结构**
```
BaseException (基础异常)
├── BusinessException (业务异常)
├── ValidationException (参数校验异常)
├── PermissionException (权限异常)
├── DataNotFoundException (数据不存在异常)
└── SystemException (系统异常)
```

**全局异常处理器**
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Response<?> handleBusinessException(BusinessException e);
    
    @ExceptionHandler(ValidationException.class)
    public Response<?> handleValidationException(ValidationException e);
    
    @ExceptionHandler(PermissionException.class)
    public Response<?> handlePermissionException(PermissionException e);
    
    @ExceptionHandler(Exception.class)
    public Response<?> handleException(Exception e);
}
```

### 3.3 常用工具类

**日期时间工具**
```java
public class DateTimeUtils {
    // 日期格式化
    public static String format(Date date, String pattern);
    public static Date parse(String dateStr, String pattern);
    
    // 日期计算
    public static Date addDays(Date date, int days);
    public static Date addMonths(Date date, int months);
    public static Date addYears(Date date, int years);
    
    // 日期比较
    public static boolean isSameDay(Date date1, Date date2);
    public static long betweenDays(Date start, Date end);
}
```

**字符串工具**
```java
public class StringUtils {
    // 判断工具
    public static boolean isEmpty(String str);
    public static boolean isNotEmpty(String str);
    public static boolean isBlank(String str);
    public static boolean isNotBlank(String str);
    
    // 转换工具
    public static String toCamelCase(String str);
    public static String toSnakeCase(String str);
    public static String toKebabCase(String str);
    
    // 字符串处理
    public static String abbreviate(String str, int maxWidth);
    public static String substringBefore(String str, String separator);
    public static String substringAfter(String str, String separator);
}
```

**JSON工具**
```java
public class JsonUtils {
    // 对象转JSON
    public static String toJson(Object obj);
    public static String toJsonPretty(Object obj);
    
    // JSON转对象
    public static <T> T fromJson(String json, Class<T> clazz);
    public static <T> T fromJson(String json, TypeReference<T> typeRef);
    
    // JSON节点操作
    public static JsonNode parseNode(String json);
    public static String getValue(String json, String path);
}
```

**加密工具**
```java
public class CryptoUtils {
    // MD5加密
    public static String md5(String input);
    
    // SHA加密
    public static String sha256(String input);
    
    // AES加密解密
    public static String aesEncrypt(String data, String key);
    public static String aesDecrypt(String encryptedData, String key);
    
    // RSA加密解密
    public static String rsaEncrypt(String data, String publicKey);
    public static String rsaDecrypt(String encryptedData, String privateKey);
    
    // Base64编解码
    public static String base64Encode(String data);
    public static String base64Decode(String encodedData);
}
```

### 3.4 通用注解

**操作日志注解**
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface OperationLog {
    String module();          // 模块名
    String operation();       // 操作名称
    String description() default "";  // 描述
    LogType type() default LogType.OTHER;  // 日志类型
}
```

**权限校验注解**
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequirePermission {
    String value();           // 权限标识
    LogicalType logical() default LogicalType.AND;  // 逻辑类型
}
```

**数据权限注解**
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface DataScope {
    String column();          // 数据权限列名
    String alias() default "";  // 表别名
}
```

**防重复提交注解**
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface PreventDuplicateSubmit {
    long timeout() default 3000;  // 超时时间(毫秒)
    String message() default "请勿重复提交";
}
```

### 3.5 拦截器和切面

**操作日志切面**
```java
@Aspect
@Component
public class OperationLogAspect {
    
    @Around("@annotation(operationLog)")
    public Object around(ProceedingJoinPoint point, OperationLog operationLog) throws Throwable {
        // 记录操作前信息
        // 执行目标方法
        // 记录操作后信息
        // 异步保存操作日志
    }
}
```

**数据权限拦截器**
```java
@Intercepts({
    @Signature(type = Executor.class, method = "query", args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})
})
public class DataScopeInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 在SQL执行前注入数据权限条件
    }
}
```

**分页拦截器**
```java
@Intercepts({
    @Signature(type = Executor.class, method = "query", args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})
})
public class PaginationInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 自动执行分页查询
        // 计算总记录数
    }
}
```

## 4. 通用功能设计

### 4.1 数据库通用功能

**基础实体**
```java
public class BaseEntity {
    private Long id;              // 主键ID
    private Long createdBy;       // 创建人ID
    private Date createdTime;     // 创建时间
    private Long updatedBy;       // 更新人ID
    private Date updatedTime;     // 更新时间
    private Boolean deleted;      // 是否删除
    private Integer version;      // 乐观锁版本号
}
```

**自动填充处理器**
```java
@Component
public class MetaObjectHandler implements com.baomidou.mybatisplus.core.handlers.MetaObjectHandler {
    
    @Override
    public void insertFill(MetaObject metaObject) {
        this.strictInsertFill(metaObject, "createdTime", Date.class, new Date());
        this.strictInsertFill(metaObject, "updatedTime", Date.class, new Date());
        this.strictInsertFill(metaObject, "deleted", Boolean.class, false);
        this.strictInsertFill(metaObject, "version", Integer.class, 1);
    }
    
    @Override
    public void updateFill(MetaObject metaObject) {
        this.strictUpdateFill(metaObject, "updatedTime", Date.class, new Date());
    }
}
```

**逻辑删除**
```java
@Configuration
public class MyBatisPlusConfig {
    
    @Bean
    public ISqlInjector sqlInjector() {
        return new DefaultSqlInjector();
    }
    
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        // 逻辑删除插件
        interceptor.addInnerInterceptor(new BlockAttackInnerInterceptor());
        return interceptor;
    }
}
```

### 4.2 通用枚举定义

**响应码枚举**
```java
public enum ResponseCode {
    SUCCESS(200, "操作成功"),
    BAD_REQUEST(400, "请求参数错误"),
    UNAUTHORIZED(401, "未授权"),
    FORBIDDEN(403, "无权限访问"),
    NOT_FOUND(404, "资源不存在"),
    INTERNAL_ERROR(500, "系统内部错误");
    
    private Integer code;
    private String message;
}
```

**操作类型枚举**
```java
public enum OperationType {
    INSERT("新增"),
    UPDATE("修改"),
    DELETE("删除"),
    QUERY("查询"),
    EXPORT("导出"),
    IMPORT("导入"),
    OTHER("其他");
    
    private String description;
}
```

**状态枚举**
```java
public enum CommonStatus {
    ENABLED(1, "启用"),
    DISABLED(0, "禁用");
    
    private Integer code;
    private String description;
}
```

### 4.3 通用DTO和VO

**分页查询DTO**
```java
public class PageQueryDTO {
    private Long current;        // 当前页
    private Long size;          // 每页大小
    private String sortField;   // 排序字段
    private String sortOrder;   // 排序方向
}
```

**树形结构VO**
```java
public class TreeNodeVO {
    private Long id;
    private String name;
    private Long parentId;
    private List<TreeNodeVO> children;
    private Boolean hasChildren;
}
```

**字典项VO**
```java
public class DictItemVO {
    private String value;        // 字典值
    private String label;        // 字典标签
    private String type;         // 字典类型
    private Integer sort;        // 排序
    private Boolean isDefault;   // 是否默认
}
```

## 5. 配置管理

### 5.1 全局配置

**统一配置类**
```java
@Configuration
public class CommonConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
    
    @Bean
    public ObjectMapper objectMapper() {
        ObjectMapper mapper = new ObjectMapper();
        mapper.registerModule(new JavaTimeModule());
        mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);
        return mapper;
    }
}
```

### 5.2 常量定义

**系统常量**
```java
public class SystemConstants {
    public static final String DEFAULT_PASSWORD = "123456";
    public static final String SUPER_ADMIN = "admin";
    public static final Long SUPER_ADMIN_ID = 1L;
    public static final String DEFAULT_TENANT = "default";
}
```

**缓存常量**
```java
public class CacheConstants {
    public static final String LOGIN_TOKEN_KEY = "login:token:";
    public static final String CAPTCHA_CODE_KEY = "captcha:code:";
    public static final String DICT_DATA_KEY = "dict:data:";
    public static final String USER_INFO_KEY = "user:info:";
}
```

## 6. 部署说明

### 6.1 依赖管理
Common模块作为jar包被其他模块依赖，不需要独立部署。

### 6.2 使用方式
```xml
<dependency>
    <groupId>com.qoobot</groupId>
    <artifactId>qooerp-common-api</artifactId>
    <version>${revision}</version>
</dependency>
```

## 7. 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2025-01-17 | 初始版本 | Auto |
| 1.1.0 | 20xx-xx-xx | 添加OpenFeign和LoadBalancer依赖，为所有微服务提供统一的微服务调用能力 | Auto |
