# QooERP 供应链管理 - 技术设计文档

> 版本：v1.0
> 创建日期：2026-02-17
> 更新日期：2026-02-18
> 服务名称：qooerp-scm
> 端口：8088
> **数据库**: PostgreSQL 15+

---

## 一、技术栈

| 分类 | 技术选型 | 版本 |
|------|---------|------|
| 开发语言 | Java | 17 |
| 框架 | Spring Boot | 3.2.x |
| 服务注册 | Nacos | 2.3.x |
| 持久层 | MyBatis Plus | 3.5.x |
| 数据库 | PostgreSQL | 15+ |
| 缓存 | Redis | 7.0.x |
| API文档 | Swagger | 3.0 |
| 工具库 | Hutool | 5.8.x |

---

## 二、配置文件

### 2.1 application.yml

```yaml
server:
  port: 8088

spring:
  application:
    name: qooerp-scm

  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/qooerp_scm?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: qooerp_scm
    password: qooerp_scm_2026
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  redis:
    host: localhost
    port: 6379
    database: 2
    timeout: 5000
    lettuce:
      pool:
        max-active: 20
        max-wait: -1
        max-idle: 10
        min-idle: 5

  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: qooerp
        group: DEFAULT_GROUP
      config:
        server-addr: localhost:8848
        namespace: qooerp
        group: DEFAULT_GROUP
        file-extension: yaml

mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  type-aliases-package: com.qoobot.qooerp.scm.**.domain
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
  global-config:
    db-config:
      id-type: auto
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
      version-field: version

logging:
  level:
    com.qoobot.qooerp.scm: debug
    com.qoobot.qooerp.scm.mapper: debug
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  metrics:
    tags:
      application: qooerp-scm
```

---

## 三、包结构

### 3.1 完整包结构

```
com.qoobot.qooerp.scm
├── constant                    # 常量定义
│   └── ScmConstant.java
├── supplier                    # 供应商管理
│   ├── domain                 # 实体类
│   │   ├── ScmSupplier.java
│   │   └── ScmSupplierEvaluation.java
│   ├── dto                    # 数据传输对象
│   │   ├── SupplierDTO.java
│   │   ├── SupplierQueryDTO.java
│   │   └── EvaluationDTO.java
│   ├── mapper                 # Mapper接口
│   │   ├── ScmSupplierMapper.java
│   │   └── ScmSupplierEvaluationMapper.java
│   ├── service                # 服务层
│   │   ├── IScmSupplierService.java
│   │   └── impl/ScmSupplierServiceImpl.java
│   └── controller             # 控制器
│       └── ScmSupplierController.java
├── customer                    # 客户管理
│   ├── domain
│   │   ├── ScmCustomer.java
│   │   └── ScmCustomerGrade.java
│   ├── dto
│   │   ├── CustomerDTO.java
│   │   └── CustomerQueryDTO.java
│   ├── mapper
│   │   ├── ScmCustomerMapper.java
│   │   └── ScmCustomerGradeMapper.java
│   ├── service
│   │   ├── IScmCustomerService.java
│   │   └── impl/ScmCustomerServiceImpl.java
│   └── controller
│       └── ScmCustomerController.java
└── logistics                   # 物流管理
    ├── domain
    │   ├── ScmLogistics.java
    │   └── ScmLogisticsTracking.java
    ├── dto
    │   ├── LogisticsDTO.java
    │   └── LogisticsQueryDTO.java
    ├── mapper
    │   ├── ScmLogisticsMapper.java
    │   └── ScmLogisticsTrackingMapper.java
    ├── service
    │   ├── IScmLogisticsService.java
    │   └── impl/ScmLogisticsServiceImpl.java
    └── controller
        └── ScmLogisticsController.java
```

---

## 四、核心实现要点

### 4.1 编号生成规则

- 供应商编码：`SP` + `yyyyMMdd` + 3位随机数
- 客户编码：`CU` + `yyyyMMdd` + 3位随机数
- 物流单号：`LG` + `yyyyMMdd` + 3位随机数

### 4.2 信用等级计算

```
综合评分 = (质量评分 + 交付评分 + 服务评分 + 价格评分) / 4
信用等级：
  - A级：90-100分
  - B级：80-89分
  - C级：70-79分
  - D级：70分以下
```

### 4.3 多租户支持

- 所有表包含 `tenant_id` 字段
- 通过 `SecurityUtil.getTenantId()` 获取当前租户ID
- 查询时自动添加租户过滤条件

### 4.4 逻辑删除

- 所有表包含 `deleted` 字段
- MyBatis Plus 全局配置逻辑删除
- 删除时标记为 1，实际数据保留

### 4.5 乐观锁

- 所有表包含 `version` 字段
- 更新时自动检查版本号
- 并发更新冲突时抛出异常

---

## 五、监控指标

| 指标名称 | 说明 |
|---------|------|
| scm_supplier_created_total | 供应商创建总数 |
| scm_customer_created_total | 客户创建总数 |
| scm_logistics_created_total | 物流创建总数 |
| scm_evaluation_total | 供应商评估次数 |
| scm_tracking_total | 物流跟踪次数 |

---

## 六、API接口汇总

| 模块 | 接口数量 | 路径前缀 |
|------|---------|---------|
| 供应商管理 | 8个 | /api/scm/suppliers |
| 客户管理 | 6个 | /api/scm/customers |
| 物流管理 | 8个 | /api/scm/logistics |
| **总计** | **22个** | |

---

## 七、错误码

| 错误码 | 错误信息 | 说明 |
|--------|---------|------|
| SCM_001 | 供应商编码已存在 | 指定的供应商编码已存在 |
| SCM_002 | 客户编码已存在 | 指定的客户编码已存在 |
| SCM_003 | 物流单号已存在 | 指定的物流单号已存在 |
| SCM_004 | 供应商不存在 | 指定的供应商不存在 |
| SCM_005 | 客户不存在 | 指定的客户不存在 |
| SCM_006 | 物流不存在 | 指定的物流不存在 |
| SCM_007 | 评估分数无效 | 评估分数必须在0-100之间 |
| SCM_008 | 客户等级无效 | 无效的客户等级 |

---

*文档维护：请保持此文档的及时更新*
