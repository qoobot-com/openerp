# QooERP 人力资源管理 - 技术设计文档

> 版本：v1.0
> 创建日期：20xx-xx-xx
> 服务名称：qooerp-hr
> **数据库**: PostgreSQL 15+

---

## 一、技术架构

### 1.1 技术栈

| 分类 | 技术选型 | 版本 |
|------|---------|------|
| 开发语言 | Java | 17 |
| 框架 | Spring Boot | 3.2.x |
| 服务注册 | Nacos | 2.3.x |
| 配置中心 | Nacos Config | 2.3.x |
| 服务网关 | Spring Cloud Gateway | 4.1.x |
| 负载均衡 | Spring Cloud LoadBalancer | 4.1.x |
| 服务调用 | OpenFeign | 4.1.x |
| 持久层框架 | MyBatis Plus | 3.5.x |
| 数据库 | PostgreSQL | 15+ |
| 缓存 | Redis | 7.0.x |
| 消息队列 | RocketMQ | 5.2.x |
| 文档工具 | Knife4j | 4.4.x |
| 监控 | Spring Boot Actuator | 3.2.x |
| 链路追踪 | OpenTelemetry | 1.34+ |
| 日志 | Logback | 1.5+ |
| 监控 | Micrometer + Prometheus | 1.13+ |

---

## 二、项目结构

### 2.1 目录结构

```
qooerp-hr/
├── qooerp-hr-service/          # 业务逻辑模块
│   └── src/main/java/com/qoobot/qooerp/hr/
│       ├── employee/           # 员工管理
│       │   ├── controller/
│       │   │   └── HrEmployeeController.java
│       │   ├── service/
│       │   │   ├── HrEmployeeService.java
│       │   │   └── impl/HrEmployeeServiceImpl.java
│       │   ├── domain/
│       │   │   ├── HrEmployee.java
│       │   │   ├── HrEmployeeEducation.java
│       │   │   └── HrEmployeeExperience.java
│       │   ├── dto/
│       │   │   ├── EmployeeDTO.java
│       │   │   ├── EmployeeQueryDTO.java
│       │   │   └── EmployeeCreateDTO.java
│       │   ├── repository/
│       │   │   └── HrEmployeeRepository.java
│       │   └── mapper/
│       │       └── HrEmployeeMapper.java
│       ├── attendance/        # 考勤管理
│       ├── salary/            # 薪资管理
│       ├── performance/      # 绩效管理
│       └── integration/       # 集成模块
└── qooerp-hr-start/          # 启动模块
    └── src/main/
        ├── java/com/qoobot/qooerp/hr/
        │   └── HrApplication.java
        └── resources/
            ├── application.yml
            ├── application-dev.yml
            └── application-prod.yml
```

### 2.2 包结构规范

| 包名 | 说明 |
|------|------|
| com.qoobot.qooerp.hr | 根包 |
| .controller | 控制器层 |
| .service | 服务接口层 |
| .service.impl | 服务实现层 |
| .domain | 领域模型 |
| .dto | 数据传输对象 |
| .vo | 视图对象 |
| .repository | 仓储层 |
| .mapper | MyBatis映射器 |
| .enums | 枚举类 |
| .exception | 异常类 |
| .event | 事件类 |
| .config | 配置类 |
| .util | 工具类 |

---

## 三、核心实现

### 3.1 员工编号生成器

```java
package com.qoobot.qooerp.hr.util;

import org.springframework.stereotype.Component;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * 员工编号生成器
 */
@Component
public class EmployeeCodeGenerator {
    
    private static final String PREFIX = "EMP";
    private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern("yyyyMM");
    
    private final AtomicInteger sequence = new AtomicInteger(1);
    private String currentMonth;
    
    /**
     * 生成员工编号
     * 格式：EMP + 年月 + 6位序号
     * 示例：EMP202601000001
     */
    public synchronized String generate() {
        String month = LocalDate.now().format(FORMATTER);
        
        if (!month.equals(currentMonth)) {
            currentMonth = month;
            sequence.set(1);
        }
        
        return PREFIX + month + String.format("%06d", sequence.getAndIncrement());
    }
}
```

### 3.2 薪资计算服务

```java
package com.qoobot.qooerp.hr.salary.service.impl;

import com.qoobot.qooerp.hr.salary.domain.HrSalary;
import com.qoobot.qooerp.hr.salary.domain.HrSalaryItem;
import com.qoobot.qooerp.hr.salary.repository.HrSalaryRepository;
import com.qoobot.qooerp.hr.salary.repository.HrSalaryItemRepository;
import com.qoobot.qooerp.common.core.exception.BusinessException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.List;

/**
 * 薪资计算服务实现
 */
@Slf4j
@Service
public class HrSalaryCalculateServiceImpl {
    
    private static final BigDecimal TAX_THRESHOLD = new BigDecimal("5000");
    private static final BigDecimal[] TAX_BRACKETS = {
        new BigDecimal("3000"),
        new BigDecimal("12000"),
        new BigDecimal("25000"),
        new BigDecimal("35000"),
        new BigDecimal("55000"),
        new BigDecimal("80000")
    };
    private static final BigDecimal[] TAX_RATES = {
        new BigDecimal("0.03"),
        new BigDecimal("0.10"),
        new BigDecimal("0.20"),
        new BigDecimal("0.25"),
        new BigDecimal("0.30"),
        new BigDecimal("0.35"),
        new BigDecimal("0.45")
    };
    private static final BigDecimal[] QUICK_DEDUCTIONS = {
        BigDecimal.ZERO,
        new BigDecimal("210"),
        new BigDecimal("1410"),
        new BigDecimal("2660"),
        new BigDecimal("4410"),
        new BigDecimal("7160"),
        new BigDecimal("15160")
    };
    
    /**
     * 计算个税（累计预扣法）
     */
    public BigDecimal calculateIncomeTax(BigDecimal taxableIncome) {
        if (taxableIncome.compareTo(TAX_THRESHOLD) <= 0) {
            return BigDecimal.ZERO;
        }
        
        BigDecimal taxable = taxableIncome.subtract(TAX_THRESHOLD);
        
        for (int i = 0; i < TAX_BRACKETS.length; i++) {
            if (taxable.compareTo(TAX_BRACKETS[i]) <= 0) {
                return taxable.multiply(TAX_RATES[i])
                    .subtract(QUICK_DEDUCTIONS[i])
                    .setScale(2, RoundingMode.HALF_UP);
            }
        }
        
        return taxable.multiply(TAX_RATES[6])
            .subtract(QUICK_DEDUCTIONS[6])
            .setScale(2, RoundingMode.HALF_UP);
    }
    
    /**
     * 计算加班费
     */
    public BigDecimal calculateOvertimePay(BigDecimal baseHourlyRate, 
                                            BigDecimal overtimeHours, 
                                            String overtimeType) {
        BigDecimal multiplier;
        switch (overtimeType) {
            case "WEEKDAY":
                multiplier = new BigDecimal("1.5");
                break;
            case "WEEKEND":
                multiplier = new BigDecimal("2.0");
                break;
            case "HOLIDAY":
                multiplier = new BigDecimal("3.0");
                break;
            default:
                throw new BusinessException("无效的加班类型: " + overtimeType);
        }
        
        return baseHourlyRate.multiply(overtimeHours).multiply(multiplier)
            .setScale(2, RoundingMode.HALF_UP);
    }
}
```

### 3.3 绩效评分计算

```java
package com.qoobot.qooerp.hr.performance.service.impl;

import com.qoobot.qooerp.hr.performance.domain.HrPerformanceAssessment;
import com.qoobot.qooerp.hr.performance.repository.HrPerformanceAssessmentRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.List;

/**
 * 绩效评分计算服务
 */
@Slf4j
@Service
public class HrPerformanceCalculateServiceImpl {
    
    private static final BigDecimal SELF_WEIGHT = new BigDecimal("0.20");
    private static final BigDecimal SUPERVISOR_WEIGHT = new BigDecimal("0.60");
    private static final BigDecimal OTHER_WEIGHT = new BigDecimal("0.20");
    
    /**
     * 计算综合得分
     * 综合得分 = 自评分 * 20% + 上评分 * 60% + 其他评分 * 20%
     */
    public BigDecimal calculateTotalScore(HrPerformanceAssessment assessment) {
        BigDecimal selfScore = assessment.getSelfScore();
        BigDecimal supervisorScore = assessment.getSupervisorScore();
        BigDecimal peerScore = assessment.getPeerScore();
        BigDecimal subordinateScore = assessment.getSubordinateScore();
        
        BigDecimal otherScore = BigDecimal.ZERO;
        int otherCount = 0;
        
        if (peerScore != null) {
            otherScore = otherScore.add(peerScore);
            otherCount++;
        }
        if (subordinateScore != null) {
            otherScore = otherScore.add(subordinateScore);
            otherCount++;
        }
        
        if (otherCount > 0) {
            otherScore = otherScore.divide(new BigDecimal(otherCount), 2, RoundingMode.HALF_UP);
        } else {
            otherScore = supervisorScore;
        }
        
        BigDecimal totalScore = selfScore.multiply(SELF_WEIGHT)
            .add(supervisorScore.multiply(SUPERVISOR_WEIGHT))
            .add(otherScore.multiply(OTHER_WEIGHT))
            .setScale(2, RoundingMode.HALF_UP);
        
        return totalScore;
    }
    
    /**
     * 根据得分确定绩效等级
     */
    public String calculateGrade(BigDecimal totalScore) {
        if (totalScore.compareTo(new BigDecimal("90")) >= 0) {
            return "S";
        } else if (totalScore.compareTo(new BigDecimal("80")) >= 0) {
            return "A";
        } else if (totalScore.compareTo(new BigDecimal("70")) >= 0) {
            return "B";
        } else if (totalScore.compareTo(new BigDecimal("60")) >= 0) {
            return "C";
        } else {
            return "D";
        }
    }
}
```

### 3.4 事件发布器

```java
package com.qoobot.qooerp.hr.config;

import com.qoobot.qooerp.hr.employee.event.EmployeeCreatedEvent;
import com.qoobot.qooerp.hr.employee.event.EmployeeTerminatedEvent;
import com.qoobot.qooerp.hr.attendance.event.AttendanceCheckedEvent;
import com.qoobot.qooerp.hr.salary.event.SalaryCalculatedEvent;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.stream.function.StreamBridge;
import org.springframework.stereotype.Component;

/**
 * HR领域事件发布器
 */
@Slf4j
@Component
public class HrEventPublisher {
    
    @Autowired
    private StreamBridge streamBridge;
    
    /**
     * 发布员工创建事件
     */
    public void publishEmployeeCreated(EmployeeCreatedEvent event) {
        boolean success = streamBridge.send("hr-employee-created-out-0", event);
        if (success) {
            log.info("发布员工创建事件成功: {}", event.getEmployeeCode());
        } else {
            log.error("发布员工创建事件失败: {}", event.getEmployeeCode());
        }
    }
    
    /**
     * 发布员工离职事件
     */
    public void publishEmployeeTerminated(EmployeeTerminatedEvent event) {
        boolean success = streamBridge.send("hr-employee-terminated-out-0", event);
        if (success) {
            log.info("发布员工离职事件成功: {}", event.getEmployeeCode());
        } else {
            log.error("发布员工离职事件失败: {}", event.getEmployeeCode());
        }
    }
    
    /**
     * 发布打卡事件
     */
    public void publishAttendanceChecked(AttendanceCheckedEvent event) {
        boolean success = streamBridge.send("hr-attendance-checked-out-0", event);
        if (success) {
            log.info("发布打卡事件成功: employeeId={}", event.getEmployeeId());
        } else {
            log.error("发布打卡事件失败: employeeId={}", event.getEmployeeId());
        }
    }
    
    /**
     * 发布薪资计算完成事件
     */
    public void publishSalaryCalculated(SalaryCalculatedEvent event) {
        boolean success = streamBridge.send("hr-salary-calculated-out-0", event);
        if (success) {
            log.info("发布薪资计算完成事件成功: month={}, employeeId={}", 
                event.getSalaryMonth(), event.getEmployeeId());
        } else {
            log.error("发布薪资计算完成事件失败: month={}, employeeId={}", 
                event.getSalaryMonth(), event.getEmployeeId());
        }
    }
}
```

---

## 四、配置文件

### 4.1 application.yml

```yaml
server:
  port: 8086
  servlet:
    context-path: /

spring:
  application:
    name: qooerp-hr
  profiles:
    active: @spring.profiles.active@
  
  cloud:
    nacos:
      discovery:
        server-addr: @nacos.addr@
        namespace: @nacos.namespace@
        group: @nacos.group@
      config:
        server-addr: @nacos.addr@
        namespace: @nacos.namespace@
        group: @nacos.group@
        file-extension: yml
  
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/qooerp_hr
    username: postgres
    password: postgres
  
  redis:
    host: localhost
    port: 6379
    database: 0
    password:
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0
  
  cloud:
    stream:
      rocketmq:
        binder:
          name-server: localhost:9876
      bindings:
        hr-employee-created-out-0:
          destination: hr-employee-created
        hr-employee-terminated-out-0:
          destination: hr-employee-terminated
        hr-attendance-checked-out-0:
          destination: hr-attendance-checked
        hr-salary-calculated-out-0:
          destination: hr-salary-calculated

mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  type-aliases-package: com.qoobot.qooerp.hr.**.domain
  configuration:
    map-underscore-to-camel-case: true
    cache-enabled: false
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
  global-config:
    db-config:
      id-type: AUTO
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0

knife4j:
  enable: true
  setting:
    language: zh_cn

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,tracing
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
      env: ${spring.profiles.active}
      instance: ${spring.application.name}:${server.port}
  otlp:
    tracing:
      endpoint: ${OTEL_ENDPOINT:http://localhost:4318/v1/traces}
  tracing:
    sampling:
      probability: 0.1
    propagation:
      type: w3c
```

---

## 五、部署配置

### 5.1 Dockerfile

```dockerfile
FROM openjdk:17-jdk-slim

LABEL maintainer="qoobot"
LABEL version="1.0.0"

WORKDIR /app

COPY target/qooerp-hr-start-1.0.0.jar app.jar

EXPOSE 8086

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 5.2 docker-compose.yml

```yaml
version: '3.8'

services:
  qooerp-hr:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8086:8086"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - NACOS_ADDR=nacos:8848
    depends_on:
      - postgres
      - redis
    networks:
      - qooerp-network

networks:
  qooerp-network:
    driver: bridge
```

---

## 六、性能优化

### 6.1 缓存策略

| 数据类型 | 缓存策略 | 过期时间 |
|---------|---------|---------|
| 员工基本信息 | Redis | 1小时 |
| 部门岗位信息 | Redis | 1小时 |
| 考勤配置 | Redis | 24小时 |
| 薪资计算规则 | Redis | 24小时 |

### 6.2 批量处理

```java
/**
 * 批量计算薪资
 */
public void batchCalculateSalary(String salaryMonth, List<Long> employeeIds) {
    // 分批处理，每批100人
    int batchSize = 100;
    List<List<Long>> batches = Lists.partition(employeeIds, batchSize);
    
    batches.forEach(batch -> {
        batch.parallelStream().forEach(employeeId -> {
            try {
                calculateSalary(employeeId, salaryMonth);
            } catch (Exception e) {
                log.error("计算薪资失败: employeeId={}, month={}", employeeId, salaryMonth, e);
            }
        });
    });
}
```

---

## 七、监控与告警

### 7.1 监控指标

| 指标名称 | 说明 |
|---------|------|
| hr_employee_created_total | 员工创建总数 |
| hr_attendance_checked_total | 打卡总数 |
| hr_salary_calculated_duration | 薪资计算耗时 |
| hr_performance_assessment_total | 绩效评估总数 |

### 7.2 告警规则

| 告警名称 | 触发条件 | 级别 |
|---------|---------|------|
| 薪资计算失败率 | 失败率 > 5% | P1 |
| 打卡接口响应慢 | P99 > 500ms | P2 |
| 员工数据同步失败 | 同步失败 | P1 |

---

## 八、附录

### 8.1 相关文档

- 01-业务设计.md
- 02-应用设计.md
- 03-数据设计.md
- 04-API接口文档.md
- 05-数据库脚本.sql

---

*文档维护：请保持此文档的及时更新，确保技术设计的准确性*
