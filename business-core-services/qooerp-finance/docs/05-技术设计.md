# QooERP 财务管理 - 技术设计文档

> 版本：v1.0
> 创建日期：2026-02-17
> 服务名称：qooerp-finance
> 端口：8087
> **数据库**: PostgreSQL 15+

---

## 一、技术栈

| 分类 | 技术选型 | 版本 |
|------|---------|------|
| 开发语言 | Java | 17 |
| 框架 | Spring Boot | 3.2.x |
| 服务注册 | Nacos | 2.3.x |
| 持久层 | MyBatis Plus | 3.5.x |
| 数据库 | PostgreSQL | 15+ |
| 缓存 | Redis | 7.0.x |
| 消息队列 | RocketMQ | 5.2.x |
| 链路追踪 | OpenTelemetry | 1.30+ |

---

## 二、核心实现

### 2.1 借贷平衡校验

```java
package com.qoobot.qooerp.finance.voucher.util;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import java.math.BigDecimal;
import java.util.List;

/**
 * 借贷平衡校验工具
 */
@Slf4j
@Component
public class BalanceChecker {
    
    /**
     * 检查借贷是否平衡
     */
    public boolean checkBalance(List<VoucherDetailDTO> details) {
        BigDecimal totalDebit = details.stream()
            .filter(d -> "DEBIT".equals(d.getDirection()))
            .map(VoucherDetailDTO::getAmount)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
        
        BigDecimal totalCredit = details.stream()
            .filter(d -> "CREDIT".equals(d.getDirection()))
            .map(VoucherDetailDTO::getAmount)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
        
        return totalDebit.compareTo(totalCredit) == 0;
    }
}
```

### 2.2 折旧计算服务

```java
package com.qoobot.qooerp.finance.asset.service.impl;

import java.math.BigDecimal;
import java.math.RoundingMode;

/**
 * 折旧计算服务
 */
public class DepreciationCalculateServiceImpl {
    
    /**
     * 直线法折旧
     * 月折旧额 = (原值 - 预计净残值) / (使用年限 * 12)
     */
    public BigDecimal straightLineMethod(BigDecimal originalValue, 
                                          BigDecimal salvageValue, 
                                          Integer usefulLife) {
        BigDecimal totalMonths = new BigDecimal(usefulLife * 12);
        return originalValue.subtract(salvageValue)
            .divide(totalMonths, 2, RoundingMode.HALF_UP);
    }
    
    /**
     * 双倍余额递减法
     * 月折旧额 = (原值 - 累计折旧) * (2 / 使用年限) / 12
     */
    public BigDecimal doubleDecliningMethod(BigDecimal originalValue,
                                            BigDecimal accumulatedDepreciation,
                                            Integer usefulLife) {
        BigDecimal bookValue = originalValue.subtract(accumulatedDepreciation);
        BigDecimal annualRate = new BigDecimal(2).divide(new BigDecimal(usefulLife), 4, RoundingMode.HALF_UP);
        return bookValue.multiply(annualRate)
            .divide(new BigDecimal(12), 2, RoundingMode.HALF_UP);
    }
}
```

### 2.3 账龄计算

```java
package com.qoobot.qooerp.finance.util;

import java.time.LocalDate;
import java.time.temporal.ChronoUnit;

/**
 * 账龄计算工具
 */
public class AgingCalculator {
    
    /**
     * 计算账龄（天）
     */
    public static Long calculateAging(LocalDate dueDate, LocalDate asOfDate) {
        if (asOfDate.isBefore(dueDate)) {
            return 0L;
        }
        return ChronoUnit.DAYS.between(dueDate, asOfDate);
    }
    
    /**
     * 获取账龄区间
     */
    public static String getAgingPeriod(Long agingDays) {
        if (agingDays <= 30) {
            return "0-30天";
        } else if (agingDays <= 60) {
            return "31-60天";
        } else if (agingDays <= 90) {
            return "61-90天";
        } else if (agingDays <= 180) {
            return "91-180天";
        } else {
            return "181天以上";
        }
    }
}
```

---

## 三、配置文件

### 3.1 application.yml

```yaml
server:
  port: 8087

spring:
  application:
    name: qooerp-finance
  
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/qooerp_finance
    username: postgres
    password: postgres
  
  redis:
    host: localhost
    port: 6379
    database: 1

mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  configuration:
    map-underscore-to-camel-case: true
```

---

## 四、性能优化

### 4.1 批量折旧处理

```java
/**
 * 批量计算折旧
 */
public void batchCalculateDepreciation(String accountingPeriod, List<Long> assetIds) {
    assetIds.parallelStream().forEach(assetId -> {
        try {
            calculateDepreciation(assetId, accountingPeriod);
        } catch (Exception e) {
            log.error("计算折旧失败: assetId={}, period={}", assetId, accountingPeriod, e);
        }
    });
}
```

---

## 五、监控指标

| 指标名称 | 说明 |
|---------|------|
| finance_voucher_created_total | 凭证创建总数 |
| finance_voucher_posted_total | 凭证记账总数 |
| finance_receivable_amount_total | 应收账款总额 |
| finance_payable_amount_total | 应付账款总额 |
| finance_depreciation_duration | 折旧计算耗时 |

---

## 六、包结构

```
com.qoobot.qooerp.finance
├── voucher           # 总账管理
├── account           # 科目管理
├── receivable        # 应收管理
├── payable           # 应付管理
├── asset             # 资产管理
└── report            # 报表管理
```

---

*文档维护：请保持此文档的及时更新，确保技术设计的准确性*
