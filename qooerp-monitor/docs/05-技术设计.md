# QooERP 监控服务模块 - 技术设计文档

> **数据库**: PostgreSQL 15+ with TimescaleDB
> **架构**: 微服务 + PostgreSQL + ECharts

## 一、技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Spring Boot | 3.2.x | 应用框架 |
| OpenTelemetry | 1.34+ | 链路追踪（OTLP 协议接收） |
| Micrometer | 1.13+ | 指标收集 |
| PostgreSQL | 15+ | 数据库 |
| TimescaleDB | Latest | 时序数据库扩展 |
| Vue 3 | 3.4+ | 前端框架 |
| TDesign | Latest | UI 组件库（PC 端） |
| ECharts | 5.x | 前端图表可视化 |
| MyBatis-Plus | Latest | ORM 框架 |

## 二、系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────┐
│                qooerp-monitor                        │
│              (Spring Boot 应用)                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │              数据采集层                      │   │
│  │  ┌────────────┐  ┌────────────┐             │   │
│  │  │ OTLP 接收器│  │ HTTP 接口  │             │   │
│  │  │  (Traces)  │  │  (Metrics) │             │   │
│  │  └──────┬─────┘  └──────┬─────┘             │   │
│  └─────────┼─────────────────┼─────────────────┘   │
│            │                 │                     │
│  ┌─────────▼─────────────────▼─────────────────┐   │
│  │              数据处理层                       │   │
│  │  ┌────────────┐  ┌────────────┐             │   │
│  │  │ 数据清洗   │  │ 聚合统计   │             │   │
│  │  └────────────┘  └────────────┘             │   │
│  └─────────┬───────────────────────────────────┘   │
│            │                                       │
│  ┌─────────▼───────────────────────────────────┐   │
│  │              数据存储层                       │   │
│  │         PostgreSQL + TimescaleDB            │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │              业务逻辑层                       │   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐          │   │
│  │  │告警引擎│ │查询服务│ │统计服务│          │   │
│  │  └────────┘ └────────┘ └────────┘          │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │              展示层 (Web)                     │   │
│  │       Vue 3 + TDesign + ECharts              │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

### 2.2 数据采集架构

```
┌─────────────────────────────────────────────────────┐
│                  微服务集群                          │
├─────────────────────────────────────────────────────┤
│  qooerp-gateway  qooerp-auth  qooerp-system  ...    │
│         │              │              │             │
│         └──────────────┼──────────────┘             │
│                        │                             │
│  ┌─────────────────────┼───────────────────────┐   │
│  │ OpenTelemetry SDK   │ Micrometer            │   │
│  │ (Tracing)           │ (Metrics)             │   │
│  └──────────┬───────────┴───────────┬───────────┘   │
│             │                       │               │
│  OTLP/v1/traces                HTTP /metrics       │
│  (gRPC 或 HTTP)                (Prometheus 格式)   │
│             │                       │               │
└─────────────┼───────────────────────┼───────────────┘
              │                       │
              ▼                       ▼
┌─────────────────────────────────────────────────────┐
│            qooerp-monitor 数据采集                   │
├─────────────────────────────────────────────────────┤
│  ┌────────────────┐  ┌────────────────┐             │
│  │  OTLP Receiver │  │ Metrics Collector│           │
│  │  (Port: 4318)  │  │  (HTTP API)     │           │
│  │  - Traces      │  │  - Scrape       │           │
│  │  - Metrics     │  │  - Push         │           │
│  └────────┬───────┘  └────────┬───────┘            │
│           │                    │                    │
└───────────┼────────────────────┼────────────────────┘
            │                    │
            ▼                    ▼
     PostgreSQL (TimescaleDB Hypertables)
```

## 三、核心模块

### 3.1 OTLP 接收模块

**功能**：接收 OpenTelemetry 协议数据

**接口**：
- `POST /monitor/api/otlp/v1/traces` - 接收链路追踪数据
- `POST /monitor/api/otlp/v1/metrics` - 接收指标数据
- `POST /monitor/api/otlp/v1/logs` - 接收日志数据

**技术实现**：
```java
@RestController
@RequestMapping("/monitor/api/otlp")
public class OtlpReceiverController {

    @PostMapping(value = "/v1/traces", consumes = "application/x-protobuf")
    public Mono<Void> receiveTraces(@RequestBody byte[] data) {
        // 解析 OTLP Traces
        // 存储到 traces 超表
    }

    @PostMapping(value = "/v1/metrics", consumes = "application/x-protobuf")
    public Mono<Void> receiveMetrics(@RequestBody byte[] data) {
        // 解析 OTLP Metrics
        // 存储到 metrics 超表
    }
}
```

### 3.2 Metrics 采集模块

**功能**：采集 Micrometer 指标数据

**接口**：
- `POST /monitor/api/metrics/push` - 主动推送指标
- `GET /monitor/api/metrics/scrape` - 被动拉取指标（兼容 Prometheus）

**技术实现**：
```java
@RestController
@RequestMapping("/monitor/api/metrics")
public class MetricsCollectorController {

    @PostMapping("/push")
    public Result<Void> pushMetrics(@RequestBody List<MetricData> metrics) {
        // 批量存储指标到 metrics 超表
    }

    @GetMapping(value = "/scrape", produces = "text/plain")
    public String scrapeMetrics(@RequestParam String serviceName) {
        // Prometheus 格式输出
    }
}
```

### 3.3 告警引擎模块

**功能**：实时监控指标，触发告警

**工作流程**：
1. 定时任务扫描 metrics 超表
2. 匹配告警规则（monitor_alert_rule）
3. 判断是否触发告警
4. 创建告警记录（monitor_alert）
5. 发送通知（邮件/短信/站内信）

**技术实现**：
```java
@Component
public class AlertEngine {

    @Scheduled(fixedRate = 60000) // 每分钟执行
    public void evaluateAlerts() {
        // 1. 查询启用的告警规则
        // 2. 计算当前指标值
        // 3. 判断是否触发告警
        // 4. 创建告警记录
        // 5. 发送通知
    }
}
```

### 3.4 可视化模块

**功能**：提供 Web 界面展示监控数据（Vue 3 + TDesign 前端）

**页面路由**：
- `/` - 仪表盘首页
- `/traces` - 链路追踪查询
- `/metrics` - 指标趋势分析
- `/logs` - 日志查询
- `/alerts` - 告警管理

**技术栈**：
- Vue 3：前端框架
- TDesign：UI 组件库（PC 端）
- ECharts：图表库
- Pinia：状态管理
- Axios：HTTP 客户端

**数据接口**：
```java
@RestController
@RequestMapping("/monitor/api")
public class MonitorApiController {

    @GetMapping("/dashboard/overview")
    public DashboardOverviewDTO getOverview() {
        // 仪表盘概览数据
    }

    @GetMapping("/traces/{traceId}")
    public List<TraceSpanDTO> getTraceDetail(@PathVariable String traceId) {
        // 链路追踪详情
    }

    @GetMapping("/metrics/trend")
    public List<MetricPointDTO> getMetricsTrend(@RequestParam String metricName,
                                                 @RequestParam String timeRange) {
        // 指标趋势数据（用于 ECharts）
    }
}
```

## 四、TimescaleDB 配置

### 4.1 超表设计

```sql
-- 启用 TimescaleDB 扩展
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- metrics 超表（按天分区）
CREATE TABLE metrics (
    time TIMESTAMPTZ NOT NULL,
    metric_name TEXT NOT NULL,
    metric_type TEXT NOT NULL,
    metric_value DOUBLE PRECISION NOT NULL,
    tags JSONB NOT NULL,
    instance TEXT NOT NULL
);

SELECT create_hypertable('metrics', 'time', chunk_time_interval => INTERVAL '1 day');

-- traces 超表（按周分区）
CREATE TABLE traces (
    time TIMESTAMPTZ NOT NULL,
    trace_id TEXT NOT NULL,
    span_id TEXT NOT NULL,
    parent_span_id TEXT,
    span_name TEXT NOT NULL,
    span_kind TEXT,
    duration_ms BIGINT,
    status_code TEXT,
    tags JSONB NOT NULL,
    instance TEXT NOT NULL
);

SELECT create_hypertable('traces', 'time', chunk_time_interval => INTERVAL '7 days');

-- logs 超表（按周分区）
CREATE TABLE logs (
    time TIMESTAMPTZ NOT NULL,
    level TEXT NOT NULL,
    logger_name TEXT NOT NULL,
    message TEXT,
    trace_id TEXT,
    span_id TEXT,
    thread_name TEXT,
    context JSONB,
    instance TEXT NOT NULL
);

SELECT create_hypertable('logs', 'time', chunk_time_interval => INTERVAL '7 days');
```

### 4.2 连续聚合（降采样）

```sql
-- 1 小时聚合
CREATE MATERIALIZED VIEW metrics_1h
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', time) AS time,
    metric_name,
    metric_type,
    AVG(metric_value) AS avg_value,
    MAX(metric_value) AS max_value,
    MIN(metric_value) AS min_value,
    COUNT(*) AS sample_count
FROM metrics
GROUP BY time_bucket('1 hour', time), metric_name, metric_type;

SELECT add_continuous_aggregate_policy('metrics_1h',
    start_offset => INTERVAL '2 hours',
    end_offset => INTERVAL '1 hour',
    schedule_interval => INTERVAL '1 hour');

-- 1 天聚合
CREATE MATERIALIZED VIEW metrics_1d
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 day', time) AS time,
    metric_name,
    metric_type,
    AVG(metric_value) AS avg_value,
    MAX(metric_value) AS max_value,
    MIN(metric_value) AS min_value,
    COUNT(*) AS sample_count
FROM metrics
GROUP BY time_bucket('1 day', time), metric_name, metric_type;

SELECT add_continuous_aggregate_policy('metrics_1d',
    start_offset => INTERVAL '2 days',
    end_offset => INTERVAL '1 day',
    schedule_interval => INTERVAL '1 day');
```

## 五、配置说明

### 5.1 application.yml

```yaml
server:
  port: 8101

spring:
  application:
    name: qooerp-monitor
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/qooerp_monitor
    username: monitor
    password: monitor123
  thymeleaf:
    prefix: classpath:/templates/
    suffix: .html

# OTLP 接收配置
otlp:
  server:
    port: 4318
  traces:
    enabled: true
  metrics:
    enabled: true
  logs:
    enabled: true

# 告警引擎配置
alert:
  engine:
    enabled: true
    interval: 60s # 检查间隔

# 数据保留策略
retention:
  metrics:
    raw: 7d # 原始数据保留 7 天
    1h: 30d # 1 小时聚合保留 30 天
    1d: 365d # 1 天聚合保留 1 年
  traces:
    raw: 30d # 链路数据保留 30 天
  logs:
    raw: 30d # 日志数据保留 30 天

# 前端配置（Vue 3 + TDesign）
frontend:
  enabled: true
  build:
    output: dist
    assetsDir: assets
  devServer:
    port: 5173
    proxy:
      /api:
        target: http://localhost:8101
        changeOrigin: true

# 管理端点
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  tracing:
    sampling:
      probability: 1.0 # 监控服务 100% 采样
```

### 5.2 环境变量

| 变量名 | 默认值 | 说明 |
|--------|---------|------|
| `SPRING_DATASOURCE_URL` | `jdbc:postgresql://localhost:5432/qooerp_monitor` | 数据库 URL |
| `SPRING_DATASOURCE_USERNAME` | `monitor` | 数据库用户名 |
| `SPRING_DATASOURCE_PASSWORD` | `monitor123` | 数据库密码 |
| `OTLP_SERVER_PORT` | `4318` | OTLP 接收端口 |

## 六、部署架构

### 6.1 开发环境

```yaml
# docker-compose.yml
version: '3.8'
services:
  postgresql:
    image: timescale/timescaledb:latest-pg15
    environment:
      POSTGRES_DB: qooerp_monitor
      POSTGRES_USER: monitor
      POSTGRES_PASSWORD: monitor123
    ports:
      - "5432:5432"
    volumes:
      - postgresql_data:/var/lib/postgresql/data

  qooerp-monitor:
    build: .
    ports:
      - "8101:8101"
      - "4318:4318"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresql:5432/qooerp_monitor
      SPRING_DATASOURCE_USERNAME: monitor
      SPRING_DATASOURCE_PASSWORD: monitor123
    depends_on:
      - postgresql

volumes:
  postgresql_data:
```

### 6.2 生产环境

**Kubernetes 部署**：
- Deployment: qooerp-monitor（3 副本）
- StatefulSet: PostgreSQL（主从复制）
- Service: ClusterIP + LoadBalancer
- Ingress: 域名路由

---

**文档版本**: v1.1
**更新日期**: 2026-02-18
