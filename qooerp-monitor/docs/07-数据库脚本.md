# 数据库脚本

## 1. TimescaleDB 扩展安装

```sql
-- 安装 TimescaleDB 扩展
CREATE EXTENSION IF NOT EXISTS timescaledb;
```

## 2. 监控数据表

### 2.1 监控日志表（超表）

```sql
-- 监控日志表
CREATE TABLE IF NOT EXISTS monitor_log (
    id BIGSERIAL PRIMARY KEY,
    time TIMESTAMPTZ NOT NULL,
    level VARCHAR(10) NOT NULL,
    logger_name VARCHAR(255),
    message TEXT,
    trace_id VARCHAR(32),
    span_id VARCHAR(16),
    thread_name VARCHAR(255),
    service_name VARCHAR(100),
    instance VARCHAR(255),
    context JSONB,
    ip_address VARCHAR(50),
    user_id BIGINT,
    tenant_id BIGINT,
    created_time TIMESTAMPTZ DEFAULT NOW(),
    updated_time TIMESTAMPTZ DEFAULT NOW(),
    deleted INTEGER DEFAULT 0
);

-- 转换为超表
SELECT create_hypertable('monitor_log', 'time', if_not_exists => TRUE);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_monitor_log_time ON monitor_log (time DESC);
CREATE INDEX IF NOT EXISTS idx_monitor_log_trace_id ON monitor_log (trace_id);
CREATE INDEX IF NOT EXISTS idx_monitor_log_service_name ON monitor_log (service_name);
CREATE INDEX IF NOT EXISTS idx_monitor_log_level ON monitor_log (level);
CREATE INDEX IF NOT EXISTS idx_monitor_log_tenant_id ON monitor_log (tenant_id);

-- 添加注释
COMMENT ON TABLE monitor_log IS '监控日志表（TimescaleDB 超表）';
COMMENT ON COLUMN monitor_log.time IS '时间戳';
COMMENT ON COLUMN monitor_log.level IS '日志级别（TRACE, DEBUG, INFO, WARN, ERROR）';
COMMENT ON COLUMN monitor_log.logger_name IS '日志器名称';
COMMENT ON COLUMN monitor_log.message IS '日志消息';
COMMENT ON COLUMN monitor_log.trace_id IS '链路 ID';
COMMENT ON COLUMN monitor_log.span_id IS 'Span ID';
COMMENT ON COLUMN monitor_log.thread_name IS '线程名称';
COMMENT ON COLUMN monitor_log.service_name IS '服务名称';
COMMENT ON COLUMN monitor_log.instance IS '实例标识';
COMMENT ON COLUMN monitor_log.context IS '上下文信息（JSONB）';
```

### 2.2 监控链路表（超表）

```sql
-- 监控链路表
CREATE TABLE IF NOT EXISTS monitor_trace (
    id BIGSERIAL PRIMARY KEY,
    time TIMESTAMPTZ NOT NULL,
    trace_id VARCHAR(32) NOT NULL,
    span_id VARCHAR(16) NOT NULL,
    parent_span_id VARCHAR(16),
    span_name VARCHAR(255),
    span_kind VARCHAR(20),
    start_time TIMESTAMPTZ NOT NULL,
    duration_ms BIGINT,
    status_code VARCHAR(20),
    status_message TEXT,
    service_name VARCHAR(100),
    instance VARCHAR(255),
    tags JSONB,
    logs JSONB,
    tenant_id BIGINT,
    created_time TIMESTAMPTZ DEFAULT NOW(),
    updated_time TIMESTAMPTZ DEFAULT NOW(),
    deleted INTEGER DEFAULT 0
);

-- 转换为超表
SELECT create_hypertable('monitor_trace', 'time', if_not_exists => TRUE);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_monitor_trace_time ON monitor_trace (time DESC);
CREATE INDEX IF NOT EXISTS idx_monitor_trace_trace_id ON monitor_trace (trace_id);
CREATE INDEX IF NOT EXISTS idx_monitor_trace_span_id ON monitor_trace (span_id);
CREATE INDEX IF NOT EXISTS idx_monitor_trace_service_name ON monitor_trace (service_name);
CREATE INDEX IF NOT EXISTS idx_monitor_trace_tenant_id ON monitor_trace (tenant_id);

-- 添加注释
COMMENT ON TABLE monitor_trace IS '监控链路表（TimescaleDB 超表）';
COMMENT ON COLUMN monitor_trace.time IS '时间戳';
COMMENT ON COLUMN monitor_trace.trace_id IS '链路 ID';
COMMENT ON COLUMN monitor_trace.span_id IS 'Span ID';
COMMENT ON COLUMN monitor_trace.parent_span_id IS '父 Span ID';
COMMENT ON COLUMN monitor_trace.span_name IS 'Span 名称';
COMMENT ON COLUMN monitor_trace.span_kind IS 'Span 类型（SERVER, CLIENT, PRODUCER, CONSUMER 等）';
COMMENT ON COLUMN monitor_trace.start_time IS '开始时间';
COMMENT ON COLUMN monitor_trace.duration_ms IS '持续时间（毫秒）';
COMMENT ON COLUMN monitor_trace.status_code IS '状态码';
COMMENT ON COLUMN monitor_trace.status_message IS '状态消息';
COMMENT ON COLUMN monitor_trace.service_name IS '服务名称';
COMMENT ON COLUMN monitor_trace.instance IS '实例标识';
COMMENT ON COLUMN monitor_trace.tags IS '标签（JSONB）';
COMMENT ON COLUMN monitor_trace.logs IS '日志（JSONB）';
```

### 2.3 监控指标表（超表）

```sql
-- 监控指标表
CREATE TABLE IF NOT EXISTS monitor_metrics (
    id BIGSERIAL PRIMARY KEY,
    time TIMESTAMPTZ NOT NULL,
    metric_name VARCHAR(255) NOT NULL,
    metric_type VARCHAR(20) NOT NULL,
    metric_value DOUBLE PRECISION,
    service_name VARCHAR(100),
    instance VARCHAR(255),
    tags JSONB,
    metric_unit VARCHAR(20),
    description TEXT,
    tenant_id BIGINT,
    created_time TIMESTAMPTZ DEFAULT NOW(),
    updated_time TIMESTAMPTZ DEFAULT NOW(),
    deleted INTEGER DEFAULT 0
);

-- 转换为超表
SELECT create_hypertable('monitor_metrics', 'time', if_not_exists => TRUE);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_monitor_metrics_time ON monitor_metrics (time DESC);
CREATE INDEX IF NOT EXISTS idx_monitor_metrics_metric_name ON monitor_metrics (metric_name);
CREATE INDEX IF NOT EXISTS idx_monitor_metrics_service_name ON monitor_metrics (service_name);
CREATE INDEX IF NOT EXISTS idx_monitor_metrics_metric_type ON monitor_metrics (metric_type);
CREATE INDEX IF NOT EXISTS idx_monitor_metrics_tenant_id ON monitor_metrics (tenant_id);

-- 添加注释
COMMENT ON TABLE monitor_metrics IS '监控指标表（TimescaleDB 超表）';
COMMENT ON COLUMN monitor_metrics.time IS '时间戳';
COMMENT ON COLUMN monitor_metrics.metric_name IS '指标名称';
COMMENT ON COLUMN monitor_metrics.metric_type IS '指标类型（GAUGE, COUNTER, SUMMARY, HISTOGRAM）';
COMMENT ON COLUMN monitor_metrics.metric_value IS '指标值';
COMMENT ON COLUMN monitor_metrics.service_name IS '服务名称';
COMMENT ON COLUMN monitor_metrics.instance IS '实例标识';
COMMENT ON COLUMN monitor_metrics.tags IS '标签（JSONB）';
COMMENT ON COLUMN monitor_metrics.metric_unit IS '指标单位';
COMMENT ON COLUMN monitor_metrics.description IS '描述';
```

## 3. 告警引擎表

### 3.1 告警规则表

```sql
-- 告警规则表
CREATE TABLE IF NOT EXISTS alert_rule (
    id BIGSERIAL PRIMARY KEY,
    rule_name VARCHAR(255) NOT NULL,
    description TEXT,
    rule_type VARCHAR(20) NOT NULL,
    metric_name VARCHAR(255),
    service_name VARCHAR(100),
    condition_type VARCHAR(10) NOT NULL,
    threshold DOUBLE PRECISION NOT NULL,
    duration BIGINT NOT NULL,
    check_interval BIGINT NOT NULL,
    severity VARCHAR(20) NOT NULL,
    alert_title VARCHAR(255),
    alert_message TEXT,
    notify_channels JSONB,
    notify_config JSONB,
    enabled BOOLEAN DEFAULT TRUE,
    silence_start TIMESTAMPTZ,
    silence_end TIMESTAMPTZ,
    label_filters JSONB,
    tenant_id BIGINT,
    created_time TIMESTAMPTZ DEFAULT NOW(),
    updated_time TIMESTAMPTZ DEFAULT NOW(),
    created_by VARCHAR(100),
    updated_by VARCHAR(100),
    deleted INTEGER DEFAULT 0
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_alert_rule_enabled ON alert_rule (enabled);
CREATE INDEX IF NOT EXISTS idx_alert_rule_rule_type ON alert_rule (rule_type);
CREATE INDEX IF NOT EXISTS idx_alert_rule_severity ON alert_rule (severity);
CREATE INDEX IF NOT EXISTS idx_alert_rule_tenant_id ON alert_rule (tenant_id);

-- 添加注释
COMMENT ON TABLE alert_rule IS '告警规则表';
COMMENT ON COLUMN alert_rule.rule_name IS '规则名称';
COMMENT ON COLUMN alert_rule.description IS '规则描述';
COMMENT ON COLUMN alert_rule.rule_type IS '规则类型（METRIC, TRACE, LOG）';
COMMENT ON COLUMN alert_rule.metric_name IS '监控指标名称';
COMMENT ON COLUMN alert_rule.service_name IS '服务名称';
COMMENT ON COLUMN alert_rule.condition_type IS '条件类型（GT, LT, GTE, LTE, EQ, NEQ）';
COMMENT ON COLUMN alert_rule.threshold IS '阈值';
COMMENT ON COLUMN alert_rule.duration IS '持续时间（秒）';
COMMENT ON COLUMN alert_rule.check_interval IS '检测间隔（秒）';
COMMENT ON COLUMN alert_rule.severity IS '告警级别（INFO, WARNING, CRITICAL）';
COMMENT ON COLUMN alert_rule.alert_title IS '告警标题';
COMMENT ON COLUMN alert_rule.alert_message IS '告警消息模板';
COMMENT ON COLUMN alert_rule.notify_channels IS '通知渠道（JSONB）';
COMMENT ON COLUMN alert_rule.notify_config IS '通知配置（JSONB）';
COMMENT ON COLUMN alert_rule.enabled IS '是否启用';
COMMENT ON COLUMN alert_rule.silence_start IS '静默开始时间';
COMMENT ON COLUMN alert_rule.silence_end IS '静默结束时间';
COMMENT ON COLUMN alert_rule.label_filters IS '标签过滤（JSONB）';
```

### 3.2 告警实例表

```sql
-- 告警实例表
CREATE TABLE IF NOT EXISTS alert_instance (
    id BIGSERIAL PRIMARY KEY,
    rule_id BIGINT NOT NULL,
    rule_name VARCHAR(255) NOT NULL,
    severity VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    firing_time TIMESTAMPTZ NOT NULL,
    resolved_time TIMESTAMPTZ,
    duration BIGINT,
    service_name VARCHAR(100),
    instance VARCHAR(255),
    metric_name VARCHAR(255),
    current_value DOUBLE PRECISION,
    threshold DOUBLE PRECISION,
    alert_title VARCHAR(255),
    alert_message TEXT,
    labels JSONB,
    notify_count INTEGER DEFAULT 0,
    last_notify_time TIMESTAMPTZ,
    tenant_id BIGINT,
    created_time TIMESTAMPTZ DEFAULT NOW(),
    updated_time TIMESTAMPTZ DEFAULT NOW(),
    deleted INTEGER DEFAULT 0
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_alert_instance_rule_id ON alert_instance (rule_id);
CREATE INDEX IF NOT EXISTS idx_alert_instance_status ON alert_instance (status);
CREATE INDEX IF NOT EXISTS idx_alert_instance_severity ON alert_instance (severity);
CREATE INDEX IF NOT EXISTS idx_alert_instance_firing_time ON alert_instance (firing_time DESC);
CREATE INDEX IF NOT EXISTS idx_alert_instance_service_name ON alert_instance (service_name);
CREATE INDEX IF NOT EXISTS idx_alert_instance_tenant_id ON alert_instance (tenant_id);

-- 添加注释
COMMENT ON TABLE alert_instance IS '告警实例表';
COMMENT ON COLUMN alert_instance.rule_id IS '告警规则 ID';
COMMENT ON COLUMN alert_instance.rule_name IS '告警规则名称';
COMMENT ON COLUMN alert_instance.severity IS '告警级别（INFO, WARNING, CRITICAL）';
COMMENT ON COLUMN alert_instance.status IS '告警状态（PENDING, FIRING, RESOLVED）';
COMMENT ON COLUMN alert_instance.firing_time IS '触发时间';
COMMENT ON COLUMN alert_instance.resolved_time IS '解决时间';
COMMENT ON COLUMN alert_instance.duration IS '持续时间（秒）';
COMMENT ON COLUMN alert_instance.service_name IS '服务名称';
COMMENT ON COLUMN alert_instance.instance IS '实例标识';
COMMENT ON COLUMN alert_instance.metric_name IS '指标名称';
COMMENT ON COLUMN alert_instance.current_value IS '当前值';
COMMENT ON COLUMN alert_instance.threshold IS '阈值';
COMMENT ON COLUMN alert_instance.alert_title IS '告警标题';
COMMENT ON COLUMN alert_instance.alert_message IS '告警消息';
COMMENT ON COLUMN alert_instance.labels IS '标签（JSONB）';
COMMENT ON COLUMN alert_instance.notify_count IS '通知次数';
COMMENT ON COLUMN alert_instance.last_notify_time IS '最后通知时间';
```

### 3.3 告警历史表（超表）

```sql
-- 告警历史表
CREATE TABLE IF NOT EXISTS alert_history (
    id BIGSERIAL PRIMARY KEY,
    instance_id BIGINT NOT NULL,
    rule_id BIGINT NOT NULL,
    rule_name VARCHAR(255) NOT NULL,
    severity VARCHAR(20) NOT NULL,
    status_change VARCHAR(20) NOT NULL,
    change_time TIMESTAMPTZ NOT NULL,
    change_reason TEXT,
    operator VARCHAR(100),
    alert_title VARCHAR(255),
    alert_message TEXT,
    tenant_id BIGINT,
    created_time TIMESTAMPTZ DEFAULT NOW(),
    deleted INTEGER DEFAULT 0
);

-- 转换为超表
SELECT create_hypertable('alert_history', 'change_time', if_not_exists => TRUE);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_alert_history_instance_id ON alert_history (instance_id);
CREATE INDEX IF NOT EXISTS idx_alert_history_rule_id ON alert_history (rule_id);
CREATE INDEX IF NOT EXISTS idx_alert_history_change_time ON alert_history (change_time DESC);
CREATE INDEX IF NOT EXISTS idx_alert_history_status_change ON alert_history (status_change);
CREATE INDEX IF NOT EXISTS idx_alert_history_tenant_id ON alert_history (tenant_id);

-- 添加注释
COMMENT ON TABLE alert_history IS '告警历史表（TimescaleDB 超表）';
COMMENT ON COLUMN alert_history.instance_id IS '告警实例 ID';
COMMENT ON COLUMN alert_history.rule_id IS '告警规则 ID';
COMMENT ON COLUMN alert_history.rule_name IS '告警规则名称';
COMMENT ON COLUMN alert_history.severity IS '告警级别';
COMMENT ON COLUMN alert_history.status_change IS '状态变更（FIRING, RESOLVED, ACKNOWLEDGED）';
COMMENT ON COLUMN alert_history.change_time IS '变更时间';
COMMENT ON COLUMN alert_history.change_reason IS '变更原因';
COMMENT ON COLUMN alert_history.operator IS '操作人';
```

## 4. 其他表

### 4.1 监控面板表

```sql
-- 监控面板表
CREATE TABLE IF NOT EXISTS monitor_dashboard (
    id BIGSERIAL PRIMARY KEY,
    dashboard_name VARCHAR(255) NOT NULL,
    dashboard_type VARCHAR(50),
    description TEXT,
    config JSONB,
    is_default BOOLEAN DEFAULT FALSE,
    tenant_id BIGINT,
    created_time TIMESTAMPTZ DEFAULT NOW(),
    updated_time TIMESTAMPTZ DEFAULT NOW(),
    created_by VARCHAR(100),
    updated_by VARCHAR(100),
    deleted INTEGER DEFAULT 0
);

-- 添加注释
COMMENT ON TABLE monitor_dashboard IS '监控面板表';
COMMENT ON COLUMN monitor_dashboard.dashboard_name IS '面板名称';
COMMENT ON COLUMN monitor_dashboard.dashboard_type IS '面板类型';
COMMENT ON COLUMN monitor_dashboard.description IS '描述';
COMMENT ON COLUMN monitor_dashboard.config IS '配置（JSONB）';
COMMENT ON COLUMN monitor_dashboard.is_default IS '是否默认';
```

### 4.2 监控收藏表

```sql
-- 监控收藏表
CREATE TABLE IF NOT EXISTS monitor_favorite (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    favorite_type VARCHAR(50) NOT NULL,
    favorite_id BIGINT NOT NULL,
    favorite_name VARCHAR(255),
    tenant_id BIGINT,
    created_time TIMESTAMPTZ DEFAULT NOW(),
    deleted INTEGER DEFAULT 0
);

-- 创建唯一索引
CREATE UNIQUE INDEX IF NOT EXISTS idx_monitor_favorite_user ON monitor_favorite (user_id, favorite_type, favorite_id);

-- 添加注释
COMMENT ON TABLE monitor_favorite IS '监控收藏表';
COMMENT ON COLUMN monitor_favorite.user_id IS '用户 ID';
COMMENT ON COLUMN monitor_favorite.favorite_type IS '收藏类型';
COMMENT ON COLUMN monitor_favorite.favorite_id IS '收藏项 ID';
COMMENT ON COLUMN monitor_favorite.favorite_name IS '收藏项名称';
```

## 5. 初始化数据

```sql
-- 插入默认监控面板
INSERT INTO monitor_dashboard (dashboard_name, dashboard_type, description, config, is_default)
VALUES
('系统概览', 'SYSTEM', '系统整体监控', '{}', TRUE),
('性能监控', 'PERFORMANCE', '服务性能监控', '{}', FALSE)
ON CONFLICT DO NOTHING;
```

## 6. 数据保留策略

```sql
-- 原始数据保留 7 天
SELECT add_retention_policy('monitor_metrics', INTERVAL '7 days');

-- 原始数据保留 30 天
SELECT add_retention_policy('monitor_log', INTERVAL '30 days');
SELECT add_retention_policy('monitor_trace', INTERVAL '30 days');
SELECT add_retention_policy('alert_history', INTERVAL '30 days');
```

## 7. 连续聚合（CAGG）

```sql
-- 1 小时聚合
CREATE MATERIALIZED VIEW IF NOT EXISTS monitor_metrics_1h
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', time) AS bucket,
    metric_name,
    service_name,
    metric_type,
    AVG(metric_value) AS avg_value,
    MIN(metric_value) AS min_value,
    MAX(metric_value) AS max_value,
    COUNT(*) AS count
FROM monitor_metrics
WHERE deleted = 0
GROUP BY bucket, metric_name, service_name, metric_type;

-- 添加保留策略（30 天）
SELECT add_retention_policy('monitor_metrics_1h', INTERVAL '30 days');

-- 1 天聚合
CREATE MATERIALIZED VIEW IF NOT EXISTS monitor_metrics_1d
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 day', time) AS bucket,
    metric_name,
    service_name,
    metric_type,
    AVG(metric_value) AS avg_value,
    MIN(metric_value) AS min_value,
    MAX(metric_value) AS max_value,
    COUNT(*) AS count
FROM monitor_metrics
WHERE deleted = 0
GROUP BY bucket, metric_name, service_name, metric_type;

-- 添加保留策略（1 年）
SELECT add_retention_policy('monitor_metrics_1d', INTERVAL '1 year');
```

## 8. 权限设置

```sql
-- 创建数据库用户
CREATE USER qooerp_monitor WITH PASSWORD 'qooerp_monitor_2026';

-- 授予权限
GRANT CONNECT ON DATABASE qooerp_monitor TO qooerp_monitor;
GRANT USAGE ON SCHEMA public TO qooerp_monitor;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO qooerp_monitor;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO qooerp_monitor;
```
