# QooERP 监控服务模块 - 数据设计文档

## 一、数据存储架构

qooerp-monitor 使用 **PostgreSQL + TimescaleDB** 存储监控数据：

- **业务表**：存储告警、服务、规则等元数据
- **超表（Hypertables）**：存储时序数据（metrics、traces、logs）
- **连续聚合视图**：数据降采样（1h、1d 聚合）
- **保留策略**：自动清理过期数据

---

## 二、TimescaleDB 超表（时序数据）

### 2.1 metrics 表（指标数据）

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| time | TIMESTAMPTZ | 时间戳 | 2026-02-18 10:30:45+08 |
| metric_name | TEXT | 指标名称 | jvm_memory_used_bytes |
| metric_type | TEXT | 指标类型 | gauge/counter/timer/summary |
| metric_value | DOUBLE PRECISION | 指标值 | 8589934592.0 |
| tags | JSONB | 标签 | {"application":"qooerp-gateway","env":"dev"} |
| instance | TEXT | 实例标识 | qooerp-gateway:8080 |

**索引**：
- `idx_metrics_name (metric_name, time DESC)`
- `idx_metrics_tags (tags) GIN 索引`
- `idx_metrics_instance (instance, time DESC)`

**分区策略**：按天分区（chunk_time_interval = 1 day）

**保留策略**：原始数据保留 7 天

### 2.2 traces 表（链路追踪数据）

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| time | TIMESTAMPTZ | 时间戳 | 2026-02-18 10:30:45+08 |
| trace_id | TEXT | 追踪 ID | 7b8f9e8c7a8b4b8a8f9e8c7a8b4b |
| span_id | TEXT | 跨度 ID | a8b4b8a8f9e8c7 |
| parent_span_id | TEXT | 父跨度 ID | 7b8f9e8c7a8b |
| span_name | TEXT | 跨度名称 | HTTP GET /api/users |
| span_kind | TEXT | 跨度类型 | SERVER/CLIENT/PRODUCER |
| duration_ms | BIGINT | 持续时间 | 156 |
| status_code | TEXT | 状态码 | OK/ERROR |
| tags | JSONB | 标签 | {"http.method":"GET","http.status_code":200} |
| instance | TEXT | 实例标识 | qooerp-gateway:8080 |

**索引**：
- `idx_traces_id (trace_id, time DESC)`
- `idx_traces_span (span_id)`
- `idx_traces_name (span_name, time DESC)`
- `idx_traces_tags (tags) GIN 索引`

**分区策略**：按周分区（chunk_time_interval = 7 days）

**保留策略**：原始数据保留 30 天

### 2.3 logs 表（日志数据）

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| time | TIMESTAMPTZ | 时间戳 | 2026-02-18 10:30:45+08 |
| level | TEXT | 日志级别 | DEBUG/INFO/WARN/ERROR |
| logger_name | TEXT | 日志记录器名称 | com.qoobot.hr.EmployeeController |
| message | TEXT | 日志消息 | Employee created successfully |
| trace_id | TEXT | 关联追踪 ID | 7b8f9e8c7a8b4b8a8f9e8c7a8b4b |
| span_id | TEXT | 关联跨度 ID | a8b4b8a8f9e8c7 |
| thread_name | TEXT | 线程名称 | http-nio-8080-exec-1 |
| context | JSONB | 上下文信息 | {"userId":12345,"tenantId":1} |
| instance | TEXT | 实例标识 | qooerp-gateway:8080 |

**索引**：
- `idx_logs_level (level, time DESC)`
- `idx_logs_trace (trace_id)`
- `idx_logs_logger (logger_name, time DESC)`
- `idx_logs_context (context) GIN 索引`

**分区策略**：按周分区（chunk_time_interval = 7 days）

**保留策略**：原始数据保留 30 天

---

## 三、连续聚合视图（降采样）

### 3.1 metrics_1h（1 小时聚合）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| time | TIMESTAMPTZ | 时间桶（1 小时） |
| metric_name | TEXT | 指标名称 |
| metric_type | TEXT | 指标类型 |
| application | TEXT | 应用名称（从 tags 提取） |
| env | TEXT | 环境标识（从 tags 提取） |
| avg_value | DOUBLE PRECISION | 平均值 |
| max_value | DOUBLE PRECISION | 最大值 |
| min_value | DOUBLE PRECISION | 最小值 |
| sample_count | BIGINT | 样本数量 |

**聚合策略**：每小时自动更新

**保留策略**：聚合数据保留 30 天

### 3.2 metrics_1d（1 天聚合）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| time | TIMESTAMPTZ | 时间桶（1 天） |
| metric_name | TEXT | 指标名称 |
| metric_type | TEXT | 指标类型 |
| application | TEXT | 应用名称（从 tags 提取） |
| env | TEXT | 环境标识（从 tags 提取） |
| avg_value | DOUBLE PRECISION | 平均值 |
| max_value | DOUBLE PRECISION | 最大值 |
| min_value | DOUBLE PRECISION | 最小值 |
| sample_count | BIGINT | 样本数量 |

**聚合策略**：每天自动更新

**保留策略**：聚合数据保留 1 年

---

## 四、业务表（元数据）

### 4.1 monitor_service（监控服务表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGSERIAL | 主键 |
| service_name | VARCHAR(100) | 服务名称 |
| service_address | VARCHAR(200) | 服务地址 |
| service_port | INTEGER | 服务端口 |
| status | SMALLINT | 状态(0:离线 1:在线) |
| health_status | SMALLINT | 健康状态(0:异常 1:正常) |
| last_check_time | TIMESTAMP | 最后检查时间 |
| tenant_id | BIGINT | 租户 ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| deleted | SMALLINT | 是否删除 |

**索引**：`idx_monitor_service_tenant_id (tenant_id)`

**约束**：`uk_service_name UNIQUE (service_name, tenant_id, deleted)`

### 4.2 monitor_alert（告警信息表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGSERIAL | 主键 |
| rule_id | BIGINT | 告警规则 ID |
| rule_name | VARCHAR(100) | 规则名称 |
| alert_level | SMALLINT | 告警级别(0:信息 1:警告 2:严重 3:紧急) |
| alert_message | TEXT | 告警消息 |
| triggered_at | TIMESTAMPTZ | 触发时间 |
| recovered_at | TIMESTAMPTZ | 恢复时间 |
| status | VARCHAR(20) | 状态(ACTIVE/RECOVERED/CLOSED) |
| notification_sent | BOOLEAN | 是否已发送通知 |
| tenant_id | BIGINT | 租户 ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |

**索引**：
- `idx_monitor_alert_rule_id (rule_id)`
- `idx_monitor_alert_triggered_at (triggered_at DESC)`
- `idx_monitor_alert_status (status)`
- `idx_monitor_alert_tenant_id (tenant_id)`

### 4.3 monitor_alert_rule（告警规则表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGSERIAL | 主键 |
| rule_name | VARCHAR(100) | 规则名称 |
| rule_type | VARCHAR(50) | 规则类型(service/metric/business) |
| metric_name | VARCHAR(100) | 指标名称 |
| condition_operator | VARCHAR(10) | 条件操作符(gt/lt/ge/le/eq) |
| threshold_value | DECIMAL(20,6) | 阈值 |
| duration | INTEGER | 持续时间（秒） |
| alert_level | SMALLINT | 告警级别(0:信息 1:警告 2:严重 3:紧急) |
| enabled | SMALLINT | 是否启用(0:禁用 1:启用) |
| notification_channels | VARCHAR(200) | 通知渠道(逗号分隔) |
| description | TEXT | 规则描述 |
| tenant_id | BIGINT | 租户 ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| deleted | SMALLINT | 是否删除 |

**索引**：
- `idx_monitor_alert_rule_rule_type (rule_type)`
- `idx_monitor_alert_rule_enabled (enabled)`
- `idx_monitor_alert_rule_tenant_id (tenant_id)`

### 4.4 monitor_alert_channel（告警通知渠道表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGSERIAL | 主键 |
| channel_name | VARCHAR(100) | 渠道名称 |
| channel_type | VARCHAR(50) | 渠道类型(sms/email/site/webhook) |
| channel_config | TEXT | 渠道配置(JSON 格式) |
| enabled | SMALLINT | 是否启用(0:禁用 1:启用) |
| description | TEXT | 渠道描述 |
| tenant_id | BIGINT | 租户 ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| deleted | SMALLINT | 是否删除 |

**索引**：
- `idx_monitor_alert_channel_channel_type (channel_type)`
- `idx_monitor_alert_channel_enabled (enabled)`
- `idx_monitor_alert_channel_tenant_id (tenant_id)`

### 4.5 monitor_alert_handle（告警处理记录表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGSERIAL | 主键 |
| alert_id | BIGINT | 告警 ID |
| handler_id | BIGINT | 处理人 ID |
| handle_action | VARCHAR(50) | 处理动作(确认/关闭/忽略) |
| handle_remark | TEXT | 处理备注 |
| handle_time | TIMESTAMPTZ | 处理时间 |
| tenant_id | BIGINT | 租户 ID |

**索引**：
- `idx_monitor_alert_handle_alert_id (alert_id)`
- `idx_monitor_alert_handle_handler_id (handler_id)`
- `idx_monitor_alert_handle_handle_time (handle_time DESC)`
- `idx_monitor_alert_handle_tenant_id (tenant_id)`

---

## 五、视图（辅助查询）

### 5.1 active_alerts（活跃告警视图）

```sql
CREATE OR REPLACE VIEW active_alerts AS
SELECT
    ma.id,
    ma.rule_id,
    ma.rule_name,
    ma.alert_level,
    ma.alert_message,
    ma.triggered_at,
    ma.status,
    CASE ma.alert_level
        WHEN 0 THEN '信息'
        WHEN 1 THEN '警告'
        WHEN 2 THEN '严重'
        WHEN 3 THEN '紧急'
    END AS alert_level_text,
    CASE ma.status
        WHEN 'ACTIVE' THEN '活跃'
        WHEN 'RECOVERED' THEN '已恢复'
        WHEN 'CLOSED' THEN '已关闭'
    END AS status_text
FROM monitor_alert ma
WHERE ma.status = 'ACTIVE'
ORDER BY ma.triggered_at DESC;
```

### 5.2 service_health_summary（服务健康统计视图）

```sql
CREATE OR REPLACE VIEW service_health_summary AS
SELECT
    ms.service_name,
    ms.status,
    ms.health_status,
    ms.last_check_time,
    COUNT(*) OVER () AS total_services,
    SUM(CASE WHEN ms.status = 1 AND ms.health_status = 1 THEN 1 ELSE 0 END) OVER () AS healthy_services,
    SUM(CASE WHEN ms.status = 0 OR ms.health_status = 0 THEN 1 ELSE 0 END) OVER () AS unhealthy_services
FROM monitor_service ms
WHERE ms.deleted = 0
ORDER BY ms.service_name;
```

### 5.3 metrics_trend_1h（指标趋势统计视图）

```sql
CREATE OR REPLACE VIEW metrics_trend_1h AS
SELECT
    time_bucket('1 minute', time) AS time,
    metric_name,
    metric_type,
    AVG(metric_value) AS avg_value,
    MAX(metric_value) AS max_value,
    MIN(metric_value) AS min_value,
    COUNT(*) AS count
FROM metrics
WHERE time > NOW() - INTERVAL '1 hour'
GROUP BY time_bucket('1 minute', time), metric_name, metric_type
ORDER BY time DESC;
```

---

## 六、存储过程和函数

### 6.1 create_alert（创建告警）

```sql
CREATE OR REPLACE FUNCTION create_alert(
    p_rule_id BIGINT,
    p_rule_name VARCHAR,
    p_alert_level SMALLINT,
    p_alert_message TEXT,
    p_tenant_id BIGINT
) RETURNS BIGINT AS $$
DECLARE
    v_alert_id BIGINT;
BEGIN
    INSERT INTO monitor_alert (rule_id, rule_name, alert_level, alert_message, triggered_at, tenant_id)
    VALUES (p_rule_id, p_rule_name, p_alert_level, p_alert_message, NOW(), p_tenant_id)
    RETURNING id INTO v_alert_id;

    RETURN v_alert_id;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 check_service_health（检查服务健康）

```sql
CREATE OR REPLACE FUNCTION check_service_health(p_service_name VARCHAR)
RETURNS TABLE(status SMALLINT) AS $$
BEGIN
    RETURN QUERY
    SELECT COALESCE(health_status, 0)
    FROM monitor_service
    WHERE service_name = p_service_name AND deleted = 0
    LIMIT 1;
END;
$$ LANGUAGE plpgsql;
```

### 6.3 get_latest_metric（获取指标最新值）

```sql
CREATE OR REPLACE FUNCTION get_latest_metric(
    p_metric_name TEXT,
    p_instance TEXT
) RETURNS DOUBLE PRECISION AS $$
BEGIN
    RETURN (
        SELECT metric_value
        FROM metrics
        WHERE metric_name = p_metric_name
          AND (p_instance IS NULL OR instance = p_instance)
        ORDER BY time DESC
        LIMIT 1
    );
END;
$$ LANGUAGE plpgsql;
```

---

## 七、数据流图

```
┌─────────────────────────────────────────────────────┐
│              微服务集群                              │
│  qooerp-gateway  qooerp-auth  qooerp-system  ...    │
└────────────┬──────────────────┬────────────────────┘
             │                  │
   OTLP Protocol         Micrometer
   (Traces/Metrics)      Push/Pull
             │                  │
┌────────────▼──────────────────▼────────────────────┐
│         qooerp-monitor 数据采集层                     │
└────────────┬──────────────────┬────────────────────┘
             │                  │
┌────────────▼──────────────────▼────────────────────┐
│         PostgreSQL + TimescaleDB                    │
│                                                        │
│  ┌────────────────────────────────────────────┐      │
│  │  TimescaleDB Hypertables (时序数据)        │      │
│  │  - metrics (按天分区, 保留7天)             │      │
│  │  - traces (按周分区, 保留30天)              │      │
│  │  - logs (按周分区, 保留30天)               │      │
│  └────────────────────────────────────────────┘      │
│                                                        │
│  ┌────────────────────────────────────────────┐      │
│  │  Continuous Aggregates (降采样)            │      │
│  │  - metrics_1h (保留30天)                   │      │
│  │  - metrics_1d (保留365天)                  │      │
│  └────────────────────────────────────────────┘      │
│                                                        │
│  ┌────────────────────────────────────────────┐      │
│  │  Business Tables (元数据)                  │      │
│  │  - monitor_service                        │      │
│  │  - monitor_alert                          │      │
│  │  - monitor_alert_rule                     │      │
│  │  - monitor_alert_channel                  │      │
│  │  - monitor_alert_handle                   │      │
│  └────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────┘
```

---

## 八、数据容量规划

### 8.1 存储容量估算

| 数据类型 | 采集频率 | 单条大小 | 日增量 | 保留期 | 总容量 |
|---------|---------|---------|--------|--------|--------|
| metrics | 10 秒/次 | 200 bytes | ~1.7 MB | 7 天 | ~12 MB |
| traces | 按需 | 500 bytes | ~500 MB | 30 天 | ~15 GB |
| logs | 按需 | 1 KB | ~1 GB | 30 天 | ~30 GB |
| 业务表 | - | - | ~10 KB | 永久 | ~10 MB |

**总计**：~45 GB / 月（取决于业务量）

### 8.2 性能优化建议

1. **索引优化**：
   - 超表主键自动包含 time 字段，无需额外索引
   - JSONB 字段使用 GIN 索引加速查询
   - 外键字段建立 B-Tree 索引

2. **分区策略**：
   - metrics 按天分区，适合高频查询
   - traces/logs 按周分区，平衡查询和存储

3. **降采样**：
   - 使用连续聚合视图降低存储成本
   - 查询历史趋势时优先使用聚合视图

4. **保留策略**：
   - 自动清理过期数据，避免磁盘占满
   - 可根据实际需求调整保留周期

---

**文档版本**: v1.1
**更新日期**: 2026-02-18
