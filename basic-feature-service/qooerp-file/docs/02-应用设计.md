# QooERP 文件服务模块 - 应用设计文档

## 一、核心接口

### 1.1 文件上传接口

```java
@RestController
@RequestMapping("/api/file")
public class FileController {

    @PostMapping("/upload")
    public Result<FileInfoDTO> upload(@RequestParam MultipartFile file,
                                       @RequestParam(required = false) Long folderId);

    @PostMapping("/upload/batch")
    public Result<List<FileInfoDTO>> batchUpload(@RequestParam List<MultipartFile> files,
                                                   @RequestParam(required = false) Long folderId);

    @PostMapping("/upload/chunk/init")
    public Result<String> initChunkUpload(@RequestBody ChunkUploadInitDTO dto);

    @PostMapping("/upload/chunk")
    public Result<Void> uploadChunk(@RequestParam String taskId,
                                     @RequestParam Integer chunkIndex,
                                     @RequestParam MultipartFile file);

    @PostMapping("/upload/chunk/complete")
    public Result<FileInfoDTO> completeChunkUpload(@RequestBody ChunkUploadCompleteDTO dto);

    @PostMapping("/upload/second-pass")
    public Result<FileInfoDTO> secondPassUpload(@RequestParam String fileMd5);
}
```

### 1.2 文件下载接口

```java
@GetMapping("/download/{id}")
public void download(@PathVariable Long id, HttpServletResponse response);

@GetMapping("/download/batch")
public void batchDownload(@RequestParam String ids, HttpServletResponse response);

@GetMapping("/download/{id}/chunk")
public void downloadChunk(@PathVariable Long id,
                          @RequestParam Integer chunkSize,
                          @RequestParam Integer chunkIndex,
                          HttpServletResponse response);
```

### 1.3 文件预览接口

```java
@GetMapping("/preview/{id}")
public void preview(@PathVariable Long id, HttpServletResponse response);

@GetMapping("/preview/{id}/thumbnail")
public void thumbnail(@PathVariable Long id,
                       @RequestParam(required = false) Integer width,
                       @RequestParam(required = false) Integer height,
                       HttpServletResponse response);
```

### 1.4 文件管理接口

```java
@GetMapping("/list")
public Result<PageResult<FileInfoDTO>> list(@RequestParam(required = false) Long folderId,
                                             @RequestParam(required = false) String fileName,
                                             @RequestParam(required = false) String fileType,
                                             @RequestParam(defaultValue = "1") Integer pageNum,
                                             @RequestParam(defaultValue = "20") Integer pageSize);

@GetMapping("/{id}")
public Result<FileInfoDTO> getInfo(@PathVariable Long id);

@PutMapping("/{id}/rename")
public Result<Void> rename(@PathVariable Long id, @RequestParam String newFileName);

@DeleteMapping("/{id}")
public Result<Void> delete(@PathVariable Long id);

@DeleteMapping("/batch")
public Result<Void> batchDelete(@RequestParam String ids);

@PutMapping("/{id}/move")
public Result<Void> move(@PathVariable Long id, @RequestParam Long targetFolderId);
```

### 1.5 文件分享接口

```java
@PostMapping("/share/{id}")
public Result<String> createShare(@PathVariable Long id, @RequestBody FileShareCreateDTO dto);

@GetMapping("/share/{code}")
public Result<FileInfoDTO> accessShare(@PathVariable String code,
                                         @RequestParam(required = false) String password);

@GetMapping("/share/{code}/info")
public Result<FileShareDTO> getShareInfo(@PathVariable String code);

@DeleteMapping("/share/{id}")
public Result<Void> cancelShare(@PathVariable Long id);

@GetMapping("/share/list")
public Result<List<FileShareDTO>> listShares(@RequestParam Long fileId);
```

### 1.6 文件夹管理接口

```java
@PostMapping("/folder")
public Result<FileFolderDTO> createFolder(@RequestBody FileFolderCreateDTO dto);

@GetMapping("/folder/list")
public Result<List<FileFolderDTO>> listFolders(@RequestParam(required = false) Long parentId);

@GetMapping("/folder/{id}/tree")
public Result<List<FileFolderDTO>> getFolderTree(@PathVariable Long id);

@PutMapping("/folder/{id}")
public Result<Void> updateFolder(@PathVariable Long id, @RequestBody FileFolderUpdateDTO dto);

@DeleteMapping("/folder/{id}")
public Result<Void> deleteFolder(@PathVariable Long id);
```

### 1.7 存储管理接口

```java
@GetMapping("/quota/info")
public Result<FileQuotaDTO> getQuotaInfo();

@GetMapping("/storage/statistics")
public Result<StorageStatisticsDTO> getStatistics();

@DeleteMapping("/storage/cleanup")
public Result<Void> cleanup(@RequestParam Integer days);
```

### 1.8 日志接口

```java
@GetMapping("/log/list")
public Result<PageResult<FileLogDTO>> listLogs(@RequestParam(required = false) Long fileId,
                                                @RequestParam(required = false) String operation,
                                                @RequestParam(defaultValue = "1") Integer pageNum,
                                                @RequestParam(defaultValue = "20") Integer pageSize);
```

---

**文档版本**: v1.1
