# QooERP 任务调度模块 - 数据设计文档

> 版本：v1.0
> 创建日期：20xx-xx-xx
> 更新日期：20xx-xx-xx

---

## 一、数据库表设计

### 1.1 schedule_job（定时任务表）

#### 表说明

存储定时任务的基本信息和配置。

#### 字段说明

| 字段名 | 类型 | 长度 | 非空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | - | 是 | - | 主键,自增 |
| job_no | VARCHAR | 50 | 是 | - | 任务编号,唯一 |
| job_name | VARCHAR | 200 | 是 | - | 任务名称 |
| job_type | VARCHAR | 20 | 是 | - | 任务类型:CRON/INTERVAL/ONCE/DEPENDENT |
| job_class | VARCHAR | 500 | 是 | - | 任务类全限定名 |
| cron_expression | VARCHAR | 100 | 否 | - | Cron表达式 |
| interval | INTEGER | - | 否 | - | 执行间隔(秒) |
| execute_strategy | VARCHAR | 20 | 是 | NOW | 执行策略:NOW/SCHEDULE/RETRY/SKIP |
| retry_strategy | VARCHAR | 20 | 是 | NONE | 重试策略:NONE/FIXED/EXPONENTIAL/LINEAR |
| retry_count | INTEGER | - | 是 | 0 | 重试次数 |
| timeout | INTEGER | - | 否 | - | 超时时间(秒) |
| concurrency | VARCHAR | 20 | 是 | SERIAL | 并发策略:SERIAL/PARALLEL |
| dependent_job_id | BIGINT | - | 否 | - | 依赖任务ID |
| status | VARCHAR | 20 | 是 | STOPPED | 状态:STOPPED/RUNNING/PAUSED/DELETED |
| next_execute_time | TIMESTAMP | - | 否 | - | 下次执行时间 |
| prev_execute_time | TIMESTAMP | - | 否 | - | 上次执行时间 |
| execute_count | BIGINT | - | 是 | 0 | 执行次数 |
| success_count | BIGINT | - | 是 | 0 | 成功次数 |
| fail_count | BIGINT | - | 是 | 0 | 失败次数 |
| tenant_id | BIGINT | - | 是 | - | 租户ID |
| create_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |
| deleted | SMALLINT | - | 是 | 0 | 删除标记:0-正常,1-删除 |

#### 索引

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| uk_job_no | UNIQUE | job_no, tenant_id, deleted | 任务编号唯一索引 |
| idx_tenant_id | NORMAL | tenant_id | 租户ID索引 |
| idx_status | NORMAL | status | 状态索引 |
| idx_next_execute_time | NORMAL | next_execute_time | 下次执行时间索引 |

---

### 1.2 schedule_log（任务日志表）

#### 表说明

存储任务执行日志。

#### 字段说明

| 字段名 | 类型 | 长度 | 非空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | - | 是 | - | 主键,自增 |
| job_id | BIGINT | - | 是 | - | 任务ID |
| execute_time | TIMESTAMP | - | 是 | - | 执行时间 |
| execute_result | TEXT | - | 否 | - | 执行结果 |
| execute_duration | BIGINT | - | 否 | - | 执行时长(毫秒) |
| status | VARCHAR | 20 | 是 | - | 状态:SUCCESS/FAILURE/RUNNING/TIMEOUT |
| exception_info | TEXT | - | 否 | - | 异常信息 |
| tenant_id | BIGINT | - | 是 | - | 租户ID |
| create_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |

#### 索引

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| idx_job_id | NORMAL | job_id | 任务ID索引 |
| idx_execute_time | NORMAL | execute_time | 执行时间索引 |
| idx_status | NORMAL | status | 状态索引 |

---

### 1.3 schedule_config（任务配置表）

#### 表说明

存储任务配置参数。

#### 字段说明

| 字段名 | 类型 | 长度 | 非空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | - | 是 | - | 主键,自增 |
| job_id | BIGINT | - | 是 | - | 任务ID |
| config_key | VARCHAR | 100 | 是 | - | 配置键 |
| config_value | VARCHAR | 500 | 是 | - | 配置值 |
| config_desc | VARCHAR | 200 | 否 | - | 配置描述 |
| tenant_id | BIGINT | - | 是 | - | 租户ID |
| create_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |

#### 索引

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| uk_job_config | UNIQUE | job_id, config_key | 任务配置唯一索引 |
| idx_job_id | NORMAL | job_id | 任务ID索引 |

---

### 1.4 schedule_notify（任务报警表）

#### 表说明

存储任务报警通知记录。

#### 字段说明

| 字段名 | 类型 | 长度 | 非空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | - | 是 | - | 主键,自增 |
| job_id | BIGINT | - | 是 | - | 任务ID |
| notify_type | VARCHAR | 20 | 是 | - | 报警类型:FAILURE/TIMEOUT/RETRY |
| notify_level | VARCHAR | 20 | 是 | - | 报警级别:LOW/MEDIUM/HIGH/CRITICAL |
| notify_content | TEXT | - | 是 | - | 报警内容 |
| notify_time | TIMESTAMP | - | 是 | - | 报警时间 |
| status | VARCHAR | 20 | 是 | PENDING | 状态:PENDING/HANDLED/IGNORED |
| handler | VARCHAR | 100 | 否 | - | 处理人 |
| handle_time | TIMESTAMP | - | 否 | - | 处理时间 |
| handle_remark | TEXT | - | 否 | - | 处理备注 |
| tenant_id | BIGINT | - | 是 | - | 租户ID |
| create_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |

#### 索引

| 索引名 | 索引类型 | 字段 | 说明 |
|--------|---------|------|------|
| idx_job_id | NORMAL | job_id | 任务ID索引 |
| idx_notify_time | NORMAL | notify_time | 报警时间索引 |
| idx_status | NORMAL | status | 状态索引 |

---

## 二、ER图

```
+----------------+           +----------------+
|  schedule_job  |           | schedule_log   |
+----------------+           +----------------+
| PK | id         |           | PK | id         |
| UK | job_no     |     1    | FK | job_id     |
|    | job_name   | ---------+    | execute_time|
|    | ...        |           |    | ...        |
+----------------+           +----------------+
       | 1                               |
       |                                 | 1
       | N                               | N
+----------------+           +----------------+
|schedule_config |           |schedule_notify |
+----------------+           +----------------+
| PK | id         |           | PK | id         |
| FK | job_id     |           | FK | job_id     |
| UK | job_id,    |           |    | notify_type|
|    | config_key |           |    | ...        |
|    | ...        |           +----------------+
+----------------+
```

---

## 三、数据字典

### 3.1 job_type（任务类型）

| 值 | 说明 |
|----|------|
| CRON | Cron表达式调度 |
| INTERVAL | 固定间隔调度 |
| ONCE | 一次性任务 |
| DEPENDENT | 依赖任务 |

### 3.2 execute_strategy（执行策略）

| 值 | 说明 |
|----|------|
| NOW | 立即执行 |
| SCHEDULE | 按计划执行 |
| RETRY | 失败重试 |
| SKIP | 跳过本次执行 |

### 3.3 retry_strategy（重试策略）

| 值 | 说明 |
|----|------|
| NONE | 不重试 |
| FIXED | 固定次数重试 |
| EXPONENTIAL | 指数退避重试 |
| LINEAR | 线性重试 |

### 3.4 concurrency（并发策略）

| 值 | 说明 |
|----|------|
| SERIAL | 串行执行 |
| PARALLEL | 并发执行 |

### 3.5 status（任务状态）

| 值 | 说明 |
|----|------|
| STOPPED | 停止 |
| RUNNING | 运行中 |
| PAUSED | 暂停 |
| DELETED | 已删除 |

### 3.6 log_status（日志状态）

| 值 | 说明 |
|----|------|
| SUCCESS | 成功 |
| FAILURE | 失败 |
| RUNNING | 执行中 |
| TIMEOUT | 超时 |

### 3.7 notify_type（报警类型）

| 值 | 说明 |
|----|------|
| FAILURE | 失败报警 |
| TIMEOUT | 超时报警 |
| RETRY | 重试报警 |

### 3.8 notify_level（报警级别）

| 值 | 说明 |
|----|------|
| LOW | 低 |
| MEDIUM | 中 |
| HIGH | 高 |
| CRITICAL | 严重 |

### 3.9 notify_status（报警状态）

| 值 | 说明 |
|----|------|
| PENDING | 待处理 |
| HANDLED | 已处理 |
| IGNORED | 已忽略 |

---

## 四、数据清理策略

### 4.1 日志清理

- 保留最近30天的执行日志
- 每天凌晨3点自动清理过期日志

### 4.2 报警清理

- 保留最近90天的报警记录
- 每天凌晨4点自动清理过期报警

### 4.3 配置清理

- 任务删除时同步删除配置
- 不保留历史配置记录

---

## 五、性能优化建议

### 5.1 索引优化

- 为常用查询字段创建索引
- 为状态字段创建索引,提升查询效率
- 为时间字段创建索引,支持时间范围查询

### 5.2 分表策略

- schedule_log 表按月分表,减少单表数据量
- schedule_notify 表按月分表,减少单表数据量

### 5.3 数据归档

- 超过1年的日志数据归档到历史表
- 超过3年的报警数据归档到历史表

---

*文档维护:请保持此文档的及时更新*
