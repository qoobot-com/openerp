# QooERP 任务调度模块 - 应用设计文档

> 版本：v1.0
> 创建日期：2026-02-17
> 更新日期：2026-02-18

---

## 一、核心实体类

### 1.1 ScheduleJob（定时任务）

```java
@Data
@TableName("schedule_job")
public class ScheduleJob {
    private Long id;
    private String jobNo;
    private String jobName;
    private String jobType;
    private String jobClass;
    private String cronExpression;
    private Integer interval;
    private String executeStrategy;
    private String retryStrategy;
    private Integer retryCount;
    private Integer timeout;
    private String concurrency;
    private Long dependentJobId;
    private String status;
    private LocalDateTime nextExecuteTime;
    private LocalDateTime prevExecuteTime;
    private Long executeCount;
    private Long successCount;
    private Long failCount;
    private Long tenantId;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    private Integer deleted;
}
```

### 1.2 ScheduleLog（任务日志）

```java
@Data
@TableName("schedule_log")
public class ScheduleLog {
    private Long id;
    private Long jobId;
    private LocalDateTime executeTime;
    private String executeResult;
    private Long executeDuration;
    private String status;
    private String exceptionInfo;
    private Long tenantId;
    private LocalDateTime createTime;
}
```

### 1.3 ScheduleConfig（任务配置）

```java
@Data
@TableName("schedule_config")
public class ScheduleConfig {
    private Long id;
    private Long jobId;
    private String configKey;
    private String configValue;
    private String configDesc;
    private Long tenantId;
    private LocalDateTime createTime;
}
```

### 1.4 ScheduleNotify（任务报警）

```java
@Data
@TableName("schedule_notify")
public class ScheduleNotify {
    private Long id;
    private Long jobId;
    private String notifyType;
    private String notifyLevel;
    private String notifyContent;
    private LocalDateTime notifyTime;
    private String status;
    private String handler;
    private LocalDateTime handleTime;
    private Long tenantId;
    private LocalDateTime createTime;
}
```

---

## 二、核心 DTO 类

### 2.1 ScheduleJobDTO

```java
@Data
@Schema(description = "定时任务DTO")
public class ScheduleJobDTO {
    @Schema(description = "任务ID")
    private Long id;

    @Schema(description = "任务编号")
    private String jobNo;

    @Schema(description = "任务名称")
    private String jobName;

    @Schema(description = "任务类型")
    private String jobType;

    @Schema(description = "任务类")
    private String jobClass;

    @Schema(description = "Cron表达式")
    private String cronExpression;

    @Schema(description = "执行间隔(秒)")
    private Integer interval;

    @Schema(description = "执行策略")
    private String executeStrategy;

    @Schema(description = "重试策略")
    private String retryStrategy;

    @Schema(description = "重试次数")
    private Integer retryCount;

    @Schema(description = "超时时间(秒)")
    private Integer timeout;

    @Schema(description = "并发策略")
    private String concurrency;

    @Schema(description = "依赖任务ID")
    private Long dependentJobId;

    @Schema(description = "状态")
    private String status;

    @Schema(description = "下次执行时间")
    private LocalDateTime nextExecuteTime;

    @Schema(description = "上次执行时间")
    private LocalDateTime prevExecuteTime;

    @Schema(description = "执行次数")
    private Long executeCount;

    @Schema(description = "成功次数")
    private Long successCount;

    @Schema(description = "失败次数")
    private Long failCount;

    @Schema(description = "任务配置")
    private Map<String, String> config;
}
```

### 2.2 ScheduleLogDTO

```java
@Data
@Schema(description = "任务日志DTO")
public class ScheduleLogDTO {
    @Schema(description = "日志ID")
    private Long id;

    @Schema(description = "任务ID")
    private Long jobId;

    @Schema(description = "任务名称")
    private String jobName;

    @Schema(description = "执行时间")
    private LocalDateTime executeTime;

    @Schema(description = "执行结果")
    private String executeResult;

    @Schema(description = "执行时长(毫秒)")
    private Long executeDuration;

    @Schema(description = "状态")
    private String status;

    @Schema(description = "异常信息")
    private String exceptionInfo;
}
```

### 2.3 JobQueryDTO

```java
@Data
@Schema(description = "任务查询DTO")
public class JobQueryDTO {
    @Schema(description = "任务编号")
    private String jobNo;

    @Schema(description = "任务名称")
    private String jobName;

    @Schema(description = "任务类型")
    private String jobType;

    @Schema(description = "状态")
    private String status;

    @Schema(description = "当前页码")
    private Integer current = 1;

    @Schema(description = "每页条数")
    private Integer size = 10;
}
```

### 2.4 JobExecuteDTO

```java
@Data
@Schema(description = "任务执行DTO")
public class JobExecuteDTO {
    @Schema(description = "任务ID")
    private Long jobId;

    @Schema(description = "执行参数")
    private Map<String, Object> params;
}
```

---

## 三、核心 Service 接口

### 3.1 ScheduleJobService

```java
public interface ScheduleJobService {
    /**
     * 创建任务
     */
    ScheduleJobDTO createJob(ScheduleJobDTO dto);

    /**
     * 更新任务
     */
    ScheduleJobDTO updateJob(Long id, ScheduleJobDTO dto);

    /**
     * 删除任务
     */
    void deleteJob(Long id);

    /**
     * 根据ID查询任务
     */
    ScheduleJobDTO getJobById(Long id);

    /**
     * 分页查询任务
     */
    Page<ScheduleJobDTO> queryJobs(JobQueryDTO queryDTO);

    /**
     * 启动任务
     */
    void startJob(Long id);

    /**
     * 停止任务
     */
    void stopJob(Long id);

    /**
     * 暂停任务
     */
    void pauseJob(Long id);

    /**
     * 恢复任务
     */
    void resumeJob(Long id);

    /**
     * 手动执行任务
     */
    void executeJob(JobExecuteDTO dto);

    /**
     * 获取任务日志
     */
    Page<ScheduleLogDTO> getJobLogs(Long jobId, Integer current, Integer size);
}
```

### 3.2 ScheduleLogService

```java
public interface ScheduleLogService {
    /**
     * 记录执行日志
     */
    void logExecution(Long jobId, String status, String result, Long duration, String exception);

    /**
     * 查询执行日志
     */
    Page<ScheduleLogDTO> queryLogs(Long jobId, LocalDateTime startTime, LocalDateTime endTime, Integer current, Integer size);

    /**
     * 获取最近日志
     */
    List<ScheduleLogDTO> getRecentLogs(Long jobId, Integer limit);
}
```

### 3.3 ScheduleConfigService

```java
public interface ScheduleConfigService {
    /**
     * 设置任务配置
     */
    void setConfig(Long jobId, String configKey, String configValue, String configDesc);

    /**
     * 获取任务配置
     */
    Map<String, String> getConfig(Long jobId);

    /**
     * 删除任务配置
     */
    void deleteConfig(Long jobId, String configKey);
}
```

### 3.4 ScheduleNotifyService

```java
public interface ScheduleNotifyService {
    /**
     * 发送报警通知
     */
    void sendNotify(Long jobId, String notifyType, String notifyLevel, String notifyContent);

    /**
     * 查询报警记录
     */
    Page<ScheduleNotifyDTO> queryNotifies(Long jobId, String status, Integer current, Integer size);

    /**
     * 处理报警
     */
    void handleNotify(Long notifyId, String handler, String handleRemark);
}
```

---

## 四、核心 Controller 接口

### 4.1 ScheduleJobController

```java
@RestController
@RequestMapping("/api/scheduler/jobs")
@Tag(name = "定时任务管理", description = "定时任务相关接口")
public class ScheduleJobController {

    @PostMapping
    @Operation(summary = "创建任务")
    Result<ScheduleJobDTO> create(@RequestBody ScheduleJobDTO dto);

    @PutMapping("/{id}")
    @Operation(summary = "更新任务")
    Result<ScheduleJobDTO> update(@PathVariable Long id, @RequestBody ScheduleJobDTO dto);

    @DeleteMapping("/{id}")
    @Operation(summary = "删除任务")
    Result<Void> delete(@PathVariable Long id);

    @GetMapping("/{id}")
    @Operation(summary = "查询任务")
    Result<ScheduleJobDTO> getById(@PathVariable Long id);

    @GetMapping
    @Operation(summary = "分页查询任务")
    Result<Page<ScheduleJobDTO>> query(JobQueryDTO queryDTO);

    @PostMapping("/{id}/start")
    @Operation(summary = "启动任务")
    Result<Void> start(@PathVariable Long id);

    @PostMapping("/{id}/stop")
    @Operation(summary = "停止任务")
    Result<Void> stop(@PathVariable Long id);

    @PostMapping("/{id}/pause")
    @Operation(summary = "暂停任务")
    Result<Void> pause(@PathVariable Long id);

    @PostMapping("/{id}/resume")
    @Operation(summary = "恢复任务")
    Result<Void> resume(@PathVariable Long id);

    @PostMapping("/execute")
    @Operation(summary = "手动执行任务")
    Result<Void> execute(@RequestBody JobExecuteDTO dto);

    @GetMapping("/{id}/logs")
    @Operation(summary = "获取任务日志")
    Result<Page<ScheduleLogDTO>> getLogs(
        @PathVariable Long id,
        @RequestParam(defaultValue = "1") Integer current,
        @RequestParam(defaultValue = "10") Integer size);
}
```

### 4.2 ScheduleLogController

```java
@RestController
@RequestMapping("/api/scheduler/logs")
@Tag(name = "任务日志管理", description = "任务日志相关接口")
public class ScheduleLogController {

    @GetMapping
    @Operation(summary = "查询执行日志")
    Result<Page<ScheduleLogDTO>> query(
        @RequestParam Long jobId,
        @RequestParam(required = false) String startTime,
        @RequestParam(required = false) String endTime,
        @RequestParam(defaultValue = "1") Integer current,
        @RequestParam(defaultValue = "10") Integer size);

    @GetMapping("/recent/{jobId}")
    @Operation(summary = "获取最近日志")
    Result<List<ScheduleLogDTO>> getRecent(
        @PathVariable Long jobId,
        @RequestParam(defaultValue = "10") Integer limit);
}
```

### 4.3 ScheduleConfigController

```java
@RestController
@RequestMapping("/api/scheduler/configs")
@Tag(name = "任务配置管理", description = "任务配置相关接口")
public class ScheduleConfigController {

    @PostMapping
    @Operation(summary = "设置任务配置")
    Result<Void> setConfig(
        @RequestParam Long jobId,
        @RequestParam String configKey,
        @RequestParam String configValue,
        @RequestParam(required = false) String configDesc);

    @GetMapping("/{jobId}")
    @Operation(summary = "获取任务配置")
    Result<Map<String, String>> getConfig(@PathVariable Long jobId);

    @DeleteMapping("/{jobId}/{configKey}")
    @Operation(summary = "删除任务配置")
    Result<Void> deleteConfig(@PathVariable Long jobId, @PathVariable String configKey);
}
```

### 4.4 ScheduleNotifyController

```java
@RestController
@RequestMapping("/api/scheduler/notifies")
@Tag(name = "任务报警管理", description = "任务报警相关接口")
public class ScheduleNotifyController {

    @GetMapping
    @Operation(summary = "查询报警记录")
    Result<Page<ScheduleNotifyDTO>> query(
        @RequestParam(required = false) Long jobId,
        @RequestParam(required = false) String status,
        @RequestParam(defaultValue = "1") Integer current,
        @RequestParam(defaultValue = "10") Integer size);

    @PostMapping("/{notifyId}/handle")
    @Operation(summary = "处理报警")
    Result<Void> handle(
        @PathVariable Long notifyId,
        @RequestParam String handler,
        @RequestParam(required = false) String handleRemark);
}
```

---

## 五、错误码定义

| 错误码 | 错误信息 | 说明 |
|--------|---------|------|
| SCHEDULE_001 | 任务不存在 | 指定的任务不存在 |
| SCHEDULE_002 | 任务已存在 | 任务编号已存在 |
| SCHEDULE_003 | Cron表达式无效 | Cron表达式格式错误 |
| SCHEDULE_004 | 任务正在运行 | 任务正在执行中,无法操作 |
| SCHEDULE_005 | 任务已停止 | 任务已停止,无法执行 |
| SCHEDULE_006 | 任务执行失败 | 任务执行过程中发生错误 |
| SCHEDULE_007 | 任务超时 | 任务执行超时 |
| SCHEDULE_008 | 依赖任务不存在 | 指定的依赖任务不存在 |
| SCHEDULE_009 | 依赖任务未完成 | 依赖任务未完成,无法执行 |
| SCHEDULE_010 | 配置项已存在 | 配置项已存在,无法添加 |

---

*文档维护:请保持此文档的及时更新*
