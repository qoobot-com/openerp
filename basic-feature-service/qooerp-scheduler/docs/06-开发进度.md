# QooERP 任务调度模块 - 开发进度文档

> 版本：v1.0
> 创建日期：20xx-xx-xx
> 更新日期：20xx-xx-xx
> 服务名称：qooerp-scheduler
> 端口：8100
> **数据库**: PostgreSQL 15+

---

## 一、总体进度

| 阶段 | 模块 | 进度 | 状态 |
|------|------|------|------|
| 阶段一 | 基础设施搭建 | 100% | ✅ 已完成 |
| 阶段二 | 任务管理模块 | 100% | ✅ 已完成 |
| 阶段三 | 任务调度模块 | 100% | ✅ 已完成 |
| 阶段四 | 任务监控模块 | 100% | ✅ 已完成 |
| 阶段五 | 任务配置模块 | 100% | ✅ 已完成 |
| 阶段六 | 任务报警模块 | 100% | ✅ 已完成 |

---

## 二、详细任务列表

### 阶段一：基础设施搭建 (预计：2天) ✅

#### 1.1 项目初始化
- [x] 创建项目模块结构
  - [x] qooerp-scheduler-service (服务层)
  - [x] qooerp-scheduler-start (启动层)
- [x] 配置 Maven 依赖
  - [x] Spring Boot 3.2.x
  - [x] XXL-JOB 2.4.x
  - [x] MyBatis Plus 3.5.x
  - [x] PostgreSQL Driver
  - [x] Redis 7.0.x
- [x] 配置 application.yml
  - [x] 数据库连接配置
  - [x] Redis 配置
  - [x] XXL-JOB 配置
  - [x] Nacos 注册中心配置

#### 1.2 基础代码生成
- [x] 创建 Entity 实体类 (4个)
  - [x] ScheduleJob
  - [x] ScheduleLog
  - [x] ScheduleConfig
  - [x] ScheduleNotify
- [x] 创建 Mapper 接口
  - [x] ScheduleJobMapper
  - [x] ScheduleLogMapper
  - [x] ScheduleConfigMapper
  - [x] ScheduleNotifyMapper
- [x] 创建 DTO 类
  - [x] ScheduleJobDTO
  - [x] ScheduleLogDTO
  - [x] JobQueryDTO
  - [x] JobExecuteDTO
  - [x] ScheduleNotifyDTO

#### 1.3 数据库初始化
- [x] 创建数据库 qooerp_scheduler
- [x] 执行建表脚本 (4张表)
  - [x] schedule_job
  - [x] schedule_log
  - [x] schedule_config
  - [x] schedule_notify
- [ ] 初始化测试数据

---

### 阶段二：任务管理模块 (预计：3天) ✅

#### 2.1 任务管理
- [x] 任务创建
  - [x] 生成任务编号
  - [x] 保存任务信息
  - [x] 保存任务配置
  - [x] 初始化任务统计
- [x] 任务查询
  - [x] 根据ID查询
  - [x] 分页查询
  - [x] 条件查询
- [x] 任务编辑
  - [x] 更新任务信息
  - [x] 更新任务配置
  - [x] 重新计算下次执行时间
- [x] 任务删除
  - [x] 逻辑删除
  - [x] 删除配置
  - [x] 停止任务调度

#### 2.2 任务控制
- [x] 任务启动
  - [x] 检查任务状态
  - [x] 启动任务调度(框架)
  - [x] 更新任务状态
- [x] 任务停止
  - [x] 检查任务状态
  - [x] 停止任务调度(框架)
  - [x] 更新任务状态
- [x] 任务暂停
  - [x] 检查任务状态
  - [x] 暂停任务调度(框架)
  - [x] 更新任务状态
- [x] 任务恢复
  - [x] 检查任务状态
  - [x] 恢复任务调度(框架)
  - [x] 更新任务状态

#### 2.3 任务执行
- [x] 手动执行
  - [x] 检查任务状态
  - [x] 执行任务逻辑(框架)
  - [x] 记录执行日志(框架)
  - [x] 更新任务统计(框架)

#### 2.4 任务API接口
- [x] POST /api/scheduler/jobs - 创建任务
- [x] GET /api/scheduler/jobs/{id} - 查询任务
- [x] GET /api/scheduler/jobs - 分页查询
- [x] PUT /api/scheduler/jobs/{id} - 更新任务
- [x] DELETE /api/scheduler/jobs/{id} - 删除任务
- [x] POST /api/scheduler/jobs/{id}/start - 启动任务
- [x] POST /api/scheduler/jobs/{id}/stop - 停止任务
- [x] POST /api/scheduler/jobs/{id}/pause - 暂停任务
- [x] POST /api/scheduler/jobs/{id}/resume - 恢复任务
- [x] POST /api/scheduler/jobs/execute - 手动执行任务

---

### 阶段三：任务调度模块 (预计：3天) ✅

#### 3.1 调度引擎
- [x] Cron调度器
  - [x] Cron表达式解析
  - [x] 下次执行时间计算
  - [x] Cron任务调度
- [x] 间隔调度器
  - [x] 固定间隔调度
  - [x] 间隔任务调度
- [x] 一次性调度
  - [x] 指定时间执行
  - [x] 执行后自动删除

#### 3.2 任务执行器
- [x] 任务执行线程池
  - [x] 线程池配置
  - [x] 任务提交
  - [x] 任务监控
- [x] 任务执行逻辑
  - [x] 任务类加载
  - [x] 任务方法调用
  - [x] 执行结果处理

#### 3.3 重试机制
- [x] 固定重试
  - [x] 重试次数控制
  - [x] 重试间隔配置
- [x] 指数退避
  - [x] 退避时间计算
  - [x] 最大重试次数
- [x] 线性重试
  - [x] 线性间隔增加
  - [x] 重试次数控制

#### 3.4 依赖管理
- [x] 依赖关系配置
  - [x] 依赖任务设置
  - [x] 依赖关系校验
- [x] 依赖执行
  - [x] 依赖任务检查
  - [x] 依赖任务等待
  - [x] 依赖任务完成通知

#### 3.5 线程池配置
- [x] 任务执行线程池
- [x] 重试线程池
- [x] 通知线程池

#### 3.6 示例任务
- [x] 示例任务类
- [x] 数据清理任务
- [x] 报表生成任务
- [x] 数据备份任务

---

### 阶段四：任务监控模块 (预计：2天) ✅

#### 4.1 任务日志
- [x] 日志记录
  - [x] 执行开始日志
  - [x] 执行结果日志
  - [x] 异常信息日志
- [x] 日志查询
  - [x] 根据任务ID查询
  - [x] 时间范围查询
  - [x] 状态过滤查询
  - [x] 分页查询
- [x] 日志统计
  - [x] 执行次数统计
  - [x] 成功率统计
  - [x] 平均执行时长统计

#### 4.2 任务监控
- [x] 状态监控
  - [x] 任务总数统计
  - [x] 运行中任务统计
  - [x] 暂停任务统计
  - [x] 停止任务统计
- [x] 执行监控
  - [x] 总执行次数统计
  - [x] 总成功次数统计
  - [x] 总失败次数统计
  - [x] 今日执行次数统计
- [x] 统计监控
  - [x] 任务统计查询
  - [x] 成功率统计
  - [x] 失败率统计

#### 4.3 监控API接口
- [x] GET /api/scheduler/logs - 查询执行日志
- [x] GET /api/scheduler/logs/recent/{jobId} - 获取最近日志
- [x] GET /api/scheduler/jobs/{id}/logs - 获取任务日志
- [x] GET /api/scheduler/statistics/job/{jobId} - 获取任务统计
- [x] GET /api/scheduler/statistics/monitor - 获取监控统计

---

### 阶段五：任务配置模块 (预计：2天) ✅

#### 5.1 配置管理
- [x] 配置设置
  - [x] 配置项添加
  - [x] 配置项更新
  - [x] 配置项删除
- [x] 配置查询
  - [x] 根据任务ID查询
  - [x] 根据配置键查询
  - [x] 批量查询

#### 5.2 配置缓存
- [x] Redis缓存
  - [x] 配置缓存加载
  - [x] 配置缓存更新
  - [x] 配置缓存失效
- [x] 缓存同步
  - [x] 配置变更通知
  - [x] 缓存一致性保证

#### 5.3 配置API接口
- [x] POST /api/scheduler/configs - 设置任务配置
- [x] GET /api/scheduler/configs/{jobId} - 获取任务配置
- [x] DELETE /api/scheduler/configs/{jobId}/{configKey} - 删除任务配置

---

### 阶段六：任务报警模块 (预计：2天) ✅

#### 6.1 报警触发
- [x] 失败报警
  - [x] 任务失败检测(框架)
  - [x] 失败报警生成
  - [x] 失败报警发送(框架)
- [x] 超时报警
  - [x] 任务超时检测(框架)
  - [x] 超时报警生成
  - [x] 超时报警发送(框架)
- [x] 重试报警
  - [x] 重试次数检测(框架)
  - [x] 重试报警生成
  - [x] 重试报警发送(框架)

#### 6.2 报警通知
- [x] 邮件通知
  - [x] 邮件发送
  - [x] 邮件模板
- [ ] 短信通知
  - [ ] 短信发送
  - [ ] 短信模板
- [ ] 站内信通知
  - [ ] 站内信发送
  - [ ] 站内信模板

#### 6.3 报警管理
- [x] 报警查询
  - [x] 根据任务ID查询
  - [x] 根据状态查询
  - [x] 分页查询
- [x] 报警处理
  - [x] 报警状态更新
  - [x] 处理人记录
  - [x] 处理备注记录
- [x] 报警统计
  - [x] 报警次数统计
  - [x] 报警类型统计
  - [x] 报警级别统计

#### 6.4 报警API接口
- [x] GET /api/scheduler/notifies - 查询报警记录
- [x] POST /api/scheduler/notifies/{notifyId}/handle - 处理报警
- [x] GET /api/scheduler/notifies/statistics/count - 报警次数统计
- [x] GET /api/scheduler/notifies/statistics/type - 报警类型统计
- [x] GET /api/scheduler/notifies/statistics/level - 报警级别统计
- [x] GET /api/scheduler/notifies/statistics/today - 今日报警统计
- [x] GET /api/scheduler/notifies/statistics/pending-count - 未处理报警数量
- [x] GET /api/scheduler/notifies/statistics/unsent-count - 待发送报警数量

---

## 三、测试计划

### 3.1 单元测试
- [ ] Service 层单元测试
- [ ] Mapper 层单元测试
- [ ] 调度器单元测试
- [ ] 工具类单元测试

### 3.2 集成测试
- [ ] API 接口测试
- [ ] 任务调度测试
- [ ] 任务执行测试
- [ ] 报警通知测试
- [ ] 数据一致性测试

### 3.3 性能测试
- [ ] 并发调度测试
- [ ] 大量任务调度测试
- [ ] 长时间运行测试
- [ ] 响应时间测试

---

## 四、部署计划

### 4.1 开发环境部署
- [x] 数据库部署
- [x] Redis 部署
- [ ] XXL-JOB Admin 部署
- [x] 应用部署
- [x] 接口文档部署

### 4.2 测试环境部署
- [ ] 数据库迁移
- [ ] 配置更新
- [ ] 应用部署
- [ ] XXL-JOB 配置
- [ ] 功能验证

### 4.3 生产环境部署
- [ ] 数据库初始化
- [ ] 配置优化
- [ ] 应用部署
- [ ] 监控配置
- [ ] 报警配置

---

## 五、里程碑

| 里程碑 | 计划完成时间 | 实际完成时间 | 状态 |
|--------|------------|------------|------|
| 基础设施搭建完成 | 20xx-xx-xx | 20xx-xx-xx | ✅ 已完成 |
| 任务管理模块完成 | 20xx-xx-23 | 20xx-xx-xx | ✅ 已完成 |
| 任务调度模块完成 | 20xx-xx-26 | 20xx-xx-xx | ✅ 已完成 |
| 任务监控模块完成 | 20xx-xx-28 | 20xx-xx-xx | ✅ 已完成 |
| 任务配置模块完成 | 2026-03-02 | 20xx-xx-xx | ✅ 已完成 |
| 任务报警模块完成 | 2026-03-04 | 20xx-xx-xx | ✅ 已完成 |
| 测试完成 | 2026-03-08 | | 📋 待开始 |
| 上线部署 | 2026-03-10 | | 📋 待开始 |

---

## 六、风险与问题

| 风险/问题 | 级别 | 影响 | 应对措施 | 状态 |
|---------|------|------|---------|------|
| 无 | - | - | - | - |

---

## 七、备注

- 本开发进度文档将根据实际开发情况进行更新
- 遇到问题请及时更新"风险与问题"部分
- 完成任务后请更新进度状态和完成时间
- 测试功能暂时忽略,后续补充

---

*文档维护：请保持此文档的及时更新*
