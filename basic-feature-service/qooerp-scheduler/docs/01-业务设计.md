# QooERP 任务调度模块 - 业务设计文档

> 模块名称: qooerp-scheduler
> 模块版本: v1.0
> 创建日期: 2026-02-17
> 更新日期: 2026-02-18

## 一、业务概述

任务调度模块提供统一的定时任务管理能力,支持任务创建、执行、监控等功能,为系统提供可靠的定时任务调度服务。

### 1.1 业务目标

- 提供统一的定时任务管理平台
- 支持多种任务调度方式(Cron、固定间隔、一次性任务)
- 支持任务执行状态监控和日志记录
- 支持任务失败重试和报警通知
- 支持任务依赖关系管理

### 1.2 适用场景

- 数据定期同步
- 报表定时生成
- 定期清理数据
- 消息定时推送
- 业务定时检查

---

## 二、核心功能

### 2.1 任务管理

#### 定时任务
- 任务创建: 创建新的定时任务
- 任务编辑: 修改任务配置
- 任务删除: 删除不需要的任务
- 任务查询: 查询任务列表和详情

#### 任务执行
- 手动执行: 立即执行指定任务
- 定时执行: 按照Cron表达式定时执行
- 间隔执行: 按照固定间隔执行
- 一次性执行: 指定时间执行一次

#### 任务调度
- Cron调度: 支持标准Cron表达式
- 间隔调度: 支持固定间隔调度
- 依赖调度: 支持任务依赖关系

### 2.2 任务监控

#### 任务状态
- 运行状态: 任务当前是否在运行
- 执行状态: 任务最近一次执行状态
- 下次执行时间: 任务下次执行时间
- 执行次数统计: 任务累计执行次数

#### 任务日志
- 执行日志: 记录每次执行详情
- 执行结果: 记录执行成功/失败结果
- 执行时长: 记录任务执行耗时
- 异常信息: 记录任务执行异常

### 2.3 任务管理

#### 任务控制
- 任务启动: 启动已停止的任务
- 任务停止: 停止正在运行的任务
- 任务暂停: 暂停任务调度
- 任务恢复: 恢复任务调度

#### 任务配置
- 执行策略: 配置任务执行策略
- 重试策略: 配置失败重试策略
- 超时配置: 配置任务执行超时时间
- 并发控制: 配置任务并发执行策略

### 2.4 任务报警

#### 报警通知
- 失败报警: 任务执行失败发送报警
- 超时报警: 任务执行超时发送报警
- 重试报警: 任务重试次数超限报警
- 通知方式: 邮件、短信、站内信

#### 报警规则
- 报警阈值: 设置报警触发条件
- 报警级别: 设置报警严重程度
- 报警人员: 设置报警接收人员
- 报警时间: 设置报警发送时间

---

## 三、领域模型

### 3.1 核心实体

```
ScheduleJob（定时任务）
├── 任务编号
├── 任务名称
├── 任务类型
├── 任务类
├── Cron表达式
├── 执行策略
├── 重试策略
├── 超时配置
├── 状态
├── 下次执行时间
├── 租户ID

ScheduleLog（任务日志）
├── 任务ID
├── 执行时间
├── 执行结果
├── 执行时长
├── 状态
├── 异常信息
├── 租户ID

ScheduleConfig（任务配置）
├── 任务ID
├── 配置键
├── 配置值
├── 配置描述

ScheduleNotify（任务报警）
├── 任务ID
├── 报警类型
├── 报警级别
├── 报警内容
├── 报警时间
├── 处理状态
```

### 3.2 实体关系

```
ScheduleJob (1) ---- (N) ScheduleLog
ScheduleJob (1) ---- (N) ScheduleConfig
ScheduleJob (1) ---- (N) ScheduleNotify
```

---

## 四、功能模块

| 模块 | 功能 |
|------|------|
| 任务管理 | 任务创建、编辑、删除、查询、手动执行 |
| 任务调度 | Cron调度、间隔调度、依赖调度 |
| 任务监控 | 状态监控、日志查询、统计分析 |
| 任务配置 | 执行策略、重试策略、超时配置 |
| 任务报警 | 失败报警、超时报警、通知管理 |
| 任务依赖 | 依赖关系配置、依赖执行管理 |

---

## 五、核心业务流程

### 5.1 任务创建流程

1. 创建任务基本信息
2. 配置任务执行策略
3. 配置任务重试策略
4. 配置任务报警规则
5. 保存任务信息
6. 启动任务调度

### 5.2 任务执行流程

1. 检查任务状态
2. 检查任务依赖
3. 加载任务配置
4. 执行任务逻辑
5. 记录执行日志
6. 更新任务状态
7. 发送报警通知(如需要)

### 5.3 任务监控流程

1. 实时监控任务状态
2. 记录任务执行日志
3. 统计执行数据
4. 生成监控报表
5. 发送异常报警

### 5.4 任务报警流程

1. 监控任务执行状态
2. 判断是否触发报警条件
3. 生成报警信息
4. 发送报警通知
5. 记录报警日志

---

## 六、任务类型

| 类型 | 说明 | 示例 |
|------|------|------|
| CRON | Cron表达式调度 | 0 0 2 * * ? 每天凌晨2点 |
| INTERVAL | 固定间隔调度 | 300 每5分钟执行一次 |
| ONCE | 一次性任务 | 指定时间执行一次 |
| DEPENDENT | 依赖任务 | 依赖其他任务完成后执行 |

---

## 七、执行策略

| 策略 | 说明 |
|------|------|
| NOW | 立即执行 |
| SCHEDULE | 按计划执行 |
| RETRY | 失败重试 |
| SKIP | 跳过本次执行 |
| PARALLEL | 并发执行 |
| SERIAL | 串行执行 |

---

## 八、重试策略

| 策略 | 说明 |
|------|------|
| NONE | 不重试 |
| FIXED | 固定次数重试 |
| EXPONENTIAL | 指数退避重试 |
| LINEAR | 线性重试 |

---

## 九、核心表清单

| 表名 | 说明 |
|------|------|
| schedule_job | 定时任务表 |
| schedule_log | 任务日志表 |
| schedule_config | 任务配置表 |
| schedule_notify | 任务报警表 |

---

## 十、状态说明

### 任务状态

| 状态 | 说明 |
|------|------|
| STOPPED | 停止 |
| RUNNING | 运行中 |
| PAUSED | 暂停 |
| DELETED | 已删除 |

### 执行状态

| 状态 | 说明 |
|------|------|
| SUCCESS | 成功 |
| FAILURE | 失败 |
| RUNNING | 执行中 |
| TIMEOUT | 超时 |

### 报警状态

| 状态 | 说明 |
|------|------|
| PENDING | 待处理 |
| HANDLED | 已处理 |
| IGNORED | 已忽略 |

---

*文档维护:请保持此文档的及时更新*
