# QooERP 工作流引擎模块 - 数据设计文档

> 模块名称: qooerp-workflow
> 模块版本: v2.0
> 创建日期: 20xx-xx-xx
> 更新日期: 20xx-xx-xx
> 作者: Auto

---

## 一、数据库设计

| 表名 | 中文名称 | 说明 |
|------|---------|------|
| workflow_definition | 流程定义表 | 流程定义主表 |
| workflow_instance | 流程实例表 | 流程实例主表 |
| workflow_task | 流程任务表 | 流程任务主表 |
| workflow_variable | 流程变量表 | 流程变量表 |
| workflow_log | 流程日志表 | 流程日志表 |
| workflow_form | 流程表单表 | 流程表单定义 |
| workflow_form_field | 表单字段表 | 表单字段定义 |
| workflow_form_record | 表单数据记录表 | 表单数据存储 |
| workflow_form_data | 表单字段数据表 | 表单字段数据 |
| workflow_category | 流程分类表 | 流程分类 |
| workflow_template | 流程模板表 | 流程模板 |
| workflow_notification | 流程通知表 | 通知记录 |
| workflow_counter | 流程统计表 | 统计数据 |

---

## 二、表结构设计

### 2.1 workflow_definition（流程定义表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| definition_id | VARCHAR(100) | 流程定义ID |
| definition_name | VARCHAR(200) | 流程定义名称 |
| definition_key | VARCHAR(100) | 流程定义Key（唯一） |
| version | INT | 版本号 |
| bpmn_content | TEXT | BPMN内容 |
| svg_content | TEXT | SVG流程图 |
| status | SMALLINT | 状态(0-草稿,1-已发布,2-已停用) |
| category_id | BIGINT | 分类ID |
| description | TEXT | 流程描述 |
| deploy_time | TIMESTAMP | 部署时间 |
| is_system | SMALLINT | 是否系统流程(0-否,1-是) |
| allow_withdraw | SMALLINT | 是否允许撤回(0-否,1-是) |
| withdraw_time_limit | INT | 撤回时间限制(小时) |
| allow_transfer | SMALLINT | 是否允许转办(0-否,1-是) |
| allow_delegate | SMALLINT | 是否允许委派(0-否,1-是) |
| tenant_id | BIGINT | 租户ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| create_by | VARCHAR(50) | 创建人 |
| update_by | VARCHAR(50) | 更新人 |
| deleted | SMALLINT | 删除标记 |

**索引：**
- `uk_definition_key_version`: (definition_key, version, tenant_id, deleted) 唯一索引
- `idx_definition_id`: (definition_id)
- `idx_status`: (status)
- `idx_category_id`: (category_id)
- `idx_tenant_id`: (tenant_id)

### 2.2 workflow_instance（流程实例表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| instance_id | VARCHAR(100) | 流程实例ID |
| definition_id | VARCHAR(100) | 流程定义ID |
| definition_key | VARCHAR(100) | 流程定义Key |
| instance_name | VARCHAR(200) | 流程实例名称 |
| business_key | VARCHAR(200) | 业务Key |
| status | SMALLINT | 状态(0-运行中,1-已完成,2-已取消,3-已挂起) |
| start_time | TIMESTAMP | 开始时间 |
| end_time | TIMESTAMP | 结束时间 |
| duration | BIGINT | 持续时长(毫秒) |
| start_user_id | BIGINT | 发起人ID |
| start_user_name | VARCHAR(50) | 发起人姓名 |
| start_dept_id | BIGINT | 发起部门ID |
| current_node | VARCHAR(100) | 当前节点 |
| form_record_id | VARCHAR(100) | 表单记录ID |
| withdraw_status | SMALLINT | 撤回状态(0-未撤回,1-已撤回) |
| withdraw_time | TIMESTAMP | 撤回时间 |
| withdraw_reason | VARCHAR(500) | 撤回原因 |
| tenant_id | BIGINT | 租户ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| deleted | SMALLINT | 删除标记 |

**索引：**
- `uk_instance_id`: (instance_id, tenant_id, deleted) 唯一索引
- `idx_definition_id`: (definition_id)
- `idx_business_key`: (business_key)
- `idx_status`: (status)
- `idx_start_time`: (start_time)
- `idx_start_user_id`: (start_user_id)
- `idx_tenant_id`: (tenant_id)

### 2.3 workflow_task（流程任务表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| task_id | VARCHAR(100) | 任务ID |
| instance_id | VARCHAR(100) | 流程实例ID |
| definition_id | VARCHAR(100) | 流程定义ID |
| task_name | VARCHAR(200) | 任务名称 |
| task_key | VARCHAR(100) | 任务Key |
| task_type | VARCHAR(50) | 任务类型(userTask,serviceTask等) |
| assignee_id | BIGINT | 处理人ID |
| assignee_name | VARCHAR(50) | 处理人姓名 |
| assignee_type | VARCHAR(20) | 分配类型(user,role,dept,expression) |
| candidate_users | TEXT | 候选人列表(JSON) |
| candidate_groups | TEXT | 候选组列表(JSON) |
| status | SMALLINT | 状态(0-待处理,1-已处理,2-已驳回,3-已撤回) |
| priority | INT | 优先级(1-低,2-中,3-高) |
| due_time | TIMESTAMP | 到期时间 |
| create_time | TIMESTAMP | 创建时间 |
| complete_time | TIMESTAMP | 完成时间 |
| duration | BIGINT | 处理时长(毫秒) |
| comment | TEXT | 处理意见 |
| is_cc | SMALLINT | 是否抄送(0-否,1-是) |
| parent_task_id | VARCHAR(100) | 父任务ID(加签场景) |
| form_id | BIGINT | 关联表单ID |
| tenant_id | BIGINT | 租户ID |
| deleted | SMALLINT | 删除标记 |

**索引：**
- `uk_task_id`: (task_id, tenant_id, deleted) 唯一索引
- `idx_instance_id`: (instance_id)
- `idx_assignee_id`: (assignee_id)
- `idx_status`: (status)
- `idx_create_time`: (create_time)
- `idx_due_time`: (due_time)
- `idx_tenant_id`: (tenant_id)

### 2.4 workflow_variable（流程变量表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| instance_id | VARCHAR(100) | 流程实例ID |
| task_id | VARCHAR(100) | 任务ID(可选) |
| execution_id | VARCHAR(100) | 执行ID |
| variable_name | VARCHAR(100) | 变量名称 |
| variable_value | TEXT | 变量值 |
| variable_type | VARCHAR(50) | 变量类型(string, integer, boolean, date, json等) |
| variable_scope | VARCHAR(20) | 变量范围(global,local,task) |
| tenant_id | BIGINT | 租户ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| deleted | SMALLINT | 删除标记 |

**索引：**
- `idx_instance_id`: (instance_id)
- `idx_task_id`: (task_id)
- `idx_variable_name`: (variable_name)
- `idx_tenant_id`: (tenant_id)

### 2.5 workflow_log（流程日志表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| instance_id | VARCHAR(100) | 流程实例ID |
| task_id | VARCHAR(100) | 任务ID |
| node_id | VARCHAR(100) | 节点ID |
| node_name | VARCHAR(200) | 节点名称 |
| action | VARCHAR(50) | 操作类型(start, complete, reject, withdraw, suspend, activate, cancel, transfer, delegate) |
| action_user_id | BIGINT | 操作人ID |
| action_user_name | VARCHAR(50) | 操作人姓名 |
| action_comment | TEXT | 操作意见 |
| action_time | TIMESTAMP | 操作时间 |
| source_node | VARCHAR(100) | 源节点 |
| target_node | VARCHAR(100) | 目标节点 |
| variables | TEXT | 变量数据(JSON) |
| tenant_id | BIGINT | 租户ID |
| create_time | TIMESTAMP | 创建时间 |
| deleted | SMALLINT | 删除标记 |

**索引：**
- `idx_instance_id`: (instance_id)
- `idx_task_id`: (task_id)
- `idx_action_time`: (action_time)
- `idx_action_user_id`: (action_user_id)
- `idx_tenant_id`: (tenant_id)

### 2.6 workflow_form（流程表单表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| form_key | VARCHAR(100) | 表单Key（唯一） |
| form_name | VARCHAR(200) | 表单名称 |
| form_type | VARCHAR(50) | 表单类型(dynamic,template) |
| form_schema | TEXT | 表单结构(JSON Schema) |
| form_layout | TEXT | 表单布局(JSON) |
| definition_id | VARCHAR(100) | 关联流程定义ID |
| node_id | VARCHAR(100) | 关联节点ID |
| status | SMALLINT | 状态(0-草稿,1-已发布) |
| description | TEXT | 表单描述 |
| version | INT | 版本号 |
| tenant_id | BIGINT | 租户ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| create_by | VARCHAR(50) | 创建人 |
| update_by | VARCHAR(50) | 更新人 |
| deleted | SMALLINT | 删除标记 |

**索引：**
- `uk_form_key`: (form_key, tenant_id, deleted) 唯一索引
- `idx_definition_id`: (definition_id)
- `idx_node_id`: (node_id)
- `idx_tenant_id`: (tenant_id)

### 2.7 workflow_form_field（表单字段表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| form_id | BIGINT | 表单ID |
| field_key | VARCHAR(100) | 字段Key |
| field_name | VARCHAR(200) | 字段名称 |
| field_type | VARCHAR(50) | 字段类型(input,textarea,select,checkbox,datetime等) |
| field_options | TEXT | 字段选项(JSON) |
| field_rules | TEXT | 字段规则(验证规则等JSON) |
| default_value | VARCHAR(500) | 默认值 |
| placeholder | VARCHAR(200) | 占位符 |
| required | SMALLINT | 是否必填(0-否,1-是) |
| readonly | SMALLINT | 是否只读(0-否,1-是) |
| visible | SMALLINT | 是否可见(0-否,1-是) |
| sort_order | INT | 排序号 |
| tenant_id | BIGINT | 租户ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| deleted | SMALLINT | 删除标记 |

**索引：**
- `uk_form_field`: (form_id, field_key, tenant_id, deleted) 唯一索引
- `idx_form_id`: (form_id)
- `idx_tenant_id`: (tenant_id)

### 2.8 workflow_form_record（表单数据记录表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | VARCHAR(100) | 主键（UUID） |
| record_id | VARCHAR(100) | 记录ID（唯一） |
| form_id | BIGINT | 表单ID |
| instance_id | VARCHAR(100) | 流程实例ID |
| task_id | VARCHAR(100) | 任务ID |
| form_data | TEXT | 表单数据(JSON) |
| submit_time | TIMESTAMP | 提交时间 |
| submit_user_id | BIGINT | 提交人ID |
| submit_user_name | VARCHAR(50) | 提交人姓名 |
| tenant_id | BIGINT | 租户ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| deleted | SMALLINT | 删除标记 |

**索引：**
- `uk_record_id`: (record_id, tenant_id, deleted) 唯一索引
- `idx_form_id`: (form_id)
- `idx_instance_id`: (instance_id)
- `idx_task_id`: (task_id)
- `idx_tenant_id`: (tenant_id)

### 2.9 workflow_category（流程分类表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| category_name | VARCHAR(100) | 分类名称 |
| category_code | VARCHAR(50) | 分类编码（唯一） |
| parent_id | BIGINT | 父分类ID |
| icon | VARCHAR(100) | 图标 |
| sort_order | INT | 排序号 |
| description | VARCHAR(500) | 描述 |
| tenant_id | BIGINT | 租户ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| deleted | SMALLINT | 删除标记 |

**索引：**
- `uk_category_code`: (category_code, tenant_id, deleted) 唯一索引
- `idx_parent_id`: (parent_id)
- `idx_tenant_id`: (tenant_id)

### 2.10 workflow_template（流程模板表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| template_name | VARCHAR(200) | 模板名称 |
| template_key | VARCHAR(100) | 模板Key（唯一） |
| bpmn_content | TEXT | BPMN内容 |
| svg_content | TEXT | SVG流程图 |
| form_id | BIGINT | 关联表单ID |
| category_id | BIGINT | 分类ID |
| description | TEXT | 描述 |
| is_public | SMALLINT | 是否公开(0-私有,1-公开) |
| use_count | INT | 使用次数 |
| status | SMALLINT | 状态(0-草稿,1-已发布) |
| tenant_id | BIGINT | 租户ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| create_by | VARCHAR(50) | 创建人 |
| update_by | VARCHAR(50) | 更新人 |
| deleted | SMALLINT | 删除标记 |

**索引：**
- `uk_template_key`: (template_key, tenant_id, deleted) 唯一索引
- `idx_category_id`: (category_id)
- `idx_form_id`: (form_id)
- `idx_tenant_id`: (tenant_id)

### 2.11 workflow_notification（流程通知表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| notification_type | VARCHAR(50) | 通知类型(todo,approval,overdue,cc) |
| target_id | VARCHAR(100) | 目标ID(任务ID或实例ID) |
| target_type | VARCHAR(20) | 目标类型(task,instance) |
| receiver_id | BIGINT | 接收人ID |
| receiver_name | VARCHAR(50) | 接收人姓名 |
| notification_method | VARCHAR(50) | 通知方式(email,sms,site-message,wechat) |
| title | VARCHAR(200) | 通知标题 |
| content | TEXT | 通知内容 |
| is_read | SMALLINT | 是否已读(0-未读,1-已读) |
| read_time | TIMESTAMP | 读取时间 |
| send_status | SMALLINT | 发送状态(0-待发送,1-已发送,2-发送失败) |
| send_time | TIMESTAMP | 发送时间 |
| error_message | VARCHAR(500) | 错误信息 |
| tenant_id | BIGINT | 租户ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |
| deleted | SMALLINT | 删除标记 |

**索引：**
- `idx_receiver_id`: (receiver_id)
- `idx_target_id`: (target_id)
- `idx_notification_type`: (notification_type)
- `idx_is_read`: (is_read)
- `idx_send_status`: (send_status)
- `idx_create_time`: (create_time)
- `idx_tenant_id`: (tenant_id)

### 2.12 workflow_counter（流程统计表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| counter_key | VARCHAR(100) | 统计Key |
| counter_type | VARCHAR(50) | 统计类型(instance,task,completion等) |
| definition_key | VARCHAR(100) | 流程定义Key |
| counter_date | DATE | 统计日期 |
| counter_value | BIGINT | 统计值 |
| extra_data | TEXT | 扩展数据(JSON) |
| tenant_id | BIGINT | 租户ID |
| create_time | TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | 更新时间 |

**索引：**
- `uk_counter`: (counter_key, counter_date, tenant_id) 唯一索引
- `idx_counter_type`: (counter_type)
| `idx_definition_key`: (definition_key)
| `idx_counter_date`: (counter_date)
| `idx_tenant_id`: (tenant_id)

---

## 三、数据字典

### 3.1 流程定义状态 (workflow_definition.status)

| 值 | 说明 |
|----|------|
| 0 | 草稿 |
| 1 | 已发布 |
| 2 | 已停用 |

### 3.2 流程实例状态 (workflow_instance.status)

| 值 | 说明 |
|----|------|
| 0 | 运行中 |
| 1 | 已完成 |
| 2 | 已取消 |
| 3 | 已挂起 |

### 3.3 任务状态 (workflow_task.status)

| 值 | 说明 |
|----|------|
| 0 | 待处理 |
| 1 | 已处理 |
| 2 | 已驳回 |
| 3 | 已撤回 |

### 3.4 任务类型 (workflow_task.task_type)

| 值 | 说明 |
|----|------|
| userTask | 用户任务 |
| serviceTask | 服务任务 |
| scriptTask | 脚本任务 |
| receiveTask | 接收任务 |
| sendTask | 发送任务 |

### 3.5 分配类型 (workflow_task.assignee_type)

| 值 | 说明 |
|----|------|
| user | 指定用户 |
| role | 指定角色 |
| dept | 指定部门 |
| expression | 表达式 |

### 3.6 任务优先级 (workflow_task.priority)

| 值 | 说明 |
|----|------|
| 1 | 低 |
| 2 | 中 |
| 3 | 高 |

### 3.7 操作类型 (workflow_log.action)

| 值 | 说明 |
|----|------|
| start | 启动流程 |
| complete | 完成任务 |
| reject | 驳回任务 |
| withdraw | 撤回流程/任务 |
| suspend | 挂起流程 |
| activate | 恢复流程 |
| cancel | 取消流程 |
| transfer | 转办 |
| delegate | 委派 |
| add_sign | 加签 |
| remove_sign | 减签 |

### 3.8 通知类型 (workflow_notification.notification_type)

| 值 | 说明 |
|----|------|
| todo | 待办通知 |
| approval | 审批通知 |
| overdue | 超时提醒 |
| cc | 抄送通知 |

### 3.9 通知方式 (workflow_notification.notification_method)

| 值 | 说明 |
|----|------|
| email | 邮件 |
| sms | 短信 |
| site-message | 站内信 |
| wechat | 企业微信/微信 |

---

## 四、ER图

```
┌─────────────────┐
│ workflow_category│
└────────┬────────┘
         │ 1
         │ N
┌────────▼────────┐       ┌─────────────────┐
│workflow_definition│──────│workflow_template│
└────────┬────────┘       └─────────────────┘
         │ 1
         │ N
┌────────▼────────┐
│workflow_instance│──────┬─────────────────┬─────────────────┐
└─────────────────┘       │                 │                 │
         │ 1                │ N               │ N               │ N
         │ N                │                 │                 │
┌────────▼────────┐  ┌────▼──────────┐  ┌──▼──────────┐  ┌─▼────────────┐
│  workflow_task  │  │workflow_variable│ │workflow_log │ │workflow_form  │
└────────┬────────┘  └─────────────────┘ └─────────────┘ └───────┬──────┘
         │                                                   │
         │ 1                                                 │ 1
         │ N                                                 │ N
┌────────▼────────┐                               ┌──────────▼──────────┐
│workflow_notification│                              │workflow_form_field   │
└─────────────────┘                               │workflow_form_record  │
                                                  └─────────────────────┘
```

---

**文档版本**: v2.0
**最后更新**: 20xx-xx-xx
**数据库**: PostgreSQL 15+
