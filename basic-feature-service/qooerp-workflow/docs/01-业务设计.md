# QooERP 工作流引擎模块 - 业务设计文档

> 模块名称: qooerp-workflow
> 模块版本: v2.0
> 创建日期: 2026-02-17
> 更新日期: 2026-02-18
> 作者: Auto

---

## 一、业务概述

### 1.1 业务定位

工作流引擎模块是QooERP的高级功能模块，基于BPMN 2.0标准，为企业提供流程定义、流程实例、流程审批、流程监控等全流程管理能力，支持复杂业务流程的灵活配置与自动化执行。

### 1.2 业务目标

| 目标 | 描述 |
|------|------|
| 流程标准化 | 统一的流程管理标准，支持跨部门协作 |
| 审批自动化 | 自动化的审批流程，减少人工干预 |
| 可视化设计 | 拖拽式流程设计器，降低使用门槛 |
| 监控分析 | 流程执行监控和分析，优化流程效率 |
| 灵活扩展 | 支持条件网关、并行网关、事件触发等复杂场景 |

### 1.3 业务价值

- **效率提升**：自动化审批，减少人工等待时间
- **流程可控**：全程监控，确保流程合规执行
- **灵活配置**：可视化的流程设计，快速适应业务变化
- **数据洞察**：统计分析，发现流程瓶颈
- **系统集成**：与HR、财务、采购等业务模块无缝集成

---

## 二、核心业务功能

### 2.1 流程定义管理

#### 2.1.1 功能清单

| 功能点 | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| 流程设计 | BPMN 2.0 可视化设计器 | P0 | 未开始 |
| 流程发布 | 流程定义部署发布 | P0 | 未开始 |
| 流程版本管理 | 流程版本控制、版本回退 | P0 | 未开始 |
| 流程分类管理 | 流程分类、分类标签 | P0 | 未开始 |
| 流程模板管理 | 流程模板创建、模板应用 | P1 | 未开始 |
| 流程导入导出 | 流程定义导入导出 | P1 | 未开始 |
| 流程复制 | 复制已有流程定义 | P2 | 未开始 |

#### 2.1.2 流程设计支持

| 元素类型 | 说明 |
|---------|------|
| 开始事件 | 流程开始节点，支持多种触发方式 |
| 结束事件 | 流程结束节点，支持终止、取消等 |
| 用户任务 | 人工审批任务 |
| 服务任务 | 自动执行任务 |
| 条件网关 | 根据条件分支流程 |
| 并行网关 | 并行执行多个分支 |
| 排他网关 | 选择性执行分支 |
| 子流程 | 嵌套子流程 |
| 定时器事件 | 定时触发 |
| 消息事件 | 消息触发 |

### 2.2 流程实例管理

| 功能点 | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| 流程启动 | 启动流程实例 | P0 | 未开始 |
| 流程执行 | 流程自动流转 | P0 | 未开始 |
| 流程完成 | 流程正常结束 | P0 | 未开始 |
| 流程取消 | 取消流程实例 | P0 | 未开始 |
| 流程挂起/恢复 | 流程暂停与恢复 | P0 | 未开始 |
| 流程撤回 | 撤回已提交的流程 | P1 | 未开始 |
| 流程转办 | 将流程转办给其他人 | P1 | 未开始 |

### 2.3 流程任务管理

#### 2.3.1 任务处理

| 功能点 | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| 待办任务查询 | 查询个人待办任务 | P0 | 未开始 |
| 已办任务查询 | 查询个人已办任务 | P0 | 未开始 |
| 任务审批通过 | 同意任务审批 | P0 | 未开始 |
| 任务审批驳回 | 驳回任务到上一步 | P0 | 未开始 |
| 任务转派 | 将任务转派给其他人 | P0 | 未开始 |
| 任务委派 | 委托他人代处理 | P0 | 未开始 |
| 任务撤回 | 撤回已完成的任务 | P1 | 未开始 |
| 任务加签 | 添加审批人 | P1 | 未开始 |
| 任务减签 | 移除审批人 | P1 | 未开始 |
| 会签处理 | 多人会签审批 | P0 | 未开始 |
| 或签处理 | 任一人审批通过即可 | P0 | 未开始 |

#### 2.3.2 会签规则

| 会签类型 | 说明 |
|---------|------|
| 全部会签 | 所有人都需要审批通过 |
| 按比例会签 | 按比例通过即可 |
| 按人数会签 | 指定人数通过即可 |
| 或签 | 任一人通过即可 |

### 2.4 流程表单管理

| 功能点 | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| 表单设计 | 可视化表单设计器 | P0 | 未开始 |
| 表单绑定 | 表单与流程节点绑定 | P0 | 未开始 |
| 表单权限控制 | 表单字段权限（只读、编辑、隐藏） | P0 | 未开始 |
| 表单验证 | 表单数据验证规则 | P0 | 未开始 |
| 表单数据存储 | 流程表单数据保存 | P0 | 未开始 |
| 动态表单 | 根据流程变量动态显示表单 | P1 | 未开始 |

### 2.5 流程监控管理

| 功能点 | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| 流程实例查询 | 流程实例列表与详情 | P0 | 未开始 |
| 流程进度跟踪 | 流程当前节点、流转路径 | P0 | 未开始 |
| 流程图查看 | 可视化流程执行图 | P0 | 未开始 |
| 流程日志查询 | 操作日志、流转日志 | P0 | 未开始 |
| 流程统计分析 | 流程统计报表 | P0 | 未开始 |
| 流程性能分析 | 平均时长、瓶颈分析 | P1 | 未开始 |
| 流程监控大屏 | 实时监控仪表盘 | P2 | 未开始 |

#### 2.5.1 统计指标

| 指标 | 说明 |
|------|------|
| 流程发起数 | 流程发起次数统计 |
| 流程完成数 | 流程完成次数统计 |
| 平均处理时长 | 流程平均处理时长 |
| 平均审批时长 | 任务平均审批时长 |
| 超时任务数 | 超时未处理任务数 |
| 流程完成率 | 流程完成率统计 |
| 节点停留时间 | 各节点平均停留时间 |

### 2.6 流程消息通知

| 功能点 | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| 待办通知 | 新任务待办通知 | P0 | 未开始 |
| 审批通知 | 审批完成/驳回通知 | P0 | 未开始 |
| 超时提醒 | 任务超时提醒 | P0 | 未开始 |
| 流程完成通知 | 流程完成通知 | P0 | 未开始 |
| 抄送通知 | 抄送消息通知 | P1 | 未开始 |
| 通知方式 | 邮件、短信、站内信、企业微信 | P0 | 未开始 |

### 2.7 流程高级功能

| 功能点 | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| 条件流转 | 基于流程变量的条件流转 | P0 | 未开始 |
| 并行审批 | 多分支并行审批 | P0 | 未开始 |
| 子流程调用 | 子流程调用与返回 | P1 | 未开始 |
| 流程变量 | 流程变量管理 | P0 | 未开始 |
| 流程监听器 | 流程事件监听器 | P1 | 未开始 |
| 流程脚本 | Groovy/JavaScript 脚本 | P1 | 未开始 |
| 流程超时处理 | 任务超时自动处理 | P1 | 未开始 |
| 流程撤回重提 | 撤回后重新提交 | P1 | 未开始 |
| 流程跳转 | 跳转到指定节点 | P2 | 未开始 |

### 2.8 流程权限控制

| 功能点 | 描述 | 优先级 | 状态 |
|--------|------|--------|------|
| 流程发起权限 | 谁可以发起流程 | P0 | 未开始 |
| 流程管理权限 | 流程设计、发布权限 | P0 | 未开始 |
| 流程查看权限 | 流程实例查看权限 | P0 | 未开始 |
| 任务处理权限 | 任务审批权限 | P0 | 未开始 |
| 流程干预权限 | 流程挂起、取消权限 | P1 | 未开始 |

---

## 三、典型业务流程

### 3.1 请假审批流程

```
员工提交申请 → 部门经理审批 → (同意) → 人事审核 → (同意) → 完成
                          ↓
                       (不同意) → 返回员工修改 → 重新提交
```

### 3.2 采购审批流程

```
采购员提交申请 → 部门经理审批 → 财务审核 → 总经理审批 → 采购执行
                    ↓              ↓
                (不同意)        (不同意)
                    ↓              ↓
                返回修改        返回修改
```

### 3.3 费用报销流程

```
员工提交报销 → 部门经理审批 → 财务审核 → 出纳付款 → 完成
                  ↓              ↓
              (不同意)        (不同意)
                  ↓              ↓
              返回修改        返回修改
```

### 3.4 合同审批流程（并行）

```
发起合同 → 法务审核 ←─────┐
            ↓             │
        财务审核 ←───────┤ 并行审批
            ↓             │
        部门经理审批 ←────┘
            ↓
        总经理审批 → 完成
```

---

## 四、领域模型

### 4.1 核心实体

| 实体 | 说明 |
|------|------|
| WorkflowDefinition | 流程定义 |
| WorkflowInstance | 流程实例 |
| WorkflowTask | 流程任务 |
| WorkflowVariable | 流程变量 |
| WorkflowLog | 流程日志 |
| WorkflowForm | 流程表单 |
| WorkflowFormField | 表单字段 |
| WorkflowFormRecord | 表单数据记录 |
| WorkflowTemplate | 流程模板 |
| WorkflowCategory | 流程分类 |
| WorkflowNotification | 流程通知 |

### 4.2 实体关系

```
WorkflowDefinition (1) ──── (N) WorkflowInstance
WorkflowDefinition (1) ──── (N) WorkflowTemplate
WorkflowInstance (1) ──── (N) WorkflowTask
WorkflowInstance (1) ──── (N) WorkflowVariable
WorkflowInstance (1) ──── (N) WorkflowLog
WorkflowTask (1) ──── (N) WorkflowFormRecord
WorkflowForm (1) ──── (N) WorkflowFormField
WorkflowCategory (1) ──── (N) WorkflowDefinition
```

---

## 五、业务规则

### 5.1 流程定义规则

| 规则 | 说明 |
|------|------|
| 唯一性约束 | 流程定义Key + 版本号唯一 |
| 发布校验 | 流程定义必须设计完成才能发布 |
| 版本管理 | 流程定义修改后自动创建新版本 |
| 启用控制 | 只有已发布的流程才能启动 |
| 停用控制 | 流程定义停用后不能启动新实例 |
| 删除保护 | 有实例的流程定义不能删除 |

### 5.2 流程实例规则

| 规则 | 说明 |
|------|------|
| 状态流转 | 运行中 → 已完成/已取消/已挂起 |
| 挂起限制 | 挂起的实例不能产生新任务 |
| 恢复限制 | 只能恢复已挂起的实例 |
| 取消限制 | 已完成的实例不能取消 |
| 撤回限制 | 撤回需要在规定时间内 |

### 5.3 任务处理规则

| 规则 | 说明 |
|------|------|
| 处理权限 | 只有分配人或委托人可以处理任务 |
| 会签规则 | 按会签配置决定是否需要全部通过 |
| 超时处理 | 超时任务自动提醒或自动流转 |
| 转派限制 | 已处理任务不能转派 |
| 委托限制 | 委托后任务仍属于原负责人 |

### 5.4 流程表单规则

| 规则 | 说明 |
|------|------|
| 权限继承 | 表单字段权限继承任务权限 |
| 数据验证 | 提交时按规则验证表单数据 |
| 版本控制 | 表单修改后不影响历史数据 |
| 只读控制 | 指定字段只读不可编辑 |

---

## 六、异常处理

### 6.1 流程定义异常

| 错误码 | 错误信息 | 处理方式 |
|--------|---------|---------|
| WF_DEF_001 | 流程定义Key已存在 | 提示修改Key |
| WF_DEF_002 | 流程定义版本已发布 | 提示创建新版本 |
| WF_DEF_003 | 流程定义存在实例，不能删除 | 提示先停用 |
| WF_DEF_004 | BPMN内容解析失败 | 提示检查流程图 |

### 6.2 流程实例异常

| 错误码 | 错误信息 | 处理方式 |
|--------|---------|---------|
| WF_INS_001 | 流程定义不存在或未发布 | 提示先发布流程 |
| WF_INS_002 | 流程实例不存在 | 提示实例已被删除 |
| WF_INS_003 | 流程实例状态不允许操作 | 提示当前状态 |
| WF_INS_004 | 流程实例已超时 | 提示超时处理 |

### 6.3 任务处理异常

| 错误码 | 错误信息 | 处理方式 |
|--------|---------|---------|
| WF_TASK_001 | 任务不存在或已被处理 | 提示任务状态 |
| WF_TASK_002 | 无权限处理该任务 | 提示权限不足 |
| WF_TASK_003 | 任务已超时 | 提示联系管理员 |
| WF_TASK_004 | 会签条件不满足 | 提示等待其他审批人 |

### 6.4 流程表单异常

| 错误码 | 错误信息 | 处理方式 |
|--------|---------|---------|
| WF_FORM_001 | 表单字段验证失败 | 提示具体错误 |
| WF_FORM_002 | 表单数据不存在 | 提示重新提交 |
| WF_FORM_003 | 表单权限不足 | 提示联系管理员 |

---

## 七、业务指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 流程启动成功率 | >99.9% | 流程启动成功率 |
| 平均流程完成时长 | <24小时 | 流程平均完成时长 |
| 平均任务审批时长 | <2小时 | 任务平均审批时长 |
| 超时任务率 | <5% | 超时任务占比 |
| 流程完成率 | >95% | 流程完成率 |
| 用户满意度 | >90% | 用户满意度调查 |

---

## 八、扩展点设计

### 8.1 流程监听器扩展

```java
public interface WorkflowListener {
    // 流程启动监听
    void onProcessStart(DelegateExecution execution);

    // 流程结束监听
    void onProcessEnd(DelegateExecution execution);

    // 任务创建监听
    void onTaskCreate(DelegateTask task);

    // 任务完成监听
    void onTaskComplete(DelegateTask task);
}
```

### 8.2 流程变量处理器扩展

```java
public interface VariableProcessor {
    Object processVariable(String variableName, Object value);
    boolean supports(String type);
}
```

### 8.3 消息通知扩展

```java
public interface NotificationProvider {
    void sendNotification(NotificationMessage message);
    boolean supports(String type);
}
```

---

## 九、与其它模块集成

| 模块 | 集成点 | 说明 |
|------|--------|------|
| qooerp-auth | 用户认证 | 获取当前用户信息 |
| qooerp-user | 用户信息 | 获取审批人信息 |
| qooerp-organization | 组织信息 | 获取部门、岗位信息 |
| qooerp-permission | 权限控制 | 流程发起、管理权限 |
| qooerp-notify | 消息通知 | 发送待办、审批通知 |
| qooerp-hr | 人事流程 | 请假、报销流程 |
| qooerp-finance | 财务流程 | 采购、付款流程 |
| qooerp-file | 附件管理 | 流程附件上传下载 |

---

**文档版本**: v2.0
**最后更新**: 2026-02-18
