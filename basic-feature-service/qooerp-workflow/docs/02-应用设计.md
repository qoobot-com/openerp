# QooERP 工作流引擎模块 - 应用设计文档

> 模块名称: qooerp-workflow
> 模块版本: v2.0
> 创建日期: 20xx-xx-xx
> 更新日期: 20xx-xx-xx
> 作者: Auto

---

## 一、应用架构

### 1.1 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│  (Controller - REST API + WebSocket)                       │
├─────────────────────────────────────────────────────────────┤
│                      Business Layer                         │
│  (Service - 业务逻辑 + Domain - 领域模型)                    │
├─────────────────────────────────────────────────────────────┤
│                   Data Access Layer                         │
│  (Mapper - 数据访问 + Flowable - 流程引擎)                   │
├─────────────────────────────────────────────────────────────┤
│                  Infrastructure Layer                       │
│  (Database + Redis + Message Queue)                        │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 模块划分

| 模块 | 说明 | 包路径 |
|------|------|--------|
| definition | 流程定义管理 | com.qoobot.qooerp.workflow.definition |
| instance | 流程实例管理 | com.qoobot.qooerp.workflow.instance |
| task | 任务管理 | com.qoobot.qooerp.workflow.task |
| form | 表单管理 | com.qoobot.qooerp.workflow.form |
| monitor | 流程监控 | com.qoobot.qooerp.workflow.monitor |
| notification | 消息通知 | com.qoobot.qooerp.workflow.notification |

---

## 二、核心类设计

### 2.1 流程定义服务 (WorkflowDefinitionService)

```java
public interface WorkflowDefinitionService {

    /**
     * 创建流程定义
     */
    WorkflowDefinitionDTO createDefinition(WorkflowDefinitionDTO dto);

    /**
     * 更新流程定义
     */
    WorkflowDefinitionDTO updateDefinition(Long id, WorkflowDefinitionDTO dto);

    /**
     * 删除流程定义
     */
    void deleteDefinition(Long id);

    /**
     * 部署流程定义
     */
    void deployDefinition(Long id);

    /**
     * 发布流程定义
     */
    void activateDefinition(Long id);

    /**
     * 停用流程定义
     */
    void suspendDefinition(Long id);

    /**
     * 获取流程定义
     */
    WorkflowDefinitionDTO getDefinition(Long id);

    /**
     * 根据流程定义Key查询
     */
    WorkflowDefinitionDTO getDefinitionByKey(String definitionKey, Integer version);

    /**
     * 分页查询流程定义
     */
    Page<WorkflowDefinitionDTO> listDefinitions(DefinitionQueryDTO query);

    /**
     * 获取流程定义版本列表
     */
    List<WorkflowDefinitionDTO> getDefinitionVersions(String definitionKey);

    /**
     * 复制流程定义
     */
    WorkflowDefinitionDTO copyDefinition(Long id, String newKey);

    /**
     * 导入流程定义
     */
    WorkflowDefinitionDTO importDefinition(DefinitionImportDTO dto);

    /**
     * 导出流程定义
     */
    DefinitionExportDTO exportDefinition(Long id);
}
```

### 2.2 流程实例服务 (WorkflowInstanceService)

```java
public interface WorkflowInstanceService {

    /**
     * 启动流程实例
     */
    WorkflowInstanceDTO startInstance(InstanceStartDTO dto);

    /**
     * 获取流程实例
     */
    WorkflowInstanceDTO getInstance(String instanceId);

    /**
     * 获取实例详情（含表单数据）
     */
    WorkflowInstanceDetailDTO getInstanceDetail(String instanceId);

    /**
     * 分页查询流程实例
     */
    Page<WorkflowInstanceDTO> listInstances(InstanceQueryDTO query);

    /**
     * 取消流程实例
     */
    void cancelInstance(String instanceId);

    /**
     * 挂起流程实例
     */
    void suspendInstance(String instanceId);

    /**
     * 恢复流程实例
     */
    void activateInstance(String instanceId);

    /**
     * 撤回流程实例
     */
    void withdrawInstance(String instanceId);

    /**
     * 转办流程实例
     */
    void transferInstance(String instanceId, Long targetUserId);

    /**
     * 获取流程实例进度
     */
    InstanceProgressDTO getInstanceProgress(String instanceId);

    /**
     * 获取流程实例流转图
     */
    InstanceDiagramDTO getInstanceDiagram(String instanceId);

    /**
     * 获取流程实例日志
     */
    List<WorkflowLogDTO> getInstanceLogs(String instanceId);
}
```

### 2.3 任务服务 (WorkflowTaskService)

```java
public interface WorkflowTaskService {

    /**
     * 获取待办任务
     */
    Page<WorkflowTaskDTO> getTodoTasks(TaskQueryDTO query);

    /**
     * 获取已办任务
     */
    Page<WorkflowTaskDTO> getDoneTasks(TaskQueryDTO query);

    /**
     * 获取抄送任务
     */
    Page<WorkflowTaskDTO> getCcTasks(TaskQueryDTO query);

    /**
     * 获取任务详情
     */
    WorkflowTaskDetailDTO getTaskDetail(String taskId);

    /**
     * 完成任务（同意）
     */
    void completeTask(TaskCompleteDTO dto);

    /**
     * 驳回任务
     */
    void rejectTask(TaskRejectDTO dto);

    /**
     * 转派任务
     */
    void transferTask(String taskId, Long targetUserId);

    /**
     * 委派任务
     */
    void delegateTask(String taskId, Long targetUserId);

    /**
     * 撤回任务
     */
    void withdrawTask(String taskId);

    /**
     * 加签任务
     */
    void addSignTask(TaskAddSignDTO dto);

    /**
     * 减签任务
     */
    void removeSignTask(TaskRemoveSignDTO dto);

    /**
     * 获取任务表单
     */
    WorkflowFormRecordDTO getTaskForm(String taskId);

    /**
     * 保存任务表单
     */
    void saveTaskForm(TaskFormSaveDTO dto);

    /**
     * 获取任务流转历史
     */
    List<TaskHistoryDTO> getTaskHistory(String taskId);
}
```

### 2.4 表单服务 (WorkflowFormService)

```java
public interface WorkflowFormService {

    /**
     * 创建表单
     */
    WorkflowFormDTO createForm(WorkflowFormDTO dto);

    /**
     * 更新表单
     */
    WorkflowFormDTO updateForm(Long id, WorkflowFormDTO dto);

    /**
     * 删除表单
     */
    void deleteForm(Long id);

    /**
     * 获取表单
     */
    WorkflowFormDTO getForm(Long id);

    /**
     * 分页查询表单
     */
    Page<WorkflowFormDTO> listForms(FormQueryDTO query);

    /**
     * 保存表单数据
     */
    void saveFormRecord(FormRecordSaveDTO dto);

    /**
     * 获取表单数据
     */
    FormRecordDTO getFormRecord(String recordId);

    /**
     * 删除表单数据
     */
    void deleteFormRecord(String recordId);

    /**
     * 复制表单
     */
    WorkflowFormDTO copyForm(Long id, String newName);
}
```

### 2.5 流程监控服务 (WorkflowMonitorService)

```java
public interface WorkflowMonitorService {

    /**
     * 流程统计
     */
    WorkflowStatisticsDTO getStatistics(StatisticsQueryDTO query);

    /**
     * 流程性能分析
     */
    WorkflowPerformanceDTO getPerformance(PerformanceQueryDTO query);

    /**
     * 节点停留时间分析
     */
    List<NodeDurationDTO> getNodeDurations(String definitionKey);

    /**
     * 流程完成率统计
     */
    CompletionRateDTO getCompletionRate(CompletionRateQueryDTO query);

    /**
     * 超时任务统计
     */
    List<OverdueTaskDTO> getOverdueTasks(OverdueQueryDTO query);

    /**
     * 流程热力图
     */
    HeatmapDTO getWorkflowHeatmap(HeatmapQueryDTO query);

    /**
     * 流程趋势分析
     */
    List<TrendDataDTO> getWorkflowTrend(TrendQueryDTO query);
}
```

### 2.6 消息通知服务 (WorkflowNotificationService)

```java
public interface WorkflowNotificationService {

    /**
     * 发送待办通知
     */
    void sendTodoNotification(String taskId, Long userId);

    /**
     * 发送审批通知
     */
    void sendApprovalNotification(String instanceId, Long userId, boolean approved);

    /**
     * 发送超时提醒
     */
    void sendOverdueReminder(String taskId);

    /**
     * 发送抄送通知
     */
    void sendCcNotification(String taskId, List<Long> userIds);

    /**
     * 批量发送通知
     */
    void batchSendNotifications(List<NotificationMessage> messages);

    /**
     * 配置通知方式
     */
    void configureNotification(NotificationConfigDTO config);
}
```

---

## 三、Controller 设计

### 3.1 流程定义控制器

```java
@RestController
@RequestMapping("/api/workflow/definitions")
@Tag(name = "流程定义管理", description = "流程定义相关接口")
public class WorkflowDefinitionController {

    @PostMapping
    @Operation(summary = "创建流程定义")
    public Result<WorkflowDefinitionDTO> createDefinition(
        @RequestBody @Valid WorkflowDefinitionDTO dto);

    @PutMapping("/{id}")
    @Operation(summary = "更新流程定义")
    public Result<WorkflowDefinitionDTO> updateDefinition(
        @PathVariable Long id,
        @RequestBody @Valid WorkflowDefinitionDTO dto);

    @DeleteMapping("/{id}")
    @Operation(summary = "删除流程定义")
    public Result<Void> deleteDefinition(@PathVariable Long id);

    @PostMapping("/{id}/deploy")
    @Operation(summary = "部署流程定义")
    public Result<Void> deployDefinition(@PathVariable Long id);

    @PostMapping("/{id}/activate")
    @Operation(summary = "发布流程定义")
    public Result<Void> activateDefinition(@PathVariable Long id);

    @PostMapping("/{id}/suspend")
    @Operation(summary = "停用流程定义")
    public Result<Void> suspendDefinition(@PathVariable Long id);

    @GetMapping("/{id}")
    @Operation(summary = "获取流程定义")
    public Result<WorkflowDefinitionDTO> getDefinition(@PathVariable Long id);

    @GetMapping("/key/{key}")
    @Operation(summary = "根据Key获取流程定义")
    public Result<WorkflowDefinitionDTO> getDefinitionByKey(
        @PathVariable String key,
        @RequestParam(required = false) Integer version);

    @GetMapping
    @Operation(summary = "分页查询流程定义")
    public Result<Page<WorkflowDefinitionDTO>> listDefinitions(
        DefinitionQueryDTO query);

    @GetMapping("/{key}/versions")
    @Operation(summary = "获取流程定义版本列表")
    public Result<List<WorkflowDefinitionDTO>> getDefinitionVersions(
        @PathVariable String key);

    @PostMapping("/{id}/copy")
    @Operation(summary = "复制流程定义")
    public Result<WorkflowDefinitionDTO> copyDefinition(
        @PathVariable Long id,
        @RequestParam String newKey);

    @PostMapping("/import")
    @Operation(summary = "导入流程定义")
    public Result<WorkflowDefinitionDTO> importDefinition(
        @RequestBody DefinitionImportDTO dto);

    @GetMapping("/{id}/export")
    @Operation(summary = "导出流程定义")
    public Result<DefinitionExportDTO> exportDefinition(@PathVariable Long id);
}
```

### 3.2 流程实例控制器

```java
@RestController
@RequestMapping("/api/workflow/instances")
@Tag(name = "流程实例管理", description = "流程实例相关接口")
public class WorkflowInstanceController {

    @PostMapping
    @Operation(summary = "启动流程实例")
    public Result<WorkflowInstanceDTO> startInstance(
        @RequestBody @Valid InstanceStartDTO dto);

    @GetMapping("/{id}")
    @Operation(summary = "获取流程实例")
    public Result<WorkflowInstanceDTO> getInstance(@PathVariable String id);

    @GetMapping("/{id}/detail")
    @Operation(summary = "获取流程实例详情")
    public Result<WorkflowInstanceDetailDTO> getInstanceDetail(
        @PathVariable String id);

    @GetMapping
    @Operation(summary = "分页查询流程实例")
    public Result<Page<WorkflowInstanceDTO>> listInstances(
        InstanceQueryDTO query);

    @PostMapping("/{id}/cancel")
    @Operation(summary = "取消流程实例")
    public Result<Void> cancelInstance(@PathVariable String id);

    @PostMapping("/{id}/suspend")
    @Operation(summary = "挂起流程实例")
    public Result<Void> suspendInstance(@PathVariable String id);

    @PostMapping("/{id}/activate")
    @Operation(summary = "恢复流程实例")
    public Result<Void> activateInstance(@PathVariable String id);

    @PostMapping("/{id}/withdraw")
    @Operation(summary = "撤回流程实例")
    public Result<Void> withdrawInstance(@PathVariable String id);

    @PostMapping("/{id}/transfer")
    @Operation(summary = "转办流程实例")
    public Result<Void> transferInstance(
        @PathVariable String id,
        @RequestParam Long targetUserId);

    @GetMapping("/{id}/progress")
    @Operation(summary = "获取流程实例进度")
    public Result<InstanceProgressDTO> getInstanceProgress(
        @PathVariable String id);

    @GetMapping("/{id}/diagram")
    @Operation(summary = "获取流程实例流转图")
    public Result<InstanceDiagramDTO> getInstanceDiagram(
        @PathVariable String id);

    @GetMapping("/{id}/logs")
    @Operation(summary = "获取流程实例日志")
    public Result<List<WorkflowLogDTO>> getInstanceLogs(
        @PathVariable String id);
}
```

### 3.3 任务控制器

```java
@RestController
@RequestMapping("/api/workflow/tasks")
@Tag(name = "任务管理", description = "任务相关接口")
public class WorkflowTaskController {

    @GetMapping("/todo")
    @Operation(summary = "获取待办任务")
    public Result<Page<WorkflowTaskDTO>> getTodoTasks(TaskQueryDTO query);

    @GetMapping("/done")
    @Operation(summary = "获取已办任务")
    public Result<Page<WorkflowTaskDTO>> getDoneTasks(TaskQueryDTO query);

    @GetMapping("/cc")
    @Operation(summary = "获取抄送任务")
    public Result<Page<WorkflowTaskDTO>> getCcTasks(TaskQueryDTO query);

    @GetMapping("/{id}")
    @Operation(summary = "获取任务详情")
    public Result<WorkflowTaskDetailDTO> getTaskDetail(
        @PathVariable String id);

    @PostMapping("/complete")
    @Operation(summary = "完成任务")
    public Result<Void> completeTask(
        @RequestBody @Valid TaskCompleteDTO dto);

    @PostMapping("/reject")
    @Operation(summary = "驳回任务")
    public Result<Void> rejectTask(
        @RequestBody @Valid TaskRejectDTO dto);

    @PostMapping("/{id}/transfer")
    @Operation(summary = "转派任务")
    public Result<Void> transferTask(
        @PathVariable String id,
        @RequestParam Long targetUserId);

    @PostMapping("/{id}/delegate")
    @Operation(summary = "委派任务")
    public Result<Void> delegateTask(
        @PathVariable String id,
        @RequestParam Long targetUserId);

    @PostMapping("/{id}/withdraw")
    @Operation(summary = "撤回任务")
    public Result<Void> withdrawTask(@PathVariable String id);

    @PostMapping("/add-sign")
    @Operation(summary = "加签任务")
    public Result<Void> addSignTask(
        @RequestBody @Valid TaskAddSignDTO dto);

    @PostMapping("/remove-sign")
    @Operation(summary = "减签任务")
    public Result<Void> removeSignTask(
        @RequestBody @Valid TaskRemoveSignDTO dto);

    @GetMapping("/{id}/form")
    @Operation(summary = "获取任务表单")
    public Result<WorkflowFormRecordDTO> getTaskForm(
        @PathVariable String id);

    @PostMapping("/form/save")
    @Operation(summary = "保存任务表单")
    public Result<Void> saveTaskForm(
        @RequestBody @Valid TaskFormSaveDTO dto);

    @GetMapping("/{id}/history")
    @Operation(summary = "获取任务流转历史")
    public Result<List<TaskHistoryDTO>> getTaskHistory(
        @PathVariable String id);
}
```

### 3.4 表单控制器

```java
@RestController
@RequestMapping("/api/workflow/forms")
@Tag(name = "表单管理", description = "表单相关接口")
public class WorkflowFormController {

    @PostMapping
    @Operation(summary = "创建表单")
    public Result<WorkflowFormDTO> createForm(
        @RequestBody @Valid WorkflowFormDTO dto);

    @PutMapping("/{id}")
    @Operation(summary = "更新表单")
    public Result<WorkflowFormDTO> updateForm(
        @PathVariable Long id,
        @RequestBody @Valid WorkflowFormDTO dto);

    @DeleteMapping("/{id}")
    @Operation(summary = "删除表单")
    public Result<Void> deleteForm(@PathVariable Long id);

    @GetMapping("/{id}")
    @Operation(summary = "获取表单")
    public Result<WorkflowFormDTO> getForm(@PathVariable Long id);

    @GetMapping
    @Operation(summary = "分页查询表单")
    public Result<Page<WorkflowFormDTO>> listForms(FormQueryDTO query);

    @PostMapping("/record/save")
    @Operation(summary = "保存表单数据")
    public Result<Void> saveFormRecord(
        @RequestBody @Valid FormRecordSaveDTO dto);

    @GetMapping("/record/{id}")
    @Operation(summary = "获取表单数据")
    public Result<FormRecordDTO> getFormRecord(@PathVariable String id);

    @DeleteMapping("/record/{id}")
    @Operation(summary = "删除表单数据")
    public Result<Void> deleteFormRecord(@PathVariable String id);

    @PostMapping("/{id}/copy")
    @Operation(summary = "复制表单")
    public Result<WorkflowFormDTO> copyForm(
        @PathVariable Long id,
        @RequestParam String newName);
}
```

### 3.5 监控统计控制器

```java
@RestController
@RequestMapping("/api/workflow/monitor")
@Tag(name = "流程监控", description = "流程监控统计接口")
public class WorkflowMonitorController {

    @GetMapping("/statistics")
    @Operation(summary = "流程统计")
    public Result<WorkflowStatisticsDTO> getStatistics(
        StatisticsQueryDTO query);

    @GetMapping("/performance")
    @Operation(summary = "流程性能分析")
    public Result<WorkflowPerformanceDTO> getPerformance(
        PerformanceQueryDTO query);

    @GetMapping("/node-durations")
    @Operation(summary = "节点停留时间分析")
    public Result<List<NodeDurationDTO>> getNodeDurations(
        @RequestParam String definitionKey);

    @GetMapping("/completion-rate")
    @Operation(summary = "流程完成率统计")
    public Result<CompletionRateDTO> getCompletionRate(
        CompletionRateQueryDTO query);

    @GetMapping("/overdue-tasks")
    @Operation(summary = "超时任务统计")
    public Result<List<OverdueTaskDTO>> getOverdueTasks(
        OverdueQueryDTO query);

    @GetMapping("/heatmap")
    @Operation(summary = "流程热力图")
    public Result<HeatmapDTO> getWorkflowHeatmap(
        HeatmapQueryDTO query);

    @GetMapping("/trend")
    @Operation(summary = "流程趋势分析")
    public Result<List<TrendDataDTO>> getWorkflowTrend(
        TrendQueryDTO query);
}
```

---

## 四、配置设计

### 4.1 application.yml

```yaml
server:
  port: 8095

spring:
  application:
    name: qooerp-workflow
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/qooerp_workflow
    username: qooerp_workflow
    password: qooerp_workflow_2026
  data:
    redis:
      host: localhost
      port: 6379
      database: 0

# Flowable 配置
flowable:
  database-schema-update: true
  async-executor-activate: true
  history-level: audit
  database-type: postgres
  process-definition-cache-limit: 100
  enable-safe-xml: true

# MyBatis-Plus 配置
mybatis-plus:
  mapper-locations: classpath*:mapper/**/*Mapper.xml
  type-aliases-package: com.qoobot.qooerp.workflow.domain
  configuration:
    map-underscore-to-camel-case: true
    cache-enabled: true

# 工作流配置
workflow:
  # 流程配置
  process:
    auto-deploy: false
    enable-withdraw: true
    withdraw-time-limit: 24h
    enable-transfer: true
    enable-delegate: true

  # 任务配置
  task:
    enable-add-sign: true
    enable-remove-sign: true
    enable-cc: true
    timeout-reminder: true
    timeout-hours: 48
    auto-timeout-action: reminder

  # 通知配置
  notification:
    enable-todo-notification: true
    enable-approval-notification: true
    enable-overdue-reminder: true
    notification-types:
      - email
      - sms
      - site-message
      - wechat

  # 表单配置
  form:
    enable-dynamic-form: true
    enable-form-validation: true
    max-form-size: 10MB

  # 监控配置
  monitor:
    enable-statistics: true
    enable-performance-analysis: true
    cache-statistics: true
    cache-hours: 24

# Nacos 配置
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: qooerp
        group: WORKFLOW_GROUP
      config:
        server-addr: localhost:8848
        namespace: qooerp
        group: WORKFLOW_GROUP
        file-extension: yaml
```

---

## 五、异常处理

### 5.1 全局异常处理

```java
@RestControllerAdvice
public class WorkflowExceptionHandler {

    @ExceptionHandler(WorkflowDefinitionNotFoundException.class)
    public Result<Void> handleDefinitionNotFound(
        WorkflowDefinitionNotFoundException e) {
        return Result.error("WF_DEF_004", "流程定义不存在");
    }

    @ExceptionHandler(WorkflowInstanceNotFoundException.class)
    public Result<Void> handleInstanceNotFound(
        WorkflowInstanceNotFoundException e) {
        return Result.error("WF_INS_002", "流程实例不存在");
    }

    @ExceptionHandler(TaskNotFoundException.class)
    public Result<Void> handleTaskNotFound(TaskNotFoundException e) {
        return Result.error("WF_TASK_001", "任务不存在或已被处理");
    }

    @ExceptionHandler(TaskPermissionException.class)
    public Result<Void> handleTaskPermission(TaskPermissionException e) {
        return Result.error("WF_TASK_002", "无权限处理该任务");
    }

    @ExceptionHandler(FormValidationException.class)
    public Result<Void> handleFormValidation(FormValidationException e) {
        return Result.error("WF_FORM_001", "表单数据验证失败: " + e.getMessage());
    }
}
```

---

## 六、安全设计

### 6.1 权限注解

```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface WorkflowPermission {

    /**
     * 流程定义Key
     */
    String definitionKey();

    /**
     * 操作类型
     */
    WorkflowOperation operation();
}

public enum WorkflowOperation {
    START,    // 发起流程
    APPROVE,  // 审批任务
    MANAGE,   // 流程管理
    VIEW,     // 查看流程
    WITHDRAW  // 撤回流程
}
```

### 6.2 权限拦截器

```java
@Component
public class WorkflowPermissionInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request,
                           HttpServletResponse response,
                           Object handler) {
        // 检查流程权限
        return checkWorkflowPermission(request, handler);
    }
}
```

---

**文档版本**: v2.0
**最后更新**: 20xx-xx-xx
