# QooERP 通知服务模块 - 数据设计文档

> 数据库类型: PostgreSQL
> 版本: 15+

## 数据库表

### notify_record（通知记录表）

| 字段名 | PostgreSQL类型 | 允许NULL | 默认值 | 说明 |
|--------|----------------|----------|--------|------|
| id | BIGSERIAL | NO | - | 主键(自增) |
| notify_no | VARCHAR(50) | NO | - | 通知编号 |
| type | ENUM | NO | - | 通知类型(email/sms/push/internal/webhook) |
| receiver | VARCHAR(500) | NO | - | 接收者 |
| title | VARCHAR(500) | YES | - | 标题 |
| content | TEXT | YES | - | 内容 |
| template_id | BIGINT | YES | - | 模板ID |
| status | ENUM | NO | PENDING | 状态(PENDING/SENDING/SUCCESS/FAILED) |
| error_msg | VARCHAR(1000) | YES | - | 错误信息 |
| retry_count | INTEGER | NO | 0 | 重试次数 |
| retry_time | TIMESTAMP | YES | - | 下次重试时间 |
| sent_time | TIMESTAMP | YES | - | 发送时间 |
| extra_params | JSONB | YES | - | 扩展参数(二进制JSON，支持索引) |
| tenant_id | BIGINT | NO | - | 租户ID |
| create_time | TIMESTAMP | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | YES | CURRENT_TIMESTAMP | 更新时间(自动触发器) |
| deleted | SMALLINT | NO | 0 | 删除标记 |

**索引：**
- PRIMARY KEY (id)
- UNIQUE uk_notify_no (notify_no, tenant_id, deleted)
- INDEX idx_type (type)
- INDEX idx_status (status)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_create_time (create_time)
- INDEX idx_template_id (template_id)

### notify_template（通知模板表）

| 字段名 | PostgreSQL类型 | 允许NULL | 默认值 | 说明 |
|--------|----------------|----------|--------|------|
| id | BIGSERIAL | NO | - | 主键(自增) |
| template_code | VARCHAR(50) | NO | - | 模板编码 |
| template_name | VARCHAR(200) | NO | - | 模板名称 |
| category | VARCHAR(50) | YES | - | 分类 |
| type | ENUM | NO | - | 类型(email/sms/push/internal/webhook) |
| subject | VARCHAR(500) | YES | - | 邮件主题 |
| content | TEXT | NO | - | 内容(支持模板变量) |
| variables | JSONB | YES | - | 变量定义 |
| status | SMALLINT | NO | 1 | 状态(0:禁用,1:启用) |
| tenant_id | BIGINT | NO | - | 租户ID |
| create_time | TIMESTAMP | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | YES | CURRENT_TIMESTAMP | 更新时间(自动触发器) |
| deleted | SMALLINT | NO | 0 | 删除标记 |

**索引：**
- PRIMARY KEY (id)
- UNIQUE uk_template_code (template_code, tenant_id, deleted)
- INDEX idx_type (type)
- INDEX idx_category (category)
- INDEX idx_status (status)
- INDEX idx_tenant_id (tenant_id)

### notify_subscription（用户订阅表）

| 字段名 | PostgreSQL类型 | 允许NULL | 默认值 | 说明 |
|--------|----------------|----------|--------|------|
| id | BIGSERIAL | NO | - | 主键(自增) |
| user_id | BIGINT | NO | - | 用户ID |
| channel_type | VARCHAR(50) | NO | - | 渠道类型(email/sms/push/internal) |
| receiver | VARCHAR(500) | YES | - | 接收者(邮箱/手机号/设备ID等) |
| subscribed | SMALLINT | NO | 1 | 是否订阅(0:否,1:是) |
| tenant_id | BIGINT | NO | - | 租户ID |
| create_time | TIMESTAMP | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | YES | CURRENT_TIMESTAMP | 更新时间(自动触发器) |
| deleted | SMALLINT | NO | 0 | 删除标记 |

**索引：**
- PRIMARY KEY (id)
- UNIQUE uk_user_channel (user_id, channel_type, tenant_id, deleted)
- INDEX idx_user_id (user_id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_channel_type (channel_type)

### notify_config（通知配置表）

| 字段名 | PostgreSQL类型 | 允许NULL | 默认值 | 说明 |
|--------|----------------|----------|--------|------|
| id | BIGSERIAL | NO | - | 主键(自增) |
| config_key | VARCHAR(100) | NO | - | 配置键 |
| config_value | TEXT | YES | - | 配置值 |
| description | VARCHAR(500) | YES | - | 说明 |
| tenant_id | BIGINT | NO | - | 租户ID |
| create_time | TIMESTAMP | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | YES | CURRENT_TIMESTAMP | 更新时间(自动触发器) |
| deleted | SMALLINT | NO | 0 | 删除标记 |

**索引：**
- PRIMARY KEY (id)
- UNIQUE uk_config_key (config_key, tenant_id, deleted)
- INDEX idx_tenant_id (tenant_id)

### notify_blacklist（黑名单表）

| 字段名 | PostgreSQL类型 | 允许NULL | 默认值 | 说明 |
|--------|----------------|----------|--------|------|
| id | BIGSERIAL | NO | - | 主键(自增) |
| receiver | VARCHAR(500) | NO | - | 接收者 |
| channel_type | VARCHAR(50) | YES | - | 渠道类型(为空表示全部) |
| reason | VARCHAR(500) | YES | - | 拉黑原因 |
| tenant_id | BIGINT | NO | - | 租户ID |
| create_time | TIMESTAMP | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | YES | CURRENT_TIMESTAMP | 更新时间(自动触发器) |
| deleted | SMALLINT | NO | 0 | 删除标记 |

**索引：**
- PRIMARY KEY (id)
- UNIQUE uk_receiver (receiver, channel_type, tenant_id, deleted)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_channel_type (channel_type)

### notify_dnd（免打扰配置表）

| 字段名 | PostgreSQL类型 | 允许NULL | 默认值 | 说明 |
|--------|----------------|----------|--------|------|
| id | BIGSERIAL | NO | - | 主键(自增) |
| user_id | BIGINT | NO | - | 用户ID |
| channel_type | VARCHAR(50) | YES | - | 渠道类型(为空表示全部) |
| start_time | TIME | YES | - | 开始时间 |
| end_time | TIME | YES | - | 结束时间 |
| status | SMALLINT | NO | 1 | 状态(0:关闭,1:开启) |
| tenant_id | BIGINT | NO | - | 租户ID |
| create_time | TIMESTAMP | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | TIMESTAMP | YES | CURRENT_TIMESTAMP | 更新时间(自动触发器) |
| deleted | SMALLINT | NO | 0 | 删除标记 |

**索引：**
- PRIMARY KEY (id)
- INDEX idx_user_id (user_id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_channel_type (channel_type)

## PostgreSQL 特性说明

### 1. 枚举类型
PostgreSQL 支持原生的 ENUM 类型，用于限制字段取值范围：
- `notify_status_enum`: PENDING, SENDING, SUCCESS, FAILED
- `notify_type_enum`: email, sms, push, internal, webhook
- `template_type_enum`: email, sms, push, internal, webhook

### 2. JSONB 类型
使用 JSONB 类型存储 JSON 数据，相比 JSON 类型：
- 二进制存储，查询性能更高
- 支持索引，可以针对 JSON 字段创建索引
- 支持丰富的 JSON 操作符和函数

### 3. 自动更新时间
使用触发器自动更新 `update_time` 字段：
```sql
CREATE OR REPLACE FUNCTION update_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.update_time = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 4. 自增主键
使用 `BIGSERIAL` 类型实现自增主键，等价于：
```sql
CREATE SEQUENCE table_id_seq;
CREATE TABLE (
  id BIGINT NOT NULL DEFAULT nextval('table_id_seq')
);
```

### 5. 时间类型
- `TIMESTAMP`: 不带时区的时间戳
- `TIME`: 时间类型，用于存储时间段
- `CURRENT_TIMESTAMP`: 当前时间戳

### 6. 数据类型映射

| PostgreSQL | Java | 说明 |
|------------|-----|------|
| BIGSERIAL | Long | 自增主键 |
| VARCHAR(n) | String | 变长字符串 |
| TEXT | String | 长文本 |
| INTEGER | Integer | 整数 |
| SMALLINT | Integer | 小整数 |
| TIMESTAMP | LocalDateTime | 时间戳 |
| TIME | LocalTime | 时间 |
| JSONB | JsonNode/Map | JSON数据 |
| ENUM | String/Enum | 枚举 |

---

**文档版本**: v1.0
