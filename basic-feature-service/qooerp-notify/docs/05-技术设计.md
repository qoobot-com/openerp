# QooERP 通知服务模块 - 技术设计文档

## 技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Spring Boot | 3.2.x | 基础框架 |
| JavaMail | 1.6.x | 邮件发送 |
| PostgreSQL | 15+ | 数据库 |
| MyBatis-Plus | 3.5.x | ORM框架 |
| Redis | 7.0+ | 缓存、限流 |
| RocketMQ | 5.x | 消息队列 |
| Thymeleaf | 3.x | 模板引擎 |
| Jackson | 2.x | JSON处理 |
| Lombok | 1.18.x | 简化代码 |
| Hutool | 5.x | 工具类 |

## PostgreSQL 依赖

### pom.xml

```xml
<!-- PostgreSQL 驱动 -->
<dependency>
    <groupId>org.postgresql</groupId>
    <artifactId>postgresql</artifactId>
    <version>42.7.1</version>
</dependency>

<!-- MyBatis-Plus PostgreSQL 适配 -->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>3.5.5</version>
</dependency>
```

## 配置

### application.yml

```yaml
server:
  port: 8099

spring:
  application:
    name: qooerp-notify

  # PostgreSQL 数据源配置
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/qooerp_notify?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: qooerp_notify
    password: qooerp_notify_2026
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-timeout: 30000

  # Redis配置
  data:
    redis:
      host: localhost
      port: 6379
      database: 0

  # 邮件配置
  mail:
    host: smtp.example.com
    port: 587
    username: xxx@example.com
    password: xxx
    properties:
      mail.smtp.auth: true
      mail.smtp.starttls.enable: true

  # RocketMQ配置
  cloud:
    stream:
      rocketmq:
        binder:
          name-server: localhost:9876

  # JPA 配置 (可选，用于原生SQL)
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    show-sql: false

# MyBatis-Plus配置
mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  type-aliases-package: com.qoobot.notify.domain
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
    # PostgreSQL 特定配置
    jdbc-type-for-null: 'null'
  global-config:
    db-config:
      # PostgreSQL 使用序列生成ID
      id-type: auto
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0

# 通知配置
notify:
  # 邮件配置
  email:
    enabled: true
    from: noreply@qooerp.com
    from-name: QooERP

  # 短信配置
  sms:
    enabled: true
    provider: aliyun
    access-key-id: ${SMS_ACCESS_KEY_ID}
    access-key-secret: ${SMS_ACCESS_KEY_SECRET}
    sign-name: QooERP
    region-id: cn-hangzhou

  # 推送配置
  push:
    enabled: true
    provider: jpush
    app-key: ${PUSH_APP_KEY}
    master-secret: ${PUSH_MASTER_SECRET}

  # Webhook配置
  webhook:
    enabled: true
    timeout: 5000
    retry-times: 3

  # 重试配置
  retry:
    enabled: true
    max-times: 3
    interval: 60000

  # 限流配置
  rate-limit:
    enabled: true
    qps: 100

# 日志配置
logging:
  level:
    com.qoobot.notify: debug
```

## PostgreSQL 适配说明

### 1. 数据类型映射

| Java | PostgreSQL | MyBatis-Plus | 说明 |
|------|------------|--------------|------|
| Long | BIGINT/BIGSERIAL | BIGINT | 主键 |
| String | VARCHAR(n) | VARCHAR | 字符串 |
| String | TEXT | TEXT | 长文本 |
| Integer | INTEGER | INTEGER | 整数 |
| Integer | SMALLINT | SMALLINT | 小整数 |
| LocalDateTime | TIMESTAMP | TIMESTAMP | 时间戳 |
| LocalTime | TIME | TIME | 时间 |
| JsonNode/Map | JSONB | JSON | JSON数据 |
| Enum | ENUM | VARCHAR | 枚举 |

### 2. Entity 定义示例

```java
@Data
@TableName("notify_record")
public class NotifyRecord {
    @TableId(type = IdType.AUTO)
    private Long id;

    private String notifyNo;

    // 使用 String 类型存储 ENUM，查询时转换
    private String type;

    private String receiver;

    private String title;

    private String content;

    private Long templateId;

    // 状态使用 String，对应 PostgreSQL ENUM
    private String status;

    private String errorMsg;

    private Integer retryCount;

    private LocalDateTime retryTime;

    private LocalDateTime sentTime;

    // JSONB 类型使用 JsonNode 或 String
    private JsonNode extraParams;

    private Long tenantId;

    private LocalDateTime createTime;

    private LocalDateTime updateTime;

    @TableLogic
    private Integer deleted;
}
```

### 3. JSONB 字段使用

```java
// 1. 实体定义
@TableField(typeHandler = JacksonTypeHandler.class)
private Map<String, Object> extraParams;

// 2. 查询使用 JSONB 索引
@Select("SELECT * FROM notify_record " +
        "WHERE extra_params->>'key' = #{value}")
List<NotifyRecord> selectByJsonField(@Param("value") String value);

// 3. JSONB 索引创建（在数据库脚本中）
-- CREATE INDEX idx_extra_params ON notify_record USING gin (extra_params);
```

### 4. MyBatis XML 配置

```xml
<!-- mapper.xml 示例 -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qoobot.notify.repository.NotifyRecordMapper">

    <select id="selectByTypeAndStatus" resultType="NotifyRecord">
        SELECT * FROM notify_record
        WHERE type = #{type}
          AND status = #{status}
          AND deleted = 0
        ORDER BY create_time DESC
        LIMIT #{limit}
    </select>

    <!-- 使用 JSONB 查询 -->
    <select id="selectByExtraParam" resultType="NotifyRecord">
        SELECT * FROM notify_record
        WHERE extra_params->>${key} = #{value}
          AND deleted = 0
    </select>

</mapper>
```

## 架构设计

### 1. 分层架构

```
Controller层   → 接收HTTP请求，参数校验
    ↓
Service层     → 业务逻辑处理
    ↓
Manager层     → 业务编排、复杂逻辑
    ↓
Repository层  → 数据访问
```

### 2. 发送器设计

```java
// 统一发送接口
public interface NotifySender {
    NotifyResult send(NotifyRequest request);
    String getType();
}

// 各渠道实现
public class EmailSender implements NotifySender { }
public class SmsSender implements NotifySender { }
public class PushSender implements NotifySender { }
public class InternalSender implements NotifySender { }
public class WebhookSender implements NotifySender { }

// 发送工厂
public class NotifySenderFactory {
    private Map<String, NotifySender> senders;

    public NotifySender getSender(String type) {
        return senders.get(type);
    }
}
```

### 3. 模板引擎

使用 Thymeleaf 作为模板引擎，支持变量替换和条件渲染。

```java
// 模板解析器
public interface TemplateParser {
    String parse(String template, Map<String, Object> variables);
}

// Thymeleaf实现
public class ThymeleafTemplateParser implements TemplateParser { }
```

### 4. 重试机制

- 基于定时任务扫描失败记录
- 指数退避策略
- 最大重试次数限制
- 重试失败告警

### 5. 限流机制

- 基于Redis + Lua脚本实现
- 按租户和渠道分别限流
- 超限后返回错误或进入队列

### 6. 消息队列

使用 RocketMQ 异步发送通知，提高吞吐量。

```java
// 生产者
public class NotifyProducer {
    public void send(NotifyMessage message) {
        rocketMQTemplate.asyncSend("notify-topic", message);
    }
}

// 消费者
public class NotifyConsumer {
    @RocketMQMessageListener(topic = "notify-topic")
    public void onMessage(NotifyMessage message) {
        notifyService.process(message);
    }
}
```

## 核心组件

### 1. 通知服务 (NotifyService)

```java
public interface NotifyService {
    // 发送通知
    String send(NotifyRequest request);

    // 批量发送
    List<String> sendBatch(List<NotifyRequest> requests);

    // 使用模板发送
    String sendByTemplate(String templateCode, String receiver, Map<String, Object> variables);

    // 重试发送
    void retry(Long recordId);
}
```

### 2. 模板服务 (TemplateService)

```java
public interface TemplateService {
    Long create(TemplateDTO dto);
    void update(TemplateDTO dto);
    void delete(Long id);
    TemplateVO get(Long id);
    Page<TemplateVO> page(TemplateQuery query);
    String preview(Long templateId, Map<String, Object> variables);
}
```

### 3. 订阅服务 (SubscriptionService)

```java
public interface SubscriptionService {
    void subscribe(SubscriptionDTO dto);
    void unsubscribe(UnsubscribeDTO dto);
    List<SubscriptionVO> getUserSubscriptions(Long userId);
    void setDND(DNDDTO dto);
}
```

### 4. 配置服务 (ConfigService)

```java
public interface ConfigService {
    NotifyConfigVO getConfig();
    void updateConfig(NotifyConfigDTO dto);
    ChannelConfigVO getChannelConfig(String channelType);
    void updateChannelConfig(String channelType, ChannelConfigDTO dto);
}
```

## 异常处理

```java
// 自定义异常
public class NotifyException extends RuntimeException { }
public class TemplateNotFoundException extends NotifyException { }
public class SendFailedException extends NotifyException { }
public class RateLimitException extends NotifyException { }

// 全局异常处理
@ControllerAdvice
public class NotifyExceptionHandler {
    @ExceptionHandler(NotifyException.class)
    public Result<Void> handleNotifyException(NotifyException e) {
        log.error("通知异常", e);
        return Result.fail(e.getMessage());
    }
}
```

## 安全设计

1. **权限校验**: 集成网关统一认证
2. **数据隔离**: 基于tenant_id租户隔离
3. **敏感信息**: 配置加密存储
4. **黑名单**: 拦黑名单用户发送

## 监控告警

1. **发送成功率监控**
2. **发送延迟监控**
3. **队列积压监控**
4. **异常告警**

---

**文档版本**: v1.0
**数据库**: PostgreSQL 15+
