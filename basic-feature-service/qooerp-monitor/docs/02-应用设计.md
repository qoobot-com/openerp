# QooERP 监控服务模块 - 应用设计文档

## 一、API 接口概览

### 1.1 OTLP 数据采集接口（OpenTelemetry 协议）

| 接口路径 | 方法 | 说明 |
|---------|------|------|
| `/monitor/api/otlp/v1/traces` | POST | 接收链路追踪数据（gRPC/HTTP） |
| `/monitor/api/otlp/v1/metrics` | POST | 接收指标数据（gRPC/HTTP） |
| `/monitor/api/otlp/v1/logs` | POST | 接收日志数据（gRPC/HTTP） |

### 1.2 Metrics 采集接口

| 接口路径 | 方法 | 说明 |
|---------|------|------|
| `/monitor/api/metrics/push` | POST | 主动推送指标数据 |
| `/monitor/api/metrics/scrape` | GET | Prometheus 格式拉取指标 |

### 1.3 Web 界面接口

| 接口路径 | 方法 | 说明 |
|---------|------|------|
| `/` | GET | 仪表盘首页（Vue 3 + TDesign） |
| `/traces` | GET | 链路追踪查询页 |
| `/metrics` | GET | 指标趋势分析页 |
| `/logs` | GET | 日志查询页 |
| `/alerts` | GET | 告警管理页 |

### 1.4 管理接口（Vue 3 前端）

| 接口路径 | 方法 | 说明 |
|---------|------|------|
| `/api/monitor/dashboard/overview` | GET | 仪表盘概览数据（JSON） |
| `/api/monitor/dashboard/services-status` | GET | 服务状态数据（JSON） |
| `/api/monitor/dashboard/realtime-alerts` | GET | 实时告警数据（JSON） |
| `/api/monitor/dashboard/metrics-trend` | POST | 指标趋势数据（JSON） |

---

## 二、核心接口定义

### 2.1 MonitorController（监控服务控制器）

```java
@RestController
@RequestMapping("/api/monitor/service")
public class MonitorController {
    // 服务管理
    @GetMapping("/list")
    public Result<List<MonitorServiceDTO>> listServices();

    @PostMapping("/register")
    public Result<Long> registerService(@RequestBody MonitorServiceCreateDTO dto);

    @PutMapping("/{id}")
    public Result<Void> updateService(@PathVariable Long id, @RequestBody MonitorServiceUpdateDTO dto);

    @DeleteMapping("/{id}")
    public Result<Void> deleteService(@PathVariable Long id);

    @GetMapping("/{id}")
    public Result<MonitorServiceDTO> getService(@PathVariable Long id);

    @PostMapping("/check")
    public Result<Void> healthCheck(@RequestBody ServiceCheckDTO dto);
}
```

### 2.2 MonitorAlertController（告警管理控制器）

```java
@RestController
@RequestMapping("/api/monitor/alert")
public class MonitorAlertController {
    // 告警管理
    @GetMapping("/list")
    public Result<Page<MonitorAlertDTO>> listAlerts(@RequestBody AlertQueryDTO dto);

    @GetMapping("/{id}")
    public Result<MonitorAlertDTO> getAlert(@PathVariable Long id);

    @PostMapping("/handle/{id}")
    public Result<Void> handleAlert(@PathVariable Long id, @RequestBody AlertHandleDTO dto);

    @GetMapping("/statistics")
    public Result<AlertStatisticsDTO> getStatistics(@RequestBody AlertStatisticsQueryDTO dto);
}
```

### 2.3 MonitorAlertRuleController（告警规则控制器）

```java
@RestController
@RequestMapping("/api/monitor/alert-rule")
public class MonitorAlertRuleController {
    @PostMapping("/create")
    public Result<Long> createRule(@RequestBody AlertRuleCreateDTO dto);

    @PutMapping("/{id}")
    public Result<Void> updateRule(@PathVariable Long id, @RequestBody AlertRuleUpdateDTO dto);

    @DeleteMapping("/{id}")
    public Result<Void> deleteRule(@PathVariable Long id);

    @GetMapping("/list")
    public Result<Page<AlertRuleDTO>> listRules(@RequestBody AlertRuleQueryDTO dto);

    @GetMapping("/{id}")
    public Result<AlertRuleDTO> getRule(@PathVariable Long id);

    @PutMapping("/{id}/enable")
    public Result<Void> enableRule(@PathVariable Long id);

    @PutMapping("/{id}/disable")
    public Result<Void> disableRule(@PathVariable Long id);
}
```

### 2.4 MonitorAlertChannelController（告警通知渠道控制器）

```java
@RestController
@RequestMapping("/api/monitor/alert-channel")
public class MonitorAlertChannelController {
    @PostMapping("/create")
    public Result<Long> createChannel(@RequestBody AlertChannelCreateDTO dto);

    @PutMapping("/{id}")
    public Result<Void> updateChannel(@PathVariable Long id, @RequestBody AlertChannelUpdateDTO dto);

    @DeleteMapping("/{id}")
    public Result<Void> deleteChannel(@PathVariable Long id);

    @GetMapping("/list")
    public Result<List<AlertChannelDTO>> listChannels();

    @GetMapping("/{id}")
    public Result<AlertChannelDTO> getChannel(@PathVariable Long id);
}
```

### 2.5 MonitorLogController（日志查询控制器）

```java
@RestController
@RequestMapping("/api/monitor/log")
public class MonitorLogController {
    @PostMapping("/list")
    public Result<Page<MonitorLogDTO>> listLogs(@RequestBody LogQueryDTO dto);

    @GetMapping("/types")
    public Result<List<String>> listLogTypes();

    @GetMapping("/levels")
    public Result<List<String>> listLogLevels();
}
```

### 2.6 MonitorMetricsController（指标查询控制器）

```java
@RestController
@RequestMapping("/api/monitor/metrics")
public class MonitorMetricsController {
    @GetMapping("/current")
    public Result<MonitorMetricsDTO> getCurrentMetrics(@RequestParam String serviceName);

    @PostMapping("/history")
    public Result<Page<MonitorMetricsDTO>> getHistoryMetrics(@RequestBody MetricsQueryDTO dto);

    @GetMapping("/summary")
    public Result<MetricsSummaryDTO> getSummary(@RequestBody MetricsSummaryQueryDTO dto);

    @GetMapping("/trend")
    public Result<List<MetricsTrendDTO>> getTrend(@RequestBody MetricsTrendQueryDTO dto);
}
```

### 2.7 MonitorTraceController（链路追踪控制器）

```java
@RestController
@RequestMapping("/api/monitor/trace")
public class MonitorTraceController {
    @GetMapping("/{traceId}")
    public Result<List<MonitorTraceDTO>> getTrace(@PathVariable String traceId);

    @PostMapping("/list")
    public Result<Page<MonitorTraceDTO>> listTraces(@RequestBody TraceQueryDTO dto);

    @GetMapping("/spans/{traceId}")
    public Result<List<MonitorTraceDTO>> getSpans(@PathVariable String traceId);
}
```

### 2.8 MonitorDashboardController（监控仪表盘控制器）

```java
@RestController
@RequestMapping("/api/monitor/dashboard")
public class MonitorDashboardController {
    @GetMapping("/overview")
    public Result<DashboardOverviewDTO> getOverview();

    @GetMapping("/services-status")
    public Result<List<ServiceStatusDTO>> getServicesStatus();

    @GetMapping("/realtime-alerts")
    public Result<List<MonitorAlertDTO>> getRealtimeAlerts();

    @GetMapping("/metrics-trend")
    public Result<List<MetricsTrendDTO>> getMetricsTrend(@RequestBody MetricsTrendQueryDTO dto);
}
```

---

## 三、OTLP 采集接口（新增）

### 3.1 OtlpReceiverController

```java
@RestController
@RequestMapping("/monitor/api/otlp")
public class OtlpReceiverController {

    /**
     * 接收 OpenTelemetry Traces 数据
     * Content-Type: application/x-protobuf
     */
    @PostMapping(value = "/v1/traces", consumes = "application/x-protobuf")
    public Mono<Void> receiveTraces(@RequestBody byte[] data) {
        return otlpParserService.parseTraces(data)
            .doOnNext(traceBatch -> traceStorageService.saveTraces(traceBatch))
            .then();
    }

    /**
     * 接收 OpenTelemetry Metrics 数据
     * Content-Type: application/x-protobuf
     */
    @PostMapping(value = "/v1/metrics", consumes = "application/x-protobuf")
    public Mono<Void> receiveMetrics(@RequestBody byte[] data) {
        return otlpParserService.parseMetrics(data)
            .doOnNext(metricsBatch -> metricStorageService.saveMetrics(metricsBatch))
            .then();
    }

    /**
     * 接收 OpenTelemetry Logs 数据
     * Content-Type: application/x-protobuf
     */
    @PostMapping(value = "/v1/logs", consumes = "application/x-protobuf")
    public Mono<Void> receiveLogs(@RequestBody byte[] data) {
        return otlpParserService.parseLogs(data)
            .doOnNext(logBatch -> logStorageService.saveLogs(logBatch))
            .then();
    }
}
```

---

## 四、Metrics 采集接口（新增）

### 4.1 MetricsCollectorController

```java
@RestController
@RequestMapping("/monitor/api/metrics")
public class MetricsCollectorController {

    /**
     * 主动推送指标数据
     */
    @PostMapping("/push")
    public Result<Void> pushMetrics(@RequestBody MetricsPushRequest request) {
        metricCollectorService.collectMetrics(request);
        return Result.success();
    }

    /**
     * Prometheus 格式拉取指标（兼容性接口）
     */
    @GetMapping(value = "/scrape", produces = "text/plain")
    public String scrapeMetrics(@RequestParam String serviceName) {
        return metricCollectorService.scrapeMetrics(serviceName);
    }
}
```

---

## 五、DTO 定义

### 5.1 OTLP 相关 DTO

```java
// 追踪数据
public class TraceData {
    private String traceId;
    private String spanId;
    private String parentSpanId;
    private String spanName;
    private String spanKind;
    private Long startTime;
    private Long duration;
    private String statusCode;
    private Map<String, String> tags;
    private String instance;
}

// 指标数据
public class MetricData {
    private String metricName;
    private String metricType;
    private Double metricValue;
    private Map<String, String> tags;
    private String instance;
    private Long timestamp;
}

// 日志数据
public class LogData {
    private Long timestamp;
    private String level;
    private String loggerName;
    private String message;
    private String traceId;
    private String spanId;
    private String threadName;
    private Map<String, Object> context;
    private String instance;
}
```

### 5.2 仪表盘相关 DTO（Vue 3 前端）

```java
// 仪表盘概览
public class DashboardOverviewDTO {
    private Integer totalServices;
    private Integer healthyServices;
    private Integer unhealthyServices;
    private Integer activeAlerts;
    private Integer recoveredAlerts;
    private List<MetricsTrendDTO> recentMetricsTrend;
}

// 服务状态
public class ServiceStatusDTO {
    private String serviceName;
    private String status; // ONLINE/OFFLINE
    private String healthStatus; // HEALTHY/UNHEALTHY
    private LocalDateTime lastCheckTime;
}

// 指标趋势（ECharts 格式）
public class MetricsTrendDTO {
    private String metricName;
    private List<MetricPointDTO> points;
}

// 指标点（ECharts 格式）
public class MetricPointDTO {
    private Long timestamp;
    private Double value;
}

// ECharts 图表配置
public class EChartsOptionDTO {
    private String title;
    private String type; // line/bar/pie
    private List<String> xAxis;
    private List<Number> yAxis;
    private Map<String, Object> options;
}
```

---

## 六、响应格式

### 6.1 统一响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1739851200000
}
```

### 6.2 分页响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "records": [],
    "total": 100,
    "current": 1,
    "pageSize": 20
  },
  "timestamp": 1739851200000
}
```

### 6.3 Vue 3 前端专用响应（ECharts 格式）

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "metricName": "jvm_memory_used_bytes",
    "type": "line",
    "xAxis": ["10:00", "10:01", "10:02", "10:03"],
    "yAxis": [1024, 2048, 3072, 4096],
    "options": {
      "smooth": true,
      "areaStyle": {}
    }
  },
  "timestamp": 1739851200000
}
```

---

## 七、前端集成说明（Vue 3 + TDesign）

### 7.1 API 请求封装

```typescript
// qooerp-monitor-frontend/src/api/monitor.ts
import axios from 'axios'
import { MessagePlugin } from 'tdesign-vue-next'

const request = axios.create({
  baseURL: '/api/monitor',
  timeout: 30000
})

// 响应拦截
request.interceptors.response.use(
  (response) => {
    const { code, message, data } = response.data
    if (code === 200) {
      return data
    } else {
      MessagePlugin.error(message)
      return Promise.reject(new Error(message))
    }
  },
  (error) => {
    MessagePlugin.error('请求失败')
    return Promise.reject(error)
  }
)

// 仪表盘 API
export const dashboardApi = {
  getOverview: () => request.get<DashboardOverview>('/dashboard/overview'),
  getServicesStatus: () => request.get<ServiceStatus[]>('/dashboard/services-status'),
  getRealtimeAlerts: (limit: number = 10) =>
    request.get<Alert[]>('/dashboard/realtime-alerts', { params: { limit } }),
  getMetricsTrend: (params: MetricsTrendQuery) =>
    request.post<MetricsTrend>('/dashboard/metrics-trend', params)
}

// 导出
export default {
  dashboard: dashboardApi
}
```

### 7.2 Pinia Store（状态管理）

```typescript
// qooerp-monitor-frontend/src/stores/dashboard.ts
import { defineStore } from 'pinia'
import { ref } from 'vue'
import { dashboardApi } from '@/api/monitor'

export const useDashboardStore = defineStore('dashboard', () => {
  const overview = ref<DashboardOverview | null>(null)
  const services = ref<ServiceStatus[]>([])
  const alerts = ref<Alert[]>([])

  const fetchOverview = async () => {
    overview.value = await dashboardApi.getOverview()
  }

  const fetchServices = async () => {
    services.value = await dashboardApi.getServicesStatus()
  }

  const fetchAlerts = async (limit: number = 10) => {
    alerts.value = await dashboardApi.getRealtimeAlerts(limit)
  }

  return {
    overview,
    services,
    alerts,
    fetchOverview,
    fetchServices,
    fetchAlerts
  }
})
```

### 7.3 Vue 组件示例

```vue
<!-- qooerp-monitor-frontend/src/views/Dashboard.vue -->
<template>
  <div class="dashboard">
    <t-layout>
      <!-- 概览卡片 -->
      <t-card class="overview-card">
        <t-row :gutter="16">
          <t-col :span="6">
            <t-statistic title="总服务数" :value="overview?.totalServices" />
          </t-col>
          <t-col :span="6">
            <t-statistic title="健康服务" :value="overview?.healthyServices" />
          </t-col>
          <t-col :span="6">
            <t-statistic title="异常服务" :value="overview?.unhealthyServices" />
          </t-col>
          <t-col :span="6">
            <t-statistic title="活跃告警" :value="overview?.activeAlerts" />
          </t-col>
        </t-row>
      </t-card>

      <!-- ECharts 图表 -->
      <t-card class="chart-card">
        <template #header>
          <span>指标趋势</span>
        </template>
        <v-chart :option="chartOption" style="height: 400px" />
      </t-card>
    </t-layout>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useDashboardStore } from '@/stores/dashboard'
import VChart from 'vue-echarts'
import { use } from 'echarts/core'
import { CanvasRenderer } from 'echarts/renderers'
import { LineChart } from 'echarts/charts'
import { GridComponent, TooltipComponent } from 'echarts/components'

use([CanvasRenderer, LineChart, GridComponent, TooltipComponent])

const dashboardStore = useDashboardStore()
const overview = computed(() => dashboardStore.overview)

const chartOption = ref({})

onMounted(async () => {
  await dashboardStore.fetchOverview()
  const trend = await dashboardApi.getMetricsTrend({
    metricName: 'jvm_memory_used_bytes',
    timeRange: '1h'
  })

  chartOption.value = {
    xAxis: { type: 'category', data: trend.xAxis },
    yAxis: { type: 'value' },
    series: [{ type: 'line', data: trend.yAxis }]
  }
})
</script>

<style scoped lang="scss">
.dashboard {
  padding: 24px;

  .overview-card {
    margin-bottom: 16px;
  }

  .chart-card {
    margin-bottom: 16px;
  }
}
</style>
```

---

## 八、OpenAPI 规范

```yaml
openapi: 3.0.3
info:
  title: QooERP 监控服务模块 API
  version: 1.1.0
  description: qooerp-monitor 监控服务 API 文档，前端采用 Vue 3 + TDesign + ECharts

servers:
  - url: http://localhost:8101
    description: 本地开发环境
  - url: https://monitor.qooerp.com
    description: 生产环境

tags:
  - name: OTLP
    description: OpenTelemetry 数据采集接口
  - name: Metrics
    description: 指标采集接口
  - name: Dashboard
    description: 仪表盘接口（Vue 3 前端）

paths:
  # OTLP 采集接口
  /monitor/api/otlp/v1/traces:
    post:
      tags: [OTLP]
      summary: 接收链路追踪数据
      requestBody:
        content:
          application/x-protobuf:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: 成功接收

  /monitor/api/otlp/v1/metrics:
    post:
      tags: [OTLP]
      summary: 接收指标数据
      requestBody:
        content:
          application/x-protobuf:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: 成功接收

  # Metrics 采集接口
  /monitor/api/metrics/push:
    post:
      tags: [Metrics]
      summary: 主动推送指标数据
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                serviceName:
                  type: string
                metrics:
                  type: array
                  items:
                    $ref: '#/components/schemas/MetricData'
      responses:
        '200':
          description: 成功推送

  /monitor/api/metrics/scrape:
    get:
      tags: [Metrics]
      summary: Prometheus 格式拉取指标
      parameters:
        - name: serviceName
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Prometheus 格式指标
          content:
            text/plain:
              schema:
                type: string

  # 仪表盘接口（Vue 3 前端）
  /api/monitor/dashboard/overview:
    get:
      tags: [Dashboard]
      summary: 仪表盘概览
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Result'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/DashboardOverviewDTO'

  /api/monitor/dashboard/metrics-trend:
    post:
      tags: [Dashboard]
      summary: 指标趋势（ECharts 格式）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                metricName:
                  type: string
                timeRange:
                  type: string
                  enum: [1h, 6h, 24h, 7d]
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Result'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/EChartsOptionDTO'

components:
  schemas:
    MetricData:
      type: object
      properties:
        metricName:
          type: string
        metricType:
          type: string
          enum: [gauge, counter, timer, summary]
        metricValue:
          type: number
        tags:
          type: object
          additionalProperties:
            type: string
        instance:
          type: string
        timestamp:
          type: integer
          format: int64

    DashboardOverviewDTO:
      type: object
      properties:
        totalServices:
          type: integer
        healthyServices:
          type: integer
        unhealthyServices:
          type: integer
        activeAlerts:
          type: integer
        recoveredAlerts:
          type: integer
        recentMetricsTrend:
          type: array
          items:
            $ref: '#/components/schemas/MetricsTrendDTO'

    MetricsTrendDTO:
      type: object
      properties:
        metricName:
          type: string
        type:
          type: string
          enum: [line, bar, pie]
        xAxis:
          type: array
          items:
            type: string
        yAxis:
          type: array
          items:
            type: number
        options:
          type: object

    EChartsOptionDTO:
      type: object
      properties:
        metricName:
          type: string
        type:
          type: string
          enum: [line, bar, pie]
        xAxis:
          type: array
          items:
            type: string
        yAxis:
          type: array
          items:
            type: number
        options:
          type: object
          description: ECharts 配置选项

    Result:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
        data:
          type: object
        timestamp:
          type: integer
          format: int64
```

---

**文档版本**: v1.1
**更新日期**: 2026-02-18
**前端技术栈**: Vue 3 + TDesign + ECharts
