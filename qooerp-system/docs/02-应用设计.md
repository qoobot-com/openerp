# QooERP System 模块 - 应用设计文档

## 1. 应用概述

### 1.1 应用定位
QooERP System 模块是系统管理核心模块，提供字典管理、配置管理、参数设置、文件管理等系统级基础功能，为整个ERP系统提供配置和基础设施支持。

### 1.2 应用目标
- 提供系统字典数据管理，统一系统枚举值
- 提供系统参数配置管理，支持动态配置
- 提供文件上传下载功能
- 提供系统日志管理
- 提供定时任务管理

## 2. 应用架构

### 2.1 分层架构

```
qooerp-system/
├── qooerp-system-api/              # API接口定义
│   ├── dto/                        # 数据传输对象
│   │   ├── SystemDictDTO.java
│   │   ├── SystemConfigDTO.java
│   │   ├── SystemParamDTO.java
│   │   └── SystemFileDTO.java
│   ├── vo/                         # 视图对象
│   │   ├── SystemDictVO.java
│   │   ├── SystemConfigVO.java
│   │   ├── SystemParamVO.java
│   │   └── SystemFileVO.java
│   └── query/                      # 查询对象
│       └── SystemDictQuery.java
├── qooerp-system-service/          # 服务实现
│   ├── controller/                 # 控制器层
│   │   ├── SystemDictController.java
│   │   ├── SystemConfigController.java
│   │   ├── SystemParamController.java
│   │   ├── SystemFileController.java
│   │   └── SystemLogController.java
│   ├── service/                    # 服务层
│   │   ├── SystemDictService.java
│   │   ├── SystemConfigService.java
│   │   ├── SystemParamService.java
│   │   ├── SystemFileService.java
│   │   └── SystemLogService.java
│   ├── mapper/                     # 数据访问层
│   │   ├── SystemDictMapper.java
│   │   ├── SystemConfigMapper.java
│   │   ├── SystemParamMapper.java
│   │   ├── SystemFileMapper.java
│   │   └── SystemLogMapper.java
│   └── entity/                    # 实体类
│       ├── SystemDict.java
│       ├── SystemDictItem.java
│       ├── SystemConfig.java
│       ├── SystemParam.java
│       ├── SystemFile.java
│       └── SystemLog.java
└── qooerp-system-job/             # 定时任务模块
    └── job/                        # 定时任务
        ├── DataBackupJob.java
        └── LogCleanJob.java
```

### 2.2 模块依赖

```
qooerp-system
    ├── qooerp-common (公共组件)
    ├── qooerp-auth (认证模块)
    └── qooerp-permission (权限模块)
```

## 3. 核心功能设计

### 3.1 字典管理

#### 功能概述
提供系统字典类型和字典项的增删改查功能，支持多语言字典、分组管理、排序等功能。

#### 字典类型管理

**SystemDict实体**
```java
@Data
@TableName("system_dict")
public class SystemDict extends BaseEntity {
    private Long id;                    // 字典ID
    private String dictCode;            // 字典编码
    private String dictName;            // 字典名称
    private String dictType;            // 字典类型
    private String description;        // 描述
    private Integer sort;               // 排序
    private Boolean isSystem;           // 是否系统字典
}
```

**字典项管理**

**SystemDictItem实体**
```java
@Data
@TableName("system_dict_item")
public class SystemDictItem extends BaseEntity {
    private Long id;                    // 字典项ID
    private Long dictId;                // 所属字典ID
    private String itemValue;           // 字典值
    private String itemLabel;           // 字典标签
    private String itemColor;           // 标签颜色
    private Integer sort;               // 排序
    private Boolean isDefault;          // 是否默认
}
```

#### 字典缓存策略

```java
@Service
public class SystemDictCacheService {
    
    private static final String DICT_CACHE_KEY = "system:dict:";
    private static final String DICT_ITEM_CACHE_KEY = "system:dict:item:";
    
    /**
     * 获取字典类型缓存
     */
    @Cacheable(value = "systemDict", key = "#dictCode")
    public SystemDictVO getDictByCode(String dictCode) {
        return systemDictMapper.selectByCode(dictCode);
    }
    
    /**
     * 获取字典项列表缓存
     */
    @Cacheable(value = "systemDictItems", key = "#dictCode")
    public List<SystemDictItemVO> getDictItemsByCode(String dictCode) {
        return systemDictItemMapper.selectByDictCode(dictCode);
    }
    
    /**
     * 清除字典缓存
     */
    @CacheEvict(value = {"systemDict", "systemDictItems"}, key = "#dictCode")
    public void clearDictCache(String dictCode) {
    }
}
```

### 3.2 参数配置管理

#### 功能概述
提供系统参数的配置管理，支持参数分组、参数类型验证、参数加密等功能。

#### SystemParam实体

```java
@Data
@TableName("system_param")
public class SystemParam extends BaseEntity {
    private Long id;                    // 参数ID
    private String paramKey;            // 参数键
    private String paramValue;          // 参数值
    private String paramType;           // 参数类型
    private String paramGroup;          // 参数分组
    private String description;        // 描述
    private Boolean isSystem;           // 是否系统参数
    private Boolean isEncrypted;        // 是否加密
}
```

#### 参数类型枚举

```java
public enum ParamType {
    STRING("string", "字符串"),
    NUMBER("number", "数字"),
    BOOLEAN("boolean", "布尔值"),
    JSON("json", "JSON对象"),
    ARRAY("array", "数组");
    
    private String code;
    private String description;
}
```

#### 参数配置服务

```java
@Service
public class SystemParamServiceImpl implements SystemParamService {
    
    @Override
    @Cacheable(value = "systemParam", key = "#paramKey")
    public String getParamValue(String paramKey) {
        SystemParam param = systemParamMapper.selectByKey(paramKey);
        if (param == null) {
            return null;
        }
        
        // 解密处理
        if (Boolean.TRUE.equals(param.getIsEncrypted())) {
            return CryptoUtils.aesDecrypt(param.getParamValue(), getEncryptKey());
        }
        
        return param.getParamValue();
    }
    
    @Override
    @CacheEvict(value = "systemParam", key = "#paramDTO.paramKey")
    public void updateParam(SystemParamDTO paramDTO) {
        SystemParam param = BeanUtil.copyProperties(paramDTO, SystemParam.class);
        
        // 加密处理
        if (Boolean.TRUE.equals(paramDTO.getIsEncrypted())) {
            param.setParamValue(CryptoUtils.aesEncrypt(paramDTO.getParamValue(), getEncryptKey()));
        }
        
        systemParamMapper.updateById(param);
    }
}
```

### 3.3 文件管理

#### 功能概述
提供文件的上传、下载、删除、预览等功能，支持本地存储和OSS存储。

#### SystemFile实体

```java
@Data
@TableName("system_file")
public class SystemFile extends BaseEntity {
    private Long id;                    // 文件ID
    private String fileName;            // 文件名
    private String originalName;        // 原始文件名
    private String fileExt;             // 文件扩展名
    private Long fileSize;              // 文件大小(字节)
    private String mimeType;            // MIME类型
    private String storageType;         // 存储类型: local/oss
    private String filePath;            // 文件路径
    private String fileUrl;             // 文件访问URL
    private String md5;                 // 文件MD5
    private String uploader;            // 上传人
}
```

#### 文件上传服务

```java
@Service
public class SystemFileServiceImpl implements SystemFileService {
    
    @Value("${file.upload.path}")
    private String uploadPath;
    
    @Override
    public SystemFileVO uploadFile(MultipartFile file, String module) throws IOException {
        // 1. 验证文件
        validateFile(file);
        
        // 2. 生成文件路径
        String datePath = DateTimeUtils.format(new Date(), "yyyy/MM/dd");
        String fileName = generateFileName(file.getOriginalFilename());
        String filePath = uploadPath + "/" + module + "/" + datePath + "/" + fileName;
        
        // 3. 保存文件
        File destFile = new File(filePath);
        destFile.getParentFile().mkdirs();
        file.transferTo(destFile);
        
        // 4. 计算MD5
        String md5 = DigestUtils.md5DigestAsHex(file.getInputStream());
        
        // 5. 保存文件记录
        SystemFile systemFile = new SystemFile();
        systemFile.setFileName(fileName);
        systemFile.setOriginalName(file.getOriginalFilename());
        systemFile.setFileExt(FilenameUtils.getExtension(file.getOriginalFilename()));
        systemFile.setFileSize(file.getSize());
        systemFile.setMimeType(file.getContentType());
        systemFile.setStorageType("local");
        systemFile.setFilePath(filePath);
        systemFile.setFileUrl("/file/" + module + "/" + datePath + "/" + fileName);
        systemFile.setMd5(md5);
        systemFile.setUploader(SecurityUtils.getUsername());
        
        systemFileMapper.insert(systemFile);
        
        return BeanUtil.copyProperties(systemFile, SystemFileVO.class);
    }
    
    private void validateFile(MultipartFile file) {
        // 文件大小校验
        long maxSize = 10 * 1024 * 1024; // 10MB
        if (file.getSize() > maxSize) {
            throw new BusinessException("文件大小不能超过10MB");
        }
        
        // 文件类型校验
        String contentType = file.getContentType();
        List<String> allowedTypes = Arrays.asList(
            "image/jpeg", "image/png", "image/gif",
            "application/pdf",
            "application/vnd.ms-excel",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        );
        if (!allowedTypes.contains(contentType)) {
            throw new BusinessException("不支持的文件类型");
        }
    }
}
```

### 3.4 日志管理

#### 功能概述
提供操作日志、登录日志、系统日志的记录、查询、分析功能。

#### SystemLog实体

```java
@Data
@TableName("system_log")
public class SystemLog extends BaseEntity {
    private Long id;                    // 日志ID
    private String logType;             // 日志类型: operation/login/system/error
    private String module;              // 模块名
    private String operation;           // 操作名称
    private String description;        // 描述
    private Long userId;                // 用户ID
    private String username;            // 用户名
    private String ip;                  // IP地址
    private String location;            // 地理位置
    private String userAgent;           // 用户代理
    private String requestMethod;       // 请求方法
    private String requestUrl;          // 请求URL
    private String requestParams;       // 请求参数
    private Long costTime;              // 耗时(毫秒)
    private Integer status;             // 状态: 1-成功 0-失败
    private String errorMessage;        // 错误信息
}
```

#### 日志服务

```java
@Service
public class SystemLogServiceImpl implements SystemLogService {
    
    @Override
    public void saveLog(SystemLogDTO logDTO) {
        SystemLog log = BeanUtil.copyProperties(logDTO, SystemLog.class);
        log.setUserId(SecurityUtils.getUserId());
        log.setUsername(SecurityUtils.getUsername());
        
        // 获取IP地址
        HttpServletRequest request = ServletUtils.getRequest();
        log.setIp(IpUtils.getIpAddr(request));
        log.setLocation(IpUtils.getLocation(log.getIp()));
        log.setUserAgent(request.getHeader("User-Agent"));
        
        systemLogMapper.insert(log);
    }
    
    @Override
    @Async
    public void saveLogAsync(SystemLogDTO logDTO) {
        saveLog(logDTO);
    }
}
```

## 4. 定时任务设计

### 4.1 定时任务管理

提供定时任务的创建、编辑、启用、停用、执行等功能。

#### SystemJob实体

```java
@Data
@TableName("system_job")
public class SystemJob extends BaseEntity {
    private Long id;                    // 任务ID
    private String jobName;             // 任务名称
    private String jobGroup;            // 任务分组
    private String beanName;            // Bean名称
    private String methodName;          // 方法名称
    private String methodParams;        // 方法参数
    private String cronExpression;      // Cron表达式
    private Integer status;             // 状态: 0-停用 1-启用
    private String description;        // 描述
}
```

### 4.2 系统内置定时任务

#### 数据备份任务

```java
@Component("dataBackupJob")
public class DataBackupJob {
    
    @Scheduled(cron = "0 0 2 * * ?")
    public void execute() {
        SystemLogDTO log = new SystemLogDTO();
        log.setLogType("system");
        log.setModule("系统管理");
        log.setOperation("数据备份");
        log.setDescription("执行数据库备份任务");
        
        try {
            // 执行备份逻辑
            backupDatabase();
            
            log.setStatus(1);
            log.setCostTime(5000L);
        } catch (Exception e) {
            log.setStatus(0);
            log.setErrorMessage(e.getMessage());
        }
        
        systemLogService.saveLogAsync(log);
    }
    
    private void backupDatabase() {
        // 数据库备份实现
    }
}
```

#### 日志清理任务

```java
@Component("logCleanJob")
public class LogCleanJob {
    
    @Scheduled(cron = "0 0 3 * * ?")
    public void execute() {
        SystemLogDTO log = new SystemLogDTO();
        log.setLogType("system");
        log.setModule("系统管理");
        log.setOperation("日志清理");
        log.setDescription("清理30天前的系统日志");
        
        try {
            // 删除30天前的日志
            LocalDate thirtyDaysAgo = LocalDate.now().minusDays(30);
            Date expireDate = DateTimeUtils.parse(thirtyDaysAgo.toString(), "yyyy-MM-dd");
            
            systemLogMapper.deleteExpireLogs(expireDate);
            
            log.setStatus(1);
        } catch (Exception e) {
            log.setStatus(0);
            log.setErrorMessage(e.getMessage());
        }
        
        systemLogService.saveLogAsync(log);
    }
}
```

## 5. 接口设计

### 5.1 字典管理接口

```
POST   /api/system/dict                    # 创建字典类型
GET    /api/system/dict/{id}               # 获取字典类型
PUT    /api/system/dict/{id}               # 更新字典类型
DELETE /api/system/dict/{id}               # 删除字典类型
GET    /api/system/dict/list               # 分页查询字典类型
GET    /api/system/dict/code/{code}        # 根据编码获取字典类型

POST   /api/system/dict-item               # 创建字典项
GET    /api/system/dict-item/{id}          # 获取字典项
PUT    /api/system/dict-item/{id}          # 更新字典项
DELETE /api/system/dict-item/{id}          # 删除字典项
GET    /api/system/dict-item/list          # 分页查询字典项
GET    /api/system/dict-item/dict/{dictId} # 根据字典ID获取字典项
```

### 5.2 参数配置接口

```
POST   /api/system/param                   # 创建参数
GET    /api/system/param/{id}              # 获取参数
PUT    /api/system/param/{id}              # 更新参数
DELETE /api/system/param/{id}              # 删除参数
GET    /api/system/param/list              # 分页查询参数
GET    /api/system/param/key/{key}         # 根据键获取参数值
POST   /api/system/param/batch             # 批量更新参数
```

### 5.3 文件管理接口

```
POST   /api/system/file/upload             # 上传文件
GET    /api/system/file/{id}               # 获取文件信息
DELETE /api/system/file/{id}               # 删除文件
GET    /api/system/file/{id}/download      # 下载文件
GET    /api/system/file/{id}/preview       # 预览文件
GET    /api/system/file/list               # 分页查询文件
```

### 5.4 日志管理接口

```
GET    /api/system/log/{id}                # 获取日志
GET    /api/system/log/list                # 分页查询日志
GET    /api/system/log/statistics          # 日志统计
DELETE /api/system/log/{id}                # 删除日志
DELETE /api/system/log/batch               # 批量删除日志
POST   /api/system/log/export              # 导出日志
```

### 5.5 定时任务接口

```
POST   /api/system/job                     # 创建定时任务
GET    /api/system/job/{id}                # 获取定时任务
PUT    /api/system/job/{id}                # 更新定时任务
DELETE /api/system/job/{id}                # 删除定时任务
GET    /api/system/job/list                # 分页查询定时任务
POST   /api/system/job/{id}/start          # 启用定时任务
POST   /api/system/job/{id}/stop           # 停用定时任务
POST   /api/system/job/{id}/execute        # 立即执行定时任务
```

## 6. 部署说明

### 6.1 配置文件

```yaml
server:
  port: 8084

spring:
  application:
    name: qooerp-system
  
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 50MB

file:
  upload:
    path: /data/qooerp/files

logging:
  file:
    name: /data/qooerp/logs/system.log
```

### 6.2 目录结构

```
/data/qooerp/
├── files/              # 文件存储目录
│   ├── user/          # 用户文件
│   ├── product/       # 产品文件
│   └── order/         # 订单文件
└── logs/              # 日志目录
    ├── system.log     # 系统日志
    └── backup/        # 备份目录
```

## 7. 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2025-01-17 | 初始版本 | Auto |
