# QooERP 工作流引擎模块 - 技术设计文档

> 模块名称: qooerp-workflow
> 模块版本: v1.0
> 创建日期: 2026-02-17
> 作者: Auto

---

## 一、技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Spring Boot | 3.2.x | 核心框架 |
| Flowable | 7.0.x | 工作流引擎 |
| MyBatis-Plus | 3.5.x | ORM框架 |
| PostgreSQL | 15+ | 数据库 |
| Redis | 7.x | 缓存 |
| Nacos | 2.x | 配置中心 |

---

## 二、核心功能实现

### 2.1 流程引擎配置

```java
@Configuration
public class FlowableConfig {

    @Bean
    public ProcessEngine processEngine(DataSource dataSource) {
        ProcessEngineConfiguration config =
            StandaloneProcessEngineConfiguration
                .createStandaloneProcessEngineConfiguration();

        config.setDataSource(dataSource);
        config.setDatabaseSchemaUpdate("true");
        config.setAsyncExecutorActivate(true);

        return config.buildProcessEngine();
    }
}
```

### 2.2 流程启动服务

```java
@Service
public class WorkflowInstanceServiceImpl implements WorkflowInstanceService {

    @Autowired
    private RuntimeService runtimeService;

    @Override
    public WorkflowInstanceDTO startInstance(String processDefinitionId,
        Map<String, Object> variables) {

        // 启动流程实例
        ProcessInstance instance = runtimeService
            .startProcessInstanceById(
                processDefinitionId,
                variables
            );

        // 保存流程变量
        if (variables != null && !variables.isEmpty()) {
            runtimeService.setVariables(
                instance.getId(),
                variables
            );
        }

        return convertToDTO(instance);
    }
}
```

### 2.3 任务处理服务

```java
@Service
public class WorkflowTaskServiceImpl implements WorkflowTaskService {

    @Autowired
    private TaskService taskService;

    @Autowired
    private RuntimeService runtimeService;

    @Override
    public void completeTask(String taskId,
        Map<String, Object> variables) {

        // 完成任务
        taskService.complete(taskId, variables);

        // 记录操作日志
        Task task = taskService.createTaskQuery()
            .taskId(taskId)
            .singleResult();

        saveWorkflowLog(task, "COMPLETE", variables);
    }

    @Override
    public void rejectTask(String taskId, String comment) {
        // 驳回任务
        Task task = taskService.createTaskQuery()
            .taskId(taskId)
            .singleResult();

        // 设置驳回变量
        Map<String, Object> variables = new HashMap<>();
        variables.put("approved", false);
        variables.put("comment", comment);

        taskService.complete(taskId, variables);

        // 记录操作日志
        saveWorkflowLog(task, "REJECT", variables);
    }
}
```

---

## 三、部署配置

```yaml
server:
  port: 8095

spring:
  application:
    name: qooerp-workflow
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/qooerp_workflow
    username: qooerp_workflow
    password: qooerp_workflow_2026

flowable:
  database-schema-update: true
  async-executor-activate: true
  history-level: audit
  database-type: postgres
```

---

## 四、监控指标

| 指标名称 | 说明 |
|---------|------|
| workflow_instance_count | 流程实例数量 |
| workflow_task_pending_count | 待处理任务数量 |
| workflow_complete_rate | 流程完成率 |
| workflow_avg_duration | 平均流程时长 |

---

**文档版本**: v1.0
**最后更新**: 2026-02-17
**数据库**: PostgreSQL 15+
