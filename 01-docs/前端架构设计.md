# QooERP 前端架构设计

## 概述

QooERP 前端采用 **统一技术栈**，支持 Web、PC、Mobile 多端适配：
- **框架**: Vue 3 + TypeScript
- **UI 组件库**: TDesign (PC + Mobile)
- **跨平台**: Electron (桌面端) / Capacitor (移动端)
- **构建工具**: Vite
- **状态管理**: Pinia
- **路由**: Vue Router
- **HTTP 客户端**: Axios
- **图表**: ECharts
- **监控**: OpenTelemetry Web SDK

---

## 一、技术栈

### 1.1 核心框架

| 技术 | 版本 | 说明 |
|------|------|------|
| Vue | 3.4+ | 渐进式前端框架 |
| TypeScript | 5.3+ | JavaScript 超集 |
| Vite | 5.0+ | 新一代前端构建工具 |
| Vue Router | 4.2+ | Vue 官方路由 |
| Pinia | 2.1+ | Vue 官方状态管理 |

### 1.2 UI 组件库

| 组件库 | 版本 | 说明 |
|--------|------|------|
| TDesign Vue Next | Latest | 企业级设计语言（PC 端） |
| TDesign Vue Mobile | Latest | 移动端组件库 |
| TDesign Icons | Latest | 图标库 |

### 1.3 跨平台

| 技术 | 版本 | 说明 |
|------|------|------|
| Electron | Latest | 桌面应用（Windows/macOS/Linux） |
| Capacitor | 5.x | 移动应用（iOS/Android） |

### 1.4 其他依赖

| 技术 | 版本 | 说明 |
|------|------|------|
| Axios | 1.6+ | HTTP 客户端 |
| ECharts | 5.x | 数据可视化 |
| Day.js | 1.11+ | 日期处理 |
| Lodash-es | 4.17+ | 工具函数库 |
| @opentelemetry/api | 1.8+ | OpenTelemetry Web SDK |
| Monaco Editor | Latest | 代码编辑器 |

---

## 二、项目结构

### 2.1 Monorepo 结构

```
qooerp-frontend/
├── packages/                    # 子包
│   ├── web/                    # Web 端
│   │   ├── src/
│   │   ├── public/
│   │   ├── package.json
│   │   └── vite.config.ts
│   ├── desktop/                # 桌面端 (Electron)
│   │   ├── src/
│   │   ├── main/               # Electron 主进程
│   │   ├── package.json
│   │   └── electron.config.js
│   └── mobile/                # 移动端 (Capacitor)
│       ├── src/
│       ├── android/           # Android 原生代码
│       ├── ios/               # iOS 原生代码
│       ├── package.json
│       └── capacitor.config.ts
├── shared/                     # 共享代码
│   ├── components/            # 共享组件
│   ├── composables/           # 共享组合式函数
│   ├── utils/                 # 工具函数
│   ├── types/                 # TypeScript 类型定义
│   └── constants/             # 常量
├── pnpm-workspace.yaml         # pnpm 工作区配置
├── package.json
└── tsconfig.json
```

### 2.2 Web 端结构

```
packages/web/
├── src/
│   ├── main.ts                # 入口文件
│   ├── App.vue                # 根组件
│   ├── assets/                # 静态资源
│   ├── components/            # 公共组件
│   │   ├── layout/           # 布局组件
│   │   ├── common/           # 通用组件
│   │   └── business/         # 业务组件
│   ├── views/                # 页面视图
│   │   ├── home/
│   │   ├── dashboard/
│   │   ├── system/
│   │   └── ...
│   ├── router/               # 路由配置
│   ├── stores/               # Pinia 状态管理
│   ├── api/                  # API 接口
│   ├── utils/                # 工具函数
│   ├── hooks/                # 组合式函数
│   ├── styles/               # 样式文件
│   └── directives/           # 自定义指令
├── public/
│   ├── favicon.ico
│   └── index.html
├── package.json
└── vite.config.ts
```

---

## 三、架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  Web (浏览器)  │  │  Desktop     │  │  Mobile      │  │
│  │  Vue 3 + TDesign │  │  Electron    │  │  Capacitor   │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                  │                  │           │
└─────────┼──────────────────┼──────────────────┼───────────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                                     │
    ┌─────▼──────┐   ┌──────────────────┐   ┌────▼─────┐
    │ Vue 3 Core │   │   Pinia Stores  │   │ Router   │
    └─────┬──────┘   └──────────────────┘   └────┬─────┘
          │                                      │
    ┌─────▼────────────────────────────────────▼──────┐
    │            共享业务逻辑层 (shared/)                 │
    │  ┌────────────┐  ┌────────────┐  ┌────────────┐   │
    │  │ Composables│  │ Components │  │  Utils     │   │
    │  └────────────┘  └────────────┘  └────────────┘   │
    └──────────────────┬─────────────────────────────────┘
                       │
    ┌──────────────────▼─────────────────────────────────┐
    │               API 服务层                             │
    │  ┌────────────┐  ┌────────────┐  ┌────────────┐   │
    │  │  HTTP API  │  │ WebSocket  │  │  Otel SDK  │   │
    │  └────────────┘  └────────────┘  └────────────┘   │
    └──────────────────┬─────────────────────────────────┘
                       │
    ┌──────────────────▼─────────────────────────────────┐
    │              后端服务集群                           │
    │  qooerp-gateway → qooerp-auth → qooerp-...         │
    └─────────────────────────────────────────────────────┘
```

### 3.2 分层架构

```
┌─────────────────────────────────────────┐
│         视图层 (Views)                  │
│  页面组件，负责数据展示和用户交互        │
└────────────┬────────────────────────────┘
             │
┌────────────▼────────────────────────────┐
│       组件层 (Components)                │
│  可复用的 UI 组件                        │
│  - layout: 布局组件                     │
│  - common: 通用组件                     │
│  - business: 业务组件                   │
└────────────┬────────────────────────────┘
             │
┌────────────▼────────────────────────────┐
│    状态管理层 (Pinia Stores)             │
│  全局状态管理、数据缓存                  │
└────────────┬────────────────────────────┘
             │
┌────────────▼────────────────────────────┐
│    逻辑层 (Composables/Hooks)           │
│  业务逻辑封装，可复用的组合式函数        │
└────────────┬────────────────────────────┘
             │
┌────────────▼────────────────────────────┐
│    API 层 (API Services)                 │
│  HTTP 请求封装，与后端接口交互          │
└─────────────────────────────────────────┘
```

---

## 四、TDesign 使用

### 4.1 PC 端

**安装**：
```bash
pnpm add tdesign-vue-next
```

**按需引入配置**：
```typescript
// vite.config.ts
import Components from 'unplugin-vue-components/vite'
import { TDesignResolver } from 'unplugin-vue-components/resolvers'

export default defineConfig({
  plugins: [
    Components({
      resolvers: [TDesignResolver()]
    })
  ]
})
```

**主题定制**：
```scss
// styles/theme.scss
$td-brand-color: #0052d9;
$td-success-color: #00a870;
$td-warning-color: #ed7b2f;
$td-error-color: #e34d59;

@import 'tdesign-vue-next/es/style/index.css';
```

### 4.2 Mobile 端

**安装**：
```bash
pnpm add tdesign-vue-next-mobile
```

**按需引入配置**：
```typescript
import Components from 'unplugin-vue-components/vite'
import { TDesignResolver } from 'unplugin-vue-components/resolvers'

export default defineConfig({
  plugins: [
    Components({
      resolvers: [
        TDesignResolver({ library: 'mobile' })
      ]
    })
  ]
})
```

### 4.3 响应式适配

**多端组件策略**：
```typescript
// shared/components/AdaptiveButton.vue
<template>
  <t-button v-if="isDesktop" v-bind="$attrs" />
  <t-mobile-button v-else v-bind="$attrs" />
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { usePlatform } from '@/hooks/usePlatform'

const { isDesktop, isMobile } = usePlatform()
</script>
```

---

## 五、跨平台适配

### 5.1 Electron 桌面端

**目录结构**：
```
packages/desktop/
├── src/
│   ├── main/               # Electron 主进程
│   │   ├── index.ts       # 主进程入口
│   │   ├── ipc.ts         # IPC 通信
│   │   └── window.ts      # 窗口管理
│   └── preload/            # 预加载脚本
│       └── index.ts
├── src/                    # Web 代码（来自 web 包）
└── package.json
```

**主进程代码**：
```typescript
// packages/desktop/src/main/index.ts
import { app, BrowserWindow } from 'electron'
import path from 'path'

let mainWindow: BrowserWindow | null = null

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      preload: path.join(__dirname, '../preload/index.js'),
      nodeIntegration: false,
      contextIsolation: true
    }
  })

  // 开发环境加载 Vite Dev Server
  if (process.env.NODE_ENV === 'development') {
    mainWindow.loadURL('http://localhost:5173')
    mainWindow.webContents.openDevTools()
  } else {
    mainWindow.loadFile(path.join(__dirname, '../dist/index.html'))
  }
}

app.whenReady().then(createWindow)
```

**IPC 通信**：
```typescript
// preload/index.ts
import { contextBridge, ipcRenderer } from 'electron'

contextBridge.exposeInMainWorld('electronAPI', {
  selectFile: () => ipcRenderer.invoke('dialog:openFile'),
  saveFile: (content: string) => ipcRenderer.invoke('file:save', content),
  onNotification: (callback: (message: string) => void) => {
    ipcRenderer.on('notification', (_, message) => callback(message))
  }
})
```

### 5.2 Capacitor 移动端

**目录结构**：
```
packages/mobile/
├── src/                    # Vue 代码
├── android/                # Android 原生代码
├── ios/                    # iOS 原生代码
├── capacitor.config.ts
└── package.json
```

**Capacitor 配置**：
```typescript
// capacitor.config.ts
import { CapacitorConfig } from '@capacitor/cli'

const config: CapacitorConfig = {
  appId: 'com.qooerp.app',
  appName: 'QooERP',
  webDir: 'dist',
  bundledWebRuntime: false,
  plugins: {
    StatusBar: {
      style: 'dark'
    },
    SplashScreen: {
      launchShowDuration: 2000,
      launchAutoHide: true
    }
  }
}

export default config
```

**使用 Capacitor 插件**：
```typescript
import { Camera, CameraResultType } from '@capacitor/camera'
import { LocalNotifications } from '@capacitor/local-notifications'
import { Device } from '@capacitor/device'

// 拍照
const takePhoto = async () => {
  const image = await Camera.getPhoto({
    quality: 90,
    allowEditing: false,
    resultType: CameraResultType.Uri
  })
  return image.webPath
}

// 本地通知
const sendNotification = async (title: string, body: string) => {
  await LocalNotifications.schedule({
    notifications: [{
      title,
      body,
      id: Date.now(),
      schedule: { at: new Date() }
    }]
  })
}

// 获取设备信息
const getDeviceInfo = async () => {
  const info = await Device.getInfo()
  return info
}
```

---

## 六、监控集成

### 6.1 OpenTelemetry Web SDK

**安装**：
```bash
pnpm add @opentelemetry/api @opentelemetry/sdk-web @opentelemetry/auto-instrumentations-web
```

**初始化配置**：
```typescript
// src/utils/otel.ts
import { initOpenTelemetry } from '@opentelemetry/sdk-web'

const telemetry = initOpenTelemetry({
  serviceName: 'qooerp-web',
  exporter: {
    url: import.meta.env.VITE_OTEL_ENDPOINT | 'http://localhost:8101/monitor/api/otlp/v1/traces'
  },
  instrumentations: {
    // 自动插桩
    '@opentelemetry/instrumentation-fetch': {},
    '@opentelemetry/instrumentation-xml-http-request': {}
  }
})

export default telemetry
```

**手动创建 Span**：
```typescript
import { trace } from '@opentelemetry/api'

const tracer = trace.getTracer('qooerp-web')

const handleClick = async () => {
  const span = tracer.startSpan('user.click.button')

  try {
    // 业务逻辑
    await fetchUserData()
    span.setStatus({ code: SpanStatusCode.OK })
  } catch (error) {
    span.recordException(error)
    span.setStatus({ code: SpanStatusCode.ERROR })
  } finally {
    span.end()
  }
}
```

### 6.2 错误监控

```typescript
// src/utils/errorHandler.ts
import { trace } from '@opentelemetry/api'

export const errorHandler = (error: Error) => {
  const tracer = trace.getTracer('error-handler')
  const span = tracer.startSpan('error.capture')

  span.setAttribute('error.name', error.name)
  span.setAttribute('error.message', error.message)
  span.setAttribute('error.stack', error.stack)

  // 发送到监控服务
  sendErrorToMonitor({
    name: error.name,
    message: error.message,
    stack: error.stack,
    timestamp: Date.now()
  })

  span.end()
}

// Vue 全局错误处理
app.config.errorHandler = errorHandler

// window 错误监听
window.addEventListener('error', (event) => {
  errorHandler(event.error)
})

window.addEventListener('unhandledrejection', (event) => {
  errorHandler(new Error(event.reason))
})
```

---

## 七、构建配置

### 7.1 Vite 配置

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import Components from 'unplugin-vue-components/vite'
import { TDesignResolver } from 'unplugin-vue-components/resolvers'
import path from 'path'

export default defineConfig({
  plugins: [
    vue(),
    Components({
      resolvers: [TDesignResolver()]
    })
  ],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'),
      '@shared': path.resolve(__dirname, '../../shared')
    }
  },
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true
      }
    }
  },
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'tdesign': ['tdesign-vue-next'],
          'vue-vendor': ['vue', 'vue-router', 'pinia'],
          'echarts': ['echarts']
        }
      }
    }
  }
})
```

### 7.2 pnpm Workspace 配置

```yaml
# pnpm-workspace.yaml
packages:
  - 'packages/*'
  - 'shared'
```

```json
{
  "name": "qooerp-frontend",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "pnpm --filter web dev",
    "dev:desktop": "pnpm --filter desktop dev",
    "dev:mobile": "pnpm --filter mobile dev",
    "build": "pnpm --filter web build",
    "build:desktop": "pnpm --filter desktop build",
    "build:mobile": "pnpm --filter mobile build && pnpm --filter mobile sync",
    "sync": "pnpm --filter mobile sync"
  },
  "devDependencies": {
    "typescript": "^5.3.3",
    "vite": "^5.0.11",
    "vue": "^3.4.15"
  }
}
```

---

## 八、环境配置

### 8.1 环境变量

```bash
# .env.development
VITE_API_BASE_URL=http://localhost:8080/api
VITE_OTEL_ENDPOINT=http://localhost:8101/monitor/api/otlp/v1/traces
VITE_APP_NAME=QooERP
VITE_APP_ENV=development

# .env.production
VITE_API_BASE_URL=https://api.qooerp.com/api
VITE_OTEL_ENDPOINT=https://monitor.qooerp.com/monitor/api/otlp/v1/traces
VITE_APP_NAME=QooERP
VITE_APP_ENV=production
```

### 8.2 配置文件

```typescript
// src/config/index.ts
interface AppConfig {
  apiBaseUrl: string
  otelEndpoint: string
  appName: string
  appEnv: string
  version: string
}

const config: AppConfig = {
  apiBaseUrl: import.meta.env.VITE_API_BASE_URL,
  otelEndpoint: import.meta.env.VITE_OTEL_ENDPOINT,
  appName: import.meta.env.VITE_APP_NAME,
  appEnv: import.meta.env.VITE_APP_ENV,
  version: '1.0.0'
}

export default config
```

---

## 九、开发规范

### 9.1 命名规范

- **组件文件**: PascalCase（如 `UserProfile.vue`）
- **组合式函数**: camelCase，以 `use` 开头（如 `useAuth.ts`）
- **工具函数**: camelCase（如 `formatDate.ts`）
- **常量**: UPPER_SNAKE_CASE（如 `API_BASE_URL`）
- **类型定义**: PascalCase（如 `User`）

### 9.2 代码规范

使用 ESLint + Prettier：

```json
{
  "scripts": {
    "lint": "eslint . --ext .vue,.ts,.tsx",
    "lint:fix": "eslint . --ext .vue,.ts,.tsx --fix",
    "format": "prettier --write ."
  }
}
```

### 9.3 Git 提交规范

使用 Conventional Commits：

```
feat: 新功能
fix: 修复 Bug
docs: 文档更新
style: 代码格式调整
refactor: 重构
perf: 性能优化
test: 测试相关
chore: 构建/工具相关
```

---

## 十、部署方案

### 10.1 Web 端部署

```bash
# 构建
pnpm build

# 部署到 Nginx
# 1. 将 dist 目录上传到服务器
# 2. 配置 Nginx
server {
  listen 80;
  server_name app.qooerp.com;
  root /var/www/qooerp-web/dist;
  index index.html;

  location / {
    try_files $uri $uri/ /index.html;
  }

  location /api {
    proxy_pass http://localhost:8080;
  }
}
```

### 10.2 Electron 桌面端打包

```bash
# 安装 electron-builder
pnpm add -D electron-builder

# 配置 package.json
{
  "build": {
    "appId": "com.qooerp.desktop",
    "productName": "QooERP",
    "directories": {
      "output": "dist-electron"
    },
    "files": [
      "dist/**/*",
      "main/**/*",
      "preload/**/*"
    ],
    "win": {
      "target": ["nsis"],
      "icon": "public/icon.ico"
    },
    "mac": {
      "target": ["dmg"],
      "icon": "public/icon.icns"
    },
    "linux": {
      "target": ["AppImage"],
      "icon": "public/icon.png"
    }
  }
}

# 打包
pnpm build:electron
```

### 10.3 Capacitor 移动端打包

```bash
# 同步代码到原生项目
pnpm sync

# 打包 Android
pnpm build:android

# 打包 iOS
pnpm build:ios
```

---

**文档版本**: v1.0
**更新日期**: 20xx-xx-xx
