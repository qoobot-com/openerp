# QooERP 监控架构设计

## 概述

QooERP 采用 **OpenTelemetry + Micrometer + Logback + PostgreSQL + ECharts** 组合的轻量级监控体系：
- **OpenTelemetry**: 分布式链路追踪
- **Micrometer**: 应用指标监控
- **Logback**: 结构化日志输出
- **qooerp-monitor**: 自研监控微服务（采集/存储/分析）
- **PostgreSQL**: 时序数据存储（使用 TimescaleDB 扩展）
- **ECharts**: 前端可视化图表

---

## 一、监控技术栈

| 组件 | 版本 | 用途 |
|------|------|------|
| OpenTelemetry | 1.34+ | 链路追踪（Trace & Span） |
| Micrometer | 1.13+ | 指标收集（Metrics） |
| Logback | 1.5+ | 日志框架 |
| Logstash Encoder | 7.4 | JSON 格式日志输出 |
| PostgreSQL | 15+ | 时序数据存储（使用 TimescaleDB 扩展） |
| ECharts | 5.x | 前端可视化图表 |
| qooerp-monitor | 自研 | 监控微服务（采集/存储/分析） |

---

## 二、监控架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     微服务集群                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ Gateway  │  │  Auth    │  │ System   │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  │
│       │               │               │           │
│       └───────────────┼───────────────┘           │
│                       │                           │
│  ┌────────────────────┼────────────────────┐       │
│  │                 │                │       │
│  │   其他微服务    │                │       │
│  └─────────────────┘                │       │
└───────────────────────────────────────────┼───────┘
                                    │
        ┌───────────────────────────────────┼───────────────┐
        │                                   │               │
  ┌─────▼──────┐   ┌───────────┐   ┌──────▼──────┐   ┌─────▼──────┐
  │ OpenTelemetry│   │ Micrometer│   │  Logback    │   │   HTTP API   │
  │  (Tracing)  │   │ (Metrics) │   │  (Logs)     │   │  (推送数据)   │
  └─────┬──────┘   └─────┬──────┘   └─────┬──────┘   └─────┬──────┘
        │                  │                  │                  │
        └──────────────────┼──────────────────┼──────────────────┘
                           │                  │
                    ┌──────▼──────────────────▼──────────┐
                    │        qooerp-monitor              │
                    │      (监控微服务 - Spring Boot)      │
                    │  ┌──────────────────────────────┐   │
                    │  │  数据采集模块                │   │
                    │  │  - OTLP 接收器              │   │
                    │  │  - HTTP 接口推送            │   │
                    │  └──────────────────────────────┘   │
                    │  ┌──────────────────────────────┐   │
                    │  │  数据处理模块                │   │
                    │  │  - 数据清洗                  │   │
                    │  │  - 聚合统计                  │   │
                    │  └──────────────────────────────┘   │
                    │  ┌──────────────────────────────┐   │
                    │  │  告警引擎模块                │   │
                    │  │  - 规则匹配                  │   │
                    │  │  - 告警通知                  │   │
                    │  └──────────────────────────────┘   │
                    └──────────────┬───────────────────────┘
                                   │
                    ┌──────────────▼───────────────────────┐
                    │         PostgreSQL + TimescaleDB      │
                    │  ┌──────────────────────────────┐   │
                    │  │  metrics 表                  │   │
                    │  │  traces 表                   │   │
                    │  │  logs 表                     │   │
                    │  │  alerts 表                   │   │
                    │  └──────────────────────────────┘   │
                    └──────────────┬───────────────────────┘
                                   │
                    ┌──────────────▼───────────────────────┐
                    │       qooerp-monitor 前端界面         │
                    │  ┌──────────────────────────────┐   │
                    │  │  Spring Boot + Thymeleaf     │   │
                    │  └──────────────────────────────┘   │
                    │  ┌──────────────────────────────┐   │
                    │  │  ECharts 图表可视化          │   │
                    │  │  - 实时时序图                │   │
                    │  │  - 趋势分析图                │   │
                    │  │  - 链路追踪图                │   │
                    │  │  - 告警看板                  │   │
                    │  └──────────────────────────────┘   │
                    └───────────────────────────────────────┘
```

---

## 三、配置说明

### 3.1 application.yml

```yaml
# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,tracing
  metrics:
    tags:
      application: ${spring.application.name}
      env: ${spring.profiles.active}
      instance: ${spring.application.name}:${server.port}
  # OpenTelemetry 链路追踪配置
  otlp:
    tracing:
      endpoint: ${MONITOR_ENDPOINT:http://localhost:8101/monitor/api/otlp/traces}
  tracing:
    sampling:
      probability: 0.1  # 10% 采样率
    propagation:
      type: w3c  # W3C Trace Context

# 日志配置
logging:
  level:
    root: INFO
    com.qoobot.qooerp: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-NA}] [%X{spanId:-NA}] %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-NA}] [%X{spanId:-NA}] %logger{36} - %msg%n"
```

### 3.2 环境变量

| 变量名 | 默认值 | 说明 |
|--------|---------|------|
| `MONITOR_ENDPOINT` | `http://localhost:8101/monitor/api/otlp/traces` | qooerp-monitor OTLP 接收地址 |
| `SPRING_PROFILES_ACTIVE` | `dev` | 环境标识（dev/prod） |

---

## 四、监控指标

### 4.1 系统指标

| 指标名称 | 类型 | 说明 |
|-----------|------|------|
| `jvm_memory_used_bytes` | Gauge | JVM 内存使用量 |
| `jvm_gc_pause_seconds` | Timer | GC 停顿时间 |
| `process_cpu_usage` | Gauge | CPU 使用率 |
| `hikaricp_connections_active` | Gauge | 数据库连接池活跃连接数 |
| `hikaricp_connections_idle` | Gauge | 数据库连接池空闲连接数 |
| `tomcat_sessions_active_current` | Gauge | Tomcat 活跃会话数 |

### 4.2 业务指标

| 指标名称 | 类型 | 说明 |
|-----------|------|------|
| `http_server_requests_seconds` | Timer | HTTP 请求耗时 |
| `http_server_requests` | Counter | HTTP 请求总数 |
| `redis_cache_hits` | Counter | Redis 缓存命中数 |
| `redis_cache_misses` | Counter | Redis 缓存未命中数 |

---

## 五、链路追踪

### 5.1 Trace 层级

```
Trace (根追踪)
├── Span 1: HTTP 请求
│   ├── Span 2: 数据库查询
│   ├── Span 3: Redis 查询
│   └── Span 4: 外部服务调用
└── Span 5: 响应写入
```

### 5.2 关键标签

| 标签名 | 说明 |
|--------|------|
| `application` | 应用名称 |
| `instance` | 实例标识 |
| `env` | 环境标识 |
| `http.method` | HTTP 方法 |
| `http.url` | 请求路径 |
| `http.status_code` | HTTP 状态码 |
| `db.system` | 数据库类型 |
| `db.statement` | SQL 语句 |
| `peer.service` | 调用的下游服务 |

---

## 六、日志规范

### 6.1 日志级别

| 级别 | 用途 | 示例 |
|------|------|------|
| `ERROR` | 错误，需要立即处理 | 数据库连接失败 |
| `WARN` | 警告，需要关注 | 缓存未命中，回源查询 |
| `INFO` | 关键业务流程 | 用户登录成功 |
| `DEBUG` | 调试信息 | SQL 执行语句 |

### 6.2 结构化日志格式

**JSON 格式**（用于 qooerp-monitor 采集）：

```json
{
  "@timestamp": "2026-02-17T10:30:45.123+08:00",
  "level": "INFO",
  "thread": "http-nio-8080-exec-1",
  "logger_name": "com.qoobot.qooerp.hr.EmployeeController",
  "message": "Employee created successfully",
  "traceId": "7b8f9e8c7a8b4b8a8f9e8c7a8b4b",
  "spanId": "a8b4b8a8f9e8c7",
  "context": {
    "userId": "12345",
    "tenantId": "1",
    "employeeId": "67890"
  }
}
```

**日志推送方式**：
- 方式一：通过 HTTP API 推送到 qooerp-monitor（推荐）
- 方式二：写入 PostgreSQL logs 表（批量写入）

---

## 七、部署架构

### 7.1 开发环境

```
+-------------------+
| Docker Compose  |
+-------------------+
  ├── qooerp-monitor      # 监控微服务（自研）
  ├── postgresql            # PostgreSQL + TimescaleDB
  └── nginx                 # 可选：反向代理
```

### 7.2 生产环境

```
┌──────────────────────────────────────────────┐
│              Kubernetes Cluster            │
│  ┌────────────────────────────────────┐  │
│  │  Monitoring Namespace             │  │
│  │  ├── qooerp-monitor             │  │
│  │  ├── postgresql-timescaledb      │  │
│  │  └── ingress-controller          │  │
│  └────────────────────────────────────┘  │
│                                      │
│  ┌────────────────────────────────────┐  │
│  │  Application Namespace           │  │
│  │  ├── qooerp-gateway             │  │
│  │  ├── qooerp-auth               │  │
│  │  ├── qooerp-system             │  │
│  │  └── ...                      │  │
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────────┘
```

---

## 八、告警规则

### 8.1 系统告警

| 告警名称 | 条件 | 级别 |
|---------|------|------|
| JVM 内存使用率 > 85% | `jvm_memory_used_bytes / jvm_memory_max_bytes > 0.85` | P2 |
| GC 停顿时间 > 1s | `jvm_gc_pause_seconds{quantile="0.99"} > 1` | P1 |
| 数据库连接池耗尽 | `hikaricp_connections_active / hikaricp_connections_max > 0.9` | P1 |
| CPU 使用率 > 80% | `process_cpu_usage > 0.8` | P2 |

### 8.2 业务告警

| 告警名称 | 条件 | 级别 |
|---------|------|------|
| API 错误率 > 5% | `rate(http_server_requests{status=~"5.."}[5m]) / rate(http_server_requests[5m]) > 0.05` | P1 |
| API P99 响应时间 > 500ms | `http_server_requests_seconds{quantile="0.99"} > 0.5` | P2 |
| 缓存命中率 < 70% | `redis_cache_hits / (redis_cache_hits + redis_cache_misses) < 0.7` | P2 |

---

## 九、自研监控服务 (qooerp-monitor)

### 9.1 功能模块

| 模块 | 功能 |
|------|------|
| **数据采集模块** | OTLP 接收器、HTTP 接口推送、Metrics 采集 |
| **数据处理模块** | 数据清洗、聚合统计、降采样 |
| **告警引擎模块** | 规则匹配、告警通知、告警历史 |
| **可视化模块** | ECharts 图表、实时看板、趋势分析 |
| **日志聚合模块** | 采集各服务日志、日志检索、日志分析 |

### 9.2 监控服务特有配置

```yaml
# qooerp-monitor 服务配置
management:
  tracing:
    sampling:
      probability: 1.0  # 监控服务 100% 采集

# PostgreSQL 配置（使用 TimescaleDB 扩展）
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/qooerp_monitor
    username: ${DB_USERNAME:monitor}
    password: ${DB_PASSWORD:monitor123}
```

### 9.3 PostgreSQL 数据表结构

**TimescaleDB 超表设计**：

```sql
-- metrics 超表（指标数据）
CREATE TABLE metrics (
    time TIMESTAMPTZ NOT NULL,
    metric_name TEXT NOT NULL,
    metric_type TEXT NOT NULL,
    metric_value DOUBLE PRECISION NOT NULL,
    tags JSONB NOT NULL,
    instance TEXT NOT NULL
);

-- 启用 TimescaleDB
SELECT create_hypertable('metrics', 'time', chunk_time_interval => INTERVAL '1 day');

-- traces 超表（链路追踪）
CREATE TABLE traces (
    time TIMESTAMPTZ NOT NULL,
    trace_id TEXT NOT NULL,
    span_id TEXT NOT NULL,
    parent_span_id TEXT,
    span_name TEXT NOT NULL,
    span_kind TEXT,
    duration_ms BIGINT,
    status_code TEXT,
    tags JSONB NOT NULL,
    instance TEXT NOT NULL
);

SELECT create_hypertable('traces', 'time', chunk_time_interval => INTERVAL '7 days');

-- logs 超表（日志数据）
CREATE TABLE logs (
    time TIMESTAMPTZ NOT NULL,
    level TEXT NOT NULL,
    logger_name TEXT NOT NULL,
    message TEXT,
    trace_id TEXT,
    span_id TEXT,
    thread_name TEXT,
    context JSONB,
    instance TEXT NOT NULL
);

SELECT create_hypertable('logs', 'time', chunk_time_interval => INTERVAL '7 days');

-- alerts 表（告警数据）
CREATE TABLE alerts (
    id BIGSERIAL PRIMARY KEY,
    rule_id BIGINT NOT NULL,
    rule_name TEXT NOT NULL,
    alert_level TEXT NOT NULL,
    alert_message TEXT NOT NULL,
    triggered_at TIMESTAMPTZ NOT NULL,
    recovered_at TIMESTAMPTZ,
    status TEXT NOT NULL,
    notification_sent BOOLEAN DEFAULT FALSE
);

-- 创建索引
CREATE INDEX idx_metrics_name ON metrics (metric_name, time DESC);
CREATE INDEX idx_metrics_tags ON metrics USING GIN (tags);
CREATE INDEX idx_traces_id ON traces (trace_id, time DESC);
CREATE INDEX idx_logs_level ON logs (level, time DESC);
CREATE INDEX idx_logs_trace ON logs (trace_id);
```

---

## 十、快速开始

### 10.1 启动监控组件

```bash
# 使用 docker-compose 启动
docker-compose -f docker-compose.monitoring.yml up -d

# 或使用 Kubernetes
kubectl apply -f k8s/monitoring/
```

**docker-compose.monitoring.yml 示例**：

```yaml
version: '3.8'
services:
  postgresql:
    image: timescale/timescaledb:latest-pg15
    environment:
      POSTGRES_DB: qooerp_monitor
      POSTGRES_USER: monitor
      POSTGRES_PASSWORD: monitor123
    ports:
      - "5432:5432"
    volumes:
      - postgresql_data:/var/lib/postgresql/data

  qooerp-monitor:
    image: qooerp/qooerp-monitor:latest
    ports:
      - "8101:8101"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresql:5432/qooerp_monitor
      SPRING_DATASOURCE_USERNAME: monitor
      SPRING_DATASOURCE_PASSWORD: monitor123
    depends_on:
      - postgresql

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - qooerp-monitor

volumes:
  postgresql_data:
```

### 10.2 配置微服务

在 `application.yml` 中添加监控配置（如上所示），自动集成 OpenTelemetry 和 Micrometer。

### 10.3 访问监控面板

| 组件 | 访问地址 |
|------|---------|
| qooerp-monitor | http://localhost:8101 |
| Nginx 代理 | http://localhost (如果配置) |

### 10.4 监控功能说明

**qooerp-monitor 前端功能**：
1. **仪表盘（Dashboard）**：
   - 服务健康状态概览
   - 实时指标图表（ECharts）
   - 告警统计看板

2. **链路追踪（Traces）**：
   - Trace 列表查询
   - 链路详情查看
   - 调用关系图（ECharts 树图）

3. **指标监控（Metrics）**：
   - 时序指标查询
   - 自定义图表
   - 指标趋势分析（ECharts 折线图）

4. **日志查询（Logs）**：
   - 日志检索
   - 日志关联 Trace
   - 日志统计分析

5. **告警管理（Alerts）**：
   - 告警规则配置
   - 告警历史查询
   - 告警通知设置

---

## 十一、优势总结

### 11.1 为什么选择轻量级方案？

| 对比项 | Prometheus + Grafana | qooerp-monitor + PostgreSQL + ECharts |
|--------|---------------------|--------------------------------------|
| 部署复杂度 | 高（需多个独立服务） | 低（单一微服务） |
| 学习曲线 | 陡峭（PromQL、Grafana 配置） | 平缓（Spring Boot + ECharts） |
| 资源占用 | 高（Prometheus/Grafana 内存占用大） | 低（PostgreSQL + 应用内存可控） |
| 集成难度 | 中等（需配置 Exporter） | 低（直接 HTTP API 推送） |
| 可定制性 | 受限（Grafana 插件限制） | 高（完全自研前端） |
| 运维成本 | 高（多服务运维） | 低（单服务运维） |

### 11.2 技术亮点

1. **TimescaleDB 时序优化**：
   - 自动分区（按天/周）
   - 降采样（保留历史趋势）
   - 连续聚合（实时计算）

2. **ECharts 可视化**：
   - 丰富的图表类型
   - 高性能渲染
   - 完全可定制

3. **自研采集协议**：
   - OTLP 兼容（OpenTelemetry 标准）
   - HTTP REST API
   - 批量推送优化

---

*文档维护：请保持此文档的及时更新，确保监控架构的准确性*
