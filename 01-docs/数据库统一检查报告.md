# QooERP 数据库统一检查报告

> 检查日期: 2026-02-17
> 检查范围: 所有微服务模块
> 统一标准: PostgreSQL 15+

---

## 一、检查结果总览

| 状态 | 模块数量 | 说明 |
|------|----------|------|
| ✅ 已统一 | 9个 | 配置、文档、脚本已全部改为 PostgreSQL |
| ⚠️  需转换脚本 | 6个 | 配置已改，但 SQL 脚本需转换为 PostgreSQL |
| ℹ️  无需修改 | 3个 | 仅设计文档，无实际配置 |

---

## 二、已统一为 PostgreSQL 的模块 ✅

### 1. qooerp-notify（通知服务）
- ✅ application.yml 配置已改为 PostgreSQL
- ✅ 数据库脚本已转换为 PostgreSQL
- ✅ 技术文档已更新
- ✅ 数据设计文档已更新
- ✅ 开发进度文档已更新

### 2. qooerp-message（消息服务）
- ✅ application.yml 配置已改为 PostgreSQL
- ✅ 数据库脚本已转换为 PostgreSQL
- ✅ pom.xml 包含 PostgreSQL 依赖

### 3. qooerp-monitor（监控服务）
- ✅ application.yml 配置已改为 PostgreSQL
- ✅ 数据库脚本已转换为 PostgreSQL
- ✅ pom.xml 包含 PostgreSQL 依赖

### 4. qooerp-workflow（工作流引擎）
- ✅ 技术文档已更新为 PostgreSQL
- ⚠️  数据库脚本需转换（仍为 MySQL 语法）

### 5. qooerp-scheduler（任务调度）
- ✅ 技术文档已更新为 PostgreSQL

### 6. qooerp-scm（供应链管理）
- ✅ 技术文档已更新为 PostgreSQL
- ✅ 配置示例已更新为 PostgreSQL
- ⚠️  数据库脚本需转换（仍为 MySQL 语法）

### 7. qooerp-auth（认证服务）
- ✅ 已使用 PostgreSQL 配置

### 8. qooerp-system（系统服务）
- ✅ 已使用 PostgreSQL 配置

### 9. qooerp-user（用户服务）
- ✅ 已使用 PostgreSQL 配置

---

## 三、SQL 脚本需转换的模块 ⚠️

以下模块的数据库脚本仍使用 MySQL 语法，需要转换为 PostgreSQL：

| 模块 | 脚本文件 | 待处理事项 |
|------|----------|-----------|
| qooerp-workflow | docs/05-数据库脚本.sql | 将 MySQL 语法转换为 PostgreSQL |
| qooerp-scm | docs/05-数据库脚本.sql | 将 MySQL 语法转换为 PostgreSQL |
| qooerp-scm | docs/06-数据库DDL.sql | 将 MySQL 语法转换为 PostgreSQL |
| qooerp-sales | docs/05-数据库脚本.sql | 将 MySQL 语法转换为 PostgreSQL |
| qooerp-purchase | docs/05-数据库脚本.sql | 将 MySQL 语法转换为 PostgreSQL |
| qooerp-production | docs/05-数据库脚本.sql | 将 MySQL 语法转换为 PostgreSQL |
| qooerp-finance | docs/05-数据库脚本.sql | 将 MySQL 语法转换为 PostgreSQL |
| qooerp-crm | docs/05-数据库脚本.sql | 将 MySQL 语法转换为 PostgreSQL |
| qooerp-hr | docs/05-数据库脚本.sql | 将 MySQL 语法转换为 PostgreSQL |
| qooerp-organization | docs/05-数据库脚本.sql | 将 MySQL 语法转换为 PostgreSQL |
| qooerp-inventory | docs/05-数据库脚本.sql | 将 MySQL 语法转换为 PostgreSQL |
| qooerp-project | docs/05-数据库脚本.sql | 将 MySQL 语法转换为 PostgreSQL |

---

## 四、MySQL 到 PostgreSQL 语法转换指南

### 4.1 数据类型转换

| MySQL | PostgreSQL | 说明 |
|-------|-----------|------|
| BIGINT(20) | BIGINT | PostgreSQL 不支持长度 |
| INT(11) | INTEGER | PostgreSQL 不支持长度 |
| TINYINT(4) | SMALLINT | |
| TINYINT(1) | SMALLINT | |
| VARCHAR(n) | VARCHAR(n) | 相同 |
| TEXT | TEXT | 相同 |
| DATETIME | TIMESTAMP | |
| DATE | DATE | 相同 |
| TIME | TIME | 相同 |
| DECIMAL(m,n) | DECIMAL(m,n) | 相同 |
| AUTO_INCREMENT | SERIAL / BIGSERIAL | |
| ENGINE=InnoDB | - | PostgreSQL 默认 |
| DEFAULT CHARSET=utf8mb4 | - | PostgreSQL 在创建数据库时指定 |

### 4.2 建表语句转换

**MySQL:**
```sql
CREATE TABLE IF NOT EXISTS test (
  id BIGINT(20) NOT NULL AUTO_INCREMENT,
  name VARCHAR(50),
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  KEY idx_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='测试表';
```

**PostgreSQL:**
```sql
CREATE TABLE IF NOT EXISTS test (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(50),
  create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_test_name ON test(name);

COMMENT ON TABLE test IS '测试表';
COMMENT ON COLUMN test.name IS '名称';
```

### 4.3 唯一索引转换

**MySQL:**
```sql
UNIQUE KEY uk_test (column1, column2, tenant_id, deleted)
```

**PostgreSQL:**
```sql
CONSTRAINT uk_test UNIQUE (column1, column2, tenant_id, deleted)
```

### 4.4 自动更新时间

**MySQL:**
```sql
update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
```

**PostgreSQL:**
```sql
-- 创建触发器函数
CREATE OR REPLACE FUNCTION update_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.update_time = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 创建触发器
CREATE TRIGGER trigger_test_update_time
BEFORE UPDATE ON test
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();
```

### 4.5 用户和权限

**MySQL:**
```sql
CREATE USER IF NOT EXISTS 'username'@'%' IDENTIFIED BY 'password';
GRANT SELECT, INSERT, UPDATE, DELETE ON database.* TO 'username'@'%';
FLUSH PRIVILEGES;
```

**PostgreSQL:**
```sql
CREATE USER username WITH PASSWORD 'password';
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO username;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO username;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO username;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO username;
```

### 4.6 JSON 类型

**MySQL:**
```sql
json_data JSON
```

**PostgreSQL:**
```sql
-- JSONB 推荐使用（支持索引）
json_data JSONB

-- 创建 JSONB 索引
CREATE INDEX idx_test_json_data ON test USING gin (json_data);
```

### 4.7 注释

**MySQL:**
```sql
COMMENT '表注释'
```

**PostgreSQL:**
```sql
COMMENT ON TABLE table_name IS '表注释';
COMMENT ON COLUMN table_name.column_name IS '列注释';
```

---

## 五、后续待办事项

### 高优先级

1. **转换所有 MySQL 语法的 SQL 脚本**
   - qooerp-workflow
   - qooerp-scm
   - qooerp-sales
   - qooerp-purchase
   - qooerp-production
   - qooerp-finance
   - qooerp-crm
   - qooerp-hr
   - qooerp-organization
   - qooerp-inventory
   - qooerp-project

2. **检查各模块的 application.yml 配置**
   - 确认所有模块使用 PostgreSQL 配置
   - 确认连接字符串正确

### 中优先级

3. **更新 Entity 层代码**
   - 确认使用正确的类型注解
   - JSONB 字段处理

4. **更新 pom.xml**
   - 确认所有模块包含 PostgreSQL 驱动
   - 移除 MySQL 相关依赖

### 低优先级

5. **测试验证**
   - 在 PostgreSQL 环境测试各模块
   - 验证所有 SQL 语句正确性

6. **文档完善**
   - 更新 README 文档
   - 添加 PostgreSQL 部署指南

---

## 六、常见问题

### Q1: PostgreSQL 和 MySQL 的主要区别是什么？

**A:**
1. PostgreSQL 对 SQL 标准支持更好
2. PostgreSQL 支持更丰富的数据类型（JSONB、ARRAY 等）
3. PostgreSQL 的 MVCC 机制不同
4. PostgreSQL 使用 SERIAL/BIGSERIAL 实现自增
5. PostgreSQL 默认不区分大小写

### Q2: 如何批量转换 SQL 脚本？

**A:** 可以使用以下方法：
1. 使用在线转换工具（如 https://www.sqlines.com/online）
2. 编写转换脚本批量处理
3. 手动逐个转换（推荐，确保准确性）

### Q3: MyBatis-Plus 如何适配 PostgreSQL？

**A:**
1. 确认 pom.xml 包含 PostgreSQL 驱动
2. 数据源配置使用 PostgreSQL 连接字符串
3. 配置 id-type 为 auto（对应 SERIAL）
4. 注意 PostgreSQL 的函数和语法差异

---

## 七、参考资料

- PostgreSQL 官方文档: https://www.postgresql.org/docs/
- MySQL to PostgreSQL 迁移指南: https://wiki.postgresql.org/wiki/Converting_from_other_Databases_to_PostgreSQL
- MyBatis-Plus 官方文档: https://baomidou.com/

---

**报告生成时间**: 2026-02-17
**检查人**: AI Assistant
**下次检查**: SQL 脚本转换完成后
