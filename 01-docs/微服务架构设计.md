# QooERP 微服务架构设计

## 概述

QooERP 采用 **前后端分离架构**，所有微服务后端统一对接 **qooerp-frontend 前端工程**：
- **后端技术栈**: Spring Boot + Spring Cloud + PostgreSQL + Redis
- **前端技术栈**: Vue 3 + TDesign (PC+Mobile) + Electron/Capacitor
- **通信协议**: RESTful API + WebSocket
- **监控**: OpenTelemetry + qooerp-monitor

---

## 一、架构总览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      客户端层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  Web 浏览器   │  │  Desktop    │  │  Mobile      │  │
│  │  (PC/Mobile) │  │  (Electron)  │  │  (Capacitor) │  │
│  │  Vue 3 +     │  │  Vue 3 +     │  │  Vue 3 +     │  │
│  │  TDesign     │  │  TDesign PC  │  │  TDesign Mobile│ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                  │                  │           │
└─────────┼──────────────────┼──────────────────┼───────────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
              ┌──────────────▼──────────────────┐
              │      qooerp-gateway            │
              │      (API Gateway)             │
              └──────────────┬──────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
    ┌─────▼───────┐  ┌─────▼───────┐  ┌─────▼───────┐
    │qooerp-auth  │  │qooerp-system│  │qooerp-user  │
    │  认证服务   │  │  系统服务   │  │  用户服务   │
    └─────┬───────┘  └─────┬───────┘  └─────┬───────┘
          │                  │                  │
    ┌─────▼───────┐  ┌─────▼───────┐  ┌─────▼───────┐
    │qooerp-permis│  │qooerp-orga  │  │qooerp-...   │
    │  权限服务   │  │  组织服务   │  │  ...        │
    └─────┬───────┘  └─────┬───────┘  └─────┬───────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
    ┌─────▼───────┐  ┌─────▼───────┐  ┌─────▼───────┐
    │ PostgreSQL  │  │   Redis     │  │ MinIO/OSS   │
    │  主数据存储  │  │   缓存      │  │  对象存储    │
    └─────────────┘  └─────────────┘  └─────────────┘
```

---

## 二、前端工程结构

### 2.1 Monorepo 结构

```
qooerp-frontend/
├── packages/                    # 子包
│   ├── web/                    # Web 端
│   │   ├── src/
│   │   │   ├── views/         # 页面视图（按微服务组织）
│   │   │   │   ├── auth/      # 认证模块
│   │   │   │   ├── system/    # 系统模块
│   │   │   │   ├── user/      # 用户模块
│   │   │   │   ├── permission/ # 权限模块
│   │   │   │   ├── monitor/   # 监控模块
│   │   │   │   └── ...
│   │   │   ├── components/    # 公共组件
│   │   │   ├── stores/        # Pinia 状态管理
│   │   │   ├── api/           # API 接口（按微服务组织）
│   │   │   │   ├── auth.ts
│   │   │   │   ├── system.ts
│   │   │   │   ├── user.ts
│   │   │   │   └── ...
│   │   │   └── router/        # 路由配置
│   │   ├── public/
│   │   ├── package.json
│   │   └── vite.config.ts
│   ├── desktop/                # 桌面端 (Electron)
│   │   ├── src/
│   │   ├── main/               # Electron 主进程
│   │   ├── package.json
│   │   └── electron.config.js
│   └── mobile/                # 移动端 (Capacitor)
│       ├── src/
│       ├── android/           # Android 原生代码
│       ├── ios/               # iOS 原生代码
│       ├── package.json
│       └── capacitor.config.ts
├── shared/                     # 共享代码
│   ├── components/            # 共享组件
│   ├── composables/           # 共享组合式函数
│   ├── utils/                 # 工具函数
│   ├── types/                 # TypeScript 类型定义
│   ├── constants/             # 常量
│   └── api/                   # 共享 API
├── pnpm-workspace.yaml
├── package.json
└── tsconfig.json
```

### 2.2 API 接口组织（按微服务）

```
qooerp-frontend/packages/web/src/api/
├── index.ts                   # 统一导出
├── auth.ts                    # 认证服务 API
├── system.ts                  # 系统服务 API
├── user.ts                    # 用户服务 API
├── permission.ts              # 权限服务 API
├── organization.ts            # 组织服务 API
├── hr.ts                      # HR 服务 API
├── finance.ts                 # 财务服务 API
├── crm.ts                     # CRM 服务 API
├── scm.ts                     # SCM 服务 API
├── sales.ts                   # 销售服务 API
├── purchase.ts                # 采购服务 API
├── inventory.ts               # 库存服务 API
├── production.ts              # 生产服务 API
├── monitor.ts                 # 监控服务 API
├── file.ts                    # 文件服务 API
├── message.ts                 # 消息服务 API
└── workflow.ts                # 工作流服务 API
```

### 2.3 页面视图组织（按微服务）

```
qooerp-frontend/packages/web/src/views/
├── auth/                      # 认证模块
│   ├── login.vue
│   └── register.vue
├── system/                    # 系统模块
│   ├── user/                  # 用户管理
│   ├── role/                  # 角色管理
│   ├── dept/                  # 部门管理
│   ├── menu/                  # 菜单管理
│   └── dict/                  # 字典管理
├── user/                      # 用户模块
│   ├── profile/               # 用户资料
│   └── settings/             # 用户设置
├── permission/                # 权限模块
│   ├── user-permission/       # 用户权限
│   └── data-permission/      # 数据权限
├── organization/              # 组织模块
│   ├── company/              # 公司管理
│   └── department/           # 部门管理
├── hr/                        # HR 模块
│   ├── employee/             # 员工管理
│   ├── attendance/           # 考勤管理
│   └── salary/               # 薪资管理
├── finance/                   # 财务模块
│   ├── account/              # 账户管理
│   └── voucher/              # 凭证管理
├── crm/                       # CRM 模块
│   ├── customer/             # 客户管理
│   └── opportunity/          # 商机管理
├── scm/                       # SCM 模块
│   ├── supplier/             # 供应商管理
│   └── contract/             # 合同管理
├── sales/                     # 销售模块
│   ├── order/                # 销售订单
│   └── invoice/              # 销售发票
├── purchase/                  # 采购模块
│   ├── order/                # 采购订单
│   └── return/               # 采购退货
├── inventory/                 # 库存模块
│   ├── warehouse/            # 仓库管理
│   └── stock/               # 库存管理
├── production/                # 生产模块
│   ├── plan/                 # 生产计划
│   └── order/                # 生产订单
├── monitor/                   # 监控模块
│   ├── dashboard/            # 监控仪表盘
│   ├── traces/               # 链路追踪
│   ├── metrics/              # 指标分析
│   ├── logs/                 # 日志查询
│   └── alerts/               # 告警管理
├── file/                      # 文件模块
│   ├── upload/               # 文件上传
│   └── download/             # 文件下载
├── message/                   # 消息模块
│   ├── notice/               # 通知
│   └── message/              # 消息
└── workflow/                  # 工作流模块
    ├── instance/             # 流程实例
    └── task/                 # 待办任务
```

---

## 三、微服务列表

### 3.1 核心服务

| 服务名称 | 端口 | 说明 | 前端 API 文件 |
|---------|------|------|---------------|
| qooerp-gateway | 8080 | API 网关 | gateway.ts |
| qooerp-auth | 8100 | 认证服务 | auth.ts |
| qooerp-system | 8102 | 系统服务 | system.ts |
| qooerp-user | 8103 | 用户服务 | user.ts |
| qooerp-permission | 8104 | 权限服务 | permission.ts |
| qooerp-organization | 8105 | 组织服务 | organization.ts |

### 3.2 业务服务

| 服务名称 | 端口 | 说明 | 前端 API 文件 |
|---------|------|------|---------------|
| qooerp-hr | 8110 | HR 服务 | hr.ts |
| qooerp-finance | 8111 | 财务服务 | finance.ts |
| qooerp-crm | 8112 | CRM 服务 | crm.ts |
| qooerp-scm | 8113 | SCM 服务 | scm.ts |
| qooerp-sales | 8114 | 销售服务 | sales.ts |
| qooerp-purchase | 8115 | 采购服务 | purchase.ts |
| qooerp-inventory | 8116 | 库存服务 | inventory.ts |
| qooerp-production | 8117 | 生产服务 | production.ts |
| qooerp-workflow | 8120 | 工作流服务 | workflow.ts |

### 3.3 支撑服务

| 服务名称 | 端口 | 说明 | 前端 API 文件 |
|---------|------|------|---------------|
| qooerp-monitor | 8101 | 监控服务 | monitor.ts |
| qooerp-file | 8106 | 文件服务 | file.ts |
| qooerp-message | 8107 | 消息服务 | message.ts |
| qooerp-notify | 8108 | 通知服务 | notify.ts |

---

## 四、前后端通信

### 4.1 API 路由规范

**请求格式**：
```
GET /api/{module}/{resource}?param=value
POST /api/{module}/{resource}
PUT /api/{module}/{resource}/{id}
DELETE /api/{module}/{resource}/{id}
```

**示例**：
```
# 系统服务
GET /api/system/user/list
POST /api/system/user/create
PUT /api/system/user/update/1
DELETE /api/system/user/delete/1

# HR 服务
GET /api/hr/employee/list
POST /api/hr/attendance/submit

# 监控服务
GET /api/monitor/dashboard/overview
GET /api/monitor/trace/{traceId}
```

### 4.2 前端 API 封装示例

```typescript
// qooerp-frontend/packages/web/src/api/system.ts
import request from '@/utils/request'

/**
 * 系统服务 API
 */
export const systemApi = {
  // 用户管理
  userList: (params: UserQuery) => {
    return request.get<PageResult<User>>('/system/user/list', { params })
  },

  userCreate: (data: UserCreate) => {
    return request.post<void>('/system/user/create', data)
  },

  userUpdate: (id: number, data: UserUpdate) => {
    return request.put<void>(`/system/user/update/${id}`, data)
  },

  userDelete: (id: number) => {
    return request.delete<void>(`/system/user/delete/${id}`)
  },

  // 角色管理
  roleList: (params: RoleQuery) => {
    return request.get<PageResult<Role>>('/system/role/list', { params })
  },

  // 部门管理
  deptList: () => {
    return request.get<Dept[]>('/system/dept/list')
  }
}

export default systemApi
```

```typescript
// qooerp-frontend/packages/web/src/api/hr.ts
import request from '@/utils/request'

/**
 * HR 服务 API
 */
export const hrApi = {
  // 员工管理
  employeeList: (params: EmployeeQuery) => {
    return request.get<PageResult<Employee>>('/hr/employee/list', { params })
  },

  employeeCreate: (data: EmployeeCreate) => {
    return request.post<void>('/hr/employee/create', data)
  },

  // 考勤管理
  attendanceSubmit: (data: AttendanceSubmit) => {
    return request.post<void>('/hr/attendance/submit', data)
  },

  // 薪资管理
  salaryCalculate: (month: string) => {
    return request.post<SalaryCalculationResult>('/hr/salary/calculate', { month })
  }
}

export default hrApi
```

### 4.3 路由配置

```typescript
// qooerp-frontend/packages/web/src/router/index.ts
import { createRouter, createWebHistory } from 'vue-router'

const routes = [
  {
    path: '/',
    component: () => import('@/layouts/MainLayout.vue'),
    children: [
      // 系统模块
      {
        path: 'system/user',
        component: () => import('@/views/system/user/index.vue')
      },
      {
        path: 'system/role',
        component: () => import('@/views/system/role/index.vue')
      },

      // HR 模块
      {
        path: 'hr/employee',
        component: () => import('@/views/hr/employee/index.vue')
      },
      {
        path: 'hr/attendance',
        component: () => import('@/views/hr/attendance/index.vue')
      },

      // 监控模块
      {
        path: 'monitor/dashboard',
        component: () => import('@/views/monitor/dashboard/index.vue')
      },
      {
        path: 'monitor/traces',
        component: () => import('@/views/monitor/traces/index.vue')
      }
    ]
  }
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

export default router
```

---

## 五、统一前端工程优势

### 5.1 代码复用

- **共享组件**：所有微服务共用一套 TDesign 组件
- **共享工具**：统一的请求封装、权限控制、路由守卫
- **共享状态**：全局用户信息、权限信息、应用配置
- **共享类型**：统一的 TypeScript 类型定义

### 5.2 开发效率

- **统一构建**：一次构建，多端部署（Web、Desktop、Mobile）
- **统一规范**：统一的代码风格、API 调用规范
- **统一监控**：统一的错误监控、性能监控
- **统一部署**：统一的 CI/CD 流程

### 5.3 用户体验

- **一致的 UI**：所有模块使用 TDesign 组件库
- **无缝切换**：Web、Desktop、Mobile 无缝切换
- **性能优化**：统一的代码分割、懒加载策略
- **离线支持**：Electron 支持离线使用

---

## 六、开发流程

### 6.1 微服务开发流程

1. **后端开发**：使用 Spring Boot 开发微服务 API
2. **前端开发**：在 `qooerp-frontend` 中对应模块开发页面
3. **API 对接**：前端调用后端 RESTful API
4. **联调测试**：前后端联调测试
5. **统一部署**：前后端独立部署

### 6.2 目录组织规范

**后端微服务**：
```
qooerp-{module}/
├── docs/                     # 文档
│   ├── 01-业务设计.md
│   ├── 02-应用设计.md
│   ├── 03-数据设计.md
│   ├── 04-API接口文档.md
│   ├── 05-技术设计.md
│   └── 05-数据库脚本.sql
└── qooerp-{module}-service/
```

**前端模块**：
```
qooerp-frontend/packages/web/src/
├── views/{module}/            # 页面视图
├── api/{module}.ts           # API 接口
├── stores/{module}/          # Pinia Store
└── components/{module}/     # 业务组件
```

---

## 七、版本管理

### 7.1 版本规范

- **后端版本**：`{module}-v{major}.{minor}.{patch}`
- **前端版本**：统一版本号 `v{major}.{minor}.{patch}`
- **API 版本**：通过 URL 路径区分（如 `/api/v2/system/user`）

### 7.2 兼容性

- 后端 API 保持向后兼容至少 2 个大版本
- 前端通过版本号适配不同后端版本
- 弃用 API 提前 3 个月通知

---

## 八、部署架构

### 8.1 开发环境

```
┌─────────────────────────────────────────┐
│  开发环境                          │
│                                     │
│  qooerp-frontend (localhost:5173)     │
│         │                            │
│         └──────────────┬─────────────┘
│                        │
│  qooerp-gateway (localhost:8080)      │
│         │                            │
│    ┌────┴────┬──────┬──────┬──────┐   │
│    │         │      │      │      │   │
│  auth     system   user  ...   monitor│
└─────────────────────────────────────┘
```

### 8.2 生产环境

```
┌─────────────────────────────────────────────────────┐
│  生产环境 (Kubernetes)                            │
│                                                     │
│  qooerp-frontend (Nginx + CDN)                      │
│         │                                           │
│         └──────────────┬────────────────────────────┘
│                        │
│  qooerp-gateway (3 副本)                          │
│         │                                           │
│    ┌────┴────┬──────┬──────┬──────┬──────┐        │
│    │         │      │      │      │      │        │
│  auth     system   user  hr    ...  monitor      │
│ (2副本) (3副本) (2副本) ...          (2副本)       │
└─────────────────────────────────────────────────────┘
```

---

**文档版本**: v1.0
**更新日期**: 2026-02-18
**前端技术栈**: Vue 3 + TDesign (PC+Mobile) + Electron/Capacitor
