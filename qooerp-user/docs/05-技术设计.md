# QooERP User 模块 - 技术设计文档

## 1. 技术选型

### 1.1 核心技术栈

| 技术组件 | 版本 | 用途 |
|---------|------|------|
| Spring Boot | 3.x | 应用框架 |
| MyBatis-Plus | 3.5.x | ORM框架 |
| PostgreSQL | 15+ | 关系型数据库 |
| Redis | 7.x | 缓存数据库 |
| Nacos | 2.x | 配置中心和服务发现 |
| EasyExcel | 3.x | Excel导入导出 |
| BCrypt | - | 密码加密 |

### 1.2 依赖模块

```xml
<dependencies>
    <!-- 公共模块 -->
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-common-api</artifactId>
    </dependency>
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-common-core</artifactId>
    </dependency>
    
    <!-- 认证模块 -->
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-auth-api</artifactId>
    </dependency>
    
    <!-- 权限模块 -->
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-permission-api</artifactId>
    </dependency>
    
    <!-- 组织模块 -->
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-organization-api</artifactId>
    </dependency>
    
    <!-- 数据库 -->
    <dependency>
        <groupId>org.postgresql</groupId>
        <artifactId>postgresql</artifactId>
    </dependency>
    
    <!-- 缓存 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    
    <!-- Excel处理 -->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>easyexcel</artifactId>
        <version>3.3.2</version>
    </dependency>
    
    <!-- 密码加密 -->
    <dependency>
        <groupId>org.mindrot</groupId>
        <artifactId>jbcrypt</artifactId>
        <version>0.4</version>
    </dependency>
    
    <!-- 注册中心和配置中心 -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    </dependency>
</dependencies>
```

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                   客户端层 (Web/Mobile)                   │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│                    API Gateway                            │
│              (路由、认证、限流)                            │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│                  User Service                            │
│  ┌────────────────────────────────────────────────────┐  │
│  │              Controller 层                         │  │
│  │  - UserController                                  │  │
│  │  - UserRoleController                             │  │
│  └──────────────────────┬─────────────────────────────┘  │
│  ┌──────────────────────▼─────────────────────────────┐  │
│  │              Service 层                             │  │
│  │  - UserService                                    │  │
│  │  - UserRoleService                                │  │
│  │  - UserDepartmentService                           │  │
│  │  - UserImportService                              │  │
│  │  - UserExportService                              │  │
│  └──────────────────────┬─────────────────────────────┘  │
│  ┌──────────────────────▼─────────────────────────────┐  │
│  │              Mapper 层                              │  │
│  │  - UserMapper                                     │  │
│  │  - UserRoleMapper                                │  │
│  │  - UserDepartmentMapper                           │  │
│  └──────────────────────┬─────────────────────────────┘  │
│  ┌──────────────────────▼─────────────────────────────┐  │
│  │              数据访问层                             │  │
│  │  - MyBatis-Plus                                     │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┬────────────┐
        │              │              │            │
┌───────▼──────┐ ┌────▼─────┐ ┌────▼─────┐ ┌───▼────┐
│  PostgreSQL  │ │  Redis   │ │  Nacos   │ │组织模块│
│   (持久化)   │ │  (缓存)  │ │(配置中心) │ │(远程调用)│
└──────────────┘ └──────────┘ └──────────┘ └────────┘
```

## 3. 核心功能实现

### 3.1 密码管理

#### 密码加密

```java
@Component
public class PasswordEncoder {
    
    /**
     * 加密密码
     */
    public String encode(String rawPassword) {
        return BCrypt.hashpw(rawPassword, BCrypt.gensalt());
    }
    
    /**
     * 校验密码
     */
    public boolean matches(String rawPassword, String encodedPassword) {
        return BCrypt.checkpw(rawPassword, encodedPassword);
    }
}
```

#### 密码强度校验

```java
@Component
public class PasswordValidator {
    
    private static final int MIN_LENGTH = 6;
    private static final int MAX_LENGTH = 20;
    
    /**
     * 校验密码强度
     */
    public void validate(String password) {
        if (StringUtils.isBlank(password)) {
            throw new ValidationException("密码不能为空");
        }
        
        if (password.length() < MIN_LENGTH) {
            throw new ValidationException("密码长度不能少于" + MIN_LENGTH + "位");
        }
        
        if (password.length() > MAX_LENGTH) {
            throw new ValidationException("密码长度不能超过" + MAX_LENGTH + "位");
        }
        
        // 校验密码复杂度：至少包含字母和数字
        boolean hasLetter = password.matches(".*[a-zA-Z].*");
        boolean hasDigit = password.matches(".*\\d.*");
        
        if (!hasLetter || !hasDigit) {
            throw new ValidationException("密码必须包含字母和数字");
        }
    }
}
```

### 3.2 用户缓存管理

#### 用户缓存服务

```java
@Service
public class UserCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String USER_CACHE_KEY = "user:info:";
    private static final String USER_USERNAME_KEY = "user:username:";
    private static final String USER_ROLES_KEY = "user:roles:";
    
    /**
     * 缓存用户信息
     */
    @Cacheable(value = "user", key = "#userId")
    public UserVO getUser(Long userId) {
        return userMapper.selectById(userId);
    }
    
    /**
     * 根据用户名获取用户（带缓存）
     */
    public UserVO getUserByUsername(String username) {
        String key = USER_USERNAME_KEY + username;
        UserVO user = (UserVO) redisTemplate.opsForValue().get(key);
        
        if (user == null) {
            user = userMapper.selectOne(
                new LambdaQueryWrapper<User>()
                    .eq(User::getUsername, username)
            );
            
            if (user != null) {
                redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
            }
        }
        
        return user;
    }
    
    /**
     * 缓存用户角色
     */
    @Cacheable(value = "userRoles", key = "#userId")
    public List<RoleVO> getUserRoles(Long userId) {
        return userRoleMapper.selectRolesByUserId(userId);
    }
    
    /**
     * 清除用户缓存
     */
    @CacheEvict(value = {"user", "userRoles"}, key = "#userId")
    public void clearUserCache(Long userId) {
        // 清除用户名缓存
        User user = userMapper.selectById(userId);
        if (user != null) {
            redisTemplate.delete(USER_USERNAME_KEY + user.getUsername());
        }
    }
}
```

### 3.3 用户导入导出

#### 导入服务

```java
@Service
public class UserImportServiceImpl implements UserImportService {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private OrganizationService organizationService;
    
    /**
     * 导入用户
     */
    @Transactional
    public ImportResultDTO importUsers(MultipartFile file) throws IOException {
        // 解析Excel
        List<UserImportDTO> importList = EasyExcel.read(file.getInputStream())
            .head(UserImportDTO.class)
            .sheet()
            .doReadSync();
        
        ImportResultDTO result = new ImportResultDTO();
        result.setTotalCount(importList.size());
        
        List<ImportFailRecord> failRecords = new ArrayList<>();
        
        for (int i = 0; i < importList.size(); i++) {
            UserImportDTO importDTO = importList.get(i);
            int rowNumber = i + 2; // Excel从第2行开始是数据
            
            try {
                // 数据校验
                validateImportData(importDTO);
                
                // 转换并创建用户
                UserDTO userDTO = convertToUserDTO(importDTO);
                userService.createUser(userDTO);
                
                result.setSuccessCount(result.getSuccessCount() + 1);
            } catch (Exception e) {
                ImportFailRecord failRecord = new ImportFailRecord();
                failRecord.setRowNumber(rowNumber);
                failRecord.setUsername(importDTO.getUsername());
                failRecord.setErrorMessage(e.getMessage());
                failRecords.add(failRecord);
                
                result.setFailCount(result.getFailCount() + 1);
            }
        }
        
        result.setFailRecords(failRecords);
        return result;
    }
    
    /**
     * 数据校验
     */
    private void validateImportData(UserImportDTO importDTO) {
        if (StringUtils.isBlank(importDTO.getUsername())) {
            throw new ValidationException("用户名不能为空");
        }
        
        if (StringUtils.isBlank(importDTO.getPassword())) {
            throw new ValidationException("密码不能为空");
        }
        
        if (StringUtils.isBlank(importDTO.getRealName())) {
            throw new ValidationException("真实姓名不能为空");
        }
        
        if (StringUtils.isBlank(importDTO.getPhone())) {
            throw new ValidationException("手机号不能为空");
        }
        
        if (StringUtils.isBlank(importDTO.getDeptCode())) {
            throw new ValidationException("部门编码不能为空");
        }
        
        // 校验部门是否存在
        Department dept = organizationService.getDepartmentByCode(importDTO.getDeptCode());
        if (dept == null) {
            throw new ValidationException("部门编码不存在: " + importDTO.getDeptCode());
        }
    }
    
    /**
     * 转换为用户DTO
     */
    private UserDTO convertToUserDTO(UserImportDTO importDTO) {
        UserDTO userDTO = new UserDTO();
        userDTO.setUsername(importDTO.getUsername());
        userDTO.setPassword(importDTO.getPassword());
        userDTO.setRealName(importDTO.getRealName());
        userDTO.setPhone(importDTO.getPhone());
        userDTO.setEmail(importDTO.getEmail());
        userDTO.setGender(importDTO.getGender());
        
        // 查找部门
        Department dept = organizationService.getDepartmentByCode(importDTO.getDeptCode());
        if (dept != null) {
            userDTO.setCompanyId(dept.getCompanyId());
            userDTO.setDeptId(dept.getId());
        }
        
        // 查找职位
        if (StringUtils.isNotBlank(importDTO.getPositionCode())) {
            Position position = organizationService.getPositionByCode(
                dept.getCompanyId(), dept.getId(), importDTO.getPositionCode());
            if (position != null) {
                userDTO.setPositionId(position.getId());
            }
        }
        
        return userDTO;
    }
}
```

#### 导出服务

```java
@Service
public class UserExportServiceImpl implements UserExportService {
    
    @Autowired
    private UserService userService;
    
    /**
     * 导出用户
     */
    public void exportUsers(UserQuery query, HttpServletResponse response) throws IOException {
        // 查询用户数据（最多导出10000条）
        query.setCurrent(1L);
        query.setSize(10000L);
        
        Page<UserVO> userPage = userService.listUsers(query);
        List<UserVO> userList = userPage.getRecords();
        
        // 转换为导出DTO
        List<UserExportDTO> exportList = userList.stream()
            .map(this::convertToExportDTO)
            .collect(Collectors.toList());
        
        // 设置响应头
        response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        response.setCharacterEncoding("utf-8");
        String fileName = URLEncoder.encode("用户列表_" + DateTimeUtils.format(new Date(), "yyyyMMddHHmmss"), 
            "UTF-8").replaceAll("\\+", "%20");
        response.setHeader("Content-disposition", "attachment;filename*=utf-8''" + fileName + ".xlsx");
        
        // 写入Excel
        EasyExcel.write(response.getOutputStream(), UserExportDTO.class)
            .sheet("用户数据")
            .doWrite(exportList);
    }
    
    /**
     * 转换为导出DTO
     */
    private UserExportDTO convertToExportDTO(UserVO user) {
        UserExportDTO exportDTO = new UserExportDTO();
        exportDTO.setUsername(user.getUsername());
        exportDTO.setNickname(user.getNickname());
        exportDTO.setRealName(user.getRealName());
        exportDTO.setEmail(user.getEmail());
        exportDTO.setPhone(user.getPhone());
        exportDTO.setGender("male".equals(user.getGender()) ? "男" : 
                           "female".equals(user.getGender()) ? "女" : "未知");
        exportDTO.setBirthday(user.getBirthday());
        exportDTO.setCompanyName(user.getCompanyName());
        exportDTO.setDeptName(user.getDeptName());
        exportDTO.setPositionName(user.getPositionName());
        exportDTO.setEmployeeNo(user.getEmployeeNo());
        exportDTO.setHireDate(user.getHireDate());
        exportDTO.setStatus(user.getStatus() == 1 ? "启用" : "禁用");
        exportDTO.setCreatedTime(user.getCreatedTime());
        return exportDTO;
    }
}
```

### 3.4 用户状态管理

#### 状态变更服务

```java
@Service
public class UserStatusServiceImpl implements UserStatusService {
    
    /**
     * 启用用户
     */
    @Override
    @Transactional
    @OperationLog(module = "用户管理", operation = "启用用户", type = OperationType.UPDATE)
    public void enableUser(Long userId) {
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new DataNotFoundException("用户不存在");
        }
        
        if (user.getStatus() == 1) {
            throw new BusinessException("用户已是启用状态");
        }
        
        user.setStatus(1);
        userMapper.updateById(user);
        
        // 清除缓存
        clearUserCache(userId);
        
        // 强制用户下线
        authService.forceLogout(userId);
    }
    
    /**
     * 禁用用户
     */
    @Override
    @Transactional
    @OperationLog(module = "用户管理", operation = "禁用用户", type = OperationType.UPDATE)
    public void disableUser(Long userId) {
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new DataNotFoundException("用户不存在");
        }
        
        if (user.getStatus() == 0) {
            throw new BusinessException("用户已是禁用状态");
        }
        
        // 不能禁用自己
        Long currentUserId = SecurityUtils.getUserId();
        if (userId.equals(currentUserId)) {
            throw new BusinessException("不能禁用自己");
        }
        
        user.setStatus(0);
        userMapper.updateById(user);
        
        // 清除缓存
        clearUserCache(userId);
        
        // 强制用户下线
        authService.forceLogout(userId);
    }
}
```

## 4. 缓存设计

### 4.1 缓存策略

| 数据类型 | 缓存Key | 过期时间 | 更新策略 |
|---------|---------|----------|----------|
| 用户信息 | user:info:{id} | 30分钟 | 用户变更时清除 |
| 用户名索引 | user:username:{username} | 30分钟 | 用户变更时清除 |
| 用户角色 | user:roles:{id} | 30分钟 | 角色变更时清除 |
| 用户权限 | user:permissions:{id} | 30分钟 | 权限变更时清除 |

### 4.2 缓存预热

```java
@Component
public class UserCacheWarmUp {
    
    @Autowired
    private UserCacheService userCacheService;
    
    /**
     * 缓存预热
     */
    @PostConstruct
    public void warmUp() {
        // 预热常用用户
        List<User> activeUsers = userMapper.selectList(
            new LambdaQueryWrapper<User>()
                .eq(User::getStatus, 1)
                .last("LIMIT 100")
        );
        
        for (User user : activeUsers) {
            userCacheService.getUser(user.getId());
            userCacheService.getUserByUsername(user.getUsername());
            userCacheService.getUserRoles(user.getId());
        }
    }
}
```

## 5. 性能优化

### 5.1 数据库优化

#### 索引设计

```sql
-- user表索引
CREATE INDEX idx_user_username ON user(username);
CREATE INDEX idx_user_email ON user(email);
CREATE INDEX idx_user_phone ON user(phone);
CREATE INDEX idx_user_employee_no ON user(employee_no);
CREATE INDEX idx_user_company_id ON user(company_id);
CREATE INDEX idx_user_dept_id ON user(dept_id);
CREATE INDEX idx_user_position_id ON user(position_id);
CREATE INDEX idx_user_status ON user(status);
CREATE INDEX idx_user_created_time ON user(created_time);

-- user_role表索引
CREATE INDEX idx_user_role_user_id ON user_role(user_id);
CREATE INDEX idx_user_role_role_id ON user_role(role_id);
CREATE UNIQUE INDEX uk_user_role ON user_role(user_id, role_id);

-- user_department表索引
CREATE INDEX idx_user_dept_user_id ON user_department(user_id);
CREATE INDEX idx_user_dept_dept_id ON user_department(dept_id);
CREATE UNIQUE INDEX uk_user_dept ON user_department(user_id, dept_id);
```

### 5.2 查询优化

#### 批量查询用户

```java
@Service
public class UserServiceImpl implements UserService {
    
    /**
     * 批量获取用户
     */
    public Map<Long, UserVO> batchGetUsers(List<Long> userIds) {
        if (CollectionUtils.isEmpty(userIds)) {
            return Collections.emptyMap();
        }
        
        List<User> users = userMapper.selectBatchIds(userIds);
        return users.stream()
            .collect(Collectors.toMap(
                User::getId,
                user -> BeanUtil.copyProperties(user, UserVO.class)
            ));
    }
    
    /**
     * 批量获取用户角色
     */
    public Map<Long, List<RoleVO>> batchGetUserRoles(List<Long> userIds) {
        if (CollectionUtils.isEmpty(userIds)) {
            return Collections.emptyMap();
        }
        
        List<UserRole> userRoles = userRoleMapper.selectList(
            new LambdaQueryWrapper<UserRole>()
                .in(UserRole::getUserId, userIds)
        );
        
        Map<Long, List<Long>> userRoleIdsMap = userRoles.stream()
            .collect(Collectors.groupingBy(
                UserRole::getUserId,
                Collectors.mapping(UserRole::getRoleId, Collectors.toList())
            ));
        
        // 批量查询角色
        Set<Long> allRoleIds = userRoles.stream()
            .map(UserRole::getRoleId)
            .collect(Collectors.toSet());
        
        Map<Long, Role> roleMap = roleService.getRoleMapByIds(allRoleIds);
        
        // 组装结果
        Map<Long, List<RoleVO>> result = new HashMap<>();
        for (Map.Entry<Long, List<Long>> entry : userRoleIdsMap.entrySet()) {
            List<RoleVO> roleVOList = entry.getValue().stream()
                .map(roleId -> BeanUtil.copyProperties(roleMap.get(roleId), RoleVO.class))
                .collect(Collectors.toList());
            result.put(entry.getKey(), roleVOList);
        }
        
        return result;
    }
}
```

## 6. 安全设计

### 6.1 密码安全

#### 密码策略

```java
@Configuration
public class PasswordConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new PasswordEncoder() {
            @Override
            public String encode(CharSequence rawPassword) {
                return BCrypt.hashpw(rawPassword.toString(), BCrypt.gensalt());
            }
            
            @Override
            public boolean matches(CharSequence rawPassword, String encodedPassword) {
                return BCrypt.checkpw(rawPassword.toString(), encodedPassword);
            }
        };
    }
}
```

### 6.2 敏感数据保护

#### 数据脱敏

```java
@Component
public class DataMaskUtils {
    
    /**
     * 手机号脱敏
     */
    public static String maskPhone(String phone) {
        if (StringUtils.isBlank(phone) || phone.length() != 11) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    /**
     * 邮箱脱敏
     */
    public static String maskEmail(String email) {
        if (StringUtils.isBlank(email) || !email.contains("@")) {
            return email;
        }
        
        String[] parts = email.split("@");
        String username = parts[0];
        String domain = parts[1];
        
        if (username.length() <= 3) {
            return username.charAt(0) + "***@" + domain;
        }
        
        return username.substring(0, 3) + "***@" + domain;
    }
    
    /**
     * 身份证脱敏
     */
    public static String maskIdCard(String idCard) {
        if (StringUtils.isBlank(idCard) || idCard.length() != 18) {
            return idCard;
        }
        return idCard.substring(0, 6) + "********" + idCard.substring(14);
    }
}
```

## 7. 部署配置

### 7.1 application.yml

```yaml
server:
  port: 8086

spring:
  application:
    name: qooerp-user
  
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/qooerp
    username: postgres
    password: postgres
  
  redis:
    host: localhost
    port: 6379
    database: 5
    password:
  
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 50MB
  
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: qooerp
      config:
        server-addr: localhost:8848
        namespace: qooerp
        file-extension: yml

mybatis-plus:
  mapper-locations: classpath*:mapper/**/*.xml
  type-aliases-package: com.qoobot.qooerp.user.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl

# 用户配置
user:
  password:
    min-length: 6
    max-length: 20
    require-letters: true
    require-digits: true
  export:
    max-records: 10000

logging:
  level:
    com.qoobot.qooerp.user: debug
```

### 7.2 环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| SERVER_PORT | 服务端口 | 8086 |
| DB_URL | 数据库URL | - |
| DB_USERNAME | 数据库用户名 | - |
| DB_PASSWORD | 数据库密码 | - |
| REDIS_HOST | Redis主机 | localhost |
| REDIS_PORT | Redis端口 | 6379 |
| NACOS_ADDR | Nacos地址 | localhost:8848 |

## 8. 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2025-01-17 | 初始版本 | Auto |
