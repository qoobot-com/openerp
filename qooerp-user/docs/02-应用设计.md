# QooERP User 模块 - 应用设计文档

## 1. 应用概述

### 1.1 应用定位
QooERP User 模块是用户管理核心模块，提供用户信息管理、用户角色关联、用户部门关联等功能，支持用户的全生命周期管理。

### 1.2 应用目标
- 提供用户信息的增删改查功能
- 提供用户角色关联管理
- 提供用户部门关联管理
- 提供用户状态管理和密码管理
- 支持用户导入导出功能

## 2. 应用架构

### 2.1 分层架构

```
qooerp-user/
├── qooerp-user-api/              # API接口定义
│   ├── dto/                        # 数据传输对象
│   │   ├── UserDTO.java
│   │   ├── UserRoleDTO.java
│   │   └── UserDepartmentDTO.java
│   ├── vo/                         # 视图对象
│   │   ├── UserVO.java
│   │   ├── UserDetailVO.java
│   │   └── UserTreeVO.java
│   └── query/                      # 查询对象
│       └── UserQuery.java
├── qooerp-user-service/            # 服务实现
│   ├── controller/                 # 控制器层
│   │   ├── UserController.java
│   │   └── UserRoleController.java
│   ├── service/                    # 服务层
│   │   ├── UserService.java
│   │   ├── UserRoleService.java
│   │   └── UserDepartmentService.java
│   ├── mapper/                     # 数据访问层
│   │   ├── UserMapper.java
│   │   ├── UserRoleMapper.java
│   │   └── UserDepartmentMapper.java
│   └── entity/                    # 实体类
│       ├── User.java
│       ├── UserRole.java
│       └── UserDepartment.java
```

### 2.2 模块依赖

```
qooerp-user
    ├── qooerp-common (公共组件)
    ├── qooerp-auth (认证模块)
    ├── qooerp-permission (权限模块)
    └── qooerp-organization (组织模块)
```

## 3. 核心功能设计

### 3.1 用户管理

#### 功能概述
提供用户信息的增删改查功能，支持用户状态管理、密码管理、头像管理等。

#### User实体

```java
@Data
@TableName("user")
public class User extends BaseEntity {
    private Long id;                    // 用户ID
    private String username;            // 用户名
    private String password;            // 密码(加密)
    private String nickname;           // 昵称
    private String realName;           // 真实姓名
    private String email;              // 邮箱
    private String phone;              // 手机号
    private String gender;              // 性别: male/female/unknown
    private Date birthday;             // 生日
    private String avatar;              // 头像
    private Long companyId;            // 所属公司ID
    private Long deptId;               // 所属部门ID
    private Long positionId;           // 职位ID
    private String employeeNo;         // 员工编号
    private Date hireDate;             // 入职日期
    private Integer status;            // 状态: 1-启用 0-禁用
    private String remark;             // 备注
}
```

#### 用户服务

```java
@Service
public class UserServiceImpl implements UserService {
    
    /**
     * 创建用户
     */
    @Override
    @Transactional
    @OperationLog(module = "用户管理", operation = "创建用户", type = OperationType.INSERT)
    public Long createUser(UserDTO userDTO) {
        // 校验用户名唯一性
        checkUsernameUnique(userDTO.getUsername());
        
        // 校验邮箱唯一性
        if (StringUtils.isNotBlank(userDTO.getEmail())) {
            checkEmailUnique(userDTO.getEmail());
        }
        
        // 校验手机号唯一性
        if (StringUtils.isNotBlank(userDTO.getPhone())) {
            checkPhoneUnique(userDTO.getPhone());
        }
        
        User user = BeanUtil.copyProperties(userDTO, User.class);
        
        // 加密密码
        user.setPassword(BCrypt.hashpw(userDTO.getPassword(), BCrypt.gensalt()));
        
        // 设置默认状态
        if (user.getStatus() == null) {
            user.setStatus(1);
        }
        
        userMapper.insert(user);
        
        // 关联角色
        if (CollectionUtils.isNotEmpty(userDTO.getRoleIds())) {
            assignRoles(user.getId(), userDTO.getRoleIds());
        }
        
        // 关联部门
        if (userDTO.getDeptId() != null) {
            assignDepartment(user.getId(), userDTO.getDeptId());
        }
        
        return user.getId();
    }
    
    /**
     * 更新用户
     */
    @Override
    @Transactional
    @OperationLog(module = "用户管理", operation = "更新用户", type = OperationType.UPDATE)
    public void updateUser(Long userId, UserDTO userDTO) {
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new DataNotFoundException("用户不存在");
        }
        
        // 校验用户名唯一性
        if (!user.getUsername().equals(userDTO.getUsername())) {
            checkUsernameUnique(userDTO.getUsername());
        }
        
        // 更新用户信息
        User updateUser = BeanUtil.copyProperties(userDTO, User.class);
        updateUser.setId(userId);
        
        // 密码更新
        if (StringUtils.isNotBlank(userDTO.getPassword())) {
            updateUser.setPassword(BCrypt.hashpw(userDTO.getPassword(), BCrypt.gensalt()));
        } else {
            updateUser.setPassword(null);
        }
        
        userMapper.updateById(updateUser);
        
        // 更新角色关联
        if (CollectionUtils.isNotEmpty(userDTO.getRoleIds())) {
            updateRoles(userId, userDTO.getRoleIds());
        }
        
        // 更新部门关联
        if (userDTO.getDeptId() != null && !userDTO.getDeptId().equals(user.getDeptId())) {
            updateDepartment(userId, userDTO.getDeptId());
        }
        
        // 清除缓存
        clearUserCache(userId);
    }
    
    /**
     * 删除用户
     */
    @Override
    @Transactional
    @OperationLog(module = "用户管理", operation = "删除用户", type = OperationType.DELETE)
    public void deleteUser(Long userId) {
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new DataNotFoundException("用户不存在");
        }
        
        // 不能删除超级管理员
        if (SystemConstants.SUPER_ADMIN.equals(user.getUsername())) {
            throw new BusinessException("不能删除超级管理员");
        }
        
        // 删除用户
        userMapper.deleteById(userId);
        
        // 删除角色关联
        deleteUserRoles(userId);
        
        // 删除部门关联
        deleteUserDepartments(userId);
        
        // 清除缓存
        clearUserCache(userId);
    }
    
    /**
     * 修改密码
     */
    @Override
    @OperationLog(module = "用户管理", operation = "修改密码", type = OperationType.UPDATE)
    public void changePassword(Long userId, String oldPassword, String newPassword) {
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new DataNotFoundException("用户不存在");
        }
        
        // 验证旧密码
        if (!BCrypt.checkpw(oldPassword, user.getPassword())) {
            throw new BusinessException("旧密码错误");
        }
        
        // 更新新密码
        user.setPassword(BCrypt.hashpw(newPassword, BCrypt.gensalt()));
        userMapper.updateById(user);
        
        // 清除缓存
        clearUserCache(userId);
    }
    
    /**
     * 重置密码
     */
    @Override
    @OperationLog(module = "用户管理", operation = "重置密码", type = OperationType.UPDATE)
    public void resetPassword(Long userId) {
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new DataNotFoundException("用户不存在");
        }
        
        // 重置为默认密码
        String defaultPassword = systemParamService.getParamValue("system.default.password");
        if (StringUtils.isBlank(defaultPassword)) {
            defaultPassword = SystemConstants.DEFAULT_PASSWORD;
        }
        
        user.setPassword(BCrypt.hashpw(defaultPassword, BCrypt.gensalt()));
        userMapper.updateById(user);
        
        // 清除缓存
        clearUserCache(userId);
    }
}
```

### 3.2 用户角色管理

#### UserRole实体

```java
@Data
@TableName("user_role")
public class UserRole {
    private Long id;                    // 关联ID
    private Long userId;                // 用户ID
    private Long roleId;                // 角色ID
    private Boolean isPrimary;         // 是否主角色
}
```

#### 用户角色服务

```java
@Service
public class UserRoleServiceImpl implements UserRoleService {
    
    /**
     * 分配角色
     */
    @Override
    @Transactional
    public void assignRoles(Long userId, List<Long> roleIds) {
        // 删除原有角色关联
        LambdaQueryWrapper<UserRole> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(UserRole::getUserId, userId);
        userRoleMapper.delete(wrapper);
        
        // 创建新的角色关联
        if (CollectionUtils.isNotEmpty(roleIds)) {
            for (int i = 0; i < roleIds.size(); i++) {
                UserRole userRole = new UserRole();
                userRole.setUserId(userId);
                userRole.setRoleId(roleIds.get(i));
                userRole.setIsPrimary(i == 0);
                userRoleMapper.insert(userRole);
            }
        }
        
        // 清除用户缓存
        clearUserCache(userId);
    }
    
    /**
     * 获取用户角色列表
     */
    @Override
    public List<RoleVO> getUserRoles(Long userId) {
        List<Long> roleIds = userRoleMapper.selectRoleIdsByUserId(userId);
        if (CollectionUtils.isEmpty(roleIds)) {
            return Collections.emptyList();
        }
        
        return roleService.getRolesByIds(roleIds);
    }
    
    /**
     * 获取用户主角色
     */
    @Override
    public RoleVO getPrimaryRole(Long userId) {
        UserRole userRole = userRoleMapper.selectOne(
            new LambdaQueryWrapper<UserRole>()
                .eq(UserRole::getUserId, userId)
                .eq(UserRole::getIsPrimary, true)
        );
        
        if (userRole == null) {
            return null;
        }
        
        return roleService.getRoleById(userRole.getRoleId());
    }
}
```

### 3.3 用户部门管理

#### UserDepartment实体

```java
@Data
@TableName("user_department")
public class UserDepartment {
    private Long id;                    // 关联ID
    private Long userId;                // 用户ID
    private Long deptId;               // 部门ID
    private Boolean isPrimary;         // 是否主部门
}
```

#### 用户部门服务

```java
@Service
public class UserDepartmentServiceImpl implements UserDepartmentService {
    
    /**
     * 关联部门
     */
    @Override
    @Transactional
    public void assignDepartment(Long userId, Long deptId) {
        // 删除原有部门关联
        LambdaQueryWrapper<UserDepartment> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(UserDepartment::getUserId, userId);
        userDepartmentMapper.delete(wrapper);
        
        // 创建新的部门关联
        UserDepartment userDept = new UserDepartment();
        userDept.setUserId(userId);
        userDept.setDeptId(deptId);
        userDept.setIsPrimary(true);
        userDepartmentMapper.insert(userDept);
        
        // 更新用户主部门
        User user = new User();
        user.setId(userId);
        user.setDeptId(deptId);
        userMapper.updateById(user);
        
        // 更新部门员工数
        employeeCountService.updateDepartmentEmployeeCount(deptId, 1);
    }
    
    /**
     * 获取用户部门列表
     */
    @Override
    public List<DepartmentVO> getUserDepartments(Long userId) {
        List<Long> deptIds = userDepartmentMapper.selectDeptIdsByUserId(userId);
        if (CollectionUtils.isEmpty(deptIds)) {
            return Collections.emptyList();
        }
        
        return departmentService.getDepartmentsByIds(deptIds);
    }
}
```

### 3.4 用户查询功能

#### 用户查询服务

```java
@Service
public class UserServiceImpl implements UserService {
    
    /**
     * 分页查询用户
     */
    @Override
    public Page<UserVO> listUsers(UserQuery query) {
        Page<User> page = new Page<>(query.getCurrent(), query.getSize());
        
        LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
        wrapper.like(StringUtils.isNotBlank(query.getUsername()), 
                     User::getUsername, query.getUsername())
               .like(StringUtils.isNotBlank(query.getNickname()), 
                     User::getNickname, query.getNickname())
               .like(StringUtils.isNotBlank(query.getRealName()), 
                     User::getRealName, query.getRealName())
               .like(StringUtils.isNotBlank(query.getPhone()), 
                     User::getPhone, query.getPhone())
               .eq(query.getCompanyId() != null, 
                  User::getCompanyId, query.getCompanyId())
               .eq(query.getDeptId() != null, 
                  User::getDeptId, query.getDeptId())
               .eq(query.getStatus() != null, 
                  User::getStatus, query.getStatus())
               .orderByDesc(User::getCreatedTime);
        
        Page<User> userPage = userMapper.selectPage(page, wrapper);
        
        // 转换为VO
        Page<UserVO> voPage = new Page<>(userPage.getCurrent(), userPage.getSize());
        voPage.setTotal(userPage.getTotal());
        voPage.setRecords(userPage.getRecords().stream()
            .map(user -> convertToVO(user))
            .collect(Collectors.toList()));
        
        return voPage;
    }
    
    /**
     * 根据用户名获取用户
     */
    @Override
    public UserVO getUserByUsername(String username) {
        User user = userMapper.selectOne(
            new LambdaQueryWrapper<User>()
                .eq(User::getUsername, username)
        );
        
        return convertToVO(user);
    }
    
    /**
     * 获取用户详情
     */
    @Override
    public UserDetailVO getUserDetail(Long userId) {
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new DataNotFoundException("用户不存在");
        }
        
        UserDetailVO detail = BeanUtil.copyProperties(user, UserDetailVO.class);
        
        // 获取用户角色
        List<RoleVO> roles = userRoleService.getUserRoles(userId);
        detail.setRoles(roles);
        
        // 获取用户部门
        List<DepartmentVO> departments = userDepartmentService.getUserDepartments(userId);
        detail.setDepartments(departments);
        
        // 获取主角色
        RoleVO primaryRole = userRoleService.getPrimaryRole(userId);
        detail.setPrimaryRole(primaryRole);
        
        // 获取部门路径
        if (user.getDeptId() != null) {
            String deptPath = departmentService.getDepartmentPath(user.getDeptId());
            detail.setDeptPath(deptPath);
        }
        
        return detail;
    }
    
    /**
     * 转换为VO
     */
    private UserVO convertToVO(User user) {
        if (user == null) {
            return null;
        }
        
        UserVO vo = BeanUtil.copyProperties(user, UserVO.class);
        vo.setPassword(null);  // 不返回密码
        
        // 查询部门名称
        if (user.getDeptId() != null) {
            Department dept = departmentMapper.selectById(user.getDeptId());
            if (dept != null) {
                vo.setDeptName(dept.getDeptName());
            }
        }
        
        // 查询职位名称
        if (user.getPositionId() != null) {
            Position position = positionMapper.selectById(user.getPositionId());
            if (position != null) {
                vo.setPositionName(position.getPositionName());
            }
        }
        
        return vo;
    }
}
```

## 4. 用户导入导出

### 4.1 用户导入

```java
@Service
public class UserImportService {
    
    /**
     * 导入用户
     */
    @Transactional
    public void importUsers(MultipartFile file) throws IOException {
        // 解析Excel文件
        List<UserImportDTO> userList = EasyExcel.read(file.getInputStream())
            .head(UserImportDTO.class)
            .sheet()
            .doReadSync();
        
        // 校验和保存
        for (UserImportDTO importDTO : userList) {
            try {
                UserDTO userDTO = convertImportDTO(importDTO);
                userService.createUser(userDTO);
            } catch (Exception e) {
                log.error("导入用户失败: {}", importDTO.getUsername(), e);
            }
        }
    }
    
    /**
     * 导入模板下载
     */
    public void downloadImportTemplate(HttpServletResponse response) throws IOException {
        response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        response.setCharacterEncoding("utf-8");
        String fileName = URLEncoder.encode("用户导入模板", "UTF-8").replaceAll("\\+", "%20");
        response.setHeader("Content-disposition", "attachment;filename*=utf-8''" + fileName + ".xlsx");
        
        EasyExcel.write(response.getOutputStream(), UserImportDTO.class)
            .sheet("用户数据")
            .doWrite(Collections.emptyList());
    }
}
```

### 4.2 用户导出

```java
@Service
public class UserExportService {
    
    /**
     * 导出用户
     */
    public void exportUsers(UserQuery query, HttpServletResponse response) throws IOException {
        // 查询用户数据
        List<UserVO> userList = userService.listUsers(query).getRecords();
        
        // 转换为导出DTO
        List<UserExportDTO> exportList = userList.stream()
            .map(this::convertToExportDTO)
            .collect(Collectors.toList());
        
        // 写入响应
        response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        response.setCharacterEncoding("utf-8");
        String fileName = URLEncoder.encode("用户列表", "UTF-8").replaceAll("\\+", "%20");
        response.setHeader("Content-disposition", "attachment;filename*=utf-8''" + fileName + ".xlsx");
        
        EasyExcel.write(response.getOutputStream(), UserExportDTO.class)
            .sheet("用户数据")
            .doWrite(exportList);
    }
}
```

## 5. 接口设计

### 5.1 用户管理接口

```
POST   /api/user                        # 创建用户
GET    /api/user/{id}                   # 获取用户
PUT    /api/user/{id}                   # 更新用户
DELETE /api/user/{id}                   # 删除用户
GET    /api/user/list                   # 分页查询用户
GET    /api/user/username/{username}    # 根据用户名获取用户
GET    /api/user/detail/{id}            # 获取用户详情
POST   /api/user/{id}/change-password  # 修改密码
POST   /api/user/{id}/reset-password    # 重置密码
POST   /api/user/{id}/enable           # 启用用户
POST   /api/user/{id}/disable           # 禁用用户
POST   /api/user/import                 # 导入用户
POST   /api/user/export                 # 导出用户
GET    /api/user/template                # 下载导入模板
```

### 5.2 用户角色接口

```
POST   /api/user/{id}/roles            # 分配角色
GET    /api/user/{id}/roles            # 获取用户角色列表
DELETE /api/user/{id}/roles             # 删除用户所有角色
DELETE /api/user/{id}/roles/{roleId}   # 删除用户指定角色
```

### 5.3 用户部门接口

```
POST   /api/user/{id}/department       # 关联部门
GET    /api/user/{id}/departments      # 获取用户部门列表
DELETE /api/user/{id}/department       # 删除用户部门关联
```

## 6. 部署说明

### 6.1 配置文件

```yaml
server:
  port: 8086

spring:
  application:
    name: qooerp-user
```

### 6.2 环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| SERVER_PORT | 服务端口 | 8086 |
| DB_URL | 数据库URL | - |
| DB_USERNAME | 数据库用户名 | - |
| DB_PASSWORD | 数据库密码 | - |
| REDIS_HOST | Redis主机 | localhost |
| REDIS_PORT | Redis端口 | 6379 |
| NACOS_ADDR | Nacos地址 | localhost:8848 |

## 7. 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2025-01-17 | 初始版本 | Auto |
