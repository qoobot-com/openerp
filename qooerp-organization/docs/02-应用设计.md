# QooERP Organization 模块 - 应用设计文档

## 1. 应用概述

### 1.1 应用定位
QooERP Organization 模块是组织架构管理模块，提供公司、部门、职位等组织信息的管理功能，支持多租户、多层级组织结构、部门树形展示等核心功能。

### 1.2 应用目标
- 提供公司信息管理，支持多公司/多租户场景
- 提供部门管理，支持无限层级部门结构
- 提供职位管理，关联部门定义职位信息
- 提供组织架构树形展示和查询
- 支持部门负责人设置和部门成员管理

## 2. 应用架构

### 2.1 分层架构

```
qooerp-organization/
├── qooerp-organization-api/        # API接口定义
│   ├── dto/                        # 数据传输对象
│   │   ├── OrganizationCompanyDTO.java
│   │   ├── OrganizationDepartmentDTO.java
│   │   └── OrganizationPositionDTO.java
│   ├── vo/                         # 视图对象
│   │   ├── OrganizationCompanyVO.java
│   │   ├── OrganizationDepartmentVO.java
│   │   ├── OrganizationPositionVO.java
│   │   └── OrganizationTreeVO.java
│   └── query/                      # 查询对象
│       └── DepartmentQuery.java
├── qooerp-organization-service/    # 服务实现
│   ├── controller/                 # 控制器层
│   │   ├── OrganizationCompanyController.java
│   │   ├── OrganizationDepartmentController.java
│   │   └── OrganizationPositionController.java
│   ├── service/                    # 服务层
│   │   ├── OrganizationCompanyService.java
│   │   ├── OrganizationDepartmentService.java
│   │   └── OrganizationPositionService.java
│   ├── mapper/                     # 数据访问层
│   │   ├── OrganizationCompanyMapper.java
│   │   ├── OrganizationDepartmentMapper.java
│   │   └── OrganizationPositionMapper.java
│   └── entity/                    # 实体类
│       ├── OrganizationCompany.java
│       ├── OrganizationDepartment.java
│       └── OrganizationPosition.java
```

### 2.2 模块依赖

```
qooerp-organization
    ├── qooerp-common (公共组件)
    ├── qooerp-auth (认证模块)
    └── qooerp-permission (权限模块)
```

## 3. 核心功能设计

### 3.1 公司管理

#### 功能概述
提供公司信息的增删改查功能，支持多公司场景下的公司层级管理。

#### OrganizationCompany实体

```java
@Data
@TableName("organization_company")
public class OrganizationCompany extends BaseEntity {
    private Long id;                    // 公司ID
    private String companyCode;        // 公司编码
    private String companyName;        // 公司名称
    private String companyNameEn;      // 英文名称
    private Long parentId;             // 父公司ID
    private Integer companyLevel;      // 公司级别
    private String legalPerson;        // 法人代表
    private String creditCode;         // 统一社会信用代码
    private String address;            // 地址
    private String phone;              // 联系电话
    private String email;              // 电子邮箱
    private String logo;               // 公司Logo
    private String description;        // 描述
    private Integer sort;              // 排序
    private Integer status;            // 状态: 1-启用 0-禁用
}
```

#### 公司服务

```java
@Service
public class OrganizationCompanyServiceImpl implements OrganizationCompanyService {
    
    /**
     * 创建公司
     */
    @Override
    @Transactional
    @OperationLog(module = "公司管理", operation = "创建公司", type = OperationType.INSERT)
    public Long createCompany(OrganizationCompanyDTO companyDTO) {
        // 校验公司编码唯一性
        checkCompanyCodeUnique(companyDTO.getCompanyCode());
        
        OrganizationCompany company = BeanUtil.copyProperties(companyDTO, OrganizationCompany.class);
        
        // 计算公司级别
        if (company.getParentId() != null && company.getParentId() > 0) {
            OrganizationCompany parent = companyMapper.selectById(company.getParentId());
            company.setCompanyLevel(parent.getCompanyLevel() + 1);
        } else {
            company.setCompanyLevel(1);
        }
        
        companyMapper.insert(company);
        return company.getId();
    }
    
    /**
     * 获取公司树
     */
    @Override
    public List<OrganizationTreeVO> getCompanyTree() {
        List<OrganizationCompany> allCompanies = companyMapper.selectList(null);
        return buildCompanyTree(allCompanies, null);
    }
    
    /**
     * 递归构建公司树
     */
    private List<OrganizationTreeVO> buildCompanyTree(List<OrganizationCompany> companies, Long parentId) {
        return companies.stream()
            .filter(company -> {
                if (parentId == null) {
                    return company.getParentId() == null || company.getParentId() == 0;
                }
                return parentId.equals(company.getParentId());
            })
            .map(company -> {
                OrganizationTreeVO node = BeanUtil.copyProperties(company, OrganizationTreeVO.class);
                List<OrganizationTreeVO> children = buildCompanyTree(companies, company.getId());
                node.setChildren(children);
                node.setHasChildren(!children.isEmpty());
                return node;
            })
            .sorted(Comparator.comparing(OrganizationTreeVO::getSort))
            .collect(Collectors.toList());
    }
}
```

### 3.2 部门管理

#### 功能概述
提供部门信息的增删改查功能，支持无限层级部门树形结构。

#### OrganizationDepartment实体

```java
@Data
@TableName("organization_department")
public class OrganizationDepartment extends BaseEntity {
    private Long id;                    // 部门ID
    private Long companyId;            // 所属公司ID
    private String deptCode;           // 部门编码
    private String deptName;           // 部门名称
    private String deptNameEn;         // 英文名称
    private Long parentId;             // 父部门ID
    private Integer deptLevel;         // 部门级别
    private Long leaderId;             // 部门负责人ID
    private String leaderName;         // 负责人姓名
    private String phone;              // 联系电话
    private String email;              // 电子邮箱
    private String address;            // 地址
    private Integer employeeCount;     // 员工数量
    private String description;        // 描述
    private Integer sort;              // 排序
    private Integer status;            // 状态: 1-启用 0-禁用
}
```

#### 部门服务

```java
@Service
public class OrganizationDepartmentServiceImpl implements OrganizationDepartmentService {
    
    /**
     * 创建部门
     */
    @Override
    @Transactional
    @OperationLog(module = "部门管理", operation = "创建部门", type = OperationType.INSERT)
    public Long createDepartment(OrganizationDepartmentDTO departmentDTO) {
        // 校验部门编码唯一性
        checkDeptCodeUnique(departmentDTO.getCompanyId(), departmentDTO.getDeptCode());
        
        OrganizationDepartment department = BeanUtil.copyProperties(departmentDTO, OrganizationDepartment.class);
        
        // 计算部门级别
        if (department.getParentId() != null && department.getParentId() > 0) {
            OrganizationDepartment parent = departmentMapper.selectById(department.getParentId());
            department.setDeptLevel(parent.getDeptLevel() + 1);
        } else {
            department.setDeptLevel(1);
        }
        
        department.setEmployeeCount(0);
        departmentMapper.insert(department);
        
        // 更新父部门子部门数
        updateParentChildrenCount(department.getParentId());
        
        return department.getId();
    }
    
    /**
     * 获取部门树
     */
    @Override
    public List<OrganizationTreeVO> getDepartmentTree(Long companyId) {
        List<OrganizationDepartment> allDepts = departmentMapper.selectList(
            new LambdaQueryWrapper<OrganizationDepartment>()
                .eq(OrganizationDepartment::getCompanyId, companyId)
        );
        return buildDepartmentTree(allDepts, null);
    }
    
    /**
     * 获取部门路径
     */
    @Override
    public String getDepartmentPath(Long deptId) {
        List<String> path = new ArrayList<>();
        OrganizationDepartment dept = departmentMapper.selectById(deptId);
        
        while (dept != null) {
            path.add(0, dept.getDeptName());
            dept = departmentMapper.selectById(dept.getParentId());
        }
        
        return String.join(" / ", path);
    }
    
    /**
     * 获取部门所有子部门
     */
    @Override
    public List<Long> getAllChildDepartmentIds(Long deptId) {
        List<Long> childIds = new ArrayList<>();
        List<OrganizationDepartment> allDepts = departmentMapper.selectList(null);
        
        findChildDepartments(allDepts, deptId, childIds);
        
        return childIds;
    }
    
    /**
     * 递归查找子部门
     */
    private void findChildDepartments(List<OrganizationDepartment> allDepts, 
                                       Long parentId, List<Long> childIds) {
        for (OrganizationDepartment dept : allDepts) {
            if (parentId.equals(dept.getParentId())) {
                childIds.add(dept.getId());
                findChildDepartments(allDepts, dept.getId(), childIds);
            }
        }
    }
    
    /**
     * 移动部门
     */
    @Override
    @Transactional
    public void moveDepartment(Long deptId, Long newParentId) {
        OrganizationDepartment department = departmentMapper.selectById(deptId);
        
        if (newParentId != null && newParentId > 0) {
            OrganizationDepartment newParent = departmentMapper.selectById(newParentId);
            
            // 校验不能移动到自己的子部门下
            List<Long> childIds = getAllChildDepartmentIds(deptId);
            if (childIds.contains(newParentId)) {
                throw new BusinessException("不能将部门移动到其子部门下");
            }
            
            // 更新级别
            department.setParentId(newParentId);
            department.setDeptLevel(newParent.getDeptLevel() + 1);
        } else {
            department.setParentId(null);
            department.setDeptLevel(1);
        }
        
        departmentMapper.updateById(department);
        
        // 更新子部门级别
        updateChildrenDeptLevel(deptId, department.getDeptLevel());
    }
    
    /**
     * 递归更新子部门级别
     */
    private void updateChildrenDeptLevel(Long deptId, Integer parentLevel) {
        List<OrganizationDepartment> children = departmentMapper.selectList(
            new LambdaQueryWrapper<OrganizationDepartment>()
                .eq(OrganizationDepartment::getParentId, deptId)
        );
        
        for (OrganizationDepartment child : children) {
            child.setDeptLevel(parentLevel + 1);
            departmentMapper.updateById(child);
            updateChildrenDeptLevel(child.getId(), child.getDeptLevel());
        }
    }
}
```

### 3.3 职位管理

#### 功能概述
提供职位信息的增删改查功能，职位关联部门和公司。

#### OrganizationPosition实体

```java
@Data
@TableName("organization_position")
public class OrganizationPosition extends BaseEntity {
    private Long id;                    // 职位ID
    private Long companyId;            // 所属公司ID
    private Long deptId;               // 所属部门ID
    private String positionCode;       // 职位编码
    private String positionName;       // 职位名称
    private String positionNameEn;     // 英文名称
    private Integer positionLevel;     // 职位级别
    private String description;        // 职位描述
    private String responsibilities;   // 职责描述
    private String requirements;       // 岗位要求
    private Integer sort;              // 排序
    private Integer status;            // 状态: 1-启用 0-禁用
}
```

#### 职位服务

```java
@Service
public class OrganizationPositionServiceImpl implements OrganizationPositionService {
    
    /**
     * 创建职位
     */
    @Override
    @Transactional
    @OperationLog(module = "职位管理", operation = "创建职位", type = OperationType.INSERT)
    public Long createPosition(OrganizationPositionDTO positionDTO) {
        // 校验职位编码唯一性
        checkPositionCodeUnique(positionDTO.getCompanyId(), positionDTO.getDeptId(), 
                                positionDTO.getPositionCode());
        
        OrganizationPosition position = BeanUtil.copyProperties(positionDTO, OrganizationPosition.class);
        positionMapper.insert(position);
        
        return position.getId();
    }
    
    /**
     * 获取部门职位列表
     */
    @Override
    public List<OrganizationPositionVO> getDepartmentPositions(Long deptId) {
        return positionMapper.selectList(
            new LambdaQueryWrapper<OrganizationPosition>()
                .eq(OrganizationPosition::getDeptId, deptId)
                .orderByAsc(OrganizationPosition::getSort)
        ).stream()
            .map(pos -> BeanUtil.copyProperties(pos, OrganizationPositionVO.class))
            .collect(Collectors.toList());
    }
    
    /**
     * 获取公司职位列表
     */
    @Override
    public List<OrganizationPositionVO> getCompanyPositions(Long companyId) {
        return positionMapper.selectList(
            new LambdaQueryWrapper<OrganizationPosition>()
                .eq(OrganizationPosition::getCompanyId, companyId)
                .orderByAsc(OrganizationPosition::getSort)
        ).stream()
            .map(pos -> BeanUtil.copyProperties(pos, OrganizationPositionVO.class))
            .collect(Collectors.toList());
    }
}
```

## 4. 组织架构树

### 4.1 树形结构VO

```java
@Data
public class OrganizationTreeVO {
    private Long id;                       // 节点ID
    private String name;                    // 节点名称
    private String nameEn;                  // 英文名称
    private Long parentId;                  // 父节点ID
    private Integer level;                  // 层级
    private String type;                    // 类型: company/department
    private Long companyId;                 // 所属公司ID
    private Long deptId;                    // 所属部门ID
    private String phone;                   // 联系电话
    private String email;                   // 电子邮箱
    private String description;             // 描述
    private Integer sort;                    // 排序
    private Integer status;                  // 状态
    
    // 树形结构字段
    private List<OrganizationTreeVO> children;  // 子节点列表
    private Boolean hasChildren;               // 是否有子节点
    
    // 扩展信息
    private Integer employeeCount;            // 员工数量
    private String leaderName;               // 负责人姓名
}
```

### 4.2 组织架构服务

```java
@Service
public class OrganizationTreeService {
    
    @Autowired
    private OrganizationCompanyMapper companyMapper;
    
    @Autowired
    private OrganizationDepartmentMapper departmentMapper;
    
    @Autowired
    private OrganizationPositionMapper positionMapper;
    
    /**
     * 获取完整组织架构树
     */
    public List<OrganizationTreeVO> getFullOrganizationTree(Long companyId) {
        OrganizationTreeVO tree = new OrganizationTreeVO();
        
        // 获取公司
        OrganizationCompany company = companyMapper.selectById(companyId);
        tree.setId(company.getId());
        tree.setName(company.getCompanyName());
        tree.setNameEn(company.getCompanyNameEn());
        tree.setType("company");
        tree.setLevel(1);
        
        // 获取公司下的部门
        List<OrganizationTreeVO> deptNodes = buildDepartmentTree(companyId);
        tree.setChildren(deptNodes);
        tree.setHasChildren(!deptNodes.isEmpty());
        
        return Collections.singletonList(tree);
    }
    
    /**
     * 构建部门树
     */
    private List<OrganizationTreeVO> buildDepartmentTree(Long companyId) {
        List<OrganizationDepartment> allDepts = departmentMapper.selectList(
            new LambdaQueryWrapper<OrganizationDepartment>()
                .eq(OrganizationDepartment::getCompanyId, companyId)
        );
        
        return buildTree(allDepts, null);
    }
    
    /**
     * 递归构建树
     */
    private List<OrganizationTreeVO> buildTree(List<OrganizationDepartment> depts, Long parentId) {
        return depts.stream()
            .filter(dept -> {
                if (parentId == null) {
                    return dept.getParentId() == null || dept.getParentId() == 0;
                }
                return parentId.equals(dept.getParentId());
            })
            .map(dept -> {
                OrganizationTreeVO node = convertToTreeVO(dept);
                
                // 添加子节点
                List<OrganizationTreeVO> children = buildTree(depts, dept.getId());
                node.setChildren(children);
                node.setHasChildren(!children.isEmpty());
                
                return node;
            })
            .sorted(Comparator.comparing(OrganizationTreeVO::getSort))
            .collect(Collectors.toList());
    }
    
    /**
     * 转换为树形VO
     */
    private OrganizationTreeVO convertToTreeVO(OrganizationDepartment dept) {
        OrganizationTreeVO vo = new OrganizationTreeVO();
        vo.setId(dept.getId());
        vo.setName(dept.getDeptName());
        vo.setNameEn(dept.getDeptNameEn());
        vo.setParentId(dept.getParentId());
        vo.setLevel(dept.getDeptLevel());
        vo.setType("department");
        vo.setCompanyId(dept.getCompanyId());
        vo.setDeptId(dept.getId());
        vo.setPhone(dept.getPhone());
        vo.setEmail(dept.getEmail());
        vo.setDescription(dept.getDescription());
        vo.setSort(dept.getSort());
        vo.setStatus(dept.getStatus());
        vo.setEmployeeCount(dept.getEmployeeCount());
        vo.setLeaderName(dept.getLeaderName());
        return vo;
    }
}
```

## 5. 接口设计

### 5.1 公司管理接口

```
POST   /api/organization/company                    # 创建公司
GET    /api/organization/company/{id}               # 获取公司
PUT    /api/organization/company/{id}               # 更新公司
DELETE /api/organization/company/{id}               # 删除公司
GET    /api/organization/company/list               # 分页查询公司
GET    /api/organization/company/tree               # 获取公司树
GET    /api/organization/company/{id}/children      # 获取子公司
```

### 5.2 部门管理接口

```
POST   /api/organization/department                # 创建部门
GET    /api/organization/department/{id}           # 获取部门
PUT    /api/organization/department/{id}           # 更新部门
DELETE /api/organization/department/{id}           # 删除部门
GET    /api/organization/department/list           # 分页查询部门
GET    /api/organization/department/tree           # 获取部门树
GET    /api/organization/department/{id}/children  # 获取子部门
GET    /api/organization/department/{id}/path      # 获取部门路径
POST   /api/organization/department/move            # 移动部门
```

### 5.3 职位管理接口

```
POST   /api/organization/position                   # 创建职位
GET    /api/organization/position/{id}              # 获取职位
PUT    /api/organization/position/{id}              # 更新职位
DELETE /api/organization/position/{id}              # 删除职位
GET    /api/organization/position/list             # 分页查询职位
GET    /api/organization/position/department/{deptId}     # 获取部门职位
GET    /api/organization/position/company/{companyId}      # 获取公司职位
```

### 5.4 组织架构接口

```
GET    /api/organization/tree/{companyId}          # 获取完整组织架构树
GET    /api/organization/tree/department/{deptId}  # 获取部门组织树
```

## 6. 部署说明

### 6.1 配置文件

```yaml
server:
  port: 8085

spring:
  application:
    name: qooerp-organization
```

### 6.2 环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| SERVER_PORT | 服务端口 | 8085 |
| DB_URL | 数据库URL | - |
| DB_USERNAME | 数据库用户名 | - |
| DB_PASSWORD | 数据库密码 | - |
| REDIS_HOST | Redis主机 | localhost |
| REDIS_PORT | Redis端口 | 6379 |
| NACOS_ADDR | Nacos地址 | localhost:8848 |

## 7. 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2025-01-17 | 初始版本 | Auto |
