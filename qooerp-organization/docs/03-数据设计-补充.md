# qooerp-organization 组织管理 - 数据设计补充文档

> 模块版本：1.0.0-SNAPSHOT
> 创建日期：2026-02-18
> 文档作者：QooERP团队

---

## 一、新增表设计

### 1.1 organization_company 公司表

#### 1.1.1 表结构

| 序号 | 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 主键 | 说明 |
|------|--------|------|------|----------|--------|------|------|
| 1 | id | BIGINT | 20 | NO | | YES | 公司ID |
| 2 | tenant_id | BIGINT | 20 | YES | 0 | NO | 租户ID |
| 3 | parent_id | BIGINT | 20 | YES | 0 | NO | 父公司ID |
| 4 | company_code | VARCHAR | 50 | NO | | NO | 公司编码（唯一） |
| 5 | company_name | VARCHAR | 200 | NO | | NO | 公司名称 |
| 6 | company_name_en | VARCHAR | 200 | YES | | NO | 英文名称 |
| 7 | company_level | INT | 11 | YES | 1 | NO | 公司级别 |
| 8 | legal_person | VARCHAR | 100 | YES | | NO | 法人代表 |
| 9 | credit_code | VARCHAR | 50 | YES | | NO | 统一社会信用代码 |
| 10 | address | VARCHAR | 500 | YES | | NO | 地址 |
| 11 | phone | VARCHAR | 50 | YES | | NO | 联系电话 |
| 12 | email | VARCHAR | 200 | YES | | NO | 电子邮箱 |
| 13 | logo | VARCHAR | 500 | YES | | NO | 公司Logo |
| 14 | description | VARCHAR | 1000 | YES | | NO | 描述 |
| 15 | sort | INT | 11 | YES | 0 | NO | 排序号 |
| 16 | status | TINYINT | 1 | NO | 1 | NO | 状态：0-禁用 1-启用 |
| 17 | remark | VARCHAR | 500 | YES | | NO | 备注 |
| 18 | create_time | TIMESTAMP | | NO | CURRENT_TIMESTAMP | NO | 创建时间 |
| 19 | create_by | VARCHAR | 50 | YES | | NO | 创建人 |
| 20 | update_time | TIMESTAMP | | NO | CURRENT_TIMESTAMP | NO | 更新时间 |
| 21 | update_by | VARCHAR | 50 | YES | | NO | 更新人 |

#### 1.1.2 建表SQL

```sql
CREATE TABLE organization_company (
    id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL DEFAULT 0,
    parent_id BIGINT DEFAULT 0,
    company_code VARCHAR(50) NOT NULL,
    company_name VARCHAR(200) NOT NULL,
    company_name_en VARCHAR(200),
    company_level INTEGER DEFAULT 1,
    legal_person VARCHAR(100),
    credit_code VARCHAR(50),
    address VARCHAR(500),
    phone VARCHAR(50),
    email VARCHAR(200),
    logo VARCHAR(500),
    description VARCHAR(1000),
    sort INTEGER DEFAULT 0,
    status SMALLINT NOT NULL DEFAULT 1,
    remark VARCHAR(500),
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    create_by VARCHAR(50),
    update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_by VARCHAR(50)
);

CREATE UNIQUE INDEX uk_organization_company_code ON organization_company(company_code);
CREATE INDEX idx_organization_company_parent_id ON organization_company(parent_id);
COMMENT ON TABLE organization_company IS '公司表';
```

---

### 1.2 organization_user_dept 用户部门关联表

#### 1.2.1 表结构

| 序号 | 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 主键 | 说明 |
|------|--------|------|------|----------|--------|------|------|
| 1 | id | BIGINT | 20 | NO | | YES | 关联ID |
| 2 | tenant_id | BIGINT | 20 | YES | 0 | NO | 租户ID |
| 3 | user_id | BIGINT | 20 | NO | | NO | 用户ID |
| 4 | dept_id | BIGINT | 20 | NO | | NO | 部门ID |
| 5 | is_primary | TINYINT | 1 | NO | 1 | NO | 是否主部门：0-否 1-是 |
| 6 | join_time | TIMESTAMP | | YES | | NO | 加入时间 |
| 7 | leave_time | TIMESTAMP | | YES | | NO | 离开时间 |
| 8 | status | TINYINT | 1 | NO | 1 | NO | 状态：0-已离职 1-在职 |
| 9 | remark | VARCHAR | 500 | YES | | NO | 备注 |
| 10 | create_time | TIMESTAMP | | NO | CURRENT_TIMESTAMP | NO | 创建时间 |
| 11 | create_by | VARCHAR | 50 | YES | | NO | 创建人 |

#### 1.2.2 建表SQL

```sql
CREATE TABLE organization_user_dept (
    id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL DEFAULT 0,
    user_id BIGINT NOT NULL,
    dept_id BIGINT NOT NULL,
    is_primary SMALLINT NOT NULL DEFAULT 1,
    join_time TIMESTAMP,
    leave_time TIMESTAMP,
    status SMALLINT NOT NULL DEFAULT 1,
    remark VARCHAR(500),
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    create_by VARCHAR(50)
);

CREATE INDEX idx_organization_user_dept_user_id ON organization_user_dept(user_id);
CREATE INDEX idx_organization_user_dept_dept_id ON organization_user_dept(dept_id);
CREATE UNIQUE INDEX uk_organization_user_dept_user_dept ON organization_user_dept(user_id, dept_id);
COMMENT ON TABLE organization_user_dept IS '用户部门关联表';
```

---

### 1.3 organization_user_position 用户岗位关联表

#### 1.3.1 表结构

| 序号 | 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 主键 | 说明 |
|------|--------|------|------|----------|--------|------|------|
| 1 | id | BIGINT | 20 | NO | | YES | 关联ID |
| 2 | tenant_id | BIGINT | 20 | YES | 0 | NO | 租户ID |
| 3 | user_id | BIGINT | 20 | NO | | NO | 用户ID |
| 4 | position_id | BIGINT | 20 | NO | | NO | 岗位ID |
| 5 | is_primary | TINYINT | 1 | NO | 1 | NO | 是否主岗位：0-否 1-是 |
| 6 | appoint_time | TIMESTAMP | | YES | | NO | 任命时间 |
| 7 | dismiss_time | TIMESTAMP | | YES | | NO | 免职时间 |
| 8 | status | TINYINT | 1 | NO | 1 | NO | 状态：0-已免职 1-在职 |
| 9 | remark | VARCHAR | 500 | YES | | NO | 备注 |
| 10 | create_time | TIMESTAMP | | NO | CURRENT_TIMESTAMP | NO | 创建时间 |
| 11 | create_by | VARCHAR | 50 | YES | | NO | 创建人 |

#### 1.3.2 建表SQL

```sql
CREATE TABLE organization_user_position (
    id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL DEFAULT 0,
    user_id BIGINT NOT NULL,
    position_id BIGINT NOT NULL,
    is_primary SMALLINT NOT NULL DEFAULT 1,
    appoint_time TIMESTAMP,
    dismiss_time TIMESTAMP,
    status SMALLINT NOT NULL DEFAULT 1,
    remark VARCHAR(500),
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    create_by VARCHAR(50)
);

CREATE INDEX idx_organization_user_position_user_id ON organization_user_position(user_id);
CREATE INDEX idx_organization_user_position_position_id ON organization_user_position(position_id);
CREATE UNIQUE INDEX uk_organization_user_position_user_pos ON organization_user_position(user_id, position_id);
COMMENT ON TABLE organization_user_position IS '用户岗位关联表';
```

---

## 二、更新 organization_dept 部门表

### 2.1 新增字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| company_id | BIGINT | 所属公司ID |
| dept_level | INT | 部门级别 |
| dept_name_en | VARCHAR(200) | 英文名称 |
| employee_count | INT | 员工数量（冗余字段） |
| path | VARCHAR(1000) | 部门路径（如：1/2/3） |

### 2.2 更新SQL

```sql
-- 添加新字段
ALTER TABLE organization_dept ADD COLUMN company_id BIGINT;
ALTER TABLE organization_dept ADD COLUMN dept_level INTEGER DEFAULT 1;
ALTER TABLE organization_dept ADD COLUMN dept_name_en VARCHAR(200);
ALTER TABLE organization_dept ADD COLUMN employee_count INTEGER DEFAULT 0;
ALTER TABLE organization_dept ADD COLUMN path VARCHAR(1000);

-- 添加索引
CREATE INDEX idx_organization_dept_company_id ON organization_dept(company_id);
CREATE INDEX idx_organization_dept_path ON organization_dept(path);

-- 添加注释
COMMENT ON COLUMN organization_dept.company_id IS '所属公司ID';
COMMENT ON COLUMN organization_dept.dept_level IS '部门级别';
COMMENT ON COLUMN organization_dept.dept_name_en IS '英文名称';
COMMENT ON COLUMN organization_dept.employee_count IS '员工数量';
COMMENT ON COLUMN organization_dept.path IS '部门路径（如：1/2/3）';
```

---

## 三、更新 organization_position 岗位表

### 3.1 新增字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| company_id | BIGINT | 所属公司ID |
| position_name_en | VARCHAR(200) | 英文名称 |
| responsibilities | VARCHAR(1000) | 职责描述 |
| requirements | VARCHAR(1000) | 岗位要求 |

### 3.2 更新SQL

```sql
-- 添加新字段
ALTER TABLE organization_position ADD COLUMN company_id BIGINT;
ALTER TABLE organization_position ADD COLUMN position_name_en VARCHAR(200);
ALTER TABLE organization_position ADD COLUMN responsibilities VARCHAR(1000);
ALTER TABLE organization_position ADD COLUMN requirements VARCHAR(1000);

-- 添加索引
CREATE INDEX idx_organization_position_company_id ON organization_position(company_id);

-- 添加注释
COMMENT ON COLUMN organization_position.company_id IS '所属公司ID';
COMMENT ON COLUMN organization_position.position_name_en IS '英文名称';
COMMENT ON COLUMN organization_position.responsibilities IS '职责描述';
COMMENT ON COLUMN organization_position.requirements IS '岗位要求';
```

---

## 四、数据关系图

```mermaid
erDiagram
    organization_company |--o{ organization_company : "包含（自关联）"
    organization_company |--o{ organization_dept : "拥有"
    organization_dept |--o{ organization_dept : "包含（自关联）"
    organization_dept |--o{ organization_position : "包含"
    organization_dept |--o{ organization_user_dept : "关联"
    organization_position |--o{ organization_user_position : "关联"

    organization_company {
        BIGINT id PK
        VARCHAR company_code
        VARCHAR company_name
        BIGINT parent_id
    }

    organization_dept {
        BIGINT id PK
        VARCHAR dept_code
        VARCHAR dept_name
        BIGINT parent_id
        BIGINT company_id FK
    }

    organization_position {
        BIGINT id PK
        VARCHAR position_code
        VARCHAR position_name
        BIGINT dept_id FK
        BIGINT company_id FK
    }

    organization_user_dept {
        BIGINT id PK
        BIGINT user_id FK
        BIGINT dept_id FK
        SMALLINT is_primary
    }

    organization_user_position {
        BIGINT id PK
        BIGINT user_id FK
        BIGINT position_id FK
        SMALLINT is_primary
    }
```

---

## 五、初始化数据

```sql
-- 插入默认公司
INSERT INTO organization_company (company_code, company_name, company_name_en, company_level, sort, create_by) VALUES
('QOOERP', 'QooERP科技有限公司', 'QooERP Technology Co., Ltd.', 1, 1, 'system');

-- 更新部门添加公司ID
UPDATE organization_dept SET company_id = 1, dept_level = CASE
    WHEN parent_id = 0 THEN 1
    ELSE 2
END;
```

---

## 六、新增功能说明

### 6.1 公司管理
- 支持多公司/多租户场景
- 支持公司层级关系
- 公司树形结构展示

### 6.2 用户部门岗位关联
- 支持用户与部门的多对多关联
- 支持设置主部门和主岗位
- 记录用户加入/离开部门的时间
- 记录用户任命/免职岗位的时间

### 6.3 部门路径优化
- 使用path字段快速查询部门层级关系
- 支持高效的子部门查询（LIKE path + '%')
- 便于权限控制和数据范围过滤

---

**文档版本**: v1.1
**最后更新**: 2026-02-18
