# QooERP 生产管理模块 - 应用设计文档

> 模块名称: qooerp-production  
> 模块版本: v1.0  
> 创建日期: 20xx-xx-xx  
> 作者: Auto  

---

## 一、应用架构

### 1.1 分层架构

```
┌─────────────────────────────────────────────────┐
│               Presentation Layer                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │Controller│  │  Filter  │  │ Interceptor│     │
│  └──────────┘  └──────────┘  └──────────┘      │
├─────────────────────────────────────────────────┤
│               Business Layer                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ Service  │  │  Domain  │  │  Event   │      │
│  └──────────┘  └──────────┘  └──────────┘      │
├─────────────────────────────────────────────────┤
│               Data Access Layer                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │  Mapper  │  │  Entity  │  │  DTO     │      │
│  └──────────┘  └──────────┘  └──────────┘      │
├─────────────────────────────────────────────────┤
│               Infrastructure Layer               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ Database │  │   Cache  │  │   MQ     │      │
│  └──────────┘  └──────────┘  └──────────┘      │
└─────────────────────────────────────────────────┘
```

### 1.2 核心模块

| 模块名称 | 说明 | 路径 |
|---------|------|------|
| production-plan | 生产计划管理 | com.qoobot.qooerp.production.plan |
| production-order | 生产订单管理 | com.qoobot.qooerp.production.order |
| production-material | 生产领料管理 | com.qoobot.qooerp.production.material |
| production-receipt | 生产入库管理 | com.qoobot.qooerp.production.receipt |
| production-report | 生产报工管理 | com.qoobot.qooerp.production.report |
| production-quality | 生产质量管理 | com.qoobot.qooerp.production.quality |

---

## 二、核心类设计

### 2.1 生产计划模块

#### 2.1.1 Controller层

```java
@RestController
@RequestMapping("/api/production/plans")
public class ProductionPlanController {
    
    @PostMapping
    public Result<ProductionPlanDTO> createPlan(@RequestBody ProductionPlanDTO dto);
    
    @PutMapping("/{id}")
    public Result<ProductionPlanDTO> updatePlan(@PathVariable Long id, 
        @RequestBody ProductionPlanDTO dto);
    
    @GetMapping("/{id}")
    public Result<ProductionPlanDTO> getPlan(@PathVariable Long id);
    
    @GetMapping
    public Result<Page<ProductionPlanDTO>> listPlans(
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size);
    
    @PostMapping("/{id}/approve")
    public Result<Void> approvePlan(@PathVariable Long id);
    
    @PostMapping("/{id}/issue")
    public Result<Void> issuePlan(@PathVariable Long id);
    
    @PostMapping("/{id}/cancel")
    public Result<Void> cancelPlan(@PathVariable Long id);
}
```

#### 2.1.2 Service层

```java
public interface ProductionPlanService {
    
    /**
     * 创建生产计划
     */
    ProductionPlanDTO createPlan(ProductionPlanDTO dto);
    
    /**
     * 更新生产计划
     */
    ProductionPlanDTO updatePlan(Long id, ProductionPlanDTO dto);
    
    /**
     * 获取生产计划
     */
    ProductionPlanDTO getPlan(Long id);
    
    /**
     * 分页查询生产计划
     */
    Page<ProductionPlanDTO> listPlans(PageParam pageParam, 
        ProductionPlanQueryParam queryParam);
    
    /**
     * 审核生产计划
     */
    void approvePlan(Long id);
    
    /**
     * 下达生产计划
     */
    void issuePlan(Long id);
    
    /**
     * 取消生产计划
     */
    void cancelPlan(Long id);
    
    /**
     * 计算物料需求(MRP)
     */
    List<MaterialRequirementDTO> calculateMRP(Long planId);
}
```

#### 2.1.3 Domain层

```java
/**
 * 生产计划领域对象
 */
public class ProductionPlan {
    
    private Long id;
    private String planNo;
    private String planName;
    private Date planDate;
    private BigDecimal planQuantity;
    private PlanStatus status;
    private Long productId;
    private String productCode;
    private String productName;
    private Date deliveryDate;
    private String remark;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    private String createBy;
    private String updateBy;
    
    /**
     * 审核计划
     */
    public void approve(String approver) {
        if (this.status != PlanStatus.DRAFT) {
            throw new BusinessException("只有草稿状态的计划才能审核");
        }
        this.status = PlanStatus.APPROVED;
        this.updateBy = approver;
    }
    
    /**
     * 下达计划
     */
    public void issue(String issuer) {
        if (this.status != PlanStatus.APPROVED) {
            throw new BusinessException("只有已审核的计划才能下达");
        }
        this.status = PlanStatus.ISSUED;
        this.updateBy = issuer;
    }
    
    /**
     * 取消计划
     */
    public void cancel(String canceller) {
        if (this.status == PlanStatus.COMPLETED) {
            throw new BusinessException("已完成的计划不能取消");
        }
        this.status = PlanStatus.CANCELLED;
        this.updateBy = canceller;
    }
}
```

### 2.2 生产订单模块

#### 2.2.1 Controller层

```java
@RestController
@RequestMapping("/api/production/orders")
public class ProductionOrderController {
    
    @PostMapping
    public Result<ProductionOrderDTO> createOrder(@RequestBody ProductionOrderDTO dto);
    
    @PutMapping("/{id}")
    public Result<ProductionOrderDTO> updateOrder(@PathVariable Long id, 
        @RequestBody ProductionOrderDTO dto);
    
    @GetMapping("/{id}")
    public Result<ProductionOrderDTO> getOrder(@PathVariable Long id);
    
    @GetMapping
    public Result<Page<ProductionOrderDTO>> listOrders(
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size);
    
    @PostMapping("/{id}/approve")
    public Result<Void> approveOrder(@PathVariable Long id);
    
    @PostMapping("/{id}/issue")
    public Result<Void> issueOrder(@PathVariable Long id);
    
    @PostMapping("/{id}/complete")
    public Result<Void> completeOrder(@PathVariable Long id);
    
    @PostMapping("/{id}/close")
    public Result<Void> closeOrder(@PathVariable Long id);
    
    @GetMapping("/{id}/progress")
    public Result<OrderProgressDTO> getProgress(@PathVariable Long id);
}
```

#### 2.2.2 Service层

```java
public interface ProductionOrderService {
    
    /**
     * 创建生产订单
     */
    ProductionOrderDTO createOrder(ProductionOrderDTO dto);
    
    /**
     * 根据生产计划生成订单
     */
    List<ProductionOrderDTO> generateOrdersFromPlan(Long planId);
    
    /**
     * 更新生产订单
     */
    ProductionOrderDTO updateOrder(Long id, ProductionOrderDTO dto);
    
    /**
     * 获取生产订单
     */
    ProductionOrderDTO getOrder(Long id);
    
    /**
     * 分页查询生产订单
     */
    Page<ProductionOrderDTO> listOrders(PageParam pageParam, 
        ProductionOrderQueryParam queryParam);
    
    /**
     * 审核生产订单
     */
    void approveOrder(Long id);
    
    /**
     * 下达生产订单
     */
    void issueOrder(Long id);
    
    /**
     * 完成生产订单
     */
    void completeOrder(Long id);
    
    /**
     * 关闭生产订单
     */
    void closeOrder(Long id);
    
    /**
     * 获取订单进度
     */
    OrderProgressDTO getProgress(Long id);
}
```

### 2.3 生产领料模块

#### 2.3.1 Service层

```java
public interface ProductionMaterialService {
    
    /**
     * 创建领料单
     */
    ProductionMaterialDTO createMaterial(ProductionMaterialDTO dto);
    
    /**
     * 审核领料单
     */
    void approveMaterial(Long id);
    
    /**
     * 领料出库
     */
    void issueMaterial(Long id);
    
    /**
     * 领料退回
     */
    void returnMaterial(Long id, BigDecimal quantity);
    
    /**
     * 获取订单物料清单
     */
    List<ProductionMaterialDTO> getOrderMaterials(Long orderId);
}
```

### 2.4 生产入库模块

#### 2.4.1 Service层

```java
public interface ProductionReceiptService {
    
    /**
     * 创建入库单
     */
    ProductionReceiptDTO createReceipt(ProductionReceiptDTO dto);
    
    /**
     * 质检
     */
    void qualityCheck(Long id, QualityCheckResultDTO result);
    
    /**
     * 入库审核
     */
    void approveReceipt(Long id);
    
    /**
     * 入库
     */
    void doReceipt(Long id);
    
    /**
     * 获取订单入库记录
     */
    List<ProductionReceiptDTO> getOrderReceipts(Long orderId);
}
```

### 2.5 生产报工模块

#### 2.5.1 Service层

```java
public interface ProductionReportService {
    
    /**
     * 创建报工单
     */
    ProductionReportDTO createReport(ProductionReportDTO dto);
    
    /**
     * 获取订单报工记录
     */
    List<ProductionReportDTO> getOrderReports(Long orderId);
    
    /**
     * 统计工时
     */
    BigDecimal sumWorkHours(Long orderId);
    
    /**
     * 统计产量
     */
    BigDecimal sumQuantity(Long orderId);
}
```

---

## 三、事件设计

### 3.1 领域事件

| 事件名称 | 说明 | 触发时机 |
|---------|------|---------|
| ProductionPlanCreatedEvent | 生产计划创建 | 创建生产计划后 |
| ProductionPlanApprovedEvent | 生产计划审核 | 审核通过后 |
| ProductionPlanIssuedEvent | 生产计划下达 | 下达后 |
| ProductionOrderCreatedEvent | 生产订单创建 | 创建订单后 |
| ProductionOrderCompletedEvent | 生产订单完成 | 订单完成后 |
| ProductionMaterialIssuedEvent | 生产领料出库 | 领料出库后 |
| ProductionReceiptCompletedEvent | 生产入库完成 | 入库完成后 |

### 3.2 事件处理

```java
@Component
public class ProductionEventHandler {
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private PurchaseService purchaseService;
    
    /**
     * 处理生产计划下达事件
     */
    @EventListener
    public void handlePlanIssued(ProductionPlanIssuedEvent event) {
        // 生成生产订单
        generateProductionOrders(event.getPlanId());
        
        // 触发物料需求检查
        checkMaterialRequirement(event.getPlanId());
    }
    
    /**
     * 处理生产领料出库事件
     */
    @EventListener
    public void handleMaterialIssued(ProductionMaterialIssuedEvent event) {
        // 扣减库存
        inventoryService.deductStock(
            event.getMaterialId(), 
            event.getQuantity()
        );
    }
    
    /**
     * 处理生产入库完成事件
     */
    @EventListener
    public void handleReceiptCompleted(ProductionReceiptCompletedEvent event) {
        // 增加库存
        inventoryService.addStock(
            event.getProductId(), 
            event.getQuantity()
        );
    }
}
```

---

## 四、缓存设计

### 4.1 缓存策略

| 缓存Key | 说明 | 过期时间 |
|---------|------|---------|
| production:plan:{id} | 生产计划 | 1h |
| production:order:{id} | 生产订单 | 1h |
| production:material:{id} | 生产物料 | 30m |
| production:receipt:{id} | 生产入库 | 30m |

### 4.2 缓存实现

```java
@Service
public class ProductionPlanServiceImpl implements ProductionPlanService {
    
    @Cacheable(value = "production:plan", key = "#id")
    public ProductionPlanDTO getPlan(Long id) {
        // 查询逻辑
    }
    
    @CacheEvict(value = "production:plan", key = "#dto.id")
    public ProductionPlanDTO updatePlan(Long id, ProductionPlanDTO dto) {
        // 更新逻辑
    }
}
```

---

## 五、异常设计

### 5.1 异常类型

| 异常类型 | 说明 | HTTP状态码 |
|---------|------|-----------|
| ProductionPlanNotFoundException | 生产计划不存在 | 404 |
| ProductionOrderNotFoundException | 生产订单不存在 | 404 |
| ProductionOrderAlreadyCompletedException | 订单已完成 | 400 |
| InsufficientStockException | 库存不足 | 400 |
| ProductionQualityCheckFailedException | 质检不通过 | 400 |

### 5.2 异常处理

```java
@RestControllerAdvice
public class ProductionExceptionHandler {
    
    @ExceptionHandler(ProductionPlanNotFoundException.class)
    public Result<Void> handlePlanNotFound(ProductionPlanNotFoundException e) {
        return Result.error(404, e.getMessage());
    }
    
    @ExceptionHandler(InsufficientStockException.class)
    public Result<Void> handleInsufficientStock(InsufficientStockException e) {
        return Result.error(400, e.getMessage());
    }
}
```

---

## 六、接口设计

### 6.1 对外服务接口

```java
@FeignClient(name = "qooerp-production", path = "/api/production")
public interface ProductionServiceClient {
    
    /**
     * 获取生产计划
     */
    @GetMapping("/plans/{id}")
    Result<ProductionPlanDTO> getPlan(@PathVariable("id") Long id);
    
    /**
     * 获取生产订单
     */
    @GetMapping("/orders/{id}")
    Result<ProductionOrderDTO> getOrder(@PathVariable("id") Long id);
    
    /**
     * 创建生产计划
     */
    @PostMapping("/plans")
    Result<ProductionPlanDTO> createPlan(@RequestBody ProductionPlanDTO dto);
}
```

### 6.2 内部服务调用

```java
@FeignClient(name = "qooerp-inventory", path = "/api/inventory")
public interface InventoryServiceClient {
    
    /**
     * 获取库存
     */
    @GetMapping("/stocks")
    Result<InventoryDTO> getStock(@RequestParam("materialId") Long materialId);
    
    /**
     * 扣减库存
     */
    @PostMapping("/stocks/deduct")
    Result<Void> deductStock(@RequestBody StockDeductDTO dto);
    
    /**
     * 增加库存
     */
    @PostMapping("/stocks/add")
    Result<Void> addStock(@RequestBody StockAddDTO dto);
}
```

---

## 七、事务设计

### 7.1 事务边界

```java
@Service
@Transactional
public class ProductionOrderServiceImpl implements ProductionOrderService {
    
    /**
     * 下达生产订单(包含多个操作,需要事务)
     */
    @Transactional(rollbackFor = Exception.class)
    public void issueOrder(Long id) {
        // 1. 更新订单状态
        updateOrderStatus(id, OrderStatus.ISSUED);
        
        // 2. 生成领料单
        generateMaterialRequisition(id);
        
        // 3. 发送事件
        publishOrderIssuedEvent(id);
    }
}
```

### 7.2 分布式事务

对于跨服务的操作,使用Saga模式或最终一致性方案。

---

## 八、配置设计

### 8.1 application.yml

```yaml
spring:
  application:
    name: qooerp-production
  
  datasource:
    url: jdbc:postgresql://localhost:5432/qooerp_production
    username: postgres
    password: postgres
    driver-class-name: org.postgresql.Driver
  
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
  
  redis:
    host: localhost
    port: 6379
    database: 6

mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  type-aliases-package: com.qoobot.qooerp.production.entity
  configuration:
    map-underscore-to-camel-case: true

server:
  port: 8092

logging:
  level:
    com.qoobot.qooerp.production: debug
```

---

## 九、部署设计

### 9.1 启动类

```java
@SpringBootApplication
@EnableFeignClients
@EnableDiscoveryClient
@MapperScan("com.qoobot.qooerp.production.mapper")
public class ProductionApplication {
    public static void main(String[] args) {
        SpringApplication.run(ProductionApplication.class, args);
    }
}
```

### 9.2 Docker配置

```dockerfile
FROM openjdk:17-jdk-slim
VOLUME /tmp
COPY qooerp-production-start-1.0.0.jar app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
EXPOSE 8092
```

---

**文档版本**: v1.0  
**最后更新**: 20xx-xx-xx
