server:
  port: 8080

spring:
  application:
    name: qooerp-gateway
  profiles:
    active: dev

  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_ADDR:localhost:8848}
        namespace: qooerp
        metadata:
          version: 1.0.0
          preserved-register-source: true
      config:
        server-addr: ${NACOS_ADDR:localhost:8848}
        namespace: qooerp
        group-id: GATEWAY_GROUP
        file-extension: yml
        shared-configs:
          - data-id: gateway-common.yml
            group-id: COMMON_GROUP
            refresh: true

    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

      # 全局跨域配置
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

      # HTTP客户端配置
      httpclient:
        connect-timeout: 1000
        response-timeout: 5s
        pool:
          type: elastic
          max-connections: 1000
          max-idle-time: 10s
          max-life-time: 30s
          acquire-timeout: 30000

  # Redis配置
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    database: 0
    password: ${REDIS_PASSWORD:}
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
        max-wait: -1ms

# Sentinel配置
spring:
  cloud:
    sentinel:
      transport:
        dashboard: ${SENTINEL_DASHBOARD:localhost:8848}
        port: 8719
      eager: true
      datasource:
        ds:
          nacos:
            server-addr: ${NACOS_ADDR:localhost:8848}
            namespace: qooerp
            data-id: gateway-sentinel-rules
            group-id: DEFAULT_GROUP
            rule-type: flow

# 链路追踪配置
management:
  otlp:
    tracing:
      endpoint: ${OTEL_ENDPOINT:http://localhost:4318/v1/traces}
  tracing:
    sampling:
      probability: 0.1
    propagation:
      type: w3c

# 日志配置
logging:
  level:
    root: INFO
    com.qoobot.qooerp.gateway: DEBUG
    org.springframework.cloud.gateway: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-NA}] [%X{spanId:-NA}] %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-NA}] [%X{spanId:-NA}] %logger{36} - %msg%n"
  file:
    name: /data/qooerp/logs/gateway.log
    max-size: 100MB
    max-history: 30

# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,metrics,prometheus,tracing
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
      env: ${spring.profiles.active}
      instance: ${spring.application.name}:${server.port}
  otlp:
    tracing:
      endpoint: ${OTEL_ENDPOINT:http://localhost:4318/v1/traces}
  tracing:
    sampling:
      probability: 0.1  # 网关10%采样
    propagation:
      type: w3c
