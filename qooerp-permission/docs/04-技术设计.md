# QooERP Permission 模块 - 技术设计文档

## 1. 技术选型

### 1.1 核心技术栈

| 技术组件 | 版本 | 用途 |
|---------|------|------|
| Spring Boot | 3.x | 应用框架 |
| Spring Security | 6.x | 安全框架 |
| MyBatis-Plus | 3.5.x | ORM框架 |
| PostgreSQL | 15+ | 关系型数据库 |
| Redis | 7.x | 缓存数据库 |
| Nacos | 2.x | 配置中心和服务发现 |
| Sentinel | 1.8.x | 限流熔断 |
| Spring Cloud OpenFeign | 4.x | 服务调用 |

### 1.2 依赖模块

```xml
<dependencies>
    <!-- 公共模块 -->
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-common-api</artifactId>
    </dependency>
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-common-core</artifactId>
    </dependency>
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-common-security</artifactId>
    </dependency>
    
    <!-- 认证模块 -->
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-auth-api</artifactId>
    </dependency>
    
    <!-- 组织模块 -->
    <dependency>
        <groupId>com.qoobot</groupId>
        <artifactId>qooerp-organization-api</artifactId>
    </dependency>
    
    <!-- 数据库 -->
    <dependency>
        <groupId>org.postgresql</groupId>
        <artifactId>postgresql</artifactId>
    </dependency>
    
    <!-- 缓存 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    
    <!-- 注册中心和配置中心 -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    </dependency>
</dependencies>
```

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                   客户端层 (Web/Mobile)                   │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│                    API Gateway                            │
│              (路由、认证、限流)                            │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│              Permission Service                          │
│  ┌────────────────────────────────────────────────────┐  │
│  │              Controller 层                         │  │
│  │  - PermissionController                             │  │
│  │  - RoleController                                   │  │
│  │  - MenuController                                   │  │
│  │  - ResourceController                               │  │
│  └──────────────────────┬─────────────────────────────┘  │
│  ┌──────────────────────▼─────────────────────────────┐  │
│  │              Service 层                             │  │
│  │  - PermissionService                               │  │
│  │  - RoleService                                     │  │
│  │  - MenuService                                     │  │
│  │  - ResourceService                                 │  │
│  └──────────────────────┬─────────────────────────────┘  │
│  ┌──────────────────────▼─────────────────────────────┐  │
│  │              Mapper 层                              │  │
│  │  - PermissionMapper                                │  │
│  │  - RoleMapper                                      │  │
│  │  - MenuMapper                                      │  │
│  │  - ResourceMapper                                  │  │
│  └──────────────────────┬─────────────────────────────┘  │
│  ┌──────────────────────▼─────────────────────────────┐  │
│  │              数据访问层                             │  │
│  │  - MyBatis-Plus                                     │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
┌───────▼──────┐ ┌─────▼─────┐ ┌────▼─────┐
│  PostgreSQL  │ │   Redis   │ │  Nacos   │
│   (持久化)   │ │  (缓存)   │ │(配置中心) │
└──────────────┘ └───────────┘ └──────────┘
```

### 2.2 分层架构详解

#### Controller 层
- 职责：接收HTTP请求，参数校验，调用Service层，返回响应
- 特性：统一异常处理，统一响应格式，操作日志记录

#### Service 层
- 职责：业务逻辑处理，事务管理，缓存管理
- 特性：接口与实现分离，使用@Transactional注解管理事务

#### Mapper 层
- 职责：数据库访问，SQL映射
- 特性：继承MyBatis-Plus的BaseMapper，支持通用CRUD

## 3. 核心功能实现

### 3.1 RBAC权限模型实现

#### 权限判断核心流程

```
用户请求 → 拦截器 → 提取用户信息 → 查询用户角色 
    → 查询角色权限 → 查询资源权限 → 匹配判断 → 允许/拒绝
```

#### 权限缓存策略

```java
@Service
public class PermissionCacheService {
    
    private static final String USER_PERMISSIONS_KEY = "permission:user:%s";
    private static final String ROLE_PERMISSIONS_KEY = "permission:role:%s";
    
    // 缓存用户权限
    @Cacheable(value = "userPermissions", key = "#userId")
    public Set<String> getUserPermissions(Long userId) {
        return permissionMapper.selectPermissionsByUserId(userId);
    }
    
    // 缓存角色权限
    @Cacheable(value = "rolePermissions", key = "#roleId")
    public Set<String> getRolePermissions(Long roleId) {
        return permissionMapper.selectPermissionsByRoleId(roleId);
    }
    
    // 清除用户权限缓存
    @CacheEvict(value = "userPermissions", key = "#userId")
    public void clearUserPermissions(Long userId) {
    }
}
```

### 3.2 数据权限实现

#### 数据权限SQL拦截

```java
@Intercepts({
    @Signature(type = Executor.class, method = "query", 
               args = {MappedStatement.class, Object.class, 
                      RowBounds.class, ResultHandler.class})
})
public class DataScopeInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 获取当前用户数据权限范围
        DataScope dataScope = SecurityUtils.getDataScope();
        
        if (dataScope != null) {
            // 注入数据权限SQL条件
            Object parameter = invocation.getArgs()[1];
            if (parameter instanceof Map) {
                Map<?, ?> map = (Map<?, ?>) parameter;
                map.put("dataScope", dataScope);
            }
        }
        
        return invocation.proceed();
    }
}
```

### 3.3 菜单树构建

#### 递归构建菜单树

```java
@Service
public class MenuServiceImpl implements MenuService {
    
    @Override
    public List<MenuVO> buildMenuTree(List<MenuVO> menuList) {
        List<MenuVO> tree = new ArrayList<>();
        Map<Long, MenuVO> menuMap = new HashMap<>();
        
        // 构建映射
        for (MenuVO menu : menuList) {
            menuMap.put(menu.getId(), menu);
        }
        
        // 构建树形结构
        for (MenuVO menu : menuList) {
            if (menu.getParentId() == null || menu.getParentId() == 0) {
                tree.add(menu);
            } else {
                MenuVO parent = menuMap.get(menu.getParentId());
                if (parent != null) {
                    if (parent.getChildren() == null) {
                        parent.setChildren(new ArrayList<>());
                    }
                    parent.getChildren().add(menu);
                }
            }
        }
        
        return tree;
    }
}
```

### 3.4 权限校验注解实现

#### @RequirePermission注解处理器

```java
@Aspect
@Component
public class PermissionAspect {
    
    @Autowired
    private PermissionService permissionService;
    
    @Around("@annotation(requirePermission)")
    public Object checkPermission(ProceedingJoinPoint point, 
                                  RequirePermission requirePermission) throws Throwable {
        // 获取当前用户
        Long userId = SecurityUtils.getUserId();
        
        // 获取需要的权限
        String[] requiredPermissions = requirePermission.value().split(",");
        
        // 校验权限
        boolean hasPermission = permissionService.hasAnyPermission(userId, requiredPermissions);
        
        if (!hasPermission) {
            throw new PermissionException("权限不足，需要权限: " + Arrays.toString(requiredPermissions));
        }
        
        return point.proceed();
    }
}
```

## 4. 缓存设计

### 4.1 缓存策略

| 数据类型 | 缓存Key | 过期时间 | 更新策略 |
|---------|---------|----------|----------|
| 用户权限 | permission:user:{userId} | 30分钟 | 用户角色/权限变更时清除 |
| 角色权限 | permission:role:{roleId} | 1小时 | 角色权限变更时清除 |
| 菜单树 | menu:tree:{userId} | 30分钟 | 菜单变更时清除 |
| 权限列表 | permission:list | 1小时 | 权限变更时清除 |

### 4.2 缓存注解使用

```java
@Service
public class PermissionServiceImpl implements PermissionService {
    
    // 查询时缓存
    @Cacheable(value = "permissions", key = "#id")
    public PermissionVO getPermission(Long id) {
        return permissionMapper.selectById(id);
    }
    
    // 更新时清除缓存
    @CacheEvict(value = "permissions", key = "#permission.id")
    public void updatePermission(PermissionDTO permission) {
        permissionMapper.updateById(permission);
        // 清除相关用户权限缓存
        clearUserPermissionsCache(permission);
    }
    
    // 删除时清除缓存
    @CacheEvict(value = "permissions", key = "#id")
    public void deletePermission(Long id) {
        permissionMapper.deleteById(id);
    }
}
```

## 5. 安全设计

### 5.1 接口安全

#### 权限校验流程

```java
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) throws Exception {
        // 获取注解
        RequirePermission annotation = 
            ((HandlerMethod) handler).getMethodAnnotation(RequirePermission.class);
        
        if (annotation != null) {
            // 校验权限
            String[] permissions = annotation.value().split(",");
            boolean hasPermission = checkPermissions(permissions);
            
            if (!hasPermission) {
                throw new PermissionException("权限不足");
            }
        }
        
        return true;
    }
}
```

### 5.2 数据安全

#### 敏感字段加密

```java
public class Permission {
    private Long id;
    private String code;
    private String name;
    @JsonIgnore
    private String remark;  // 敏感字段不返回
}
```

#### SQL注入防护

使用MyBatis-Plus的参数化查询，防止SQL注入。

```java
// 安全的查询方式
LambdaQueryWrapper<Permission> wrapper = new LambdaQueryWrapper<>();
wrapper.eq(Permission::getCode, permissionCode);
List<Permission> list = permissionMapper.selectList(wrapper);

// 避免直接拼接SQL
// String sql = "SELECT * FROM permission WHERE code = '" + code + "'";  // 不安全
```

## 6. 性能优化

### 6.1 数据库优化

#### 索引设计

```sql
-- permission_permission表索引
CREATE INDEX idx_permission_code ON permission_permission(code);
CREATE INDEX idx_permission_name ON permission_permission(name);

-- permission_role表索引
CREATE INDEX idx_role_code ON permission_role(code);
CREATE INDEX idx_role_name ON permission_role(name);

-- permission_menu表索引
CREATE INDEX idx_menu_parent_id ON permission_menu(parent_id);
CREATE INDEX idx_menu_sort ON permission_menu(sort);

-- permission_resource表索引
CREATE INDEX idx_resource_path ON permission_resource(path);
CREATE INDEX idx_resource_method ON permission_resource(method);

-- 关联表索引
CREATE INDEX idx_user_role_user_id ON permission_user_role(user_id);
CREATE INDEX idx_user_role_role_id ON permission_user_role(role_id);
CREATE INDEX idx_role_permission_role_id ON permission_role_permission(role_id);
CREATE INDEX idx_role_permission_permission_id ON permission_role_permission(permission_id);
```

#### 分页查询优化

```java
@Override
public Page<PermissionVO> listPermissions(PageQueryDTO query) {
    Page<Permission> page = new Page<>(query.getCurrent(), query.getSize());
    
    LambdaQueryWrapper<Permission> wrapper = new LambdaQueryWrapper<>();
    wrapper.like(StringUtils.isNotBlank(query.getKeyword()), 
                 Permission::getName, query.getKeyword())
           .orderByAsc(Permission::getSort);
    
    return permissionMapper.selectPage(page, wrapper);
}
```

### 6.2 缓存优化

#### 批量预热缓存

```java
@PostConstruct
public void warmUpCache() {
    // 预热角色权限缓存
    List<Role> roles = roleMapper.selectList(null);
    for (Role role : roles) {
        permissionCacheService.getRolePermissions(role.getId());
    }
}
```

## 7. 监控和日志

### 7.1 操作日志

记录权限相关操作，包括角色分配、权限变更等。

```java
@OperationLog(module = "权限管理", operation = "分配角色", type = OperationType.UPDATE)
public void assignRole(Long userId, Long roleId) {
    // ...
}
```

### 7.2 性能监控

使用Spring Actuator监控接口性能。

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  metrics:
    export:
      prometheus:
        enabled: true
```

## 8. 部署配置

### 8.1 application.yml

```yaml
server:
  port: 8083

spring:
  application:
    name: qooerp-permission
  
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/qooerp
    username: postgres
    password: postgres
  
  redis:
    host: localhost
    port: 6379
    database: 2
    password:
  
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: qooerp
      config:
        server-addr: localhost:8848
        namespace: qooerp
        file-extension: yml

mybatis-plus:
  mapper-locations: classpath*:mapper/**/*.xml
  type-aliases-package: com.qoobot.qooerp.permission.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl

logging:
  level:
    com.qoobot.qooerp.permission: debug
```

### 8.2 环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| SERVER_PORT | 服务端口 | 8083 |
| DB_URL | 数据库URL | - |
| DB_USERNAME | 数据库用户名 | - |
| DB_PASSWORD | 数据库密码 | - |
| REDIS_HOST | Redis主机 | localhost |
| REDIS_PORT | Redis端口 | 6379 |
| NACOS_ADDR | Nacos地址 | localhost:8848 |

## 9. 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2025-01-17 | 初始版本 | Auto |
