# qooerp-permission 权限服务 - 数据设计文档

> 模块版本：1.0.0-SNAPSHOT
> 创建日期：2026-02-17
> 文档作者：QooERP团队

---

## 一、数据库概述

### 1.1 数据库信息

| 项目 | 值 |
|------|-----|
| 数据库名称 | qooerp_permission |
| 数据库类型 | PostgreSQL 15+ |
| 字符集 | UTF8 |
| 排序规则 | zh_CN.UTF-8 |

### 1.2 表清单

| 序号 | 表名 | 中文名 | 说明 |
|------|------|--------|------|
| 1 | permission_role | 角色表 | 存储角色信息 |
| 2 | permission_menu | 菜单表 | 存储菜单信息 |
| 3 | permission_role_menu | 角色菜单关联表 | 角色与菜单多对多关系 |
| 4 | permission_user_role | 用户角色关联表 | 用户与角色多对多关系 |

---

## 二、数据表设计

### 2.1 permission_role 角色表

#### 2.1.1 表结构

| 序号 | 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 主键 | 说明 |
|------|--------|------|------|----------|--------|------|------|
| 1 | id | BIGINT | 20 | NO | | YES | 角色ID |
| 2 | tenant_id | BIGINT | 20 | YES | 0 | NO | 租户ID |
| 3 | role_name | VARCHAR | 50 | NO | | NO | 角色名称 |
| 4 | role_code | VARCHAR | 50 | NO | | NO | 角色编码（唯一） |
| 5 | role_type | TINYINT | 1 | NO | 2 | NO | 角色类型：1-系统角色 2-业务角色 |
| 6 | data_scope | TINYINT | 1 | NO | 1 | NO | 数据权限范围：1-全部 2-部门 3-部门及子部门 4-本人 5-自定义 |
| 7 | dept_ids | VARCHAR | 500 | YES | | NO | 自定义部门ID（data_scope=5时使用） |
| 8 | status | TINYINT | 1 | NO | 1 | NO | 状态：0-禁用 1-启用 |
| 9 | sort | INT | 11 | YES | 0 | NO | 排序号 |
| 10 | remark | VARCHAR | 500 | YES | | NO | 备注 |
| 11 | create_time | TIMESTAMP | | NO | CURRENT_TIMESTAMP | NO | 创建时间 |
| 12 | create_by | VARCHAR | 50 | YES | | NO | 创建人 |
| 13 | update_time | TIMESTAMP | | NO | CURRENT_TIMESTAMP | NO | 更新时间 |
| 14 | update_by | VARCHAR | 50 | YES | | NO | 更新人 |
| 15 | deleted | TINYINT | 1 | NO | 0 | NO | 删除标记：0-未删除 1-已删除 |

#### 2.1.2 索引设计

| 索引名 | 索引类型 | 索引字段 | 说明 |
|--------|---------|---------|------|
| PRIMARY | 主键索引 | id | 主键索引 |
| uk_role_code | 唯一索引 | role_code, deleted | 角色编码唯一索引 |
| idx_tenant_id | 普通索引 | tenant_id, deleted | 租户索引 |
| idx_role_type | 普通索引 | role_type, deleted | 角色类型索引 |

#### 2.1.3 建表SQL

```sql
CREATE TABLE permission_role (
    id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL DEFAULT 0,
    role_name VARCHAR(50) NOT NULL,
    role_code VARCHAR(50) NOT NULL,
    role_type SMALLINT NOT NULL DEFAULT 2,
    data_scope SMALLINT NOT NULL DEFAULT 1,
    dept_ids VARCHAR(500),
    status SMALLINT NOT NULL DEFAULT 1,
    sort INTEGER NOT NULL DEFAULT 0,
    remark VARCHAR(500),
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    create_by VARCHAR(50),
    update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_by VARCHAR(50),
    deleted SMALLINT NOT NULL DEFAULT 0
);

-- 创建索引
CREATE UNIQUE INDEX uk_permission_role_code ON permission_role(role_code) WHERE deleted = 0;
CREATE INDEX idx_permission_tenant_id ON permission_role(tenant_id, deleted);
CREATE INDEX idx_permission_role_type ON permission_role(role_type, deleted);

-- 添加表注释
COMMENT ON TABLE permission_role IS '角色表';
COMMENT ON COLUMN permission_role.id IS '角色ID';
COMMENT ON COLUMN permission_role.tenant_id IS '租户ID';
COMMENT ON COLUMN permission_role.role_name IS '角色名称';
COMMENT ON COLUMN permission_role.role_code IS '角色编码';
COMMENT ON COLUMN permission_role.role_type IS '角色类型：1-系统角色 2-业务角色';
COMMENT ON COLUMN permission_role.data_scope IS '数据权限范围：1-全部 2-部门 3-部门及子部门 4-本人 5-自定义';
COMMENT ON COLUMN permission_role.dept_ids IS '自定义部门ID';
COMMENT ON COLUMN permission_role.status IS '状态：0-禁用 1-启用';
COMMENT ON COLUMN permission_role.sort IS '排序号';
COMMENT ON COLUMN permission_role.remark IS '备注';
```

---

### 2.2 permission_menu 菜单表

#### 2.2.1 表结构

| 序号 | 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 主键 | 说明 |
|------|--------|------|------|----------|--------|------|------|
| 1 | id | BIGINT | 20 | NO | | YES | 菜单ID |
| 2 | parent_id | BIGINT | 20 | YES | 0 | NO | 父菜单ID |
| 3 | menu_name | VARCHAR | 50 | NO | | NO | 菜单名称 |
| 4 | menu_type | VARCHAR | 1 | NO | | NO | 菜单类型：M-目录 C-菜单 F-按钮 |
| 5 | path | VARCHAR | 200 | YES | | NO | 路由路径 |
| 6 | component | VARCHAR | 200 | YES | | NO | 组件路径 |
| 7 | permission | VARCHAR | 100 | YES | | NO | 权限标识 |
| 8 | icon | VARCHAR | 100 | YES | | NO | 图标 |
| 9 | sort | INT | 11 | YES | 0 | NO | 排序号 |
| 10 | visible | TINYINT | 1 | NO | 1 | NO | 是否显示：0-隐藏 1-显示 |
| 11 | is_cache | TINYINT | 1 | NO | 0 | NO | 是否缓存：0-不缓存 1-缓存 |
| 12 | is_frame | TINYINT | 1 | NO | 1 | NO | 是否外链：0-否 1-是 |
| 13 | remark | VARCHAR | 500 | YES | | NO | 备注 |
| 14 | create_time | TIMESTAMP | | NO | CURRENT_TIMESTAMP | NO | 创建时间 |
| 15 | create_by | VARCHAR | 50 | YES | | NO | 创建人 |
| 16 | update_time | TIMESTAMP | | NO | CURRENT_TIMESTAMP | NO | 更新时间 |
| 17 | update_by | VARCHAR | 50 | YES | | NO | 更新人 |

#### 2.2.2 索引设计

| 索引名 | 索引类型 | 索引字段 | 说明 |
|--------|---------|---------|------|
| PRIMARY | 主键索引 | id | 主键索引 |
| idx_parent_id | 普通索引 | parent_id | 父菜单索引 |
| idx_menu_type | 普通索引 | menu_type | 菜单类型索引 |
| idx_sort | 普通索引 | parent_id, sort | 排序索引 |

#### 2.2.3 建表SQL

```sql
CREATE TABLE permission_menu (
    id BIGSERIAL PRIMARY KEY,
    parent_id BIGINT DEFAULT 0,
    menu_name VARCHAR(50) NOT NULL,
    menu_type VARCHAR(1) NOT NULL,
    path VARCHAR(200),
    component VARCHAR(200),
    permission VARCHAR(100),
    icon VARCHAR(100),
    sort INTEGER DEFAULT 0,
    visible SMALLINT NOT NULL DEFAULT 1,
    is_cache SMALLINT NOT NULL DEFAULT 0,
    is_frame SMALLINT NOT NULL DEFAULT 1,
    remark VARCHAR(500),
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    create_by VARCHAR(50),
    update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_by VARCHAR(50)
);

-- 创建索引
CREATE INDEX idx_permission_parent_id ON permission_menu(parent_id);
CREATE INDEX idx_permission_menu_type ON permission_menu(menu_type);
CREATE INDEX idx_permission_sort ON permission_menu(parent_id, sort);

-- 添加表注释
COMMENT ON TABLE permission_menu IS '菜单表';
COMMENT ON COLUMN permission_menu.id IS '菜单ID';
COMMENT ON COLUMN permission_menu.parent_id IS '父菜单ID';
COMMENT ON COLUMN permission_menu.menu_name IS '菜单名称';
COMMENT ON COLUMN permission_menu.menu_type IS '菜单类型：M-目录 C-菜单 F-按钮';
COMMENT ON COLUMN permission_menu.path IS '路由路径';
COMMENT ON COLUMN permission_menu.component IS '组件路径';
COMMENT ON COLUMN permission_menu.permission IS '权限标识';
COMMENT ON COLUMN permission_menu.icon IS '图标';
COMMENT ON COLUMN permission_menu.sort IS '排序号';
COMMENT ON COLUMN permission_menu.visible IS '是否显示：0-隐藏 1-显示';
COMMENT ON COLUMN permission_menu.is_cache IS '是否缓存：0-不缓存 1-缓存';
COMMENT ON COLUMN permission_menu.is_frame IS '是否外链：0-否 1-是';
```

---

### 2.3 permission_role_menu 角色菜单关联表

#### 2.3.1 表结构

| 序号 | 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 主键 | 说明 |
|------|--------|------|------|----------|--------|------|------|
| 1 | id | BIGINT | 20 | NO | | YES | 主键ID |
| 2 | role_id | BIGINT | 20 | NO | | NO | 角色ID |
| 3 | menu_id | BIGINT | 20 | NO | | NO | 菜单ID |

#### 2.3.2 索引设计

| 索引名 | 索引类型 | 索引字段 | 说明 |
|--------|---------|---------|------|
| PRIMARY | 主键索引 | id | 主键索引 |
| uk_role_menu | 唯一索引 | role_id, menu_id | 角色菜单唯一索引 |

#### 2.3.3 建表SQL

```sql
CREATE TABLE permission_role_menu (
    id BIGSERIAL PRIMARY KEY,
    role_id BIGINT NOT NULL,
    menu_id BIGINT NOT NULL
);

-- 创建唯一索引
CREATE UNIQUE INDEX uk_permission_role_menu ON permission_role_menu(role_id, menu_id);

-- 添加表注释
COMMENT ON TABLE permission_role_menu IS '角色菜单关联表';
COMMENT ON COLUMN permission_role_menu.id IS '主键ID';
COMMENT ON COLUMN permission_role_menu.role_id IS '角色ID';
COMMENT ON COLUMN permission_role_menu.menu_id IS '菜单ID';
```

---

### 2.4 permission_user_role 用户角色关联表

#### 2.4.1 表结构

| 序号 | 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 主键 | 说明 |
|------|--------|------|------|----------|--------|------|------|
| 1 | id | BIGINT | 20 | NO | | YES | 主键ID |
| 2 | user_id | BIGINT | 20 | NO | | NO | 用户ID |
| 3 | role_id | BIGINT | 20 | NO | | NO | 角色ID |

#### 2.4.2 索引设计

| 索引名 | 索引类型 | 索引字段 | 说明 |
|--------|---------|---------|------|
| PRIMARY | 主键索引 | id | 主键索引 |
| uk_user_role | 唯一索引 | user_id, role_id | 用户角色唯一索引 |
| idx_user_id | 普通索引 | user_id | 用户ID索引 |

#### 2.4.3 建表SQL

```sql
CREATE TABLE permission_user_role (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL
);

-- 创建索引
CREATE UNIQUE INDEX uk_permission_user_role ON permission_user_role(user_id, role_id);
CREATE INDEX idx_permission_user_id ON permission_user_role(user_id);

-- 添加表注释
COMMENT ON TABLE permission_user_role IS '用户角色关联表';
COMMENT ON COLUMN permission_user_role.id IS '主键ID';
COMMENT ON COLUMN permission_user_role.user_id IS '用户ID';
COMMENT ON COLUMN permission_user_role.role_id IS '角色ID';
```

---

## 三、数据字典

### 3.1 permission_role 字段枚举

#### role_type（角色类型）

| 值 | 名称 | 说明 |
|----|------|------|
| 1 | 系统角色 | 系统内置角色，不可删除 |
| 2 | 业务角色 | 自定义业务角色 |

#### data_scope（数据权限范围）

| 值 | 名称 | 说明 |
|----|------|------|
| 1 | 全部数据 | 可查看所有数据 |
| 2 | 本部门数据 | 仅查看本部门数据 |
| 3 | 本部门及子部门 | 查看本部门及子部门数据 |
| 4 | 仅本人 | 仅查看自己创建的数据 |
| 5 | 自定义数据 | 自定义部门数据范围 |

### 3.2 permission_menu 字段枚举

#### menu_type（菜单类型）

| 值 | 名称 | 说明 |
|----|------|------|
| M | 目录 | 一级菜单，下级菜单的父节点 |
| C | 菜单 | 实际功能页面 |
| F | 按钮 | 页面内的操作按钮 |

---

## 四、初始化数据

### 4.1 默认角色数据

```sql
-- 插入默认管理员角色
INSERT INTO permission_role (
    tenant_id, role_name, role_code, role_type, data_scope, status, create_by, update_by
) VALUES (
    0,
    '超级管理员',
    'ADMIN',
    1,
    1,
    1,
    'system',
    'system'
);

-- 插入默认普通用户角色
INSERT INTO permission_role (
    tenant_id, role_name, role_code, role_type, data_scope, status, create_by, update_by
) VALUES (
    0,
    '普通用户',
    'USER',
    2,
    4,
    1,
    'system',
    'system'
);
```

### 4.2 默认菜单数据

```sql
-- 插入默认菜单（一级菜单）
INSERT INTO permission_menu (parent_id, menu_name, menu_type, path, icon, sort, visible, create_by, update_by) VALUES
(0, '系统管理', 'M', '/system', 'system', 1, 1, 'system', 'system'),
(0, '权限管理', 'M', '/permission', 'permission', 2, 1, 'system', 'system'),
(0, '用户管理', 'M', '/user', 'user', 3, 1, 'system', 'system');

-- 插入默认菜单（二级菜单）
INSERT INTO permission_menu (parent_id, menu_name, menu_type, path, icon, sort, visible, create_by, update_by) VALUES
(1, '角色管理', 'C', '/system/role', 'role', 1, 1, 'system', 'system'),
(1, '菜单管理', 'C', '/system/menu', 'menu', 2, 1, 'system', 'system'),
(2, '用户管理', 'C', '/permission/user', 'user', 1, 1, 'system', 'system');
```

### 4.3 默认角色菜单关联

```sql
-- 为超级管理员角色分配所有菜单
INSERT INTO permission_role_menu (role_id, menu_id)
SELECT
    (SELECT id FROM permission_role WHERE role_code = 'ADMIN'),
    id
FROM permission_menu;

-- 为超级管理员分配给admin用户（假设admin用户ID为1）
INSERT INTO permission_user_role (user_id, role_id)
VALUES (1, (SELECT id FROM permission_role WHERE role_code = 'ADMIN'));
```

---

## 五、数据关系

### 5.1 ER图

```mermaid
erDiagram
    permission_user |--o{ permission_user_role : "拥有"
    permission_role |--o{ permission_user_role : "被分配"
    permission_role |--o{ permission_role_menu : "拥有"
    permission_menu |--o{ permission_role_menu : "被分配"
    permission_menu |--o{ permission_menu : "包含（自关联）"
    permission_role {
        BIGINT id PK
        VARCHAR role_code
        VARCHAR role_name
        SMALLINT role_type
        SMALLINT data_scope
        SMALLINT status
    }
    permission_menu {
        BIGINT id PK
        BIGINT parent_id FK
        VARCHAR menu_name
        VARCHAR menu_type
        VARCHAR permission
        SMALLINT sort
    }
    permission_user_role {
        BIGINT id PK
        BIGINT user_id FK
        BIGINT role_id FK
    }
    permission_role_menu {
        BIGINT id PK
        BIGINT role_id FK
        BIGINT menu_id FK
    }
```

### 5.2 关系说明

| 表A | 表B | 关系类型 | 说明 |
|-----|-----|---------|------|
| permission_user | permission_user_role | 1:N | 一个用户可以有多个角色 |
| permission_role | permission_user_role | 1:N | 一个角色可以分配给多个用户 |
| permission_role | permission_role_menu | 1:N | 一个角色可以拥有多个菜单 |
| permission_menu | permission_role_menu | 1:N | 一个菜单可以分配给多个角色 |
| permission_menu | permission_menu | 1:N | 一个菜单可以有多个子菜单 |

---

## 六、数据维护

### 6.1 数据清理策略

| 表名 | 清理策略 | 保留周期 |
|------|---------|---------|
| permission_role | 软删除 | 永久保留 |
| permission_menu | 软删除 | 永久保留 |
| permission_role_menu | 级联删除 | 永久保留 |
| permission_user_role | 级联删除 | 永久保留 |

### 6.2 数据备份策略

| 备份类型 | 频率 | 保留周期 |
|---------|------|---------|
| 全量备份 | 每天凌晨2点 | 保留7天 |
| 增量备份 | 每小时 | 保留24小时 |

---

## 七、性能优化

### 7.1 索引优化

- 已为常用查询字段创建索引
- 复合索引遵循最左前缀原则
- 定期分析索引使用情况

### 7.2 查询优化

- 使用递归查询获取菜单树
- 使用缓存减少数据库查询
- 避免使用 `SELECT *`

### 7.3 分区策略

暂不需要分区，数据量较小。

---

## 八、数据安全

### 8.1 数据权限

| 操作 | 权限要求 |
|------|---------|
| 创建角色 | 需要角色管理权限 |
| 编辑角色 | 需要角色管理权限 |
| 删除角色 | 需要角色删除权限 |
| 创建菜单 | 需要菜单管理权限 |
| 分配角色 | 需要角色分配权限 |

### 8.2 敏感字段保护

所有表都使用软删除，数据可追溯。

---

## 九、参考资料

- [PostgreSQL官方文档](https://www.postgresql.org/docs/)
- [RBAC模型设计](https://en.wikipedia.org/wiki/Role-based_access_control)
